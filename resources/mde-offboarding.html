<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MDE Offboarding Runbook | Security Transformation</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
  <div class="layout">
        <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="sidebar-logo-icon">RF</div>
          <div class="sidebar-logo-text">
            <span class="sidebar-logo-title">Security Transformation</span>
            <span class="sidebar-logo-subtitle">RevFlow Analytics</span>
          </div>
        </div>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Overview</div>
          <a href="../index.html" class="nav-item">Executive Summary</a>
          <a href="../company-profile.html" class="nav-item">Company Profile</a>
          <a href="../security-framework.html" class="nav-item">Security Framework</a>
          <a href="../program-structure.html" class="nav-item">Program Structure</a>
          <a href="../controls-mapping.html" class="nav-item">Controls Mapping</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">SIEM Migration</div>
          <a href="../siem/index.html" class="nav-item">SIEM Overview</a>
          <a href="../siem/discovery.html" class="nav-item">Discovery & Assessment</a>
          <a href="../siem/log-sources.html" class="nav-item">Log Source Strategy</a>
          <a href="../siem/log-engineering.html" class="nav-item">Log Engineering</a>
          <a href="../siem/parsing-deep-dive.html" class="nav-item">Parsing Deep Dive</a>
          <a href="../siem/threat-intelligence.html" class="nav-item">Threat Intelligence</a>
          <a href="../siem/detection-engineering.html" class="nav-item">Detection Engineering</a>
          <a href="../siem/detection-anatomy.html" class="nav-item">Detection Anatomy</a>
          <a href="../siem/detection-catalog.html" class="nav-item">Detection Catalog</a>
          <a href="../siem/soar-automation.html" class="nav-item">SOAR &amp; Automation</a>
          <a href="../siem/workbooks.html" class="nav-item">Workbooks &amp; Dashboards</a>
          <a href="../siem/cost-optimization.html" class="nav-item">Cost Optimization</a>
          <a href="../siem/soc-transition.html" class="nav-item">SOC Transition</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">EDR Migration</div>
          <a href="../edr/index.html" class="nav-item">EDR Overview</a>
          <a href="../edr/xdr-detection-model.html" class="nav-item">XDR Detection Model</a>
          <a href="../edr/advanced-hunting.html" class="nav-item">Advanced Hunting</a>
          <a href="../edr/live-response.html" class="nav-item">Live Response</a>
          <a href="../edr/tvm.html" class="nav-item">Vulnerability Management</a>
          <a href="../edr/deployment.html" class="nav-item">MDE Deployment</a>
          <a href="../edr/asr-rules.html" class="nav-item">ASR Rules</a>
          <a href="../edr/device-control.html" class="nav-item">Device Control</a>
          <a href="../edr/coexistence.html" class="nav-item">Coexistence Strategy</a>
          <a href="../edr/eset-removal.html" class="nav-item">ESET Removal</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">DLP Migration</div>
          <a href="../dlp/index.html" class="nav-item">DLP Overview</a>
          <a href="../dlp/dlp-catalog.html" class="nav-item">DLP Catalog</a>
          <a href="../dlp/policy-translation.html" class="nav-item">Policy Translation</a>
          <a href="../dlp/rollout-phases.html" class="nav-item">Rollout Phases</a>
          <a href="../dlp/user-communication.html" class="nav-item">User Communication</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Identity & Access</div>
          <a href="../identity/index.html" class="nav-item">Identity Overview</a>
          <a href="../identity/hybrid-setup.html" class="nav-item">Hybrid Identity</a>
          <a href="../identity/conditional-access.html" class="nav-item">Conditional Access</a>
          <a href="../identity/pim.html" class="nav-item">PIM Configuration</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Infrastructure</div>
          <a href="../infrastructure/index.html" class="nav-item">Infrastructure Overview</a>
          <a href="../infrastructure/landing-zone.html" class="nav-item">Landing Zone</a>
          <a href="../infrastructure/network-architecture.html" class="nav-item">Network Architecture</a>
          <a href="../infrastructure/workload-migration.html" class="nav-item">Workload Migration</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Operations</div>
          <a href="../operations/parallel-ops.html" class="nav-item">Parallel Operations</a>
          <a href="../operations/soc-workflows.html" class="nav-item">SOC Workflows</a>
          <a href="../operations/integration.html" class="nav-item">Platform Integration</a>
          <a href="../operations/xdr-integration.html" class="nav-item">XDR Integration</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Resources</div>
          <a href="../resources/timeline.html" class="nav-item">Project Timeline</a>
          <a href="../resources/raci.html" class="nav-item">RACI Matrix</a>
          <a href="../resources/infrastructure-reference.html" class="nav-item">Infrastructure Reference</a>
          <a href="../resources/scripts.html" class="nav-item">Scripts & Queries</a>
          <a href="../resources/data-dictionary.html" class="nav-item">Data Dictionary</a>
          <a href="../resources/templates.html" class="nav-item">Templates</a>
          <a href="../resources/splunk-reference.html" class="nav-item">Splunk Reference</a>
          <a href="../resources/alternative-architectures.html" class="nav-item">Alternative Architectures</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Runbooks</div>
          <a href="../resources/mde-onboarding.html" class="nav-item">MDE Onboarding</a>
          <a href="../resources/mde-offboarding.html" class="nav-item active">MDE Offboarding</a>
          <a href="../resources/incident-response.html" class="nav-item">Incident Response</a>
          <a href="../resources/operational-procedures.html" class="nav-item">Operational Procedures</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Troubleshooting</div>
          <a href="../troubleshooting/index.html" class="nav-item">Common Issues</a>
          <a href="../troubleshooting/siem-issues.html" class="nav-item">SIEM Issues</a>
          <a href="../troubleshooting/mde-issues.html" class="nav-item">MDE Issues</a>
          <a href="../troubleshooting/dlp-issues.html" class="nav-item">DLP Issues</a>
          <a href="../troubleshooting/agent-conflicts.html" class="nav-item">Agent Conflicts</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Career</div>
          <a href="../career-narrative.html" class="nav-item">Career Narrative</a>
          <a href="../interview-prep.html" class="nav-item">Interview Prep</a>
        </div>
      </nav>
    </aside>

    <main class="main-content">
      <div class="content-wrapper">
        <nav class="breadcrumb">
          <a href="../index.html">Home</a>
          <span class="breadcrumb-separator">/</span>
          <a href="templates.html">Resources</a>
          <span class="breadcrumb-separator">/</span>
          <span class="breadcrumb-current">MDE Offboarding Runbook</span>
        </nav>

        <div class="page-header">
          <h1>MDE Offboarding Runbook</h1>
          <div class="page-header-meta">
            <span class="page-badge edr">EDR Track</span>
            <span class="page-reading-time">Operational Runbook</span>
          </div>
          <p class="intro-text">
            Step-by-step procedures for offboarding devices from Microsoft Defender for Endpoint. Use when decommissioning devices, reimaging, or transferring to another tenant.
          </p>
        </div>

        <div class="callout warning">
          <div class="callout-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>
            Important: Offboarding Considerations
          </div>
          <div class="callout-content">
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
              <li><strong>Data Retention:</strong> Device data remains in the portal for 180 days after offboarding</li>
              <li><strong>License:</strong> License becomes available for reassignment after offboarding</li>
              <li><strong>Security Gap:</strong> Device loses EDR protection immediately upon offboarding</li>
              <li><strong>Approval Required:</strong> Follow change management process before offboarding production devices</li>
            </ul>
          </div>
        </div>

        <!-- ==================== SECTION 1: SCENARIOS ==================== -->
        <h2>1. Offboarding Scenarios</h2>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Scenario</th><th>Action</th><th>Portal Cleanup</th><th>Notes</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Device Decommission</strong></td>
                <td>Run offboarding script</td>
                <td>Optional (auto-purges after 180 days)</td>
                <td>Device being retired/destroyed</td>
              </tr>
              <tr>
                <td><strong>Device Reimage</strong></td>
                <td>Run offboarding script before reimage</td>
                <td>Not needed (same device re-onboards)</td>
                <td>Device will re-onboard with same ID</td>
              </tr>
              <tr>
                <td><strong>Tenant Transfer</strong></td>
                <td>Offboard from source, onboard to target</td>
                <td>Yes (remove from source)</td>
                <td>Requires offboarding from old tenant first</td>
              </tr>
              <tr>
                <td><strong>License Reclaim</strong></td>
                <td>Run offboarding script</td>
                <td>No</td>
                <td>License available within 24 hours</td>
              </tr>
              <tr>
                <td><strong>Troubleshooting</strong></td>
                <td>Offboard then re-onboard</td>
                <td>No</td>
                <td>Last resort for onboarding issues</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- ==================== SECTION 2: DOWNLOAD PACKAGE ==================== -->
        <h2>2. Download Offboarding Package</h2>

        <h3>2.1 From M365 Defender Portal</h3>

        <ol style="margin: 1rem 0; padding-left: 1.5rem;">
          <li>Go to <strong>Microsoft 365 Defender Portal</strong> (security.microsoft.com)</li>
          <li>Navigate to <strong>Settings → Endpoints → Offboarding</strong></li>
          <li>Select the operating system (Windows 10/11, Windows Server, macOS, Linux)</li>
          <li>Select deployment method (Local Script, Group Policy, etc.)</li>
          <li>Click <strong>Download package</strong></li>
          <li>Extract the package to get the offboarding script</li>
        </ol>

        <div class="callout info">
          <div class="callout-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
            Package Expiration
          </div>
          <div class="callout-content">
            <p>Offboarding packages expire after <strong>30 days</strong>. Download a fresh package if the current one is expired.</p>
          </div>
        </div>

        <!-- ==================== SECTION 3: WINDOWS ==================== -->
        <h2>3. Windows Offboarding</h2>

        <h3>3.1 Local Script Method</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">CMD - Windows Offboarding (Run as Admin)</span></div>
          <pre><code>@echo off
:: MDE Windows Offboarding Script
:: Run as Administrator

echo =========================================
echo Microsoft Defender for Endpoint Offboarding
echo =========================================

:: Check for admin rights
net session >nul 2>&1
if %errorLevel% neq 0 (
    echo ERROR: Please run as Administrator
    exit /b 1
)

:: Confirm offboarding
echo.
echo WARNING: This will remove the device from MDE protection.
echo Device data will be retained in the portal for 180 days.
echo.
set /p CONFIRM="Are you sure you want to proceed? (yes/no): "
if /i not "%CONFIRM%"=="yes" (
    echo Offboarding cancelled.
    exit /b 0
)

:: Record device info before offboarding
echo.
echo Recording device information...
hostname > "%TEMP%\mde_offboard_%COMPUTERNAME%.log"
echo Offboard Date: %DATE% %TIME% >> "%TEMP%\mde_offboard_%COMPUTERNAME%.log"
reg query "HKLM\SOFTWARE\Microsoft\Windows Advanced Threat Protection\Status" >> "%TEMP%\mde_offboard_%COMPUTERNAME%.log" 2>nul

:: Run offboarding script
echo.
echo Running offboarding script...
call "%~dp0WindowsDefenderATPOffboardingScript_valid_until_YYYY-MM-DD.cmd"

:: Verify offboarding
echo.
echo Verifying offboarding status...
timeout /t 30 /nobreak >nul

reg query "HKLM\SOFTWARE\Microsoft\Windows Advanced Threat Protection\Status" /v OnboardingState 2>nul
if %errorLevel% equ 0 (
    for /f "tokens=3" %%a in ('reg query "HKLM\SOFTWARE\Microsoft\Windows Advanced Threat Protection\Status" /v OnboardingState 2^>nul ^| find "OnboardingState"') do (
        if "%%a"=="0x0" (
            echo SUCCESS: Device offboarded successfully
        ) else (
            echo WARNING: Onboarding state is %%a - may need time to complete
        )
    )
)

:: Stop SENSE service
echo.
echo Stopping SENSE service...
sc stop SENSE

echo.
echo =========================================
echo Offboarding complete.
echo Log saved to: %TEMP%\mde_offboard_%COMPUTERNAME%.log
echo =========================================
pause</code></pre>
        </div>

        <h3>3.2 PowerShell Offboarding with Validation</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">PowerShell - Windows Offboarding with Full Validation</span></div>
          <pre><code># MDE Windows Offboarding Script
# Run as Administrator

param(
    [Parameter(Mandatory=$false)]
    [string]$OffboardingScriptPath = ".\WindowsDefenderATPOffboardingScript.cmd",
    
    [Parameter(Mandatory=$false)]
    [switch]$Force = $false
)

$ErrorActionPreference = "Stop"

function Write-Log {
    param([string]$Message, [string]$Level = "INFO")
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logMessage = "[$timestamp] [$Level] $Message"
    Write-Host $logMessage -ForegroundColor $(switch($Level) { "ERROR" { "Red" } "WARN" { "Yellow" } "SUCCESS" { "Green" } default { "White" } })
    Add-Content -Path $script:LogFile -Value $logMessage
}

# Initialize
$script:LogFile = "$env:TEMP\MDE_Offboard_$env:COMPUTERNAME_$(Get-Date -Format 'yyyyMMdd_HHmmss').log"
Write-Log "========================================="
Write-Log "MDE Offboarding - $env:COMPUTERNAME"
Write-Log "========================================="

# Check admin rights
$isAdmin = ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")
if (-not $isAdmin) {
    Write-Log "Please run as Administrator" "ERROR"
    exit 1
}

# Get current MDE status
Write-Log "Gathering current MDE status..."
try {
    $status = Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows Advanced Threat Protection\Status" -ErrorAction Stop
    Write-Log "Current Onboarding State: $($status.OnboardingState)"
    Write-Log "Organization ID: $($status.OrgId)"
    Write-Log "Last Connected: $($status.LastConnected)"
} catch {
    Write-Log "Device does not appear to be onboarded to MDE" "WARN"
}

# Confirm offboarding
if (-not $Force) {
    Write-Host "`nWARNING: This will remove the device from MDE protection." -ForegroundColor Yellow
    $confirm = Read-Host "Type 'OFFBOARD' to confirm"
    if ($confirm -ne "OFFBOARD") {
        Write-Log "Offboarding cancelled by user" "WARN"
        exit 0
    }
}

# Verify offboarding script exists
if (-not (Test-Path $OffboardingScriptPath)) {
    Write-Log "Offboarding script not found at: $OffboardingScriptPath" "ERROR"
    Write-Log "Download from M365 Defender Portal → Settings → Endpoints → Offboarding" "INFO"
    exit 1
}

# Check script expiration (parse filename for date)
$scriptFile = Get-Item $OffboardingScriptPath
if ($scriptFile.Name -match "valid_until_(\d{4}-\d{2}-\d{2})") {
    $expiryDate = [datetime]::ParseExact($matches[1], "yyyy-MM-dd", $null)
    if ($expiryDate -lt (Get-Date)) {
        Write-Log "Offboarding script has expired on $expiryDate" "ERROR"
        Write-Log "Please download a new offboarding package" "INFO"
        exit 1
    } else {
        Write-Log "Offboarding script valid until: $expiryDate"
    }
}

# Run offboarding script
Write-Log "Executing offboarding script..."
try {
    $process = Start-Process -FilePath $OffboardingScriptPath -Wait -PassThru -NoNewWindow
    if ($process.ExitCode -eq 0) {
        Write-Log "Offboarding script executed successfully" "SUCCESS"
    } else {
        Write-Log "Offboarding script returned exit code: $($process.ExitCode)" "WARN"
    }
} catch {
    Write-Log "Failed to execute offboarding script: $_" "ERROR"
    exit 1
}

# Wait for offboarding to complete
Write-Log "Waiting for offboarding to complete (60 seconds)..."
Start-Sleep -Seconds 60

# Verify offboarding
Write-Log "Verifying offboarding status..."
try {
    $status = Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows Advanced Threat Protection\Status" -ErrorAction Stop
    if ($status.OnboardingState -eq 0) {
        Write-Log "Device offboarded successfully!" "SUCCESS"
    } else {
        Write-Log "Onboarding state is still: $($status.OnboardingState)" "WARN"
    }
} catch {
    Write-Log "Could not read onboarding status (may indicate successful offboarding)" "INFO"
}

# Stop and disable SENSE service
Write-Log "Stopping SENSE service..."
try {
    Stop-Service -Name SENSE -Force -ErrorAction SilentlyContinue
    # Optionally disable to prevent restart
    # Set-Service -Name SENSE -StartupType Disabled
    Write-Log "SENSE service stopped"
} catch {
    Write-Log "Could not stop SENSE service: $_" "WARN"
}

# Summary
Write-Log "========================================="
Write-Log "Offboarding Summary"
Write-Log "========================================="
Write-Log "Computer Name: $env:COMPUTERNAME"
Write-Log "Offboard Time: $(Get-Date)"
Write-Log "Log File: $script:LogFile"
Write-Log "========================================="
Write-Log "IMPORTANT: Device data retained in portal for 180 days" "INFO"
Write-Log "IMPORTANT: Update CMDB/asset inventory to reflect offboarding" "INFO"</code></pre>
        </div>

        <h3>3.3 Group Policy Offboarding</h3>

        <ol style="margin: 1rem 0; padding-left: 1.5rem;">
          <li>Download the GPO offboarding package from M365 Defender portal</li>
          <li>Copy offboarding script to SYSVOL: <code>\\domain\SYSVOL\domain\scripts\MDE\</code></li>
          <li>Create new GPO: <code>MDE-Offboarding-[Date]</code></li>
          <li>Configure: Computer Configuration → Policies → Windows Settings → Scripts → Startup</li>
          <li>Add the offboarding script</li>
          <li>Link GPO to target OU containing devices to offboard</li>
          <li>Force Group Policy update: <code>gpupdate /force</code></li>
          <li>Restart target devices</li>
          <li><strong>Remove GPO link</strong> after offboarding is verified</li>
        </ol>

        <!-- ==================== SECTION 4: LINUX ==================== -->
        <h2>4. Linux Offboarding</h2>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Bash - Linux Offboarding Script</span></div>
          <pre><code>#!/bin/bash
# MDE Linux Offboarding Script
# Run as root

set -e

echo "========================================="
echo "MDE Linux Offboarding"
echo "========================================="

# Check root
if [ "$EUID" -ne 0 ]; then
    echo "ERROR: Please run as root"
    exit 1
fi

# Confirm offboarding
echo ""
echo "WARNING: This will remove the device from MDE protection."
read -p "Type 'OFFBOARD' to confirm: " CONFIRM
if [ "$CONFIRM" != "OFFBOARD" ]; then
    echo "Offboarding cancelled."
    exit 0
fi

# Record current status
echo ""
echo "Recording current MDE status..."
LOGFILE="/var/log/mde_offboard_$(hostname)_$(date +%Y%m%d_%H%M%S).log"
mdatp health > "$LOGFILE" 2>&1 || true

echo "[1/4] Stopping MDE service..."
systemctl stop mdatp || true

echo "[2/4] Running offboarding..."
# Option 1: Using offboarding script from portal
if [ -f "./MicrosoftDefenderATPOffboardingLinuxServer.py" ]; then
    python3 MicrosoftDefenderATPOffboardingLinuxServer.py
fi

# Option 2: Manual offboarding via config removal
# rm -f /etc/opt/microsoft/mdatp/mdatp_onboard.json

echo "[3/4] Uninstalling MDE package..."
# Detect package manager
if command -v apt-get &> /dev/null; then
    apt-get remove -y mdatp
    apt-get autoremove -y
elif command -v yum &> /dev/null; then
    yum remove -y mdatp
elif command -v zypper &> /dev/null; then
    zypper remove -y mdatp
fi

echo "[4/4] Cleaning up..."
rm -rf /etc/opt/microsoft/mdatp
rm -rf /var/opt/microsoft/mdatp

echo ""
echo "========================================="
echo "Offboarding complete!"
echo "Log saved to: $LOGFILE"
echo "========================================="</code></pre>
        </div>

        <!-- ==================== SECTION 5: MACOS ==================== -->
        <h2>5. macOS Offboarding</h2>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Bash - macOS Offboarding Script</span></div>
          <pre><code>#!/bin/bash
# MDE macOS Offboarding Script
# Run with sudo

set -e

echo "========================================="
echo "MDE macOS Offboarding"
echo "========================================="

# Check sudo
if [ "$EUID" -ne 0 ]; then
    echo "ERROR: Please run with sudo"
    exit 1
fi

# Confirm offboarding
echo ""
echo "WARNING: This will remove the device from MDE protection."
read -p "Type 'OFFBOARD' to confirm: " CONFIRM
if [ "$CONFIRM" != "OFFBOARD" ]; then
    echo "Offboarding cancelled."
    exit 0
fi

# Record current status
echo ""
echo "Recording current MDE status..."
LOGFILE="/var/log/mde_offboard_$(hostname)_$(date +%Y%m%d_%H%M%S).log"
/usr/local/bin/mdatp health > "$LOGFILE" 2>&1 || true

echo "[1/3] Running offboarding..."
# Apply offboarding configuration
if [ -f "./WindowsDefenderATPOffboarding.plist" ]; then
    cp "./WindowsDefenderATPOffboarding.plist" "/Library/Application Support/Microsoft/Defender/"
fi

echo "[2/3] Stopping MDE..."
# Unload launch daemon
launchctl unload /Library/LaunchDaemons/com.microsoft.wdav.plist 2>/dev/null || true

echo "[3/3] Uninstalling MDE..."
# Remove application
rm -rf "/Applications/Microsoft Defender.app"

# Remove supporting files
rm -rf "/Library/Application Support/Microsoft/Defender"
rm -rf "/Library/LaunchDaemons/com.microsoft.wdav.plist"
rm -rf "/Library/LaunchAgents/com.microsoft.wdav.tray.plist"

# Remove kernel extensions (older versions)
kextunload -b com.microsoft.wdav.epsext 2>/dev/null || true
rm -rf /Library/Extensions/wdavkext.kext 2>/dev/null || true

echo ""
echo "========================================="
echo "Offboarding complete!"
echo "Log saved to: $LOGFILE"
echo "========================================="</code></pre>
        </div>

        <!-- ==================== SECTION 6: INTUNE ==================== -->
        <h2>6. Intune-Managed Device Offboarding</h2>

        <h3>6.1 Remove from Intune MDE Configuration</h3>

        <ol style="margin: 1rem 0; padding-left: 1.5rem;">
          <li>Go to <strong>Intune Admin Center</strong> (intune.microsoft.com)</li>
          <li>Navigate to <strong>Devices → Configuration profiles</strong></li>
          <li>Find the MDE onboarding profile</li>
          <li>Edit <strong>Assignments</strong></li>
          <li>Add device/user to <strong>Excluded groups</strong></li>
          <li>Wait for policy sync (or force sync from device)</li>
        </ol>

        <h3>6.2 Deploy Offboarding Profile</h3>

        <ol style="margin: 1rem 0; padding-left: 1.5rem;">
          <li>Download offboarding package from M365 Defender portal</li>
          <li>Create new Configuration Profile in Intune</li>
          <li>Select <strong>Windows 10+ → Templates → Custom</strong></li>
          <li>Add OMA-URI setting for offboarding</li>
          <li>Assign to target devices</li>
        </ol>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Intune Custom OMA-URI for Offboarding</span></div>
          <pre><code>Name: MDE Offboarding
Description: Offboard device from Microsoft Defender for Endpoint
OMA-URI: ./Device/Vendor/MSFT/WindowsAdvancedThreatProtection/Offboarding
Data type: String
Value: [Paste offboarding blob from downloaded package]</code></pre>
        </div>

        <!-- ==================== SECTION 7: PORTAL CLEANUP ==================== -->
        <h2>7. Portal Cleanup (Optional)</h2>

        <div class="callout info">
          <div class="callout-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
            Automatic Cleanup
          </div>
          <div class="callout-content">
            <p>Offboarded devices are automatically removed from the portal after <strong>180 days</strong> of inactivity. Manual cleanup is optional but recommended for decommissioned devices.</p>
          </div>
        </div>

        <h3>7.1 Manual Device Removal via API</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">PowerShell - Remove Device via Graph API</span></div>
          <pre><code># Remove offboarded device from M365 Defender portal
# Requires: Microsoft.Graph.Security module

param(
    [Parameter(Mandatory=$true)]
    [string]$DeviceName
)

# Connect to Graph API
Connect-MgGraph -Scopes "Machine.ReadWrite.All"

# Find device
$device = Get-MgSecurityTiIndicator | Where-Object { $_.hostName -eq $DeviceName }

if ($device) {
    # Note: Direct device deletion may require WindowsDefenderATP API
    # This is for illustration - actual implementation may vary
    Write-Host "Device found: $($device.id)"
    Write-Host "Use M365 Defender portal for manual deletion if needed"
} else {
    Write-Host "Device not found: $DeviceName"
}</code></pre>
        </div>

        <h3>7.2 Manual Portal Deletion</h3>

        <ol style="margin: 1rem 0; padding-left: 1.5rem;">
          <li>Go to <strong>M365 Defender Portal</strong> → Assets → Devices</li>
          <li>Search for the offboarded device</li>
          <li>Click on the device name</li>
          <li>Click the <strong>...</strong> menu → <strong>Delete device</strong></li>
          <li>Confirm deletion</li>
        </ol>

        <!-- ==================== SECTION 8: CHECKLIST ==================== -->
        <h2>8. Offboarding Checklist</h2>

        <h3>Pre-Offboarding</h3>
        <ul style="margin: 1rem 0; padding-left: 1.5rem;">
          <li>☐ Change request approved (if production device)</li>
          <li>☐ Offboarding package downloaded and not expired</li>
          <li>☐ Device accessible (network, credentials)</li>
          <li>☐ Backup any needed forensic data from device</li>
          <li>☐ Document device details (hostname, serial, user)</li>
        </ul>

        <h3>During Offboarding</h3>
        <ul style="margin: 1rem 0; padding-left: 1.5rem;">
          <li>☐ Run offboarding script as administrator/root</li>
          <li>☐ Verify OnboardingState = 0 (Windows)</li>
          <li>☐ Confirm SENSE/mdatp service stopped</li>
          <li>☐ Save offboarding log for records</li>
        </ul>

        <h3>Post-Offboarding</h3>
        <ul style="margin: 1rem 0; padding-left: 1.5rem;">
          <li>☐ Verify device shows as "Inactive" in M365 Defender portal</li>
          <li>☐ Update CMDB/asset inventory</li>
          <li>☐ Remove from MDE device groups (if applicable)</li>
          <li>☐ Delete from portal (if device decommissioned)</li>
          <li>☐ Close change request</li>
        </ul>

        <nav class="page-nav">
          <a href="mde-onboarding.html" class="page-nav-link prev"><span class="page-nav-label">Previous</span><span class="page-nav-title">← MDE Onboarding</span></a>
          <a href="incident-response.html" class="page-nav-link next"><span class="page-nav-label">Next</span><span class="page-nav-title">Incident Response →</span></a>
        </nav>

      </div>
    </main>
  </div>
  <script src="../js/main.js"></script>
</body>
</html>
