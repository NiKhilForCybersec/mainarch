<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MDE Onboarding Runbook | Security Transformation</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
  <div class="layout">
        <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="sidebar-logo-icon">RF</div>
          <div class="sidebar-logo-text">
            <span class="sidebar-logo-title">Security Transformation</span>
            <span class="sidebar-logo-subtitle">RevFlow Analytics</span>
          </div>
        </div>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Overview</div>
          <a href="../index.html" class="nav-item">Executive Summary</a>
          <a href="../company-profile.html" class="nav-item">Company Profile</a>
          <a href="../security-framework.html" class="nav-item">Security Framework</a>
          <a href="../program-structure.html" class="nav-item">Program Structure</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">SIEM Migration</div>
          <a href="../siem/index.html" class="nav-item">SIEM Overview</a>
          <a href="../siem/discovery.html" class="nav-item">Discovery & Assessment</a>
          <a href="../siem/log-sources.html" class="nav-item">Log Source Strategy</a>
          <a href="../siem/log-engineering.html" class="nav-item">Log Engineering</a>
          <a href="../siem/detection-engineering.html" class="nav-item">Detection Engineering</a>
          <a href="../siem/detection-catalog.html" class="nav-item">Detection Catalog</a>
          <a href="../siem/soc-transition.html" class="nav-item">SOC Transition</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">EDR Migration</div>
          <a href="../edr/index.html" class="nav-item">EDR Overview</a>
          <a href="../edr/deployment.html" class="nav-item">MDE Deployment</a>
          <a href="../edr/asr-rules.html" class="nav-item">ASR Rules</a>
          <a href="../edr/coexistence.html" class="nav-item">Coexistence Strategy</a>
          <a href="../edr/eset-removal.html" class="nav-item">ESET Removal</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">DLP Migration</div>
          <a href="../dlp/index.html" class="nav-item">DLP Overview</a>
          <a href="../dlp/dlp-catalog.html" class="nav-item">DLP Catalog</a>
          <a href="../dlp/policy-translation.html" class="nav-item">Policy Translation</a>
          <a href="../dlp/rollout-phases.html" class="nav-item">Rollout Phases</a>
          <a href="../dlp/user-communication.html" class="nav-item">User Communication</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Identity & Access</div>
          <a href="../identity/index.html" class="nav-item">Identity Overview</a>
          <a href="../identity/hybrid-setup.html" class="nav-item">Hybrid Identity</a>
          <a href="../identity/conditional-access.html" class="nav-item">Conditional Access</a>
          <a href="../identity/pim.html" class="nav-item">PIM Configuration</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Infrastructure</div>
          <a href="../infrastructure/index.html" class="nav-item">Infrastructure Overview</a>
          <a href="../infrastructure/landing-zone.html" class="nav-item">Landing Zone</a>
          <a href="../infrastructure/network-architecture.html" class="nav-item">Network Architecture</a>
          <a href="../infrastructure/workload-migration.html" class="nav-item">Workload Migration</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Operations</div>
          <a href="../operations/parallel-ops.html" class="nav-item">Parallel Operations</a>
          <a href="../operations/soc-workflows.html" class="nav-item">SOC Workflows</a>
          <a href="../operations/integration.html" class="nav-item">Platform Integration</a>
          <a href="../operations/xdr-integration.html" class="nav-item">XDR Integration</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Resources</div>
          <a href="timeline.html" class="nav-item">Project Timeline</a>
          <a href="raci.html" class="nav-item">RACI Matrix</a>
          <a href="infrastructure-reference.html" class="nav-item">Infrastructure Reference</a>
          <a href="scripts.html" class="nav-item">Scripts & Queries</a>
          <a href="data-dictionary.html" class="nav-item">Data Dictionary</a>
          <a href="templates.html" class="nav-item">Templates</a>
          <a href="splunk-reference.html" class="nav-item">Splunk Reference</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Runbooks</div>
          <a href="mde-onboarding.html" class="nav-item active">MDE Onboarding</a>
          <a href="mde-offboarding.html" class="nav-item">MDE Offboarding</a>
          <a href="incident-response.html" class="nav-item">Incident Response</a>
          <a href="operational-procedures.html" class="nav-item">Operational Procedures</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Troubleshooting</div>
          <a href="../troubleshooting/index.html" class="nav-item">Common Issues</a>
          <a href="../troubleshooting/siem-issues.html" class="nav-item">SIEM Issues</a>
          <a href="../troubleshooting/mde-issues.html" class="nav-item">MDE Issues</a>
          <a href="../troubleshooting/dlp-issues.html" class="nav-item">DLP Issues</a>
          <a href="../troubleshooting/agent-conflicts.html" class="nav-item">Agent Conflicts</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Career</div>
          <a href="../career-narrative.html" class="nav-item">Career Narrative</a>
          <a href="../interview-prep.html" class="nav-item">Interview Prep</a>
        </div>
      </nav>
    </aside>

    <main class="main-content">
      <div class="content-wrapper">
        <nav class="breadcrumb">
          <a href="../index.html" class="breadcrumb-link">Home</a>
          <span class="breadcrumb-separator">/</span>
          <span class="breadcrumb-current">MDE Onboarding Runbook</span>
        </nav>

        <div class="page-header">
          <h1>MDE Onboarding Runbook</h1>
          <div class="page-header-meta">
            <span class="page-badge edr">EDR Track</span>
            <span class="page-reading-time">Operational Runbook</span>
          </div>
          <p class="intro-text">Step-by-step procedures for onboarding RevFlow devices to Microsoft Defender for Endpoint across all locations and device types.</p>
        </div>

        <div class="callout info">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>Document Information</div>
          <div class="callout-content">
            <p><strong>Version:</strong> 3.2 | <strong>Last Updated:</strong> 2024-12-01 | <strong>Owner:</strong> RF-SEC-PLAT</p>
            <p><strong>ServiceNow Queue:</strong> SEC-REQ | <strong>SLA:</strong> 3 business days</p>
            <p><strong>Approved By:</strong> Director, Security Engineering</p>
          </div>
        </div>

        <div class="callout warning">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>ESET Coexistence</div>
          <div class="callout-content"><p>During migration, ESET remains installed. MDE runs in <strong>passive mode</strong> until ESET removal. See <a href="../edr/coexistence.html">Coexistence Strategy</a>.</p></div>
        </div>

        <h2>1. Onboarding Decision Tree</h2>
        <div class="code-block">
          <div class="code-header"><span class="code-lang">Decision Tree</span></div>
          <pre><code>REVFLOW MDE ONBOARDING DECISION TREE
═══════════════════════════════════════════════════════════════════════════════

CORPORATE LAPTOP/DESKTOP (RF-{LOC}-L-* / RF-{LOC}-D-*)
├── Intune-enrolled? → YES → Method A: Intune Deployment
└── Domain-joined?   → YES → Method B: GPO Deployment
                     → NO  → Method E: Local Script

MACOS (RF-{LOC}-MAC-*)
└── In Jamf? → YES → Method C: Jamf + Intune Hybrid
              → NO → Method E: Local Script (macOS)

DEVELOPER WORKSTATION (RF-{LOC}-DEV-*)
└── Use Method A (Intune) + Developer exclusion profile

WINDOWS SERVER (RF-{LOC}-SRV-*)
├── DC/CA/AAD (Tier 0) → Method D: Manual + CAB Approval
└── SQL/WEB/API        → Method B: GPO via RF-GPO-MDE-Onboarding

LINUX SERVER (rf-{loc}-*)
├── Ubuntu 20.04+  → Method F: Linux Script (apt)
├── RHEL 8+        → Method F: Linux Script (yum)
└── Other          → Escalate to RF-SEC-PLAT

VDI (RF-VDI-*)
├── Persistent (RF-VDI-P-*)     → Method A: Intune
└── Non-Persistent (RF-VDI-NP-*) → Method G: Golden Image

AZURE VM / AWS EC2 → Method H: Azure Arc + Defender for Cloud</code></pre>
        </div>

        <h2>2. Method A: Intune Deployment</h2>
        <p><strong>Use for:</strong> Corporate laptops, desktops, persistent VDI | <strong>Group:</strong> <code>RF-MDE-Production</code></p>

        <h3>2.1 Prerequisites</h3>
        <div class="table-wrapper">
          <table>
            <thead><tr><th>Requirement</th><th>Verification</th><th>Owner</th></tr></thead>
            <tbody>
              <tr><td>Device Entra ID Joined/Hybrid</td><td><code>dsregcmd /status</code></td><td>RF-IT-DESK</td></tr>
              <tr><td>Device Intune-enrolled</td><td>Intune Admin Center → Devices</td><td>RF-IT-DESK</td></tr>
              <tr><td>User has M365 E5 license</td><td>Entra Admin → Users → Licenses</td><td>RF-IT-DESK</td></tr>
              <tr><td>ESET installed and healthy</td><td>ESET Management Console</td><td>RF-SEC-PLAT</td></tr>
              <tr><td>Hostname follows convention</td><td><code>RF-{LOC}-{TYPE}-{ASSET#}</code></td><td>RF-IT-DESK</td></tr>
            </tbody>
          </table>
        </div>

        <h3>2.2 Intune Profile Configuration</h3>
        <div class="code-block">
          <div class="code-header"><span class="code-lang">Intune Profile: RF-MDE-Onboarding-Windows</span></div>
          <pre><code>Profile Type: Microsoft Defender for Endpoint (Windows 10+)
Assignment:   Include: RF-MDE-Production | Exclude: RF-MDE-Exclusions

SETTINGS:
├── Onboarding package: [From security.microsoft.com]
├── Sample sharing: Enabled
├── Telemetry reporting: Expedited
└── Tamper protection: Enabled</code></pre>
        </div>

        <h3>2.3 Step-by-Step Procedure</h3>
        <div class="table-wrapper">
          <table>
            <thead><tr><th>Step</th><th>Action</th><th>Details</th></tr></thead>
            <tbody>
              <tr><td>1</td><td>Receive SEC-REQ ticket</td><td>Verify: hostname, asset tag, user, department</td></tr>
              <tr><td>2</td><td>Verify prerequisites</td><td>Run checklist; route to RF-IT-DESK if not enrolled</td></tr>
              <tr><td>3</td><td>Add to RF-MDE-Production</td><td>Entra Admin → Groups → Add device</td></tr>
              <tr><td>4</td><td>Trigger Intune sync</td><td>Intune → Device → Sync (or wait 8 hours)</td></tr>
              <tr><td>5</td><td>Verify onboarding (30-60 min)</td><td>security.microsoft.com → Device inventory</td></tr>
              <tr><td>6</td><td>Validate sensor health</td><td>Run RF-MDE-Validate.ps1 on device</td></tr>
              <tr><td>7</td><td>Apply device tags</td><td>Location, Department, Criticality, Migration status</td></tr>
              <tr><td>8</td><td>Close ticket</td><td>Document Device ID, timestamp, validation results</td></tr>
            </tbody>
          </table>
        </div>

        <h2>3. Method B: GPO Deployment</h2>
        <p><strong>Use for:</strong> Domain-joined endpoints not in Intune, Windows Servers | <strong>Group:</strong> <code>RF-GPO-MDE-Onboarding</code></p>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">GPO: RF-SEC-MDE-Onboarding</span></div>
          <pre><code>LINKED TO:
├── OU=Workstations,OU=RevFlow,DC=revflow,DC=local
└── OU=Servers,OU=RevFlow,DC=revflow,DC=local

SECURITY FILTERING: RF-GPO-MDE-Onboarding

STARTUP SCRIPT:
\\revflow.local\SYSVOL\revflow.local\scripts\MDE\MDE-Onboard-GPO.ps1

REQUIRED FILES IN SYSVOL:
├── MDE-Onboard-GPO.ps1 (wrapper)
├── WindowsDefenderATPOnboardingScript.cmd (from Microsoft)
└── MDE-Onboard-Config.json (RevFlow settings)</code></pre>
        </div>

        <h2>4. Method D: Critical Server Onboarding (DC, CA, AAD)</h2>
        <div class="callout critical">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>Tier 0 Assets</div>
          <div class="callout-content">
            <p>Requires Security CAB + Infrastructure CAB approval, maintenance window, rollback plan, L3 SOC standby.</p>
          </div>
        </div>

        <h3>Critical Server Checklist</h3>
        <div class="table-wrapper">
          <table>
            <thead><tr><th>Step</th><th>Action</th><th>Owner</th><th>✓</th></tr></thead>
            <tbody>
              <tr><td>1</td><td>Submit SEC-CHG with impact analysis</td><td>RF-SEC-PLAT</td><td>☐</td></tr>
              <tr><td>2</td><td>Security CAB approval</td><td>CISO</td><td>☐</td></tr>
              <tr><td>3</td><td>Infrastructure CAB approval</td><td>VP Infra</td><td>☐</td></tr>
              <tr><td>4</td><td>Maintenance window confirmed</td><td>RF-IT-CLOUD</td><td>☐</td></tr>
              <tr><td>5</td><td>Full system backup</td><td>RF-IT-CLOUD</td><td>☐</td></tr>
              <tr><td>6</td><td>Rollback script tested</td><td>RF-SEC-PLAT</td><td>☐</td></tr>
              <tr><td>7</td><td>L3 SOC notified</td><td>RF-SEC-SOC-L3</td><td>☐</td></tr>
              <tr><td>8</td><td>MDE exclusions pre-configured</td><td>RF-SEC-PLAT</td><td>☐</td></tr>
            </tbody>
          </table>
        </div>

        <h3>Domain Controller Exclusions</h3>
        <div class="code-block">
          <div class="code-header"><span class="code-lang">MDE Exclusions for DC</span></div>
          <pre><code>FOLDER EXCLUSIONS:
├── %systemroot%\NTDS
├── %systemroot%\SYSVOL
├── %systemroot%\System32\DNS
└── %systemroot%\System32\DHCP

PROCESS EXCLUSIONS:
├── lsass.exe, ntfrs.exe, dns.exe
├── dfsr.exe, dfsrs.exe, ntdsutil.exe
└── dsac.exe

FILE EXTENSIONS (NTDS folder):
├── *.dit, *.pat, *.edb
└── *.log, *.jrs</code></pre>
        </div>

        <h2>5. Method F: Linux Server Onboarding</h2>
        <div class="code-block">
          <div class="code-header"><span class="code-lang">Ubuntu/Debian</span><button class="code-copy-btn">Copy</button></div>
          <pre><code>#!/bin/bash
# rf-mde-linux-onboard.sh - RevFlow Linux Onboarding

# Add Microsoft repository
curl -sSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > /usr/share/keyrings/microsoft-prod.gpg
echo "deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft-prod.gpg] https://packages.microsoft.com/ubuntu/$(lsb_release -rs)/prod $(lsb_release -cs) main" > /etc/apt/sources.list.d/microsoft-prod.list

# Install MDE
apt-get update && apt-get install -y mdatp

# Onboard (download script from secure blob)
python3 /tmp/MicrosoftDefenderATPOnboardingLinuxServer.py

# Enable real-time protection
mdatp config real-time-protection --value enabled

# Verify
mdatp health</code></pre>
        </div>

        <h2>6. Validation Script</h2>
        <div class="code-block">
          <div class="code-header"><span class="code-lang">PowerShell - RF-MDE-Validate.ps1</span><button class="code-copy-btn">Copy</button></div>
          <pre><code># RF-MDE-Validate.ps1 - Run as Administrator
Write-Host "REVFLOW MDE HEALTH VALIDATION" -ForegroundColor Cyan

# Check Sense Service
$Sense = Get-Service -Name "Sense" -ErrorAction SilentlyContinue
Write-Host "Sense Service: $($Sense.Status)"

# Check Onboarding State
$RegPath = "HKLM:\SOFTWARE\Microsoft\Windows Advanced Threat Protection\Status"
$State = (Get-ItemProperty -Path $RegPath -EA SilentlyContinue).OnboardingState
Write-Host "Onboarding State: $State (1=Onboarded)"

# Check AV Mode
$AVMode = (Get-MpComputerStatus).AMRunningMode
Write-Host "AV Mode: $AVMode (Passive if ESET active)"

# Check Definitions
$DefAge = (Get-MpComputerStatus).AntivirusSignatureAge
Write-Host "Definition Age: $DefAge days"

# Check Tamper Protection
$Tamper = (Get-MpComputerStatus).IsTamperProtected
Write-Host "Tamper Protection: $Tamper"</code></pre>
        </div>

        <h2>7. Troubleshooting</h2>
        <div class="table-wrapper">
          <table>
            <thead><tr><th>Issue</th><th>Resolution</th></tr></thead>
            <tbody>
              <tr><td>Device not in portal after 60 min</td><td>Check Sense service, verify connectivity to *.securitycenter.windows.com, re-run onboarding</td></tr>
              <tr><td>Sense service not starting</td><td>Check Event Log (SENSE/Operational), verify no conflicting AV, check disk space</td></tr>
              <tr><td>Passive mode not working</td><td>Set ForcePassiveMode=1 via GPO/Intune, restart Sense service</td></tr>
              <tr><td>Wrong organization</td><td>Offboard, wait 24h, re-onboard with correct RevFlow package</td></tr>
              <tr><td>macOS FDA denied</td><td>Verify MDM profile, check System Preferences → Security</td></tr>
            </tbody>
          </table>
        </div>

        <h2>8. Escalation Path</h2>
        <div class="code-block">
          <div class="code-header"><span class="code-lang">Escalation Matrix</span></div>
          <pre><code>LEVEL 1: RF-SEC-PLAT
├── First responder | SLA: 4 hours
└── Slack: #sec-platform-support

LEVEL 2: RF-SEC-SOC-L3
├── Security incident suspected | SLA: 1 hour
└── PagerDuty: "RevFlow SOC L3"

LEVEL 3: Microsoft Support
├── Platform bugs, unexplained failures
└── Portal: admin.microsoft.com (Premier: RevFlow-MS-Premier-2024)

EMERGENCY (Tier 0):
├── RF-SEC-PLAT on-call
├── Teams: "Security Incident Bridge"
└── CISO notification required</code></pre>
        </div>

        <h2>9. RevFlow Device Tags</h2>
        <div class="table-wrapper">
          <table>
            <thead><tr><th>Category</th><th>Values</th><th>Purpose</th></tr></thead>
            <tbody>
              <tr><td>Location</td><td>TOR, VAN, SFO, NYC, BLR, HYD</td><td>Geographic compliance</td></tr>
              <tr><td>Department</td><td>Engineering, Sales, Finance, HR, IT, Security</td><td>Business ownership</td></tr>
              <tr><td>Criticality</td><td>Tier0, Tier1, Tier2, Standard</td><td>Incident priority</td></tr>
              <tr><td>Environment</td><td>Production, Development, Test</td><td>Environment class</td></tr>
              <tr><td>Migration</td><td>ESET-Coexist, ESET-Removed, MDE-Primary</td><td>Migration tracking</td></tr>
            </tbody>
          </table>
        </div>

        <div class="callout success">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Related Runbooks</div>
          <div class="callout-content">
          </div>
        </div>

      </div>
    </main>
  </div>
  <script src="../js/main.js"></script>
</body>
</html>
