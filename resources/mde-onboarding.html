<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MDE Onboarding Runbook | Security Transformation</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
  <div class="layout">
        <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="sidebar-logo-icon">RF</div>
          <div class="sidebar-logo-text">
            <span class="sidebar-logo-title">Security Transformation</span>
            <span class="sidebar-logo-subtitle">RevFlow Analytics</span>
          </div>
        </div>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Overview</div>
          <a href="../index.html" class="nav-item">Executive Summary</a>
          <a href="../company-profile.html" class="nav-item">Company Profile</a>
          <a href="../security-framework.html" class="nav-item">Security Framework</a>
          <a href="../program-structure.html" class="nav-item">Program Structure</a>
          <a href="../controls-mapping.html" class="nav-item">Controls Mapping</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">SIEM Migration</div>
          <a href="../siem/index.html" class="nav-item">SIEM Overview</a>
          <a href="../siem/discovery.html" class="nav-item">Discovery & Assessment</a>
          <a href="../siem/log-sources.html" class="nav-item">Log Source Strategy</a>
          <a href="../siem/log-engineering.html" class="nav-item">Log Engineering</a>
          <a href="../siem/parsing-deep-dive.html" class="nav-item">Parsing Deep Dive</a>
          <a href="../siem/threat-intelligence.html" class="nav-item">Threat Intelligence</a>
          <a href="../siem/detection-engineering.html" class="nav-item">Detection Engineering</a>
          <a href="../siem/detection-anatomy.html" class="nav-item">Detection Anatomy</a>
          <a href="../siem/detection-catalog.html" class="nav-item">Detection Catalog</a>
          <a href="../siem/soar-automation.html" class="nav-item">SOAR &amp; Automation</a>
          <a href="../siem/workbooks.html" class="nav-item">Workbooks &amp; Dashboards</a>
          <a href="../siem/cost-optimization.html" class="nav-item">Cost Optimization</a>
          <a href="../siem/soc-transition.html" class="nav-item">SOC Transition</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">EDR Migration</div>
          <a href="../edr/index.html" class="nav-item">EDR Overview</a>
          <a href="../edr/xdr-detection-model.html" class="nav-item">XDR Detection Model</a>
          <a href="../edr/advanced-hunting.html" class="nav-item">Advanced Hunting</a>
          <a href="../edr/live-response.html" class="nav-item">Live Response</a>
          <a href="../edr/tvm.html" class="nav-item">Vulnerability Management</a>
          <a href="../edr/deployment.html" class="nav-item">MDE Deployment</a>
          <a href="../edr/asr-rules.html" class="nav-item">ASR Rules</a>
          <a href="../edr/device-control.html" class="nav-item">Device Control</a>
          <a href="../edr/coexistence.html" class="nav-item">Coexistence Strategy</a>
          <a href="../edr/eset-removal.html" class="nav-item">ESET Removal</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">DLP Migration</div>
          <a href="../dlp/index.html" class="nav-item">DLP Overview</a>
          <a href="../dlp/dlp-catalog.html" class="nav-item">DLP Catalog</a>
          <a href="../dlp/policy-translation.html" class="nav-item">Policy Translation</a>
          <a href="../dlp/rollout-phases.html" class="nav-item">Rollout Phases</a>
          <a href="../dlp/user-communication.html" class="nav-item">User Communication</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Identity & Access</div>
          <a href="../identity/index.html" class="nav-item">Identity Overview</a>
          <a href="../identity/hybrid-setup.html" class="nav-item">Hybrid Identity</a>
          <a href="../identity/conditional-access.html" class="nav-item">Conditional Access</a>
          <a href="../identity/pim.html" class="nav-item">PIM Configuration</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Infrastructure</div>
          <a href="../infrastructure/index.html" class="nav-item">Infrastructure Overview</a>
          <a href="../infrastructure/landing-zone.html" class="nav-item">Landing Zone</a>
          <a href="../infrastructure/network-architecture.html" class="nav-item">Network Architecture</a>
          <a href="../infrastructure/workload-migration.html" class="nav-item">Workload Migration</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Operations</div>
          <a href="../operations/parallel-ops.html" class="nav-item">Parallel Operations</a>
          <a href="../operations/soc-workflows.html" class="nav-item">SOC Workflows</a>
          <a href="../operations/integration.html" class="nav-item">Platform Integration</a>
          <a href="../operations/xdr-integration.html" class="nav-item">XDR Integration</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Resources</div>
          <a href="../resources/timeline.html" class="nav-item">Project Timeline</a>
          <a href="../resources/raci.html" class="nav-item">RACI Matrix</a>
          <a href="../resources/infrastructure-reference.html" class="nav-item">Infrastructure Reference</a>
          <a href="../resources/scripts.html" class="nav-item">Scripts & Queries</a>
          <a href="../resources/data-dictionary.html" class="nav-item">Data Dictionary</a>
          <a href="../resources/templates.html" class="nav-item">Templates</a>
          <a href="../resources/splunk-reference.html" class="nav-item">Splunk Reference</a>
          <a href="../resources/alternative-architectures.html" class="nav-item">Alternative Architectures</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Runbooks</div>
          <a href="../resources/mde-onboarding.html" class="nav-item active">MDE Onboarding</a>
          <a href="../resources/mde-offboarding.html" class="nav-item">MDE Offboarding</a>
          <a href="../resources/incident-response.html" class="nav-item">Incident Response</a>
          <a href="../resources/operational-procedures.html" class="nav-item">Operational Procedures</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Troubleshooting</div>
          <a href="../troubleshooting/index.html" class="nav-item">Common Issues</a>
          <a href="../troubleshooting/siem-issues.html" class="nav-item">SIEM Issues</a>
          <a href="../troubleshooting/mde-issues.html" class="nav-item">MDE Issues</a>
          <a href="../troubleshooting/dlp-issues.html" class="nav-item">DLP Issues</a>
          <a href="../troubleshooting/agent-conflicts.html" class="nav-item">Agent Conflicts</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Career</div>
          <a href="../career-narrative.html" class="nav-item">Career Narrative</a>
          <a href="../interview-prep.html" class="nav-item">Interview Prep</a>
        </div>
      </nav>
    </aside>

    <main class="main-content">
      <div class="content-wrapper">
        <nav class="breadcrumb">
          <a href="../index.html" class="breadcrumb-link">Home</a>
          <span class="breadcrumb-separator">/</span>
          <a href="mde-onboarding.html" class="breadcrumb-link">Runbooks</a>
          <span class="breadcrumb-separator">/</span>
          <span class="breadcrumb-current">MDE Onboarding</span>
        </nav>

        <div class="page-header">
          <h1>MDE Onboarding Runbook</h1>
          <div class="page-header-meta">
            <span class="page-badge edr">EDR Track</span>
            <span class="page-badge">Version 3.0</span>
          </div>
          <p class="intro-text">Complete procedures for onboarding devices to Microsoft Defender for Endpoint at RevFlow Analytics. Covers all device types: Windows endpoints, macOS, Linux servers, VDI, and cloud VMs.</p>
        </div>

        <div class="callout info">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>Quick Reference</div>
          <div class="callout-content">
            <p><strong>Onboarding Portal:</strong> <a href="https://security.microsoft.com">security.microsoft.com</a> → Settings → Endpoints → Onboarding</p>
            <p><strong>ServiceNow Queue:</strong> SEC-REQ (MDE Onboarding) | SLA: 3 business days</p>
            <p><strong>Owner:</strong> RF-SEC-PLAT | Slack: #sec-platform-support</p>
          </div>
        </div>

        <!-- ==================== SECTION 1: DECISION TREE ==================== -->
        <h2>1. Onboarding Decision Tree</h2>

        <div class="callout critical">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>Golden Image Policy</div>
          <div class="callout-content">
            <p><strong>DO NOT include MDE onboarding in golden images.</strong> Pre-onboarded images cause duplicate Device IDs in the console when cloned. Always deploy MDE post-provisioning using the methods below.</p>
          </div>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Decision Tree - Which Method to Use</span></div>
          <pre><code>REVFLOW MDE ONBOARDING DECISION TREE
═══════════════════════════════════════════════════════════════════════════════

START: What type of device?
│
├─► WINDOWS LAPTOP/DESKTOP (RF-{LOC}-L-* / RF-{LOC}-D-*)
│   │
│   ├─► Intune-enrolled?
│   │   ├─► YES → <strong>Method A: Intune Deployment</strong>
│   │   └─► NO → Is it domain-joined?
│   │           ├─► YES → <strong>Method B: GPO Deployment</strong>
│   │           └─► NO → <strong>Method E: Local Script</strong>
│   │
│   └─► Developer workstation (RF-{LOC}-DEV-*)?
│       └─► Use Method A + Developer exclusion profile
│
├─► MACOS (RF-{LOC}-MAC-*)
│   │
│   ├─► Managed by Jamf?
│   │   └─► YES → <strong>Method C: Jamf Deployment</strong>
│   │
│   └─► Intune-only (no Jamf)?
│       └─► <strong>Method C: Intune for macOS</strong>
│
├─► WINDOWS SERVER (RF-{LOC}-SRV-*)
│   │
│   ├─► Tier 0 (DC, CA, AAD Connect)?
│   │   └─► <strong>Method D: Critical Server (CAB Approval Required)</strong>
│   │
│   └─► Standard server (SQL, Web, App)?
│       └─► <strong>Method B: GPO Deployment</strong>
│
├─► LINUX SERVER (rf-{loc}-*)
│   │
│   ├─► Ubuntu 20.04+ / Debian 10+?
│   │   └─► <strong>Method F: Linux Script (apt)</strong>
│   │
│   └─► RHEL 8+ / CentOS 8+?
│       └─► <strong>Method F: Linux Script (yum)</strong>
│
├─► VDI (RF-VDI-*)
│   │
│   ├─► Persistent VDI (RF-VDI-P-*)?
│   │   └─► <strong>Method A: Intune (post-provisioning)</strong>
│   │
│   └─► Non-Persistent VDI (RF-VDI-NP-*)?
│       └─► <strong>Method G: VDI Session Script</strong>
│
├─► NEWLY IMAGED DEVICE (SCCM/MDT/Autopilot)
│   └─► DO NOT include MDE in image → Deploy post-imaging via Method A or B
│
└─► CLOUD VM (Azure/AWS)
    └─► <strong>Method H: Cloud-Native Deployment</strong></code></pre>
        </div>

        <h3>1.1 Method Summary Table</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Method</th><th>Device Type</th><th>Delivery</th><th>Automation</th><th>Approval</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>A</strong></td>
                <td>Windows laptops/desktops (Intune)</td>
                <td>Intune MDM policy</td>
                <td>Automatic via group</td>
                <td>Standard</td>
              </tr>
              <tr>
                <td><strong>B</strong></td>
                <td>Domain-joined Windows (no Intune)</td>
                <td>Group Policy</td>
                <td>Automatic via GPO</td>
                <td>Standard</td>
              </tr>
              <tr>
                <td><strong>C</strong></td>
                <td>macOS devices</td>
                <td>Jamf or Intune</td>
                <td>Automatic via policy</td>
                <td>Standard</td>
              </tr>
              <tr>
                <td><strong>D</strong></td>
                <td>Tier 0 servers (DC, CA, AAD)</td>
                <td>Manual with exclusions</td>
                <td>Manual</td>
                <td>CAB Required</td>
              </tr>
              <tr>
                <td><strong>E</strong></td>
                <td>Standalone/workgroup Windows</td>
                <td>Local script</td>
                <td>Manual</td>
                <td>Standard</td>
              </tr>
              <tr>
                <td><strong>F</strong></td>
                <td>Linux servers</td>
                <td>Shell script</td>
                <td>Semi-automatic</td>
                <td>Standard</td>
              </tr>
              <tr>
                <td><strong>G</strong></td>
                <td>Non-persistent VDI</td>
                <td>Session startup script</td>
                <td>Automatic per session</td>
                <td>Standard</td>
              </tr>
              <tr>
                <td><strong>H</strong></td>
                <td>Azure VMs, AWS EC2</td>
                <td>Cloud extensions</td>
                <td>Automatic via policy</td>
                <td>Standard</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- ==================== SECTION 2: METHOD A - INTUNE ==================== -->
        <h2>2. Method A: Intune Deployment (Windows)</h2>

        <p><strong>Use for:</strong> Corporate laptops, desktops, and persistent VDI that are Entra ID joined and Intune-enrolled.</p>
        <p><strong>Target Group:</strong> <code>RF-MDE-Production</code> (Entra ID security group)</p>

        <h3>2.1 Prerequisites Checklist</h3>

        <div class="table-wrapper">
          <table>
            <thead><tr><th>✓</th><th>Requirement</th><th>How to Verify</th><th>Fix If Not Met</th></tr></thead>
            <tbody>
              <tr>
                <td>☐</td>
                <td>Device is Entra ID Joined or Hybrid Joined</td>
                <td>Run <code>dsregcmd /status</code> on device</td>
                <td>Route to RF-IT-DESK for Entra join</td>
              </tr>
              <tr>
                <td>☐</td>
                <td>Device is Intune-enrolled</td>
                <td>Intune Admin Center → Devices → search hostname</td>
                <td>Trigger auto-enrollment or manual enroll</td>
              </tr>
              <tr>
                <td>☐</td>
                <td>User has M365 E5 or MDE P2 license</td>
                <td>Entra Admin → Users → select user → Licenses</td>
                <td>Request license from RF-IT-OPS</td>
              </tr>
              <tr>
                <td>☐</td>
                <td>ESET agent installed (coexistence)</td>
                <td>Check ESET Management Console</td>
                <td>MDE will run in passive mode until ESET removed</td>
              </tr>
              <tr>
                <td>☐</td>
                <td>Hostname follows naming convention</td>
                <td><code>hostname</code> matches RF-{LOC}-{TYPE}-{ASSET#}</td>
                <td>Rename device before onboarding</td>
              </tr>
            </tbody>
          </table>
        </div>

        <h3>2.2 Intune Configuration Profile</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Intune Profile Settings</span></div>
          <pre><code>INTUNE PROFILE: RF-MDE-Onboarding-Windows
═══════════════════════════════════════════════════════════════════════════════

LOCATION: Intune Admin Center → Endpoint Security → Endpoint Detection and Response

PROFILE SETTINGS:
├── Platform: Windows 10 and later
├── Profile type: Endpoint detection and response
├── Name: RF-MDE-Onboarding-Windows
│
├── CONFIGURATION:
│   ├── Microsoft Defender for Endpoint client configuration package type: Auto from connector
│   │   └── (This automatically pulls onboarding blob from MDE connector)
│   │
│   ├── Sample sharing for all files: Enabled
│   │   └── Allows MDE to upload suspicious files for analysis
│   │
│   ├── Expedite telemetry reporting frequency: Enabled
│   │   └── Faster detection, slightly higher bandwidth
│   │
│   └── [OPTIONAL] Onboarding blob (if not using connector):
│       └── Paste contents from security.microsoft.com onboarding package
│
├── ASSIGNMENTS:
│   ├── Include groups: RF-MDE-Production
│   ├── Exclude groups: RF-MDE-Exclusions
│   └── Filter: None (or use device filters if needed)
│
└── SCOPE TAGS: Default, Security</code></pre>
        </div>

        <h3>2.3 Step-by-Step Procedure</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Method A: Detailed Steps</span></div>
          <pre><code>METHOD A: INTUNE ONBOARDING - STEP BY STEP
═══════════════════════════════════════════════════════════════════════════════

STEP 1: RECEIVE AND VALIDATE REQUEST
────────────────────────────────────────────────────────────────────────────────
• Receive SEC-REQ ticket in ServiceNow
• Verify ticket contains: Hostname, Asset tag, User UPN, Department, Business justification
• Confirm device is in scope (corporate-owned, not BYOD)

STEP 2: VERIFY PREREQUISITES
────────────────────────────────────────────────────────────────────────────────
• Open Intune Admin Center (intune.microsoft.com)
• Navigate to Devices → All devices → Search for hostname
• Verify:
  □ Device appears in Intune
  □ Compliance state: Compliant (or identify issues)
  □ OS version: Windows 10 1809+ or Windows 11
  □ Primary user: Matches requestor

If device NOT in Intune:
  → Check Entra ID: entra.microsoft.com → Devices → Search hostname
  → If in Entra but not Intune: trigger Intune enrollment via Company Portal
  → If not in Entra: Route to RF-IT-DESK for device enrollment

STEP 3: ADD DEVICE TO MDE PRODUCTION GROUP
────────────────────────────────────────────────────────────────────────────────
• Open Entra Admin Center (entra.microsoft.com)
• Navigate to Groups → All groups → Search "RF-MDE-Production"
• Click group → Members → Add members
• Select DEVICE (not user) by searching for hostname
• Click Select → Add

ALTERNATIVE (PowerShell):
  $DeviceId = (Get-MgDevice -Filter "displayName eq 'RF-TOR-L-12345'").Id
  $GroupId = (Get-MgGroup -Filter "displayName eq 'RF-MDE-Production'").Id
  New-MgGroupMember -GroupId $GroupId -DirectoryObjectId $DeviceId

STEP 4: TRIGGER INTUNE SYNC
────────────────────────────────────────────────────────────────────────────────
• In Intune Admin Center → Devices → Find device
• Click device → Overview → Click "Sync" button
• This forces device to check in and receive the MDE policy

ALTERNATIVE (on device):
  → Open Settings → Accounts → Access work or school
  → Click connected account → Info → Sync

Without manual sync: Device will sync within 8 hours automatically

STEP 5: WAIT FOR ONBOARDING (30-60 MINUTES)
────────────────────────────────────────────────────────────────────────────────
• MDE agent installation and onboarding takes 30-60 minutes
• Factors: Network speed, Intune sync timing, device load

STEP 6: VERIFY IN MDE PORTAL
────────────────────────────────────────────────────────────────────────────────
• Open Microsoft 365 Defender (security.microsoft.com)
• Navigate to Assets → Devices → Search hostname
• Verify:
  □ Device appears in inventory
  □ Onboarding status: Onboarded
  □ Sensor health: Active (or check if issues)
  □ Exposure level: Note current risk level

STEP 7: RUN VALIDATION SCRIPT ON DEVICE
────────────────────────────────────────────────────────────────────────────────
• Remote into device or have user run:
  \\revflow.local\SYSVOL\revflow.local\scripts\MDE\RF-MDE-Validate.ps1

• Expected output:
  Sense Service: Running
  Onboarding State: 1
  Org ID: a3f8b2c1-xxxx-xxxx-xxxx-xxxxxxxxxxxx (RevFlow tenant)
  AV Mode: Passive (if ESET present) or Active
  Tamper Protection: True

STEP 8: APPLY DEVICE TAGS
────────────────────────────────────────────────────────────────────────────────
• In MDE portal → Device page → Manage tags
• Add tags:
  □ Location: TOR / VAN / SFO / NYC / BLR / HYD
  □ Department: SALES / ENG / FIN / HR / IT / EXEC
  □ Criticality: Standard (or Tier1/Tier2 if applicable)
  □ Migration: ESET-Coexist (or MDE-Primary if ESET removed)

STEP 9: UPDATE TICKET AND CLOSE
────────────────────────────────────────────────────────────────────────────────
• Update SEC-REQ ticket with:
  □ Device ID from MDE portal
  □ Onboarding timestamp
  □ Validation script output
  □ Any issues encountered
• Change ticket status to Resolved</code></pre>
        </div>

        <!-- ==================== SECTION 3: METHOD B - GPO ==================== -->
        <h2>3. Method B: GPO Deployment (Domain-Joined Windows)</h2>

        <p><strong>Use for:</strong> Domain-joined Windows devices not enrolled in Intune, including servers.</p>
        <p><strong>Target Group:</strong> <code>RF-GPO-MDE-Onboarding</code> (AD security group)</p>

        <h3>3.1 GPO Configuration</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">GPO Settings</span></div>
          <pre><code>GROUP POLICY OBJECT: RF-SEC-MDE-Onboarding
═══════════════════════════════════════════════════════════════════════════════

LOCATION: Group Policy Management → revflow.local → Security Policies

LINKS:
├── OU=Workstations,OU=Toronto,OU=RevFlow,DC=revflow,DC=local
├── OU=Workstations,OU=Vancouver,OU=RevFlow,DC=revflow,DC=local
├── OU=Servers,OU=Toronto,OU=RevFlow,DC=revflow,DC=local
└── [Add other OUs as needed]

SECURITY FILTERING:
├── Remove: Authenticated Users
└── Add: RF-GPO-MDE-Onboarding (security group)

DELEGATION:
└── Read: Authenticated Users (required for GPO to process)

COMPUTER CONFIGURATION:
├── Policies
│   └── Windows Settings
│       └── Scripts (Startup/Shutdown)
│           └── Startup
│               └── Script: \\revflow.local\SYSVOL\revflow.local\scripts\MDE\MDE-Onboard-GPO.ps1
│
└── Preferences
    └── Windows Settings
        └── Registry
            └── [Optional] ForcePassiveMode = 1 (if ESET coexistence needed)</code></pre>
        </div>

        <h3>3.2 Onboarding Script</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">PowerShell - MDE-Onboard-GPO.ps1</span><button class="code-copy-btn">Copy</button></div>
          <pre><code># MDE-Onboard-GPO.ps1 - RevFlow GPO-based MDE Onboarding
# Location: \\revflow.local\SYSVOL\revflow.local\scripts\MDE\
# Owner: RF-SEC-PLAT | Version: 2.0

$LogFile = "C:\Windows\Logs\MDE-GPO-Onboard.log"
$OnboardingScript = "\\revflow.local\SYSVOL\revflow.local\scripts\MDE\WindowsDefenderATPOnboardingScript.cmd"

function Write-Log {
    param([string]$Message)
    $Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    "$Timestamp - $Message" | Out-File -Append -FilePath $LogFile
    Write-Host $Message
}

Write-Log "========== MDE GPO Onboarding Started =========="
Write-Log "Hostname: $env:COMPUTERNAME"

# Check if already onboarded
$RegPath = "HKLM:\SOFTWARE\Microsoft\Windows Advanced Threat Protection\Status"
$OnboardingState = (Get-ItemProperty -Path $RegPath -ErrorAction SilentlyContinue).OnboardingState

if ($OnboardingState -eq 1) {
    Write-Log "Device already onboarded. Exiting."
    exit 0
}

# Verify script exists
if (-not (Test-Path $OnboardingScript)) {
    Write-Log "ERROR: Onboarding script not found at $OnboardingScript"
    exit 1
}

# Run Microsoft onboarding script
Write-Log "Running onboarding script..."
try {
    $process = Start-Process -FilePath "cmd.exe" -ArgumentList "/c `"$OnboardingScript`"" -Wait -NoNewWindow -PassThru
    Write-Log "Onboarding script exit code: $($process.ExitCode)"
} catch {
    Write-Log "ERROR: Failed to run onboarding script - $($_.Exception.Message)"
    exit 1
}

# Wait and verify
Start-Sleep -Seconds 60
$NewState = (Get-ItemProperty -Path $RegPath -ErrorAction SilentlyContinue).OnboardingState
if ($NewState -eq 1) {
    Write-Log "SUCCESS: Device onboarded to MDE"
} else {
    Write-Log "WARNING: Onboarding state not confirmed. Manual verification required."
}

# Check Sense service
$Sense = Get-Service -Name "Sense" -ErrorAction SilentlyContinue
Write-Log "Sense service status: $($Sense.Status)"

Write-Log "========== MDE GPO Onboarding Complete =========="</code></pre>
        </div>

        <h3>3.3 Step-by-Step Procedure</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Method B: Detailed Steps</span></div>
          <pre><code>METHOD B: GPO ONBOARDING - STEP BY STEP
═══════════════════════════════════════════════════════════════════════════════

STEP 1: VERIFY DEVICE IS DOMAIN-JOINED
────────────────────────────────────────────────────────────────────────────────
• Remote into device or use AD tools
• Run: systeminfo | findstr /B /C:"Domain"
• Expected: revflow.local

STEP 2: ADD COMPUTER TO AD SECURITY GROUP
────────────────────────────────────────────────────────────────────────────────
• Open Active Directory Users and Computers
• Navigate to: OU=Security Groups,OU=RevFlow,DC=revflow,DC=local
• Find group: RF-GPO-MDE-Onboarding
• Right-click → Properties → Members → Add
• Click "Object Types" → Check "Computers" → OK
• Enter hostname (e.g., RF-TOR-L-12345) → Check Names → OK → Apply

ALTERNATIVE (PowerShell on domain controller):
  Add-ADGroupMember -Identity "RF-GPO-MDE-Onboarding" -Members "RF-TOR-L-12345$"
  # Note: Computer accounts end with $ in AD

STEP 3: FORCE GROUP POLICY UPDATE
────────────────────────────────────────────────────────────────────────────────
• On the target device, run as Administrator:
  gpupdate /force

• Alternatively, reboot the device (startup script runs at boot)

STEP 4: VERIFY GPO APPLIED
────────────────────────────────────────────────────────────────────────────────
• Run: gpresult /r /scope computer
• Look for: "RF-SEC-MDE-Onboarding" in Applied GPOs
• If not listed:
  □ Check security filtering (device must be in RF-GPO-MDE-Onboarding)
  □ Check GPO link is enabled
  □ Check WMI filter (if any)

STEP 5: VERIFY ONBOARDING
────────────────────────────────────────────────────────────────────────────────
• Check log file: C:\Windows\Logs\MDE-GPO-Onboard.log
• Run validation: \\revflow.local\SYSVOL\revflow.local\scripts\MDE\RF-MDE-Validate.ps1
• Check MDE portal: security.microsoft.com → Devices

STEP 6: UPDATE TICKET
────────────────────────────────────────────────────────────────────────────────
• Document Device ID, timestamp, validation results
• Close SEC-REQ ticket</code></pre>
        </div>

        <!-- ==================== SECTION 4: METHOD C - MACOS ==================== -->
        <h2>4. Method C: macOS Deployment</h2>

        <p><strong>Use for:</strong> MacBooks and Mac desktops (RF-{LOC}-MAC-*).</p>
        <p><strong>Deployment Options:</strong> Jamf Pro (primary) or Intune-only (alternative)</p>

        <h3>4.1 Prerequisites</h3>

        <div class="table-wrapper">
          <table>
            <thead><tr><th>✓</th><th>Requirement</th><th>Notes</th></tr></thead>
            <tbody>
              <tr><td>☐</td><td>macOS 11 (Big Sur) or later</td><td>Earlier versions not supported by MDE</td></tr>
              <tr><td>☐</td><td>Device enrolled in Jamf or Intune</td><td>Check Jamf Pro or Intune portal</td></tr>
              <tr><td>☐</td><td>User has M365 E5 license</td><td>Required for MDE functionality</td></tr>
              <tr><td>☐</td><td>System Extensions approved</td><td>MDM profile must allow Microsoft extensions</td></tr>
              <tr><td>☐</td><td>Full Disk Access granted</td><td>Required for MDE scanning</td></tr>
              <tr><td>☐</td><td>Network Extensions approved</td><td>Required for network protection</td></tr>
            </tbody>
          </table>
        </div>

        <h3>4.2 Option A: Jamf Pro Deployment</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Jamf Configuration</span></div>
          <pre><code>JAMF PRO MDE DEPLOYMENT
═══════════════════════════════════════════════════════════════════════════════

STEP 1: CREATE CONFIGURATION PROFILES (Jamf Pro → Computers → Configuration Profiles)

PROFILE 1: RF-MDE-SystemExtensions
────────────────────────────────────────────────────────────────────────────────
├── General:
│   ├── Name: RF-MDE-SystemExtensions
│   ├── Category: Security
│   └── Distribution: Install Automatically
│
├── System Extensions:
│   ├── Allow users to approve system extensions: No
│   ├── Allowed Team Identifiers: UBF8T346G9 (Microsoft)
│   └── Allowed System Extensions:
│       ├── com.microsoft.wdav.epsext (Endpoint Security)
│       └── com.microsoft.wdav.netext (Network Extension)
│
└── Scope: Smart Group "RF-MDE-macOS-Devices"

PROFILE 2: RF-MDE-FullDiskAccess
────────────────────────────────────────────────────────────────────────────────
├── Privacy Preferences Policy Control (PPPC):
│   ├── App: /Applications/Microsoft Defender.app
│   ├── Identifier: com.microsoft.wdav
│   ├── Identifier Type: Bundle ID
│   ├── Code Requirement: (Microsoft code signature)
│   ├── Services:
│   │   ├── SystemPolicyAllFiles: Allow
│   │   └── SystemPolicySysAdminFiles: Allow
│   │
│   └── Also add for:
│       ├── com.microsoft.wdav.epsext
│       └── com.microsoft.wdav.netext
│
└── Scope: Smart Group "RF-MDE-macOS-Devices"

PROFILE 3: RF-MDE-NetworkFilter
────────────────────────────────────────────────────────────────────────────────
├── Content Filter:
│   ├── Filter Type: Plugin
│   ├── Filter Name: Microsoft Defender Network Extension
│   ├── Identifier: com.microsoft.wdav.netext
│   ├── Filter Sockets: True
│   └── Filter Network: True
│
└── Scope: Smart Group "RF-MDE-macOS-Devices"

PROFILE 4: RF-MDE-Notifications
────────────────────────────────────────────────────────────────────────────────
├── Notifications:
│   ├── Bundle Identifier: com.microsoft.wdav.tray
│   ├── Notifications Enabled: True
│   ├── Alert Type: Temporary Banner
│   └── Show in Notification Center: True
│
└── Scope: Smart Group "RF-MDE-macOS-Devices"

STEP 2: CREATE ONBOARDING CONFIGURATION PROFILE
────────────────────────────────────────────────────────────────────────────────
├── General:
│   └── Name: RF-MDE-Onboarding
│
├── Application & Custom Settings:
│   ├── Upload the .mobileconfig from Microsoft 365 Defender portal
│   │   └── Download from: security.microsoft.com → Settings → Endpoints →
│   │       Onboarding → macOS → Mobile Device Management
│   │
│   └── This contains the onboarding blob specific to RevFlow tenant
│
└── Scope: Smart Group "RF-MDE-macOS-Devices"

STEP 3: DEPLOY MDE APPLICATION (Jamf Pro → Computers → Policies)
────────────────────────────────────────────────────────────────────────────────
POLICY: RF-MDE-Install-macOS
├── General:
│   ├── Name: RF-MDE-Install-macOS
│   ├── Trigger: Enrollment Complete, Recurring Check-in
│   └── Execution Frequency: Once per computer
│
├── Packages:
│   └── Microsoft_Defender_for_Endpoint.pkg
│       └── Download from: Microsoft CDN or Jamf App Installers
│
├── Maintenance:
│   └── Update Inventory
│
└── Scope: Smart Group "RF-MDE-macOS-Devices"</code></pre>
        </div>

        <h3>4.3 Option B: Intune-Only Deployment (macOS)</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Intune macOS Configuration</span></div>
          <pre><code>INTUNE MACOS MDE DEPLOYMENT
═══════════════════════════════════════════════════════════════════════════════

STEP 1: SYSTEM EXTENSIONS PROFILE
────────────────────────────────────────────────────────────────────────────────
Location: Intune → Devices → macOS → Configuration profiles → Create

├── Profile type: Templates → Extensions
├── Name: RF-MDE-SystemExtensions-macOS
├── Configuration:
│   ├── Allow user overrides: No
│   ├── Team identifier: UBF8T346G9
│   ├── Allowed system extensions:
│   │   ├── com.microsoft.wdav.epsext
│   │   └── com.microsoft.wdav.netext
│   └── Allowed system extension types: Endpoint Security, Network Extension
│
└── Assignments: RF-MDE-macOS-Devices

STEP 2: PRIVACY PREFERENCES (FDA)
────────────────────────────────────────────────────────────────────────────────
├── Profile type: Templates → Preference file
├── Name: RF-MDE-FDA-macOS
├── Upload custom .mobileconfig with PPPC payloads
│   └── (Same content as Jamf PPPC profile)
│
└── Assignments: RF-MDE-macOS-Devices

STEP 3: MDE APP DEPLOYMENT
────────────────────────────────────────────────────────────────────────────────
Location: Intune → Apps → macOS → Add

├── App type: Microsoft Defender for Endpoint
├── App information: Accept defaults
│
└── Assignments:
    ├── Required: RF-MDE-macOS-Devices
    └── Available: None (force install)

STEP 4: ONBOARDING PROFILE
────────────────────────────────────────────────────────────────────────────────
├── Profile type: Templates → Custom
├── Name: RF-MDE-Onboarding-macOS
├── Configuration profile file: Upload .mobileconfig from MDE portal
│
└── Assignments: RF-MDE-macOS-Devices</code></pre>
        </div>

        <h3>4.4 macOS Onboarding Step-by-Step</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Method C: Detailed Steps</span></div>
          <pre><code>METHOD C: MACOS ONBOARDING - STEP BY STEP
═══════════════════════════════════════════════════════════════════════════════

STEP 1: VERIFY DEVICE ENROLLMENT
────────────────────────────────────────────────────────────────────────────────
Jamf: Jamf Pro → Computers → Search → Verify device enrolled
Intune: Intune Admin Center → Devices → macOS → Search hostname

STEP 2: ADD TO MDE DEPLOYMENT GROUP
────────────────────────────────────────────────────────────────────────────────
Jamf: Add to Smart Group "RF-MDE-macOS-Devices"
      Computers → Search → Edit → Category → Add to static group
      OR: Verify Smart Group criteria matches device

Intune: Add to Entra group "RF-MDE-macOS-Devices"
        Entra Admin → Groups → RF-MDE-macOS-Devices → Members → Add

STEP 3: FORCE MDM SYNC
────────────────────────────────────────────────────────────────────────────────
Jamf: Jamf Pro → Computer record → Management → Send MDM Command → Update Inventory
Intune: Intune → Device → Overview → Sync

On device: System Preferences → Profiles → Check for updates

STEP 4: VERIFY PROFILES INSTALLED (on Mac)
────────────────────────────────────────────────────────────────────────────────
Open: System Preferences → Profiles
Verify these profiles are installed:
  ☐ RF-MDE-SystemExtensions
  ☐ RF-MDE-FullDiskAccess
  ☐ RF-MDE-NetworkFilter
  ☐ RF-MDE-Onboarding

If profiles missing: Check MDM scope/assignments

STEP 5: VERIFY MDE APP INSTALLED
────────────────────────────────────────────────────────────────────────────────
Check: /Applications/Microsoft Defender.app exists
Open: Microsoft Defender app
Verify: Dashboard shows "Protected" status

STEP 6: VERIFY SYSTEM EXTENSIONS LOADED
────────────────────────────────────────────────────────────────────────────────
Terminal command:
  systemextensionsctl list

Expected output should include:
  com.microsoft.wdav.epsext  [activated enabled]
  com.microsoft.wdav.netext  [activated enabled]

If showing "waiting for user": MDM profile not applied correctly

STEP 7: VERIFY FULL DISK ACCESS
────────────────────────────────────────────────────────────────────────────────
Open: System Preferences → Security & Privacy → Privacy → Full Disk Access
Verify: Microsoft Defender and extensions are listed and checked

STEP 8: CHECK MDE PORTAL
────────────────────────────────────────────────────────────────────────────────
Open: security.microsoft.com → Devices
Search: hostname (RF-TOR-MAC-xxxxx)
Verify: Device shows as onboarded, sensor health active

STEP 9: RUN VALIDATION ON MAC
────────────────────────────────────────────────────────────────────────────────
Terminal commands:
  mdatp health                          # Overall health
  mdatp health --field org_id           # Should show RevFlow org ID
  mdatp health --field real_time_protection_enabled   # Should be true
  mdatp connectivity test               # Test cloud connectivity

STEP 10: APPLY TAGS AND CLOSE TICKET
────────────────────────────────────────────────────────────────────────────────
• Tag device in MDE portal
• Update SEC-REQ ticket
• Close ticket</code></pre>
        </div>

        <h3>4.5 macOS Troubleshooting</h3>

        <div class="table-wrapper">
          <table>
            <thead><tr><th>Issue</th><th>Cause</th><th>Resolution</th></tr></thead>
            <tbody>
              <tr>
                <td>System extension waiting for approval</td>
                <td>MDM profile not deployed or wrong team ID</td>
                <td>Re-deploy system extension profile; verify Team ID UBF8T346G9</td>
              </tr>
              <tr>
                <td>Full Disk Access denied</td>
                <td>PPPC profile missing or malformed</td>
                <td>Re-deploy PPPC profile; manually approve in System Preferences if urgent</td>
              </tr>
              <tr>
                <td>Device not appearing in MDE</td>
                <td>Onboarding profile not applied</td>
                <td>Verify onboarding .mobileconfig deployed; check MDM logs</td>
              </tr>
              <tr>
                <td>Real-time protection disabled</td>
                <td>Missing permissions or conflict</td>
                <td>Run <code>mdatp health</code>; verify all extensions loaded</td>
              </tr>
              <tr>
                <td>Network protection not working</td>
                <td>Network extension not approved</td>
                <td>Deploy network filter profile; verify netext extension activated</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- ==================== SECTION 5: METHOD D - CRITICAL SERVERS ==================== -->
        <h2>5. Method D: Critical Server Onboarding (Tier 0)</h2>

        <p><strong>Use for:</strong> Domain Controllers, Certificate Authorities, Entra Connect servers, and other Tier 0 assets.</p>
        <p><strong>REQUIRES:</strong> Security CAB + Infrastructure CAB approval</p>

        <div class="callout critical">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>Critical: CAB Approval Required</div>
          <div class="callout-content">
            <p>Tier 0 servers require Change Advisory Board approval before MDE onboarding:</p>
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
              <li><strong>Security CAB:</strong> Tuesdays 10:00 AM EST (CISO, Dir Security Engineering)</li>
              <li><strong>Infrastructure CAB:</strong> Thursdays 2:00 PM EST (VP Infrastructure, Dir IT)</li>
              <li><strong>Maintenance Window:</strong> Required for production DCs</li>
              <li><strong>Rollback Plan:</strong> Must be documented before proceeding</li>
            </ul>
          </div>
        </div>

        <h3>5.1 Tier 0 Server List</h3>

        <div class="table-wrapper">
          <table>
            <thead><tr><th>Server</th><th>Role</th><th>Location</th><th>Criticality</th></tr></thead>
            <tbody>
              <tr><td>RF-TOR-SRV-DC-01</td><td>Primary Domain Controller</td><td>Toronto DC</td><td>Tier 0</td></tr>
              <tr><td>RF-TOR-SRV-DC-02</td><td>Secondary Domain Controller</td><td>Toronto DC</td><td>Tier 0</td></tr>
              <tr><td>RF-VAN-SRV-DC-01</td><td>Domain Controller</td><td>Vancouver</td><td>Tier 0</td></tr>
              <tr><td>RF-TOR-SRV-CA-01</td><td>Root Certificate Authority</td><td>Toronto DC</td><td>Tier 0</td></tr>
              <tr><td>RF-TOR-SRV-AAD-01</td><td>Entra Connect Server</td><td>Toronto DC</td><td>Tier 0</td></tr>
            </tbody>
          </table>
        </div>

        <h3>5.2 Required Exclusions for Domain Controllers</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">DC Exclusions Configuration</span></div>
          <pre><code>DOMAIN CONTROLLER MDE EXCLUSIONS
═══════════════════════════════════════════════════════════════════════════════
Per Microsoft KB and RevFlow operational requirements

FOLDER EXCLUSIONS:
├── C:\Windows\NTDS\                           # AD database
├── C:\Windows\SYSVOL\                         # Group Policy, scripts
├── C:\Windows\System32\DNS\                   # DNS zones
├── C:\Windows\System32\DHCP\                  # DHCP (if role installed)
├── C:\Windows\System32\LogFiles\              # System logs
└── %SystemRoot%\System32\spool\               # Print spooler

PROCESS EXCLUSIONS:
├── C:\Windows\System32\lsass.exe              # Local Security Authority
├── C:\Windows\System32\ntfrs.exe              # File Replication Service
├── C:\Windows\System32\dfsr.exe               # DFS Replication
├── C:\Windows\System32\dfsrs.exe              # DFS Replication Service
├── C:\Windows\System32\dns.exe                # DNS Server
├── C:\Windows\System32\ntdsutil.exe           # NTDS maintenance
├── C:\Windows\System32\samsrv.dll             # SAM Server
├── C:\Windows\System32\ismserv.exe            # Intersite Messaging
└── C:\Windows\ADWS\Microsoft.ActiveDirectory.WebServices.exe

FILE EXTENSION EXCLUSIONS:
├── *.dit                                      # AD database
├── *.edb                                      # Exchange/AD database
├── *.log                                      # Transaction logs
├── *.chk                                      # Checkpoint files
├── *.jrs                                      # AD reserve logs
└── *.pat                                      # Patch files

DEPLOY VIA:
├── Intune: Create custom Endpoint Security profile for DCs
└── GPO: Create separate GPO for Tier0 servers with exclusions</code></pre>
        </div>

        <h3>5.3 Step-by-Step Procedure</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Method D: Detailed Steps</span></div>
          <pre><code>METHOD D: TIER 0 SERVER ONBOARDING - STEP BY STEP
═══════════════════════════════════════════════════════════════════════════════

PRE-WORK (1-2 weeks before)
────────────────────────────────────────────────────────────────────────────────
□ 1. Submit SEC-CHG in ServiceNow with:
     • Business justification
     • Impact analysis
     • Rollback plan
     • Maintenance window request

□ 2. Present at Security CAB (Tuesday)
     • Attendees: CISO, Dir Security Eng, Dir SecOps
     • Obtain approval signature

□ 3. Present at Infrastructure CAB (Thursday)
     • Attendees: VP Infrastructure, Dir IT, Security Rep, SRE Lead
     • Obtain approval signature

□ 4. Schedule maintenance window
     • Production DCs: After business hours
     • Notify affected teams via #it-announcements

□ 5. Pre-stage resources:
     • Exclusions policy created in Intune/GPO
     • Onboarding script accessible
     • Validation script ready
     • Rollback script ready

EXECUTION (Maintenance Window)
────────────────────────────────────────────────────────────────────────────────
□ 1. Join maintenance bridge call
     • Attendees: RF-SEC-PLAT, RF-IT-INFRA, L3 SOC on standby
     • Teams channel: "Security Maintenance Bridge"

□ 2. Verify rollback readiness:
     • Offboarding script staged
     • System restore point created (if applicable)
     • Backup verified

□ 3. Deploy exclusions profile FIRST:
     • Add server to RF-MDE-Tier0-Exclusions group
     • Force GPO/Intune sync
     • Verify exclusions applied:
       Get-MpPreference | Select-Object -Property Exclusion*

□ 4. Deploy MDE onboarding:
     • Add server to RF-GPO-MDE-Onboarding group
     • Run onboarding script manually (preferred for control):
       \\revflow.local\SYSVOL\revflow.local\scripts\MDE\WindowsDefenderATPOnboardingScript.cmd

□ 5. Monitor for 15 minutes:
     • Check AD replication: repadmin /replsummary
     • Check DNS: nslookup revflow.local
     • Check services: Get-Service | Where-Object {$_.Status -ne 'Running' -and $_.StartType -eq 'Automatic'}
     • Check MDE sensor: Get-Service Sense

□ 6. Validate onboarding:
     • Run RF-MDE-Validate.ps1
     • Confirm in MDE portal
     • Verify no performance impact

□ 7. If issues detected:
     → ROLLBACK: Run offboarding script immediately
     → Restore previous state
     → Document issue for post-mortem

POST-EXECUTION
────────────────────────────────────────────────────────────────────────────────
□ 1. Enhanced monitoring (24-48 hours):
     • SOC to watch for alerts from DC
     • Infrastructure team to monitor performance

□ 2. Tag device in MDE:
     • Criticality: Tier0
     • Environment: Production
     • Role: DomainController / CA / EntraConnect

□ 3. Update documentation:
     • SEC-CHG ticket closed
     • Infrastructure CMDB updated
     • Security inventory updated

□ 4. Post-implementation review (optional):
     • Was there any impact?
     • Any tuning required?</code></pre>
        </div>

        <!-- ==================== SECTION 6: METHOD E - LOCAL SCRIPT ==================== -->
        <h2>6. Method E: Local Script Deployment</h2>

        <p><strong>Use for:</strong> Standalone Windows devices, workgroup computers, lab machines, or devices that cannot use Intune/GPO.</p>

        <h3>6.1 Prerequisites</h3>

        <div class="table-wrapper">
          <table>
            <thead><tr><th>✓</th><th>Requirement</th><th>Notes</th></tr></thead>
            <tbody>
              <tr><td>☐</td><td>Local administrator access</td><td>Script must run elevated</td></tr>
              <tr><td>☐</td><td>Internet connectivity to Microsoft</td><td>*.securitycenter.windows.com, etc.</td></tr>
              <tr><td>☐</td><td>Windows 10 1809+ or Windows 11</td><td>Or Windows Server 2016+</td></tr>
              <tr><td>☐</td><td>Onboarding package downloaded</td><td>From security.microsoft.com</td></tr>
            </tbody>
          </table>
        </div>

        <h3>6.2 Obtain Onboarding Package</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Download Onboarding Script</span></div>
          <pre><code>HOW TO DOWNLOAD MDE ONBOARDING PACKAGE
═══════════════════════════════════════════════════════════════════════════════

1. Open Microsoft 365 Defender portal: https://security.microsoft.com

2. Navigate to: Settings → Endpoints → Device management → Onboarding

3. Select deployment method: "Local Script (for up to 10 devices)"

4. Select operating system: Windows 10/11 or Windows Server

5. Click "Download package"

6. Extract the downloaded .zip file. Contents:
   └── WindowsDefenderATPLocalOnboardingScript.cmd

7. Copy to target device or accessible network share

NOTE: The onboarding package contains your organization's unique onboarding blob.
      Do NOT share this file externally.</code></pre>
        </div>

        <h3>6.3 Step-by-Step Procedure</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Method E: Detailed Steps</span></div>
          <pre><code>METHOD E: LOCAL SCRIPT ONBOARDING - STEP BY STEP
═══════════════════════════════════════════════════════════════════════════════

STEP 1: PREPARE THE DEVICE
────────────────────────────────────────────────────────────────────────────────
• Log in with local administrator account
• Copy onboarding script to device (e.g., C:\Temp\)
• Verify network connectivity:
  Test-NetConnection -ComputerName securitycenter.windows.com -Port 443

STEP 2: RUN ONBOARDING SCRIPT
────────────────────────────────────────────────────────────────────────────────
• Open Command Prompt as Administrator
• Navigate to script location:
  cd C:\Temp

• Run the script:
  WindowsDefenderATPLocalOnboardingScript.cmd

• Wait for completion (1-2 minutes)
• Expected output: "Successfully onboarded machine to Microsoft Defender for Endpoint"

STEP 3: VERIFY ONBOARDING
────────────────────────────────────────────────────────────────────────────────
• Check registry:
  reg query "HKLM\SOFTWARE\Microsoft\Windows Advanced Threat Protection\Status" /v OnboardingState
  Expected: OnboardingState REG_DWORD 0x1

• Check Sense service:
  sc query sense
  Expected: STATE: 4 RUNNING

• Run detection test (optional):
  powershell.exe -NoExit -ExecutionPolicy Bypass -WindowStyle Hidden $ErrorActionPreference= 'silentlycontinue';(New-Object System.Net.WebClient).DownloadString('https://securitycenter.windows.com/api/test')

STEP 4: VERIFY IN MDE PORTAL
────────────────────────────────────────────────────────────────────────────────
• Wait 30-60 minutes for device to appear
• Open: security.microsoft.com → Devices
• Search for hostname
• Verify onboarding status and sensor health

STEP 5: MANUAL TAGGING (Important for standalone devices)
────────────────────────────────────────────────────────────────────────────────
Since device is standalone, manually add tags in MDE portal:
• Device page → Manage tags
• Add: Location, Department, Environment
• Add: Standalone (to identify non-managed devices)</code></pre>
        </div>

        <!-- ==================== SECTION 7: METHOD F - LINUX ==================== -->
        <h2>7. Method F: Linux Server Deployment</h2>

        <p><strong>Use for:</strong> Linux servers (rf-{loc}-srv-*) running Ubuntu, Debian, RHEL, or CentOS.</p>

        <h3>7.1 Supported Distributions</h3>

        <div class="table-wrapper">
          <table>
            <thead><tr><th>Distribution</th><th>Versions</th><th>Package Manager</th></tr></thead>
            <tbody>
              <tr><td>Ubuntu</td><td>20.04, 22.04, 24.04</td><td>apt</td></tr>
              <tr><td>Debian</td><td>10, 11, 12</td><td>apt</td></tr>
              <tr><td>RHEL</td><td>8.x, 9.x</td><td>yum/dnf</td></tr>
              <tr><td>CentOS</td><td>8 Stream</td><td>yum/dnf</td></tr>
              <tr><td>Amazon Linux</td><td>2, 2023</td><td>yum</td></tr>
            </tbody>
          </table>
        </div>

        <h3>7.2 Ubuntu/Debian Script</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Bash - rf-mde-linux-ubuntu.sh</span><button class="code-copy-btn">Copy</button></div>
          <pre><code>#!/bin/bash
# rf-mde-linux-ubuntu.sh - RevFlow MDE Onboarding for Ubuntu/Debian
# Owner: RF-SEC-PLAT | Version: 2.0
# Usage: sudo bash rf-mde-linux-ubuntu.sh

set -e
LOG_FILE="/var/log/mde-onboarding.log"

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

log "========== MDE Linux Onboarding Started =========="
log "Hostname: $(hostname)"
log "OS: $(lsb_release -ds)"

# Check if running as root
if [[ $EUID -ne 0 ]]; then
    log "ERROR: This script must be run as root (sudo)"
    exit 1
fi

# Check if already onboarded
if mdatp health --field org_id 2>/dev/null | grep -q "a3f8b2c1"; then
    log "Device already onboarded to RevFlow tenant. Exiting."
    exit 0
fi

log "STEP 1: Adding Microsoft package repository..."
# Install prerequisites
apt-get update
apt-get install -y curl apt-transport-https gnupg

# Add Microsoft GPG key
curl -sSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor -o /usr/share/keyrings/microsoft-prod.gpg

# Add repository
DISTRO=$(lsb_release -cs)
echo "deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft-prod.gpg] https://packages.microsoft.com/ubuntu/$(lsb_release -rs)/prod $DISTRO main" > /etc/apt/sources.list.d/microsoft-prod.list

log "STEP 2: Installing Microsoft Defender for Endpoint..."
apt-get update
apt-get install -y mdatp

log "STEP 3: Downloading onboarding package..."
# Download onboarding script from secure location
# NOTE: Replace with actual RevFlow blob storage URL or SYSVOL path
ONBOARD_SCRIPT="/tmp/MicrosoftDefenderATPOnboardingLinuxServer.py"
curl -sSL "https://revflowsecure.blob.core.windows.net/mde/MicrosoftDefenderATPOnboardingLinuxServer.py" -o "$ONBOARD_SCRIPT"
# Or copy from network share:
# cp /mnt/revflow/scripts/MDE/MicrosoftDefenderATPOnboardingLinuxServer.py "$ONBOARD_SCRIPT"

log "STEP 4: Running onboarding script..."
python3 "$ONBOARD_SCRIPT"

log "STEP 5: Enabling real-time protection..."
mdatp config real-time-protection --value enabled

log "STEP 6: Verifying onboarding..."
sleep 30

# Validate
ORG_ID=$(mdatp health --field org_id)
RTP=$(mdatp health --field real_time_protection_enabled)
HEALTH=$(mdatp health --field healthy)

log "Org ID: $ORG_ID"
log "Real-time Protection: $RTP"
log "Health Status: $HEALTH"

if [[ "$HEALTH" == "true" ]]; then
    log "SUCCESS: MDE onboarding completed successfully"
else
    log "WARNING: Device may not be fully healthy. Check 'mdatp health' for details."
fi

# Cleanup
rm -f "$ONBOARD_SCRIPT"

log "========== MDE Linux Onboarding Complete =========="</code></pre>
        </div>

        <h3>7.3 RHEL/CentOS Script</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Bash - rf-mde-linux-rhel.sh</span><button class="code-copy-btn">Copy</button></div>
          <pre><code>#!/bin/bash
# rf-mde-linux-rhel.sh - RevFlow MDE Onboarding for RHEL/CentOS
# Owner: RF-SEC-PLAT | Version: 2.0
# Usage: sudo bash rf-mde-linux-rhel.sh

set -e
LOG_FILE="/var/log/mde-onboarding.log"

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

log "========== MDE Linux Onboarding Started =========="
log "Hostname: $(hostname)"
log "OS: $(cat /etc/redhat-release)"

# Check if running as root
if [[ $EUID -ne 0 ]]; then
    log "ERROR: This script must be run as root (sudo)"
    exit 1
fi

log "STEP 1: Adding Microsoft package repository..."
# Add Microsoft repository
rpm --import https://packages.microsoft.com/keys/microsoft.asc

RHEL_VERSION=$(rpm -E %{rhel})
cat > /etc/yum.repos.d/microsoft-prod.repo << EOF
[packages-microsoft-com-prod]
name=Microsoft Packages for RHEL $RHEL_VERSION
baseurl=https://packages.microsoft.com/rhel/$RHEL_VERSION/prod/
enabled=1
gpgcheck=1
gpgkey=https://packages.microsoft.com/keys/microsoft.asc
EOF

log "STEP 2: Installing Microsoft Defender for Endpoint..."
yum install -y mdatp

log "STEP 3: Downloading onboarding package..."
ONBOARD_SCRIPT="/tmp/MicrosoftDefenderATPOnboardingLinuxServer.py"
curl -sSL "https://revflowsecure.blob.core.windows.net/mde/MicrosoftDefenderATPOnboardingLinuxServer.py" -o "$ONBOARD_SCRIPT"

log "STEP 4: Running onboarding script..."
python3 "$ONBOARD_SCRIPT"

log "STEP 5: Enabling real-time protection..."
mdatp config real-time-protection --value enabled

log "STEP 6: Configuring SELinux policy (if enforcing)..."
if sestatus | grep -q "enforcing"; then
    log "SELinux is enforcing. Installing MDE SELinux policy..."
    # MDE package should include policy, but manual install if needed
    # semodule -i /opt/microsoft/mdatp/selinux/mdatp.pp
fi

log "STEP 7: Verifying onboarding..."
sleep 30

# Validate
mdatp health

log "========== MDE Linux Onboarding Complete =========="</code></pre>
        </div>

        <!-- ==================== SECTION 8: METHOD G - VDI ==================== -->
        <h2>8. Method G: VDI Deployment (Non-Persistent)</h2>

        <p><strong>Use for:</strong> Non-persistent VDI pools (RF-VDI-NP-*) where VMs reset after each session.</p>

        <div class="callout critical">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>Critical: Duplicate Device ID Prevention</div>
          <div class="callout-content">
            <p><strong>Problem:</strong> If MDE is onboarded in the golden image, every clone gets the same Device ID.</p>
            <p><strong>Solution:</strong> Install MDE binaries in image (NOT onboarded), run onboarding at each session start.</p>
          </div>
        </div>

        <h3>8.1 Golden Image Preparation</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Golden Image Steps</span></div>
          <pre><code>VDI GOLDEN IMAGE PREPARATION
═══════════════════════════════════════════════════════════════════════════════

STEP 1: INSTALL MDE BINARIES ONLY (NOT ONBOARDING)
────────────────────────────────────────────────────────────────────────────────
# Download MDE installer from Microsoft 365 Defender portal:
# Settings → Endpoints → Onboarding → Windows 10/11 → Download "Installation Package"
# NOT the "Onboarding package" - those are different!

# Install MDE without onboarding
msiexec /i md4ws.msi /quiet /norestart

STEP 2: VERIFY MDE IS INSTALLED BUT NOT ONBOARDED
────────────────────────────────────────────────────────────────────────────────
# Check Sense service exists
Get-Service Sense
# Expected: Exists (Status may be Stopped - that's OK)

# Check onboarding state - should be 0 or not exist
$State = (Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows Advanced Threat Protection\Status" -EA SilentlyContinue).OnboardingState
# Expected: 0 or property does not exist

STEP 3: SET VDI FLAG IN REGISTRY
────────────────────────────────────────────────────────────────────────────────
# This tells MDE the device is VDI (affects telemetry/dedup)
New-Item -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Advanced Threat Protection" -Force
Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Advanced Threat Protection" -Name "VDI" -Value 1 -Type DWord

STEP 4: ⚠️ DO NOT RUN ONBOARDING SCRIPT
────────────────────────────────────────────────────────────────────────────────
# The onboarding script generates the unique Device ID.
# Running it in the image = all clones share same ID = BAD!

# ⛔ DO NOT RUN: WindowsDefenderATPOnboardingScript.cmd
# ⛔ DO NOT RUN: WindowsDefenderATPLocalOnboardingScript.cmd

STEP 5: SYSPREP AND SEAL
────────────────────────────────────────────────────────────────────────────────
# Run sysprep as normal for your VDI platform
# Snapshot/seal the image

The result: Image has MDE installed but not onboarded.
Onboarding happens fresh at each session boot.</code></pre>
        </div>

        <h3>8.2 Session Startup Script</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">PowerShell - RF-MDE-VDI-SessionStart.ps1</span><button class="code-copy-btn">Copy</button></div>
          <pre><code># RF-MDE-VDI-SessionStart.ps1 - Onboards non-persistent VDI at session start
# Deploy via: AVD Custom Script Extension, Citrix Startup Script, or GPO Startup
# Owner: RF-SEC-PLAT | Version: 2.0
# Run as: SYSTEM (startup script, not user logon)

$LogFile = "C:\Windows\Logs\MDE-VDI-Onboard.log"
$ScriptPath = "\\revflow.local\SYSVOL\revflow.local\scripts\MDE\WindowsDefenderATPOnboardingScript.cmd"

function Write-Log {
    param([string]$Message)
    $Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    "$Timestamp - $Message" | Out-File -Append -FilePath $LogFile
}

Write-Log "========== VDI Session MDE Onboarding =========="
Write-Log "Hostname: $env:COMPUTERNAME"
Write-Log "Session Start: $(Get-Date)"

# Check if already onboarded THIS session
$RegPath = "HKLM:\SOFTWARE\Microsoft\Windows Advanced Threat Protection\Status"
$OnboardingState = (Get-ItemProperty -Path $RegPath -ErrorAction SilentlyContinue).OnboardingState

if ($OnboardingState -eq 1) {
    Write-Log "Already onboarded this session. Checking health..."
    $Sense = Get-Service Sense -ErrorAction SilentlyContinue
    if ($Sense.Status -eq "Running") {
        Write-Log "Sense running. Skipping onboarding."
        exit 0
    }
}

# Verify script path accessible
if (-not (Test-Path $ScriptPath)) {
    Write-Log "ERROR: Onboarding script not found: $ScriptPath"
    Write-Log "Checking alternate path..."
    
    # Fallback to local copy if network unavailable
    $LocalScript = "C:\ProgramData\MDE\WindowsDefenderATPOnboardingScript.cmd"
    if (Test-Path $LocalScript) {
        $ScriptPath = $LocalScript
        Write-Log "Using local copy: $LocalScript"
    } else {
        Write-Log "FATAL: No onboarding script available. Exiting."
        exit 1
    }
}

# Run onboarding
Write-Log "Running onboarding from: $ScriptPath"
try {
    $Process = Start-Process -FilePath "cmd.exe" -ArgumentList "/c `"$ScriptPath`"" -Wait -NoNewWindow -PassThru
    Write-Log "Onboarding script exit code: $($Process.ExitCode)"
} catch {
    Write-Log "ERROR: Failed to run onboarding - $($_.Exception.Message)"
    exit 1
}

# Wait for Sense service
Write-Log "Waiting for Sense service..."
Start-Sleep -Seconds 30

$Sense = Get-Service Sense -ErrorAction SilentlyContinue
if ($Sense.Status -eq "Running") {
    Write-Log "SUCCESS: Sense service running"
    
    # Verify onboarding state
    $NewState = (Get-ItemProperty -Path $RegPath -ErrorAction SilentlyContinue).OnboardingState
    Write-Log "Onboarding state: $NewState"
} else {
    Write-Log "WARNING: Sense not running. Status: $($Sense.Status)"
}

Write-Log "========== VDI Onboarding Complete =========="</code></pre>
        </div>

        <h3>8.3 AVD (Azure Virtual Desktop) Deployment</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">AVD Custom Script Extension</span></div>
          <pre><code>AVD MDE DEPLOYMENT
═══════════════════════════════════════════════════════════════════════════════

OPTION 1: CUSTOM SCRIPT EXTENSION (per host pool)
────────────────────────────────────────────────────────────────────────────────
# In Azure Portal: Virtual machines → Extensions → Add Custom Script Extension

Script URI: https://revflowsecure.blob.core.windows.net/scripts/RF-MDE-VDI-SessionStart.ps1
Command: powershell -ExecutionPolicy Bypass -File RF-MDE-VDI-SessionStart.ps1

# Or use Azure CLI:
az vm extension set \
  --resource-group "rg-avd-production" \
  --vm-name "avd-host-0" \
  --name "CustomScriptExtension" \
  --publisher "Microsoft.Compute" \
  --settings '{"fileUris":["https://revflowsecure.blob.core.windows.net/scripts/RF-MDE-VDI-SessionStart.ps1"],"commandToExecute":"powershell -ExecutionPolicy Bypass -File RF-MDE-VDI-SessionStart.ps1"}'

OPTION 2: INTUNE (for AVD with Intune enrollment)
────────────────────────────────────────────────────────────────────────────────
# Use standard Method A (Intune) if AVD hosts are Intune-enrolled
# Intune policy deploys automatically after enrollment</code></pre>
        </div>

        <!-- ==================== SECTION 9: METHOD H - CLOUD VMS ==================== -->
        <h2>9. Method H: Cloud VM Deployment (Azure/AWS)</h2>

        <p><strong>Use for:</strong> Azure VMs, AWS EC2 instances, and other cloud-based servers.</p>

        <h3>9.1 Azure VMs - Defender for Cloud Integration</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Azure Defender for Cloud</span></div>
          <pre><code>AZURE VM MDE DEPLOYMENT VIA DEFENDER FOR CLOUD
═══════════════════════════════════════════════════════════════════════════════

STEP 1: ENABLE DEFENDER FOR SERVERS
────────────────────────────────────────────────────────────────────────────────
# Azure Portal → Microsoft Defender for Cloud → Environment settings
# Select subscription: rf-production
# Enable: Servers plan (Plan 2 for full MDE)

Settings:
├── Servers: ON (Plan 2)
├── Auto-provisioning: ON
│   └── Log Analytics agent / Azure Monitor Agent: Enabled
│   └── Endpoint protection: Microsoft Defender for Endpoint
└── Continuous export: To Log Analytics workspace (rf-sentinel-prod)

STEP 2: VERIFY AUTO-ONBOARDING
────────────────────────────────────────────────────────────────────────────────
# After enabling, new VMs automatically get MDE agent
# Existing VMs may need extension install

# Check VM extensions:
az vm extension list --resource-group "rg-app-production" --vm-name "rf-app-web-01" -o table

# Expected extension: MDE.Windows or MDE.Linux

STEP 3: MANUAL EXTENSION INSTALL (if auto-provision missed)
────────────────────────────────────────────────────────────────────────────────
# Windows VM
az vm extension set \
  --resource-group "rg-app-production" \
  --vm-name "rf-app-web-01" \
  --name "MDE.Windows" \
  --publisher "Microsoft.Azure.AzureDefenderForServers" \
  --settings '{}'

# Linux VM
az vm extension set \
  --resource-group "rg-app-production" \
  --vm-name "rf-app-api-01" \
  --name "MDE.Linux" \
  --publisher "Microsoft.Azure.AzureDefenderForServers" \
  --settings '{}'

STEP 4: AZURE ARC (for hybrid/on-prem servers)
────────────────────────────────────────────────────────────────────────────────
# For on-prem servers managed via Azure Arc:
# Install Azure Connected Machine agent → Enable Defender for Servers
# MDE deploys automatically via Arc</code></pre>
        </div>

        <h3>9.2 AWS EC2 Instances</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">AWS EC2 MDE Deployment</span></div>
          <pre><code>AWS EC2 MDE DEPLOYMENT
═══════════════════════════════════════════════════════════════════════════════

OPTION 1: AZURE ARC + DEFENDER FOR CLOUD
────────────────────────────────────────────────────────────────────────────────
# Connect AWS account to Azure Arc
# Azure Portal → Azure Arc → AWS Servers → Connect AWS account

# Once connected, EC2 instances appear in Azure Arc
# Enable Defender for Servers → MDE auto-deploys

OPTION 2: AWS SYSTEMS MANAGER (SSM)
────────────────────────────────────────────────────────────────────────────────
# Use SSM Run Command to deploy MDE

# Windows EC2:
aws ssm send-command \
  --document-name "AWS-RunPowerShellScript" \
  --targets "Key=tag:Environment,Values=Production" \
  --parameters 'commands=["Invoke-WebRequest -Uri https://revflowsecure.blob.core.windows.net/mde/WindowsDefenderATPOnboardingScript.cmd -OutFile C:\\Temp\\mde-onboard.cmd","cmd /c C:\\Temp\\mde-onboard.cmd"]'

# Linux EC2:
aws ssm send-command \
  --document-name "AWS-RunShellScript" \
  --targets "Key=tag:Environment,Values=Production" \
  --parameters 'commands=["curl -o /tmp/mde-onboard.sh https://revflowsecure.blob.core.windows.net/mde/rf-mde-linux-ubuntu.sh","bash /tmp/mde-onboard.sh"]'

OPTION 3: USER DATA (for new instances)
────────────────────────────────────────────────────────────────────────────────
# Include in EC2 launch template User Data:

#!/bin/bash
# MDE Onboarding for new EC2
curl -o /tmp/mde-onboard.sh https://revflowsecure.blob.core.windows.net/mde/rf-mde-linux-ubuntu.sh
bash /tmp/mde-onboard.sh</code></pre>
        </div>

        <!-- ==================== SECTION 10: VALIDATION ==================== -->
        <h2>10. Validation & Health Check</h2>

        <h3>10.1 Windows Validation Script</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">PowerShell - RF-MDE-Validate.ps1</span><button class="code-copy-btn">Copy</button></div>
          <pre><code># RF-MDE-Validate.ps1 - RevFlow MDE Health Validation
# Run as Administrator on Windows endpoints
# Owner: RF-SEC-PLAT | Version: 2.0

Write-Host "═══════════════════════════════════════════════════════" -ForegroundColor Cyan
Write-Host "    REVFLOW MDE HEALTH VALIDATION" -ForegroundColor Cyan
Write-Host "═══════════════════════════════════════════════════════" -ForegroundColor Cyan
Write-Host ""
Write-Host "Hostname: $env:COMPUTERNAME" -ForegroundColor White
Write-Host "Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor White
Write-Host ""

# Check 1: Sense Service
Write-Host "[CHECK 1] Sense Service" -ForegroundColor Yellow
$Sense = Get-Service -Name "Sense" -ErrorAction SilentlyContinue
if ($Sense) {
    if ($Sense.Status -eq "Running") {
        Write-Host "  ✓ Sense Service: Running" -ForegroundColor Green
    } else {
        Write-Host "  ✗ Sense Service: $($Sense.Status)" -ForegroundColor Red
    }
} else {
    Write-Host "  ✗ Sense Service: NOT INSTALLED" -ForegroundColor Red
}

# Check 2: Onboarding State
Write-Host "[CHECK 2] Onboarding State" -ForegroundColor Yellow
$RegPath = "HKLM:\SOFTWARE\Microsoft\Windows Advanced Threat Protection\Status"
$State = (Get-ItemProperty -Path $RegPath -ErrorAction SilentlyContinue).OnboardingState
if ($State -eq 1) {
    Write-Host "  ✓ Onboarding State: Onboarded (1)" -ForegroundColor Green
} else {
    Write-Host "  ✗ Onboarding State: $State (expected: 1)" -ForegroundColor Red
}

# Check 3: Organization ID
Write-Host "[CHECK 3] Organization ID" -ForegroundColor Yellow
$OrgId = (Get-ItemProperty -Path $RegPath -ErrorAction SilentlyContinue).OrgId
$ExpectedOrg = "a3f8b2c1"  # First part of RevFlow org ID
if ($OrgId -like "$ExpectedOrg*") {
    Write-Host "  ✓ Org ID: $OrgId (RevFlow)" -ForegroundColor Green
} else {
    Write-Host "  ✗ Org ID: $OrgId (NOT RevFlow!)" -ForegroundColor Red
}

# Check 4: AV Mode
Write-Host "[CHECK 4] Antivirus Mode" -ForegroundColor Yellow
try {
    $AVStatus = Get-MpComputerStatus
    Write-Host "  ✓ AV Mode: $($AVStatus.AMRunningMode)" -ForegroundColor Green
    Write-Host "    (Passive = ESET coexist, Normal = MDE primary)" -ForegroundColor Gray
} catch {
    Write-Host "  ! Could not query AV status" -ForegroundColor Yellow
}

# Check 5: Tamper Protection
Write-Host "[CHECK 5] Tamper Protection" -ForegroundColor Yellow
try {
    $Tamper = (Get-MpComputerStatus).IsTamperProtected
    if ($Tamper) {
        Write-Host "  ✓ Tamper Protection: Enabled" -ForegroundColor Green
    } else {
        Write-Host "  ⚠ Tamper Protection: Disabled" -ForegroundColor Yellow
    }
} catch {
    Write-Host "  ! Could not query tamper protection" -ForegroundColor Yellow
}

# Check 6: Definition Age
Write-Host "[CHECK 6] Definition Currency" -ForegroundColor Yellow
try {
    $DefAge = (Get-MpComputerStatus).AntivirusSignatureAge
    if ($DefAge -le 1) {
        Write-Host "  ✓ Definition Age: $DefAge days (current)" -ForegroundColor Green
    } elseif ($DefAge -le 3) {
        Write-Host "  ⚠ Definition Age: $DefAge days (acceptable)" -ForegroundColor Yellow
    } else {
        Write-Host "  ✗ Definition Age: $DefAge days (OUTDATED)" -ForegroundColor Red
    }
} catch {
    Write-Host "  ! Could not query definitions" -ForegroundColor Yellow
}

# Check 7: Cloud Connectivity
Write-Host "[CHECK 7] Cloud Connectivity" -ForegroundColor Yellow
$CloudEndpoints = @(
    "winatp-gw-cus.microsoft.com",
    "winatp-gw-eus.microsoft.com",
    "securitycenter.windows.com"
)
foreach ($endpoint in $CloudEndpoints) {
    $test = Test-NetConnection -ComputerName $endpoint -Port 443 -WarningAction SilentlyContinue
    if ($test.TcpTestSucceeded) {
        Write-Host "  ✓ $endpoint : Connected" -ForegroundColor Green
        break
    }
}

Write-Host ""
Write-Host "═══════════════════════════════════════════════════════" -ForegroundColor Cyan
Write-Host "    VALIDATION COMPLETE" -ForegroundColor Cyan
Write-Host "═══════════════════════════════════════════════════════" -ForegroundColor Cyan</code></pre>
        </div>

        <!-- ==================== SECTION 11: TROUBLESHOOTING ==================== -->
        <h2>11. Troubleshooting</h2>

        <div class="table-wrapper">
          <table>
            <thead><tr><th>Issue</th><th>Symptoms</th><th>Resolution</th></tr></thead>
            <tbody>
              <tr>
                <td><strong>Device not appearing in portal</strong></td>
                <td>Waited >60 min, device not in MDE inventory</td>
                <td>1. Check Sense service running<br>2. Verify connectivity to *.securitycenter.windows.com<br>3. Check onboarding state in registry<br>4. Re-run onboarding script</td>
              </tr>
              <tr>
                <td><strong>Sense service won't start</strong></td>
                <td>Service stuck in Stopped/Starting state</td>
                <td>1. Check Event Viewer: Applications and Services → Microsoft → Windows → SENSE<br>2. Verify no conflicting AV<br>3. Check disk space (>2GB free)<br>4. Reinstall MDE agent</td>
              </tr>
              <tr>
                <td><strong>Wrong organization</strong></td>
                <td>Device onboarded to different tenant</td>
                <td>1. Run offboarding script for wrong tenant<br>2. Wait 24 hours<br>3. Re-onboard with correct RevFlow package</td>
              </tr>
              <tr>
                <td><strong>Passive mode not working</strong></td>
                <td>MDE trying to run in active mode despite ESET</td>
                <td>1. Set ForcePassiveMode=1 in registry<br>2. Apply via GPO or Intune<br>3. Restart Sense service</td>
              </tr>
              <tr>
                <td><strong>Duplicate Device IDs (VDI)</strong></td>
                <td>Multiple VDI clones showing same Device ID</td>
                <td>1. Golden image was pre-onboarded (bad)<br>2. Offboard all affected devices<br>3. Update golden image (install only, no onboard)<br>4. Implement session startup onboarding</td>
              </tr>
              <tr>
                <td><strong>macOS system extension blocked</strong></td>
                <td>"System extension blocked" message</td>
                <td>1. Verify MDM profile deployed<br>2. Check Team ID: UBF8T346G9<br>3. Reboot Mac<br>4. Manual approve in System Preferences if urgent</td>
              </tr>
              <tr>
                <td><strong>macOS Full Disk Access denied</strong></td>
                <td>MDE shows limited protection</td>
                <td>1. Deploy PPPC profile via MDM<br>2. Verify profile installed in System Preferences → Profiles<br>3. Check Privacy → Full Disk Access for Microsoft Defender</td>
              </tr>
              <tr>
                <td><strong>Linux: mdatp command not found</strong></td>
                <td>Package not installed correctly</td>
                <td>1. Verify Microsoft repo configured<br>2. Run: apt update && apt install mdatp (Ubuntu)<br>3. Check package: dpkg -l mdatp</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- ==================== SECTION 12: ESCALATION ==================== -->
        <h2>12. Escalation Path</h2>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Escalation Matrix</span></div>
          <pre><code>REVFLOW MDE ONBOARDING ESCALATION
═══════════════════════════════════════════════════════════════════════════════

LEVEL 1: RF-SEC-PLAT (Security Platform Team)
├── First responder for onboarding issues
├── SLA: 4 business hours
├── Contact: Slack #sec-platform-support
└── Handles: Standard onboarding, minor troubleshooting

LEVEL 2: RF-SEC-SOC-L3 (SOC Level 3)
├── Security incident suspected during onboarding
├── SLA: 1 hour
├── Contact: PagerDuty "RevFlow SOC L3"
└── Handles: Sensor tampering, suspicious failures, security concerns

LEVEL 3: Microsoft Support
├── Platform bugs, unexplained failures, product defects
├── Contact: admin.microsoft.com
├── Premier Contract: RevFlow-MS-Premier-2024
└── Handles: Backend issues, connector problems, known bugs

EMERGENCY (Tier 0 Servers)
├── Contact: RF-SEC-PLAT on-call via PagerDuty
├── Teams Bridge: "Security Incident Bridge"
├── CISO notification required for Tier 0 issues
└── VP Infrastructure approval for emergency changes</code></pre>
        </div>

        <!-- ==================== SECTION 13: DEVICE TAGS ==================== -->
        <h2>13. RevFlow Device Tags</h2>

        <div class="table-wrapper">
          <table>
            <thead><tr><th>Tag Category</th><th>Values</th><th>When to Apply</th></tr></thead>
            <tbody>
              <tr>
                <td><strong>Location</strong></td>
                <td>TOR, VAN, SFO, NYC, BLR, HYD</td>
                <td>All devices - based on physical location</td>
              </tr>
              <tr>
                <td><strong>Department</strong></td>
                <td>SALES, ENG, FIN, HR, IT, LEGAL, EXEC, CS</td>
                <td>All devices - based on primary user's department</td>
              </tr>
              <tr>
                <td><strong>Criticality</strong></td>
                <td>Tier0, Tier1, Tier2, Standard</td>
                <td>Tier0: DC/CA/AAD | Tier1: Critical servers | Tier2: Standard servers | Standard: Workstations</td>
              </tr>
              <tr>
                <td><strong>Environment</strong></td>
                <td>Production, Staging, Development, Lab</td>
                <td>All devices - based on environment</td>
              </tr>
              <tr>
                <td><strong>Migration</strong></td>
                <td>ESET-Coexist, ESET-Removed, MDE-Primary</td>
                <td>Track ESET removal progress</td>
              </tr>
              <tr>
                <td><strong>Compliance</strong></td>
                <td>PCI, SOC2, PIPEDA, ISO27001</td>
                <td>Devices in scope for specific compliance frameworks</td>
              </tr>
              <tr>
                <td><strong>VDI</strong></td>
                <td>VDI-Persistent, VDI-NonPersistent</td>
                <td>Virtual desktop infrastructure devices</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="callout success">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Runbook Complete</div>
          <div class="callout-content">
            <p>This runbook covers all MDE onboarding scenarios at RevFlow. For questions, contact RF-SEC-PLAT via Slack #sec-platform-support.</p>
          </div>
        </div>

      </div>
    </main>
  </div>
  <script src="../js/main.js"></script>
</body>
</html>
