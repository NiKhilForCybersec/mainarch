<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detection Catalog | Security Transformation</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
  <div class="layout">
        <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="sidebar-logo-icon">RF</div>
          <div class="sidebar-logo-text">
            <span class="sidebar-logo-title">Security Transformation</span>
            <span class="sidebar-logo-subtitle">RevFlow Analytics</span>
          </div>
        </div>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Overview</div>
          <a href="../index.html" class="nav-item">Executive Summary</a>
          <a href="../company-profile.html" class="nav-item">Company Profile</a>
          <a href="../security-framework.html" class="nav-item">Security Framework</a>
          <a href="../program-structure.html" class="nav-item">Program Structure</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">SIEM Migration</div>
          <a href="index.html" class="nav-item">SIEM Overview</a>
          <a href="discovery.html" class="nav-item">Discovery & Assessment</a>
          <a href="log-sources.html" class="nav-item">Log Source Strategy</a>
          <a href="log-engineering.html" class="nav-item">Log Engineering</a>
          <a href="detection-engineering.html" class="nav-item">Detection Engineering</a>
          <a href="detection-catalog.html" class="nav-item active">Detection Catalog</a>
          <a href="soc-transition.html" class="nav-item">SOC Transition</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">EDR Migration</div>
          <a href="../edr/index.html" class="nav-item">EDR Overview</a>
          <a href="../edr/deployment.html" class="nav-item">MDE Deployment</a>
          <a href="../edr/asr-rules.html" class="nav-item">ASR Rules</a>
          <a href="../edr/coexistence.html" class="nav-item">Coexistence Strategy</a>
          <a href="../edr/eset-removal.html" class="nav-item">ESET Removal</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">DLP Migration</div>
          <a href="../dlp/index.html" class="nav-item">DLP Overview</a>
          <a href="../dlp/dlp-catalog.html" class="nav-item">DLP Catalog</a>
          <a href="../dlp/policy-translation.html" class="nav-item">Policy Translation</a>
          <a href="../dlp/rollout-phases.html" class="nav-item">Rollout Phases</a>
          <a href="../dlp/user-communication.html" class="nav-item">User Communication</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Identity & Access</div>
          <a href="../identity/index.html" class="nav-item">Identity Overview</a>
          <a href="../identity/hybrid-setup.html" class="nav-item">Hybrid Identity</a>
          <a href="../identity/conditional-access.html" class="nav-item">Conditional Access</a>
          <a href="../identity/pim.html" class="nav-item">PIM Configuration</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Infrastructure</div>
          <a href="../infrastructure/index.html" class="nav-item">Infrastructure Overview</a>
          <a href="../infrastructure/landing-zone.html" class="nav-item">Landing Zone</a>
          <a href="../infrastructure/network-architecture.html" class="nav-item">Network Architecture</a>
          <a href="../infrastructure/workload-migration.html" class="nav-item">Workload Migration</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Operations</div>
          <a href="../operations/parallel-ops.html" class="nav-item">Parallel Operations</a>
          <a href="../operations/soc-workflows.html" class="nav-item">SOC Workflows</a>
          <a href="../operations/integration.html" class="nav-item">Platform Integration</a>
          <a href="../operations/xdr-integration.html" class="nav-item">XDR Integration</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Resources</div>
          <a href="../resources/timeline.html" class="nav-item">Project Timeline</a>
          <a href="../resources/raci.html" class="nav-item">RACI Matrix</a>
          <a href="../resources/infrastructure-reference.html" class="nav-item">Infrastructure Reference</a>
          <a href="../resources/scripts.html" class="nav-item">Scripts & Queries</a>
          <a href="../resources/data-dictionary.html" class="nav-item">Data Dictionary</a>
          <a href="../resources/templates.html" class="nav-item">Templates</a>
          <a href="../resources/splunk-reference.html" class="nav-item">Splunk Reference</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Runbooks</div>
          <a href="../resources/mde-onboarding.html" class="nav-item">MDE Onboarding</a>
          <a href="../resources/mde-offboarding.html" class="nav-item">MDE Offboarding</a>
          <a href="../resources/incident-response.html" class="nav-item">Incident Response</a>
          <a href="../resources/operational-procedures.html" class="nav-item">Operational Procedures</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Troubleshooting</div>
          <a href="../troubleshooting/index.html" class="nav-item">Common Issues</a>
          <a href="../troubleshooting/siem-issues.html" class="nav-item">SIEM Issues</a>
          <a href="../troubleshooting/mde-issues.html" class="nav-item">MDE Issues</a>
          <a href="../troubleshooting/dlp-issues.html" class="nav-item">DLP Issues</a>
          <a href="../troubleshooting/agent-conflicts.html" class="nav-item">Agent Conflicts</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Career</div>
          <a href="../career-narrative.html" class="nav-item">Career Narrative</a>
          <a href="../interview-prep.html" class="nav-item">Interview Prep</a>
        </div>
      </nav>
    </aside>

    <main class="main-content">
      <div class="content-wrapper">
        <nav class="breadcrumb">
          <a href="../index.html" class="breadcrumb-link">Home</a>
          <span class="breadcrumb-separator">/</span>
          <a href="index.html" class="breadcrumb-link">SIEM Migration</a>
          <span class="breadcrumb-separator">/</span>
          <span class="breadcrumb-current">Detection Catalog</span>
        </nav>

        <div class="page-header">
          <h1>RevFlow Detection Catalog</h1>
          <div class="page-header-meta">
            <span class="page-badge siem">SIEM Track</span>
          </div>
          <p class="intro-text">Complete catalog of detection rules for RevFlow Analytics. Includes XDR-native detections (Microsoft-managed), Sentinel custom rules, and cross-domain correlations specific to our Salesforce, Workday, and cloud infrastructure.</p>
        </div>

        <div class="callout info">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>Detection Architecture</div>
          <div class="callout-content">
            <p><strong>XDR-First:</strong> M365 Defender handles endpoint (~150), identity (~85), email (~65), cloud apps (~50) = ~350 detection types</p>
            <p><strong>Sentinel Custom:</strong> Network (85), Azure (65), higher-order (35), DLP (25), custom (22), Linux (18), third-party (15), TI (8) = ~270 rules</p>
            <p><strong>Total Coverage:</strong> ~620 detection types across all domains</p>
          </div>
        </div>

        <!-- ==================== SECTION 1: DETECTION SUMMARY ==================== -->
        <h2>1. Detection Coverage Summary</h2>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Domain</th><th>Source</th><th>Detection Count</th><th>Owner</th><th>Example Scenarios</th></tr>
            </thead>
            <tbody>
              <tr style="background: rgba(59, 130, 246, 0.1);">
                <td><strong>Endpoint</strong></td>
                <td>XDR (MDE)</td>
                <td>~150</td>
                <td>Microsoft-managed</td>
                <td>Malware, ransomware, LOLBins, credential theft</td>
              </tr>
              <tr style="background: rgba(59, 130, 246, 0.1);">
                <td><strong>Identity</strong></td>
                <td>XDR (MDI)</td>
                <td>~85</td>
                <td>Microsoft-managed</td>
                <td>Pass-the-hash, DCSync, Golden Ticket, lateral movement</td>
              </tr>
              <tr style="background: rgba(59, 130, 246, 0.1);">
                <td><strong>Email</strong></td>
                <td>XDR (MDO)</td>
                <td>~65</td>
                <td>Microsoft-managed</td>
                <td>Phishing, BEC, malicious attachments, impersonation</td>
              </tr>
              <tr style="background: rgba(59, 130, 246, 0.1);">
                <td><strong>Cloud Apps</strong></td>
                <td>XDR (MDA)</td>
                <td>~50</td>
                <td>Microsoft-managed</td>
                <td>Impossible travel, mass download, OAuth abuse</td>
              </tr>
              <tr style="background: rgba(34, 197, 94, 0.1);">
                <td><strong>Network</strong></td>
                <td>Sentinel</td>
                <td>85</td>
                <td>RF-SEC-DET</td>
                <td>C2 beaconing, DNS tunneling, lateral movement</td>
              </tr>
              <tr style="background: rgba(34, 197, 94, 0.1);">
                <td><strong>Azure/Cloud</strong></td>
                <td>Sentinel</td>
                <td>65</td>
                <td>RF-SEC-DET</td>
                <td>Privilege escalation, resource abuse, key vault access</td>
              </tr>
              <tr style="background: rgba(34, 197, 94, 0.1);">
                <td><strong>SaaS Apps</strong></td>
                <td>Sentinel</td>
                <td>35</td>
                <td>RF-SEC-DET</td>
                <td>Salesforce bulk export, Workday suspicious access</td>
              </tr>
              <tr style="background: rgba(34, 197, 94, 0.1);">
                <td><strong>DLP Events</strong></td>
                <td>Sentinel</td>
                <td>25</td>
                <td>RF-SEC-DET</td>
                <td>Data exfil correlation, policy bypass attempts</td>
              </tr>
              <tr style="background: rgba(34, 197, 94, 0.1);">
                <td><strong>Custom/RevFlow</strong></td>
                <td>Sentinel</td>
                <td>22</td>
                <td>RF-SEC-DET</td>
                <td>Tier 0 access, project code leakage, VIP monitoring</td>
              </tr>
              <tr style="background: rgba(34, 197, 94, 0.1);">
                <td><strong>Linux Servers</strong></td>
                <td>Sentinel</td>
                <td>18</td>
                <td>RF-SEC-DET</td>
                <td>SSH brute force, privilege escalation, web shells</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- ==================== SECTION 2: REVFLOW CUSTOM DETECTIONS ==================== -->
        <h2>2. RevFlow Custom Detections</h2>

        <h3>2.1 Tier 0 Asset Protection</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Rule ID</th><th>Name</th><th>Severity</th><th>MITRE</th><th>Data Source</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>RF-T0-001</strong></td>
                <td>Domain Controller Logon from Non-Admin Workstation</td>
                <td><span class="status-badge critical">High</span></td>
                <td>T1078</td>
                <td>SecurityEvent, IdentityLogonEvents</td>
              </tr>
              <tr>
                <td><strong>RF-T0-002</strong></td>
                <td>Entra Connect Server Remote Access</td>
                <td><span class="status-badge critical">High</span></td>
                <td>T1021</td>
                <td>SecurityEvent, DeviceLogonEvents</td>
              </tr>
              <tr>
                <td><strong>RF-T0-003</strong></td>
                <td>Certificate Authority Private Key Access</td>
                <td><span class="status-badge critical">Critical</span></td>
                <td>T1552.004</td>
                <td>SecurityEvent (4663, 4656)</td>
              </tr>
              <tr>
                <td><strong>RF-T0-004</strong></td>
                <td>RF-SEC-GlobalAdmins Group Modification</td>
                <td><span class="status-badge critical">Critical</span></td>
                <td>T1098</td>
                <td>AuditLogs</td>
              </tr>
              <tr>
                <td><strong>RF-T0-005</strong></td>
                <td>Privileged Role Activation Outside Business Hours</td>
                <td><span class="status-badge complete">Medium</span></td>
                <td>T1078.004</td>
                <td>AuditLogs (PIM)</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">KQL - RF-T0-001: DC Logon from Non-Admin Workstation</span><button class="code-copy-btn">Copy</button></div>
          <pre><code>// RF-T0-001: Domain Controller Logon from Non-Admin Workstation
// Detects interactive logons to DCs from workstations not in admin tier
// Owner: RF-SEC-DET | Severity: High | MITRE: T1078

let DomainControllers = dynamic(["RF-TOR-SRV-DC-01", "RF-TOR-SRV-DC-02", "RF-VAN-SRV-DC-01", 
                                  "RF-BLR-SRV-DC-01", "RF-SFO-SRV-DC-01", "RF-NYC-SRV-DC-01"]);
let AdminWorkstations = dynamic(["RF-TOR-PAW-01", "RF-TOR-PAW-02", "RF-VAN-PAW-01", "RF-BLR-PAW-01"]);
let AllowedAdminAccounts = dynamic(["svc-ad-admin", "svc-entra-connect"]);

SecurityEvent
| where TimeGenerated > ago(1h)
| where Computer in (DomainControllers)
| where EventID in (4624, 4625)  // Successful and failed logons
| where LogonType in (2, 10, 11)  // Interactive, RemoteInteractive, CachedInteractive
| where WorkstationName !in (AdminWorkstations)
| where TargetUserName !in (AllowedAdminAccounts)
| where TargetUserName !endswith "$"  // Exclude computer accounts
| project TimeGenerated, Computer, TargetUserName, WorkstationName, LogonType, IpAddress
| extend Severity = "High"
| extend AlertTitle = strcat("DC logon from non-admin workstation: ", WorkstationName, " → ", Computer)
| extend MITRE = "T1078 - Valid Accounts"</code></pre>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">KQL - RF-T0-004: GlobalAdmins Group Modification</span><button class="code-copy-btn">Copy</button></div>
          <pre><code>// RF-T0-004: RF-SEC-GlobalAdmins Group Modification
// Detects any changes to the Global Administrators security group
// Owner: RF-SEC-DET | Severity: Critical | MITRE: T1098

let ProtectedGroups = dynamic(["RF-SEC-GlobalAdmins", "RF-SEC-SecurityAdmins", 
                               "RF-AD-DomainAdmins", "RF-SEC-PrivilegedUsers"]);

AuditLogs
| where TimeGenerated > ago(1h)
| where OperationName has_any ("Add member", "Remove member", "Update group")
| where TargetResources[0].displayName in (ProtectedGroups)
| extend InitiatedBy = tostring(InitiatedBy.user.userPrincipalName)
| extend TargetGroup = tostring(TargetResources[0].displayName)
| extend ModifiedMember = tostring(TargetResources[0].modifiedProperties[0].newValue)
| project TimeGenerated, InitiatedBy, OperationName, TargetGroup, ModifiedMember, CorrelationId
| extend Severity = "Critical"
| extend AlertTitle = strcat("Protected group modified: ", TargetGroup)
| extend MITRE = "T1098 - Account Manipulation"</code></pre>
        </div>

        <h3>2.2 Salesforce Security Monitoring</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Rule ID</th><th>Name</th><th>Severity</th><th>Trigger</th><th>Data Source</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>RF-SF-001</strong></td>
                <td>Salesforce Bulk Data Export</td>
                <td><span class="status-badge critical">High</span></td>
                <td>>1000 records exported in 1 hour</td>
                <td>Salesforce_CL via Sentinel connector</td>
              </tr>
              <tr>
                <td><strong>RF-SF-002</strong></td>
                <td>Salesforce Login from New Country</td>
                <td><span class="status-badge complete">Medium</span></td>
                <td>Login from country not in user's history</td>
                <td>Salesforce_CL, SigninLogs</td>
              </tr>
              <tr>
                <td><strong>RF-SF-003</strong></td>
                <td>Salesforce Report Export After Hours</td>
                <td><span class="status-badge complete">Medium</span></td>
                <td>Report export outside 6AM-9PM local</td>
                <td>Salesforce_CL</td>
              </tr>
              <tr>
                <td><strong>RF-SF-004</strong></td>
                <td>Salesforce Admin Permission Change</td>
                <td><span class="status-badge critical">High</span></td>
                <td>Profile or permission set modified</td>
                <td>Salesforce_CL</td>
              </tr>
              <tr>
                <td><strong>RF-SF-005</strong></td>
                <td>Salesforce API Key Created</td>
                <td><span class="status-badge complete">Medium</span></td>
                <td>New connected app or API key</td>
                <td>Salesforce_CL</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">KQL - RF-SF-001: Salesforce Bulk Data Export</span><button class="code-copy-btn">Copy</button></div>
          <pre><code>// RF-SF-001: Salesforce Bulk Data Export Detection
// Detects when a user exports large amounts of customer data
// Owner: RF-SEC-DET | Severity: High | MITRE: T1567 (Exfiltration Over Web Service)

Salesforce_CL
| where TimeGenerated > ago(1h)
| where EventType_s in ("ReportExport", "DataExport", "ListView")
| where RecordsProcessed_d > 100  // Threshold for significant export
| summarize 
    TotalRecords = sum(RecordsProcessed_d),
    ExportCount = count(),
    Reports = make_set(ReportName_s)
    by UserId_s, UserName_s, bin(TimeGenerated, 1h)
| where TotalRecords > 1000  // Alert threshold
| extend Severity = case(
    TotalRecords > 10000, "Critical",
    TotalRecords > 5000, "High",
    "Medium")
| extend AlertTitle = strcat("Bulk Salesforce export by ", UserName_s, ": ", TotalRecords, " records")
| extend MITRE = "T1567 - Exfiltration Over Web Service"

// Enrich with user context
| join kind=leftouter (
    IdentityInfo
    | project AccountUPN, Department, JobTitle, ManagerUPN
) on $left.UserName_s == $right.AccountUPN</code></pre>
        </div>

        <h3>2.3 Workday HR System Monitoring</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Rule ID</th><th>Name</th><th>Severity</th><th>Trigger</th><th>Data Source</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>RF-WD-001</strong></td>
                <td>Workday Compensation Report Access</td>
                <td><span class="status-badge complete">Medium</span></td>
                <td>Access to comp reports by non-HR</td>
                <td>Workday_CL</td>
              </tr>
              <tr>
                <td><strong>RF-WD-002</strong></td>
                <td>Workday Bulk Employee Export</td>
                <td><span class="status-badge critical">High</span></td>
                <td>>100 employee records exported</td>
                <td>Workday_CL</td>
              </tr>
              <tr>
                <td><strong>RF-WD-003</strong></td>
                <td>Workday Terminated Employee Access</td>
                <td><span class="status-badge critical">High</span></td>
                <td>Access after termination date</td>
                <td>Workday_CL, SigninLogs</td>
              </tr>
              <tr>
                <td><strong>RF-WD-004</strong></td>
                <td>Workday Security Role Change</td>
                <td><span class="status-badge complete">Medium</span></td>
                <td>Security role assigned/removed</td>
                <td>Workday_CL</td>
              </tr>
            </tbody>
          </table>
        </div>

        <h3>2.4 Financial Systems (NetSuite)</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Rule ID</th><th>Name</th><th>Severity</th><th>Trigger</th><th>Data Source</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>RF-NS-001</strong></td>
                <td>NetSuite Financial Report Export</td>
                <td><span class="status-badge complete">Medium</span></td>
                <td>P&L, Balance Sheet export</td>
                <td>NetSuite_CL</td>
              </tr>
              <tr>
                <td><strong>RF-NS-002</strong></td>
                <td>NetSuite Vendor/Payment Modification</td>
                <td><span class="status-badge critical">High</span></td>
                <td>Vendor bank details changed</td>
                <td>NetSuite_CL</td>
              </tr>
              <tr>
                <td><strong>RF-NS-003</strong></td>
                <td>NetSuite Admin Role Assignment</td>
                <td><span class="status-badge critical">High</span></td>
                <td>Administrator role granted</td>
                <td>NetSuite_CL</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- ==================== SECTION 3: CROSS-DOMAIN CORRELATIONS ==================== -->
        <h2>3. Cross-Domain Correlation Rules</h2>

        <p>These rules correlate events across multiple data sources to detect sophisticated attacks that span domains.</p>

        <h3>3.1 Data Exfiltration Correlations</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Rule ID</th><th>Name</th><th>Correlation</th><th>Severity</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>RF-COR-001</strong></td>
                <td>Salesforce Export + DLP Alert + USB Copy</td>
                <td>Salesforce_CL + DLP Events + DeviceFileEvents</td>
                <td><span class="status-badge critical">Critical</span></td>
              </tr>
              <tr>
                <td><strong>RF-COR-002</strong></td>
                <td>Terminated Employee + Active Salesforce Session</td>
                <td>Workday_CL (term) + Salesforce_CL (active)</td>
                <td><span class="status-badge critical">Critical</span></td>
              </tr>
              <tr>
                <td><strong>RF-COR-003</strong></td>
                <td>VPN from New Location + Bulk Download</td>
                <td>SigninLogs (VPN) + CloudAppEvents (download)</td>
                <td><span class="status-badge critical">High</span></td>
              </tr>
              <tr>
                <td><strong>RF-COR-004</strong></td>
                <td>Failed MFA + Successful Login (MFA Fatigue)</td>
                <td>SigninLogs (MFA failures) + SigninLogs (success)</td>
                <td><span class="status-badge critical">High</span></td>
              </tr>
              <tr>
                <td><strong>RF-COR-005</strong></td>
                <td>GitHub Secret Commit + External Email</td>
                <td>GitHub audit + EmailEvents (external)</td>
                <td><span class="status-badge critical">High</span></td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">KQL - RF-COR-001: Salesforce Export + DLP + USB Chain</span><button class="code-copy-btn">Copy</button></div>
          <pre><code>// RF-COR-001: Salesforce Export → DLP Alert → USB Copy Chain
// Detects potential data theft: SF export, DLP trigger, USB exfil
// Owner: RF-SEC-DET | Severity: Critical | MITRE: T1567, T1052

// Step 1: Find Salesforce exports in last 24h
let SalesforceExports = Salesforce_CL
| where TimeGenerated > ago(24h)
| where EventType_s in ("ReportExport", "DataExport")
| where RecordsProcessed_d > 500
| project SF_Time = TimeGenerated, UserId_s, UserName_s, RecordsProcessed_d;

// Step 2: Find DLP alerts for customer data
let DLPAlerts = SecurityAlert
| where TimeGenerated > ago(24h)
| where AlertName has "Customer Data" or AlertName has "RF-SIT-Salesforce"
| extend UserPrincipalName = tostring(parse_json(ExtendedProperties)["User Principal Name"])
| project DLP_Time = TimeGenerated, UserPrincipalName, AlertName;

// Step 3: Find USB file copies
let USBCopies = DeviceFileEvents
| where TimeGenerated > ago(24h)
| where ActionType == "FileCreated"
| where FolderPath startswith "E:\\" or FolderPath startswith "F:\\" // Removable drives
| where FileName endswith ".csv" or FileName endswith ".xlsx"
| extend AccountUpn = InitiatingProcessAccountUpn
| project USB_Time = TimeGenerated, DeviceName, FileName, AccountUpn;

// Correlate: Same user, within 4 hour window
SalesforceExports
| join kind=inner (DLPAlerts) on $left.UserName_s == $right.UserPrincipalName
| where DLP_Time between (SF_Time .. SF_Time + 4h)
| join kind=inner (USBCopies) on $left.UserName_s == $right.AccountUpn
| where USB_Time between (SF_Time .. SF_Time + 6h)
| project SF_Time, DLP_Time, USB_Time, UserName_s, RecordsProcessed_d, AlertName, DeviceName, FileName
| extend Severity = "Critical"
| extend AlertTitle = strcat("DATA EXFIL CHAIN: ", UserName_s, " - SF Export → DLP Alert → USB Copy")
| extend MITRE = "T1567, T1052 - Exfiltration Over Web Service, Exfiltration Over Physical Medium"</code></pre>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">KQL - RF-COR-002: Terminated Employee Active Access</span><button class="code-copy-btn">Copy</button></div>
          <pre><code>// RF-COR-002: Terminated Employee with Active Salesforce/Workday Session
// Correlates Workday termination with continued application access
// Owner: RF-SEC-DET | Severity: Critical | MITRE: T1078

// Get recent terminations from Workday
let Terminations = Workday_CL
| where TimeGenerated > ago(7d)
| where EventType_s == "Termination"
| project EmployeeID_s, TerminatedUser = Email_s, TerminationDate = TimeGenerated;

// Check for active sessions after termination
let PostTermActivity = union
    (SigninLogs | project TimeGenerated, UserPrincipalName, AppDisplayName, ResultType),
    (Salesforce_CL | project TimeGenerated, UserPrincipalName = UserName_s, AppDisplayName = "Salesforce", ResultType = "Success"),
    (AADNonInteractiveUserSignInLogs | project TimeGenerated, UserPrincipalName, AppDisplayName, ResultType)
| where ResultType == 0 or ResultType == "Success"
| project ActivityTime = TimeGenerated, UserPrincipalName, AppDisplayName;

// Correlate
Terminations
| join kind=inner (PostTermActivity) on $left.TerminatedUser == $right.UserPrincipalName
| where ActivityTime > TerminationDate
| project TerminationDate, ActivityTime, TerminatedUser, AppDisplayName,
          HoursAfterTerm = datetime_diff('hour', ActivityTime, TerminationDate)
| where HoursAfterTerm > 0  // Activity after termination
| extend Severity = "Critical"
| extend AlertTitle = strcat("TERMINATED USER ACTIVE: ", TerminatedUser, " accessed ", AppDisplayName, 
                             " ", HoursAfterTerm, " hours after termination")</code></pre>
        </div>

        <h3>3.2 Identity Attack Correlations</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Rule ID</th><th>Name</th><th>Correlation</th><th>Severity</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>RF-COR-010</strong></td>
                <td>Password Spray + Successful Login</td>
                <td>SigninLogs (failures across users) + SigninLogs (success)</td>
                <td><span class="status-badge critical">High</span></td>
              </tr>
              <tr>
                <td><strong>RF-COR-011</strong></td>
                <td>Impossible Travel + Privileged Action</td>
                <td>SigninLogs (geo-anomaly) + AuditLogs (admin action)</td>
                <td><span class="status-badge critical">Critical</span></td>
              </tr>
              <tr>
                <td><strong>RF-COR-012</strong></td>
                <td>Entra Connect Compromise Chain</td>
                <td>DeviceLogonEvents (AAD server) + AuditLogs (sync changes)</td>
                <td><span class="status-badge critical">Critical</span></td>
              </tr>
              <tr>
                <td><strong>RF-COR-013</strong></td>
                <td>Service Account Anomaly + Data Access</td>
                <td>SigninLogs (svc-* unusual) + CloudAppEvents</td>
                <td><span class="status-badge critical">High</span></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- ==================== SECTION 4: LOCATION-SPECIFIC RULES ==================== -->
        <h2>4. Location-Specific Detections</h2>

        <p>Rules scoped to specific RevFlow office locations and their unique risk profiles.</p>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Rule ID</th><th>Name</th><th>Location</th><th>Trigger</th><th>Rationale</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>RF-LOC-TOR-001</strong></td>
                <td>Toronto DC Tier 0 Access</td>
                <td>RF-CA-TOR</td>
                <td>Logon to RF-TOR-SRV-DC-* from non-PAW</td>
                <td>HQ DCs are primary targets</td>
              </tr>
              <tr>
                <td><strong>RF-LOC-BLR-001</strong></td>
                <td>Bangalore After-Hours Admin Activity</td>
                <td>RF-IN-BLR</td>
                <td>Admin actions outside 6AM-11PM IST</td>
                <td>Large dev team, off-hours risk</td>
              </tr>
              <tr>
                <td><strong>RF-LOC-SFO-001</strong></td>
                <td>SF Office Salesforce Mass Export</td>
                <td>RF-US-SFO</td>
                <td>Sales team bulk customer export</td>
                <td>Sales HQ, customer data risk</td>
              </tr>
              <tr>
                <td><strong>RF-LOC-VPN-001</strong></td>
                <td>VPN from Unexpected Country</td>
                <td>All</td>
                <td>VPN login from non-CA/US/IN</td>
                <td>Travel baseline: CA, US, IN, DE, UK</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">KQL - RF-LOC-VPN-001: VPN from Unexpected Country</span><button class="code-copy-btn">Copy</button></div>
          <pre><code>// RF-LOC-VPN-001: VPN Login from Unexpected Country
// RevFlow baseline: CA, US, IN (offices), DE, UK (Siemens, common travel)
// Owner: RF-SEC-DET | Severity: Medium | MITRE: T1078

let ExpectedCountries = dynamic(["CA", "US", "IN", "DE", "UK", "GB"]);
let VPNAppIds = dynamic(["app-id-for-globalprotect", "app-id-for-azurevpn"]);  // Replace with actual

SigninLogs
| where TimeGenerated > ago(1h)
| where AppId in (VPNAppIds) or AppDisplayName has "VPN"
| where ResultType == 0  // Successful
| extend Country = tostring(LocationDetails.countryOrRegion)
| where Country !in (ExpectedCountries)
| project TimeGenerated, UserPrincipalName, Country, City = tostring(LocationDetails.city),
          IPAddress, DeviceDetail, AppDisplayName
| extend Severity = "Medium"
| extend AlertTitle = strcat("VPN login from unexpected country: ", UserPrincipalName, " from ", Country)

// Exclude known travelers (optional watchlist)
| join kind=leftanti (
    _GetWatchlist('ApprovedTravelers')
    | project UserPrincipalName = SearchKey
) on UserPrincipalName</code></pre>
        </div>

        <!-- ==================== SECTION 5: COMPLIANCE DETECTIONS ==================== -->
        <h2>5. Compliance-Aligned Detections</h2>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Compliance</th><th>Control</th><th>Rule ID</th><th>Detection</th></tr>
            </thead>
            <tbody>
              <tr>
                <td rowspan="3"><strong>SOC 2</strong></td>
                <td>CC6.1 - Logical Access</td>
                <td>RF-SOC2-001</td>
                <td>Unauthorized privileged access attempt</td>
              </tr>
              <tr>
                <td>CC6.7 - Data Transmission</td>
                <td>RF-SOC2-002</td>
                <td>Unencrypted sensitive data transfer</td>
              </tr>
              <tr>
                <td>CC7.2 - Incident Response</td>
                <td>RF-SOC2-003</td>
                <td>Critical alert not acknowledged in SLA</td>
              </tr>
              <tr>
                <td rowspan="2"><strong>ISO 27001</strong></td>
                <td>A.9.2.3 - Privilege Management</td>
                <td>RF-ISO-001</td>
                <td>Privilege escalation without approval</td>
              </tr>
              <tr>
                <td>A.12.4.1 - Event Logging</td>
                <td>RF-ISO-002</td>
                <td>Log source stopped sending events</td>
              </tr>
              <tr>
                <td rowspan="2"><strong>PIPEDA</strong></td>
                <td>4.7 - Safeguards</td>
                <td>RF-PIP-001</td>
                <td>Canadian employee PII accessed without authorization</td>
              </tr>
              <tr>
                <td>4.9 - Individual Access</td>
                <td>RF-PIP-002</td>
                <td>Bulk employee data export (potential breach)</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- ==================== SECTION 6: MITRE COVERAGE ==================== -->
        <h2>6. MITRE ATT&CK Coverage</h2>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">MITRE Coverage Summary</span></div>
          <pre><code>REVFLOW MITRE ATT&CK COVERAGE (Enterprise)
═══════════════════════════════════════════════════════════════════════════════

INITIAL ACCESS (TA0001)                    PERSISTENCE (TA0003)
├── T1078 Valid Accounts: ✓ High           ├── T1098 Account Manipulation: ✓ High  
├── T1566 Phishing: ✓ XDR (MDO)            ├── T1136 Create Account: ✓ High
└── T1199 Trusted Relationship: ✓ Med      └── T1053 Scheduled Task: ✓ XDR (MDE)

PRIVILEGE ESCALATION (TA0004)              DEFENSE EVASION (TA0005)
├── T1068 Exploitation: ✓ XDR (MDE)        ├── T1070 Indicator Removal: ✓ Med
├── T1078 Valid Accounts: ✓ High           ├── T1562 Impair Defenses: ✓ High
└── T1134 Access Token: ✓ XDR (MDE)        └── T1036 Masquerading: ✓ XDR (MDE)

CREDENTIAL ACCESS (TA0006)                 DISCOVERY (TA0007)
├── T1003 OS Credential Dump: ✓ XDR        ├── T1087 Account Discovery: ✓ Med
├── T1110 Brute Force: ✓ High              ├── T1082 System Info: ✓ XDR (MDE)
└── T1558 Steal Kerberos: ✓ XDR (MDI)      └── T1069 Permission Groups: ✓ Med

LATERAL MOVEMENT (TA0008)                  COLLECTION (TA0009)
├── T1021 Remote Services: ✓ High          ├── T1005 Data from Local: ✓ XDR
├── T1550 Use Alt Auth: ✓ XDR (MDI)        ├── T1213 Data from Info Repos: ✓ High
└── T1570 Lateral Tool Transfer: ✓ Med     └── T1560 Archive Collected: ✓ Med

EXFILTRATION (TA0010)                      IMPACT (TA0040)
├── T1041 Exfil Over C2: ✓ Med             ├── T1486 Data Encrypted: ✓ XDR (MDE)
├── T1567 Exfil Over Web: ✓ High           ├── T1490 Inhibit Recovery: ✓ High
└── T1052 Exfil Over Physical: ✓ High      └── T1489 Service Stop: ✓ Med

LEGEND: ✓ XDR = Microsoft-managed | ✓ High/Med = Sentinel custom rule</code></pre>
        </div>

        <!-- ==================== SECTION 7: RULE LIFECYCLE ==================== -->
        <h2>7. Detection Rule Lifecycle</h2>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Stage</th><th>Duration</th><th>Actions</th><th>Approval</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Development</strong></td>
                <td>1-2 weeks</td>
                <td>Write KQL, test in dev workspace, document</td>
                <td>RF-SEC-DET peer review</td>
              </tr>
              <tr>
                <td><strong>Testing</strong></td>
                <td>1 week</td>
                <td>Run in audit mode, validate against test cases</td>
                <td>RF-SEC-DET lead</td>
              </tr>
              <tr>
                <td><strong>Pilot</strong></td>
                <td>2 weeks</td>
                <td>Enable for SOC review, collect false positives</td>
                <td>RF-SEC-SOC-L3</td>
              </tr>
              <tr>
                <td><strong>Production</strong></td>
                <td>Ongoing</td>
                <td>Full alerting, playbook integration</td>
                <td>Security CAB</td>
              </tr>
              <tr>
                <td><strong>Tuning</strong></td>
                <td>Quarterly</td>
                <td>Review FP rate, adjust thresholds</td>
                <td>RF-SEC-DET</td>
              </tr>
              <tr>
                <td><strong>Retirement</strong></td>
                <td>As needed</td>
                <td>Disable when superseded or no longer relevant</td>
                <td>Security CAB</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="callout success">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Interview-Ready Summary</div>
          <div class="callout-content">
            <p><em>"Our detection strategy at RevFlow is XDR-first — Microsoft manages ~350 detections for endpoint, identity, email, and cloud apps. Sentinel adds ~270 custom rules for gaps: network telemetry, SaaS apps like Salesforce and Workday, and cross-domain correlations. Key custom detections include Salesforce bulk export monitoring, terminated employee access correlation with Workday, and Tier 0 asset protection for our domain controllers. We scope rules by location — Toronto HQ has stricter DC monitoring, Bangalore has after-hours alerting for the dev team, San Francisco monitors Sales team customer data access. Everything maps to MITRE ATT&CK for coverage analysis and SOC 2/ISO 27001 for compliance."</em></p>
          </div>
        </div>

      </div>
    </main>
  </div>
  <script src="../js/main.js"></script>
</body>
</html>
