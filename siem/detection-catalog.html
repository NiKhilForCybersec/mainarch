<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detection Catalog | Security Transformation</title>
  <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
  <div class="layout">
        <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="sidebar-logo-icon">RF</div>
          <div class="sidebar-logo-text">
            <span class="sidebar-logo-title">Security Transformation</span>
            <span class="sidebar-logo-subtitle">RevFlow Analytics</span>
          </div>
        </div>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Overview</div>
          <a href="../index.html" class="nav-item">Executive Summary</a>
          <a href="../company-profile.html" class="nav-item">Company Profile</a>
          <a href="../security-framework.html" class="nav-item">Security Framework</a>
          <a href="../program-structure.html" class="nav-item">Program Structure</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">SIEM Migration</div>
          <a href="../siem/index.html" class="nav-item">SIEM Overview</a>
          <a href="../siem/discovery.html" class="nav-item">Discovery & Assessment</a>
          <a href="../siem/log-sources.html" class="nav-item">Log Source Strategy</a>
          <a href="../siem/log-engineering.html" class="nav-item">Log Engineering</a>
          <a href="../siem/detection-engineering.html" class="nav-item">Detection Engineering</a>
          <a href="../siem/detection-catalog.html" class="nav-item active">Detection Catalog</a>
          <a href="../siem/soc-transition.html" class="nav-item">SOC Transition</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">EDR Migration</div>
          <a href="../edr/index.html" class="nav-item">EDR Overview</a>
          <a href="../edr/deployment.html" class="nav-item">MDE Deployment</a>
          <a href="../edr/asr-rules.html" class="nav-item">ASR Rules</a>
          <a href="../edr/coexistence.html" class="nav-item">Coexistence Strategy</a>
          <a href="../edr/eset-removal.html" class="nav-item">ESET Removal</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">DLP Migration</div>
          <a href="../dlp/index.html" class="nav-item">DLP Overview</a>
          <a href="../dlp/policy-translation.html" class="nav-item">Policy Translation</a>
          <a href="../dlp/rollout-phases.html" class="nav-item">Rollout Phases</a>
          <a href="../dlp/user-communication.html" class="nav-item">User Communication</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Identity & Access</div>
          <a href="../identity/index.html" class="nav-item">Identity Overview</a>
          <a href="../identity/hybrid-setup.html" class="nav-item">Hybrid Identity</a>
          <a href="../identity/conditional-access.html" class="nav-item">Conditional Access</a>
          <a href="../identity/pim.html" class="nav-item">PIM Configuration</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Infrastructure</div>
          <a href="../infrastructure/index.html" class="nav-item">Infrastructure Overview</a>
          <a href="../infrastructure/landing-zone.html" class="nav-item">Landing Zone</a>
          <a href="../infrastructure/network-architecture.html" class="nav-item">Network Architecture</a>
          <a href="../infrastructure/workload-migration.html" class="nav-item">Workload Migration</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Operations</div>
          <a href="../operations/parallel-ops.html" class="nav-item">Parallel Operations</a>
          <a href="../operations/soc-workflows.html" class="nav-item">SOC Workflows</a>
          <a href="../operations/integration.html" class="nav-item">Platform Integration</a>
          <a href="../operations/xdr-integration.html" class="nav-item">XDR Integration</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Resources</div>
          <a href="../resources/timeline.html" class="nav-item">Project Timeline</a>
          <a href="../resources/raci.html" class="nav-item">RACI Matrix</a>
          <a href="../resources/scripts.html" class="nav-item">Scripts & Queries</a>
          <a href="../resources/data-dictionary.html" class="nav-item">Data Dictionary</a>
          <a href="../resources/templates.html" class="nav-item">Templates</a>
          <a href="../resources/splunk-reference.html" class="nav-item">Splunk Reference</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Runbooks</div>
          <a href="../resources/mde-onboarding.html" class="nav-item">MDE Onboarding</a>
          <a href="../resources/mde-offboarding.html" class="nav-item">MDE Offboarding</a>
          <a href="../resources/incident-response.html" class="nav-item">Incident Response</a>
          <a href="../resources/operational-procedures.html" class="nav-item">Operational Procedures</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Troubleshooting</div>
          <a href="../troubleshooting/index.html" class="nav-item">Common Issues</a>
          <a href="../troubleshooting/siem-issues.html" class="nav-item">SIEM Issues</a>
          <a href="../troubleshooting/mde-issues.html" class="nav-item">MDE Issues</a>
          <a href="../troubleshooting/dlp-issues.html" class="nav-item">DLP Issues</a>
          <a href="../troubleshooting/agent-conflicts.html" class="nav-item">Agent Conflicts</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Career</div>
          <a href="../career-narrative.html" class="nav-item">Career Narrative</a>
          <a href="../interview-prep.html" class="nav-item">Interview Prep</a>
        </div>
      </nav>
    </aside>

    <main class="main-content">
      <div class="content-wrapper">
        
        <nav class="breadcrumb">
          <a href="../index.html">Home</a>
          <span class="breadcrumb-separator">/</span>
          <a href="index.html">SIEM Migration</a>
          <span class="breadcrumb-separator">/</span>
          <span class="breadcrumb-current">Detection Catalog</span>
        </nav>

        <div class="page-header">
          <h1>Detection Catalog</h1>
          <div class="page-header-meta">
            <span class="page-badge siem">SIEM Track</span>
            <span class="page-reading-time">Comprehensive Reference</span>
          </div>
          <p class="intro-text">
            Complete reference for detection engineering following the <strong>XDR-first approach</strong>: XDR handles endpoint, identity, and email detection natively while Sentinel owns network, Azure, custom apps, and higher-order correlation. This right-sized approach results in ~270 Sentinel rules (not 500+) from Day 1.
          </p>
        </div>

        <div class="callout warning">
          <div class="callout-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>
            XDR-First Detection Strategy
          </div>
          <div class="callout-content">
            <p><strong>Key Insight:</strong> In the Microsoft ecosystem, correlation is layered â€” XDR handles endpoint + identity + email correlation upstream, and Sentinel handles network + Azure + custom apps. Don't rebuild detections XDR handles natively.</p>
            <p><strong>Result:</strong></p>
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
              <li><strong>XDR Handles:</strong> ~350 detection categories (endpoint, identity, email, cloud apps)</li>
              <li><strong>Sentinel Owns:</strong> ~270 rules (network, Azure, DLP, custom, higher-order)</li>
              <li><strong>Benefit:</strong> Right-sized effort, 12-month timeline, XDR correlation from Day 1</li>
            </ul>
            <p style="margin-top: 0.5rem;">ðŸ‘‰ <strong><a href="../operations/xdr-integration.html">Full XDR-First Strategy Documentation â†’</a></strong></p>
          </div>
        </div>

        <div class="callout info">
          <div class="callout-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
            Detection Catalog Overview
          </div>
          <div class="callout-content">
            <p><strong>Microsoft Sentinel Content Hub</strong> provides 250+ solutions with 1,050+ analytics rule templates. For our environment (4,000 employees, 9,000 endpoints), we deployed 12 solutions focused on Sentinel's domain (network, Azure, DLP) and enabled <strong>~270 detection rules</strong>.</p>
            <p><strong>Detection Ownership:</strong></p>
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
              <li><strong>XDR (M365 Defender):</strong> Endpoint, identity, email, cloud app detection â€” automatic, Microsoft-managed</li>
              <li><strong>Sentinel:</strong> Network, Azure, DLP, custom apps, higher-order correlation â€” ~270 user-authored rules</li>
            </ul>
          </div>
        </div>

        <div class="callout success">
          <div class="callout-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
            XDR Detection Model â‰  SIEM Detection Model
          </div>
          <div class="callout-content">
            <p><strong>This catalog contains Sentinel rules only â€” not XDR detections.</strong> XDR detections are:</p>
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
              <li><strong>Microsoft-managed</strong> â€” you cannot see the exact logic, cannot edit them</li>
              <li><strong>Behavior + ML-based</strong> â€” continuously updated by Microsoft</li>
              <li><strong>Automatic correlation</strong> â€” no correlation rules to configure</li>
            </ul>
            <p style="margin-top: 0.5rem;">XDR handles ~350 detection categories automatically. This catalog documents the ~270 Sentinel rules for domains XDR doesn't cover. The phrase "XDR detection rules" is almost a misnomer â€” XDR has detections, but they're not rules you author.</p>
          </div>
        </div>

        <!-- ==================== SECTION 1: CONNECTORS ==================== -->
        <h2>1. Data Connectors & Tables</h2>

        <p>These are the built-in connectors deployed during the migration, the tables they populate, and whether data is free or billable.</p>

        <h3>1.1 Microsoft 365 Defender Connector</h3>

        <div class="callout success">
          <div class="callout-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
            Free Ingestion â€” M365 Defender Data Grant
          </div>
          <div class="callout-content">
            <p>All Device* tables from MDE are <strong>free</strong> when ingested via the M365 Defender connector. This is a massive cost savings (~$12,000/month in our environment).</p>
          </div>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Table</th><th>Source</th><th>Description</th><th>Key Fields</th><th>Cost</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><code>DeviceProcessEvents</code></td>
                <td>MDE</td>
                <td>Process creation and execution</td>
                <td>ProcessCommandLine, FileName, FolderPath, InitiatingProcessFileName, AccountName</td>
                <td><span class="status-badge complete">Free</span></td>
              </tr>
              <tr>
                <td><code>DeviceNetworkEvents</code></td>
                <td>MDE</td>
                <td>Network connections and DNS</td>
                <td>RemoteIP, RemotePort, RemoteUrl, InitiatingProcessFileName, Protocol</td>
                <td><span class="status-badge complete">Free</span></td>
              </tr>
              <tr>
                <td><code>DeviceFileEvents</code></td>
                <td>MDE</td>
                <td>File creation, modification, deletion</td>
                <td>FileName, FolderPath, SHA256, FileSize, ActionType</td>
                <td><span class="status-badge complete">Free</span></td>
              </tr>
              <tr>
                <td><code>DeviceRegistryEvents</code></td>
                <td>MDE</td>
                <td>Registry modifications</td>
                <td>RegistryKey, RegistryValueName, RegistryValueData, ActionType</td>
                <td><span class="status-badge complete">Free</span></td>
              </tr>
              <tr>
                <td><code>DeviceLogonEvents</code></td>
                <td>MDE</td>
                <td>Local and network logons</td>
                <td>LogonType, AccountName, AccountDomain, RemoteIP, IsLocalAdmin</td>
                <td><span class="status-badge complete">Free</span></td>
              </tr>
              <tr>
                <td><code>DeviceImageLoadEvents</code></td>
                <td>MDE</td>
                <td>DLL and driver loads</td>
                <td>FileName, FolderPath, SHA256, InitiatingProcessFileName</td>
                <td><span class="status-badge complete">Free</span></td>
              </tr>
              <tr>
                <td><code>DeviceEvents</code></td>
                <td>MDE</td>
                <td>Miscellaneous events (ASR, tamper protection, etc.)</td>
                <td>ActionType, AdditionalFields, RemoteUrl</td>
                <td><span class="status-badge complete">Free</span></td>
              </tr>
              <tr>
                <td><code>DeviceInfo</code></td>
                <td>MDE</td>
                <td>Device inventory and health</td>
                <td>DeviceName, OSPlatform, OSVersion, OnboardingStatus</td>
                <td><span class="status-badge complete">Free</span></td>
              </tr>
              <tr>
                <td><code>DeviceFileCertificateInfo</code></td>
                <td>MDE</td>
                <td>Certificate information for files</td>
                <td>Signer, SignerHash, IsTrusted</td>
                <td><span class="status-badge complete">Free</span></td>
              </tr>
              <tr>
                <td><code>AlertEvidence</code></td>
                <td>M365 Defender</td>
                <td>Evidence associated with alerts</td>
                <td>EntityType, EvidenceRole, SHA256, FileName</td>
                <td><span class="status-badge complete">Free</span></td>
              </tr>
              <tr>
                <td><code>AlertInfo</code></td>
                <td>M365 Defender</td>
                <td>Alert metadata</td>
                <td>AlertId, Title, Severity, Category, ServiceSource</td>
                <td><span class="status-badge complete">Free</span></td>
              </tr>
            </tbody>
          </table>
        </div>

        <h3>1.2 Microsoft Entra ID (Azure AD) Connector</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Table</th><th>Description</th><th>Key Fields</th><th>Cost</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><code>SigninLogs</code></td>
                <td>Interactive and non-interactive sign-ins</td>
                <td>UserPrincipalName, IPAddress, Location, ResultType, AppDisplayName, ConditionalAccessStatus</td>
                <td><span class="status-badge in-progress">Billable</span></td>
              </tr>
              <tr>
                <td><code>AADNonInteractiveUserSignInLogs</code></td>
                <td>Service principal and app sign-ins</td>
                <td>UserPrincipalName, IPAddress, AppDisplayName, ResourceDisplayName</td>
                <td><span class="status-badge in-progress">Billable</span></td>
              </tr>
              <tr>
                <td><code>AADServicePrincipalSignInLogs</code></td>
                <td>Service principal authentication</td>
                <td>ServicePrincipalId, IPAddress, ResourceDisplayName</td>
                <td><span class="status-badge in-progress">Billable</span></td>
              </tr>
              <tr>
                <td><code>AADManagedIdentitySignInLogs</code></td>
                <td>Managed identity authentication</td>
                <td>ServicePrincipalId, ResourceDisplayName</td>
                <td><span class="status-badge in-progress">Billable</span></td>
              </tr>
              <tr>
                <td><code>AuditLogs</code></td>
                <td>Directory changes and admin actions</td>
                <td>OperationName, Result, TargetResources, InitiatedBy</td>
                <td><span class="status-badge in-progress">Billable</span></td>
              </tr>
              <tr>
                <td><code>AADRiskyUsers</code></td>
                <td>Users flagged by Identity Protection</td>
                <td>UserPrincipalName, RiskLevel, RiskState, RiskDetail</td>
                <td><span class="status-badge in-progress">Billable</span></td>
              </tr>
              <tr>
                <td><code>AADUserRiskEvents</code></td>
                <td>Risk detection events</td>
                <td>RiskEventType, RiskLevel, UserPrincipalName, IPAddress</td>
                <td><span class="status-badge in-progress">Billable</span></td>
              </tr>
            </tbody>
          </table>
        </div>

        <h3>1.3 Azure Activity Connector</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Table</th><th>Description</th><th>Key Fields</th><th>Cost</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><code>AzureActivity</code></td>
                <td>Azure control plane operations</td>
                <td>OperationName, Caller, CallerIpAddress, ResourceGroup, SubscriptionId, ActivityStatus</td>
                <td><span class="status-badge complete">Free</span></td>
              </tr>
            </tbody>
          </table>
        </div>

        <h3>1.4 Microsoft Defender for Cloud Connector</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Table</th><th>Description</th><th>Key Fields</th><th>Cost</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><code>SecurityAlert</code></td>
                <td>Security alerts from Defender for Cloud</td>
                <td>AlertName, AlertSeverity, Entities, ProviderName, Tactics</td>
                <td><span class="status-badge complete">Free</span></td>
              </tr>
              <tr>
                <td><code>SecurityRecommendation</code></td>
                <td>Security posture recommendations</td>
                <td>RecommendationName, RecommendationState, ResourceId</td>
                <td><span class="status-badge complete">Free</span></td>
              </tr>
              <tr>
                <td><code>SecurityIncident</code></td>
                <td>Incidents created in Sentinel</td>
                <td>IncidentNumber, Title, Severity, Status, Owner</td>
                <td><span class="status-badge complete">Free</span></td>
              </tr>
            </tbody>
          </table>
        </div>

        <h3>1.5 Windows Security Events (via AMA)</h3>

        <div class="callout info">
          <div class="callout-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
            Filtered Collection via DCR
          </div>
          <div class="callout-content">
            <p>We use Data Collection Rules to filter Windows Security Events to security-relevant Event IDs only. This reduces ingestion by ~70%.</p>
          </div>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Table</th><th>Description</th><th>Key Event IDs</th><th>Cost</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><code>SecurityEvent</code></td>
                <td>Windows Security Events from servers</td>
                <td>4624, 4625, 4648, 4672, 4688, 4698, 4720, 4728, 4732, 4756, 4768, 4769, 4776</td>
                <td><span class="status-badge in-progress">Billable</span></td>
              </tr>
            </tbody>
          </table>
        </div>

        <h3>1.6 Syslog / CEF Connector (Palo Alto, Linux)</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Table</th><th>Source</th><th>Description</th><th>Key Fields</th><th>Cost</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><code>CommonSecurityLog</code></td>
                <td>Palo Alto Firewall</td>
                <td>CEF-formatted firewall logs</td>
                <td>SourceIP, DestinationIP, DestinationPort, DeviceAction, DeviceVendor</td>
                <td><span class="status-badge in-progress">Billable</span></td>
              </tr>
              <tr>
                <td><code>Syslog</code></td>
                <td>Linux Servers</td>
                <td>Linux syslog events</td>
                <td>SyslogMessage, Facility, SeverityLevel, ProcessName, HostName</td>
                <td><span class="status-badge in-progress">Billable</span></td>
              </tr>
            </tbody>
          </table>
        </div>

        <h3>1.7 Office 365 Connector</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Table</th><th>Description</th><th>Key Fields</th><th>Cost</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><code>OfficeActivity</code></td>
                <td>Exchange, SharePoint, Teams activity</td>
                <td>Operation, UserId, ClientIP, Workload, ResultStatus</td>
                <td><span class="status-badge complete">Free</span></td>
              </tr>
            </tbody>
          </table>
        </div>

        <h3>1.8 Microsoft Purview (DLP) Connector</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Table</th><th>Description</th><th>Key Fields</th><th>Cost</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><code>PurviewDLPLogs</code></td>
                <td>DLP policy matches and actions</td>
                <td>PolicyName, RuleName, ActionsTaken, SensitiveInfoType, User</td>
                <td><span class="status-badge in-progress">Billable</span></td>
              </tr>
            </tbody>
          </table>
        </div>

        <h3>Connector Summary (XDR-First Selective Ingestion)</h3>

        <div class="callout warning">
          <div class="callout-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>
            Selective Ingestion Principle
          </div>
          <div class="callout-content">
            <p><strong>With XDR enabled:</strong> We consume XDR incidents (SecurityIncident, SecurityAlert) and selectively ingest only raw tables needed for cross-domain correlation. We do NOT ingest all Device* tables â€” XDR handles that detection.</p>
          </div>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Connector</th><th>Tables Ingested</th><th>Ingestion Strategy</th><th>Volume (Est.)</th><th>Sentinel Rules</th></tr>
            </thead>
            <tbody>
              <tr style="background: rgba(34, 197, 94, 0.1);">
                <td>Microsoft 365 Defender (XDR)</td>
                <td>SecurityIncident, SecurityAlert, DeviceNetworkEvents (selective)</td>
                <td><strong>XDR incidents only</strong> â€” raw Device* tables NOT ingested except DeviceNetworkEvents for firewall correlation</td>
                <td>~25 GB/day</td>
                <td>0 (XDR handles)</td>
              </tr>
              <tr>
                <td>Entra ID</td>
                <td>SigninLogs, AuditLogs, AADRiskyUsers</td>
                <td>Identity logs for higher-order correlation (XDR + CA context)</td>
                <td>~5 GB/day</td>
                <td>8 rules (edge cases)</td>
              </tr>
              <tr>
                <td>Azure Activity</td>
                <td>AzureActivity</td>
                <td>Full ingestion â€” Sentinel owns Azure control plane detection</td>
                <td>~500 MB/day (free)</td>
                <td>28 rules</td>
              </tr>
              <tr>
                <td>Defender for Cloud</td>
                <td>SecurityAlert</td>
                <td>Cloud security alerts â€” Sentinel owns</td>
                <td>~200 MB/day (free)</td>
                <td>22 rules</td>
              </tr>
              <tr>
                <td>Windows Security Events</td>
                <td>SecurityEvent (DC only)</td>
                <td>Domain controller logs only â€” MDI handles most AD detection</td>
                <td>~5 GB/day</td>
                <td>15 rules</td>
              </tr>
              <tr>
                <td>Syslog/CEF (Palo Alto)</td>
                <td>2 tables</td>
                <td>Firewall logs, network security</td>
                <td>~20 GB/day</td>
                <td>38 rules</td>
              </tr>
              <tr>
                <td>Office 365</td>
                <td>1 table</td>
                <td>Email, SharePoint, Teams activity</td>
                <td>~2 GB/day (free)</td>
                <td>22 rules</td>
              </tr>
              <tr>
                <td>Purview DLP</td>
                <td>1 table</td>
                <td>DLP violations, policy matches</td>
                <td>~500 MB/day</td>
                <td>12 rules</td>
              </tr>
              <tr>
                <td>UEBA</td>
                <td>3 tables</td>
                <td>User and entity behavior analytics</td>
                <td>Derived</td>
                <td>35 rules</td>
              </tr>
              <tr>
                <td>Threat Intelligence</td>
                <td>2 tables</td>
                <td>IOC matching, TI enrichment</td>
                <td>~100 MB/day</td>
                <td>25 rules</td>
              </tr>
              <tr>
                <td>DNS Essentials (ASIM)</td>
                <td>1 table (normalized)</td>
                <td>DNS-based detections</td>
                <td>Derived</td>
                <td>18 rules</td>
              </tr>
              <tr>
                <td>Network Session Essentials</td>
                <td>1 table (normalized)</td>
                <td>Network flow analysis</td>
                <td>Derived</td>
                <td>22 rules</td>
              </tr>
              <tr>
                <td>Azure Key Vault</td>
                <td>1 table</td>
                <td>Secret access, key operations</td>
                <td>~50 MB/day</td>
                <td>12 rules</td>
              </tr>
              <tr>
                <td>Azure SQL</td>
                <td>2 tables</td>
                <td>Database security, SQL injection</td>
                <td>~200 MB/day</td>
                <td>15 rules</td>
              </tr>
              <tr>
                <td>Linux Syslog</td>
                <td>1 table</td>
                <td>Linux server security</td>
                <td>~3 GB/day</td>
                <td>18 rules</td>
              </tr>
              <tr style="font-weight: bold; background: rgba(139, 92, 246, 0.1);">
                <td colspan="4">TOTAL (Built-in from Solutions)</td>
                <td>~350 rules</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- ==================== SECTION 2: DETECTION ENGINEERING STRATEGY ==================== -->
        <h2>2. Detection Engineering Strategy</h2>

        <h3>2.1 Detection Categories</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Category</th><th>Source</th><th>Description</th><th>Count</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Built-in (Microsoft)</strong></td>
                <td>Sentinel Content Hub (12 solutions)</td>
                <td>Pre-built analytics rules for Sentinel's domain (network, Azure, DLP)</td>
                <td>~145 enabled</td>
              </tr>
              <tr>
                <td><strong>Custom (KQL)</strong></td>
                <td>Internal development</td>
                <td>Organization-specific detections (non-Microsoft sources)</td>
                <td>~65 rules</td>
              </tr>
              <tr>
                <td><strong>Sigma-Converted</strong></td>
                <td>SigmaHQ community rules</td>
                <td>Network, cloud, and custom app detections converted to KQL</td>
                <td>~25 rules</td>
              </tr>
              <tr>
                <td><strong>Higher-Order Correlation</strong></td>
                <td>Internal development</td>
                <td>XDR incidents + non-Microsoft context (firewall, DLP, critical assets)</td>
                <td>~35 rules</td>
              </tr>
              <tr style="font-weight: bold; background: rgba(139, 92, 246, 0.1);">
                <td colspan="3"><strong>TOTAL SENTINEL RULES</strong></td>
                <td><strong>~270 rules</strong></td>
              </tr>
              <tr style="background: rgba(34, 197, 94, 0.1);">
                <td colspan="3"><em>XDR handles endpoint, identity, email, cloud apps (~350 detection types) â€” not counted here</em></td>
                <td></td>
              </tr>
            </tbody>
          </table>
        </div>

        <h3>2.2 Solutions Deployed from Content Hub</h3>

        <p>With XDR-first approach, Sentinel Content Hub solutions focus on network, Azure, and non-Microsoft sources. XDR-covered domains (endpoint, identity, email) are handled by M365 Defender directly.</p>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Solution</th><th>Analytics Rules</th><th>Enabled</th><th>Domain</th></tr>
            </thead>
            <tbody>
              <tr><td>Palo Alto Networks</td><td>38</td><td>32</td><td>Network Security</td></tr>
              <tr><td>Azure Activity</td><td>28</td><td>25</td><td>Azure Infrastructure</td></tr>
              <tr><td>Network Session Essentials</td><td>22</td><td>18</td><td>Network Security</td></tr>
              <tr><td>DNS Essentials</td><td>18</td><td>15</td><td>Network Security</td></tr>
              <tr><td>Microsoft Defender for Cloud</td><td>35</td><td>22</td><td>Azure Security</td></tr>
              <tr><td>Threat Intelligence</td><td>25</td><td>8</td><td>TI (non-Microsoft feeds)</td></tr>
              <tr><td>Linux Syslog</td><td>18</td><td>12</td><td>Linux Servers</td></tr>
              <tr><td>Azure SQL</td><td>15</td><td>10</td><td>Database Security</td></tr>
              <tr><td>Purview DLP</td><td>12</td><td>12</td><td>Data Protection</td></tr>
              <tr><td>Azure Key Vault</td><td>12</td><td>10</td><td>Secrets Management</td></tr>
              <tr><td>UEBA</td><td>35</td><td>8</td><td>Behavior Analytics (edge cases)</td></tr>
              <tr><td>Custom Application Connectors</td><td>â€”</td><td>22</td><td>Business Apps</td></tr>
              <tr style="font-weight: bold; background: rgba(139, 92, 246, 0.1);">
                <td>TOTAL SENTINEL</td><td>â€”</td><td>~145</td><td></td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="callout info">
          <div class="callout-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
            What About Endpoint, Identity, Email Solutions?
          </div>
          <div class="callout-content">
            <p>You may notice we did <strong>not</strong> deploy these Content Hub solutions:</p>
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
              <li><strong>Microsoft 365 Defender</strong> (78 rules) â€” XDR handles natively</li>
              <li><strong>Microsoft Entra ID</strong> (65 rules) â€” XDR + Entra ID Protection handles</li>
              <li><strong>Windows Security Events</strong> (42 rules) â€” XDR + MDE handles better</li>
              <li><strong>Office 365</strong> (22 rules) â€” XDR + MDO handles</li>
            </ul>
            <p>These would duplicate XDR's built-in capabilities. Instead, XDR incidents flow to Sentinel for unified incident management.</p>
          </div>
        </div>

        <div class="callout success">
          <div class="callout-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
            Threat Intelligence & Context Sources
          </div>
          <div class="callout-content">
            <p><strong>TI in XDR:</strong> Microsoft global threat intel (built-in) â€” inline enrichment for alerts. You can't manage external feeds in XDR.</p>
            <p><strong>TI in Sentinel:</strong> External TI feeds (MISP, commercial, open-source) are ingested and correlated with network, cloud, and XDR incidents. <strong>Sentinel is the TI management and correlation engine.</strong></p>
            <p style="margin-top: 0.5rem;"><strong>Vulnerability context:</strong> XDR (via TVM) sees managed endpoint vulnerabilities. Sentinel correlates with external scanners (Qualys, Nessus) and broader asset context (CMDB, business criticality).</p>
            <p style="margin-top: 0.5rem;">ðŸ‘‰ <strong><a href="../operations/xdr-integration.html#xdr-correlation-scope">Full XDR Correlation Scope Documentation â†’</a></strong></p>
          </div>
        </div>

        <h3>2.3 MITRE ATT&CK Coverage</h3>

        <p>Combined MITRE coverage across XDR + Sentinel. XDR handles most endpoint/identity techniques; Sentinel adds network, cloud, and higher-order correlation:</p>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Tactic</th><th>ID</th><th>Rule Count</th><th>Coverage</th><th>Key Techniques Covered</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>Reconnaissance</td>
                <td>TA0043</td>
                <td>18</td>
                <td><span class="status-badge in-progress">Medium</span></td>
                <td>T1595 (Active Scanning), T1592 (Gather Victim Host Info)</td>
              </tr>
              <tr>
                <td>Resource Development</td>
                <td>TA0042</td>
                <td>12</td>
                <td><span class="status-badge in-progress">Medium</span></td>
                <td>T1583 (Acquire Infrastructure), T1588 (Obtain Capabilities)</td>
              </tr>
              <tr>
                <td>Initial Access</td>
                <td>TA0001</td>
                <td>52</td>
                <td><span class="status-badge complete">High</span></td>
                <td>T1566 (Phishing), T1078 (Valid Accounts), T1133 (External Remote Services), T1190 (Exploit Public App)</td>
              </tr>
              <tr>
                <td>Execution</td>
                <td>TA0002</td>
                <td>78</td>
                <td><span class="status-badge complete">High</span></td>
                <td>T1059 (Command and Scripting), T1204 (User Execution), T1047 (WMI), T1053 (Scheduled Task)</td>
              </tr>
              <tr>
                <td>Persistence</td>
                <td>TA0003</td>
                <td>65</td>
                <td><span class="status-badge complete">High</span></td>
                <td>T1053 (Scheduled Task), T1547 (Boot Autostart), T1136 (Create Account), T1098 (Account Manipulation)</td>
              </tr>
              <tr>
                <td>Privilege Escalation</td>
                <td>TA0004</td>
                <td>58</td>
                <td><span class="status-badge complete">High</span></td>
                <td>T1068 (Exploitation), T1078 (Valid Accounts), T1548 (Abuse Elevation), T1134 (Access Token Manipulation)</td>
              </tr>
              <tr>
                <td>Defense Evasion</td>
                <td>TA0005</td>
                <td>72</td>
                <td><span class="status-badge complete">High</span></td>
                <td>T1027 (Obfuscation), T1070 (Indicator Removal), T1562 (Impair Defenses), T1036 (Masquerading)</td>
              </tr>
              <tr>
                <td>Credential Access</td>
                <td>TA0006</td>
                <td>55</td>
                <td><span class="status-badge complete">High</span></td>
                <td>T1003 (OS Credential Dumping), T1110 (Brute Force), T1558 (Kerberoasting), T1552 (Unsecured Credentials)</td>
              </tr>
              <tr>
                <td>Discovery</td>
                <td>TA0007</td>
                <td>42</td>
                <td><span class="status-badge in-progress">Medium</span></td>
                <td>T1087 (Account Discovery), T1082 (System Info), T1016 (Network Config), T1083 (File Discovery)</td>
              </tr>
              <tr>
                <td>Lateral Movement</td>
                <td>TA0008</td>
                <td>48</td>
                <td><span class="status-badge complete">High</span></td>
                <td>T1021 (Remote Services), T1550 (Use Alternate Auth), T1570 (Lateral Tool Transfer), T1563 (Remote Service Hijack)</td>
              </tr>
              <tr>
                <td>Collection</td>
                <td>TA0009</td>
                <td>28</td>
                <td><span class="status-badge in-progress">Medium</span></td>
                <td>T1114 (Email Collection), T1213 (Data from Info Repos), T1005 (Data from Local System)</td>
              </tr>
              <tr>
                <td>Command & Control</td>
                <td>TA0011</td>
                <td>35</td>
                <td><span class="status-badge in-progress">Medium</span></td>
                <td>T1071 (Application Layer Protocol), T1105 (Ingress Tool Transfer), T1572 (Protocol Tunneling)</td>
              </tr>
              <tr>
                <td>Exfiltration</td>
                <td>TA0010</td>
                <td>22</td>
                <td><span class="status-badge in-progress">Medium</span></td>
                <td>T1048 (Exfiltration Over Alternative Protocol), T1041 (Exfil Over C2), T1567 (Exfil to Cloud)</td>
              </tr>
              <tr>
                <td>Impact</td>
                <td>TA0040</td>
                <td>25</td>
                <td><span class="status-badge complete">High</span></td>
                <td>T1486 (Data Encrypted for Impact), T1489 (Service Stop), T1485 (Data Destruction)</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- ==================== SECTION 3: BUILT-IN RULES ==================== -->
        <h2>3. Built-in Analytics Rules (Enabled)</h2>

        <p>These are the Microsoft-provided rules enabled from Sentinel Content Hub solutions.</p>

        <h3>3.1 Identity-Based Detections</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Rule Name</th><th>Table</th><th>MITRE</th><th>Severity</th><th>XDR Status</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>Successful logon from IP and target account that has been failed logon multiple times</td>
                <td>SigninLogs</td>
                <td>T1110</td>
                <td>Medium</td>
                <td><span class="status-badge complete">Retire with XDR</span></td>
              </tr>
              <tr>
                <td>Sign-ins from IPs that attempt sign-ins to disabled accounts</td>
                <td>SigninLogs</td>
                <td>T1078</td>
                <td>Medium</td>
                <td><span class="status-badge complete">Retire with XDR</span></td>
              </tr>
              <tr>
                <td>Anomalous sign-in location by user account and authenticating application</td>
                <td>SigninLogs</td>
                <td>T1078</td>
                <td>Medium</td>
                <td><span class="status-badge complete">Retire with XDR</span></td>
              </tr>
              <tr>
                <td>User added to Azure AD Privileged Groups</td>
                <td>AuditLogs</td>
                <td>T1078</td>
                <td>High</td>
                <td><span class="status-badge in-progress">Keep</span></td>
              </tr>
              <tr>
                <td>Admin account created outside of expected process</td>
                <td>AuditLogs</td>
                <td>T1136</td>
                <td>High</td>
                <td><span class="status-badge in-progress">Keep</span></td>
              </tr>
              <tr>
                <td>Possible use of Pass-the-Hash attack</td>
                <td>SigninLogs, SecurityEvent</td>
                <td>T1550</td>
                <td>High</td>
                <td><span class="status-badge complete">Retire with XDR</span></td>
              </tr>
              <tr>
                <td>Possible Kerberoasting attack</td>
                <td>SecurityEvent</td>
                <td>T1558</td>
                <td>High</td>
                <td><span class="status-badge complete">Retire with XDR (MDI)</span></td>
              </tr>
              <tr>
                <td>MFA rejected by user</td>
                <td>SigninLogs</td>
                <td>T1078</td>
                <td>Medium</td>
                <td><span class="status-badge complete">Retire with XDR</span></td>
              </tr>
            </tbody>
          </table>
        </div>

        <h3>3.2 Endpoint-Based Detections</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Rule Name</th><th>Table</th><th>MITRE</th><th>Severity</th><th>XDR Status</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>Potential LSASS credential dumping</td>
                <td>DeviceProcessEvents</td>
                <td>T1003</td>
                <td>High</td>
                <td><span class="status-badge complete">Retire with XDR</span></td>
              </tr>
              <tr>
                <td>Encoded PowerShell command execution</td>
                <td>DeviceProcessEvents</td>
                <td>T1059.001</td>
                <td>Medium</td>
                <td><span class="status-badge complete">Retire with XDR</span></td>
              </tr>
              <tr>
                <td>Suspicious process spawned by Office application</td>
                <td>DeviceProcessEvents</td>
                <td>T1204</td>
                <td>High</td>
                <td><span class="status-badge complete">Retire with XDR</span></td>
              </tr>
              <tr>
                <td>Potential ransomware activity</td>
                <td>DeviceFileEvents</td>
                <td>T1486</td>
                <td>High</td>
                <td><span class="status-badge complete">Retire with XDR</span></td>
              </tr>
              <tr>
                <td>Registry run key modifications</td>
                <td>DeviceRegistryEvents</td>
                <td>T1547</td>
                <td>Medium</td>
                <td><span class="status-badge complete">Retire with XDR</span></td>
              </tr>
              <tr>
                <td>Scheduled task created with suspicious command</td>
                <td>DeviceProcessEvents</td>
                <td>T1053</td>
                <td>Medium</td>
                <td><span class="status-badge complete">Retire with XDR</span></td>
              </tr>
              <tr>
                <td>Suspicious network connection to rare external IP</td>
                <td>DeviceNetworkEvents</td>
                <td>T1071</td>
                <td>Medium</td>
                <td><span class="status-badge complete">Retire with XDR</span></td>
              </tr>
            </tbody>
          </table>
        </div>

        <h3>3.3 Cloud & Azure Detections</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Rule Name</th><th>Table</th><th>MITRE</th><th>Severity</th><th>XDR Status</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>Azure resource deleted by unfamiliar principal</td>
                <td>AzureActivity</td>
                <td>T1485</td>
                <td>Medium</td>
                <td><span class="status-badge in-progress">Keep</span></td>
              </tr>
              <tr>
                <td>New Azure storage account public access enabled</td>
                <td>AzureActivity</td>
                <td>T1530</td>
                <td>High</td>
                <td><span class="status-badge in-progress">Keep</span></td>
              </tr>
              <tr>
                <td>Azure Key Vault access from unusual IP</td>
                <td>AzureDiagnostics</td>
                <td>T1552</td>
                <td>High</td>
                <td><span class="status-badge in-progress">Keep</span></td>
              </tr>
              <tr>
                <td>Suspicious Azure VM extension installation</td>
                <td>AzureActivity</td>
                <td>T1059</td>
                <td>Medium</td>
                <td><span class="status-badge in-progress">Keep</span></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- ==================== SECTION 4: CUSTOM DETECTIONS ==================== -->
        <h2>4. Custom Detection Rules (KQL)</h2>

        <p>These are organization-specific detections developed internally.</p>

        <h3>4.1 Identity Detections</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">CUSTOM-IDENTITY-001: Impossible Travel Detection</span></div>
          <pre><code>// Detects sign-ins from geographically impossible locations within short timeframe
// MITRE: T1078 (Valid Accounts)
// Severity: High
// Tables: SigninLogs
// XDR Status: RETIRE when XDR enabled (Entra ID Protection handles natively)

let timeWindow = 1h;
let distanceThresholdKm = 500;
let timeThresholdMinutes = 60;

SigninLogs
| where TimeGenerated > ago(timeWindow)
| where ResultType == "0" // Successful sign-ins only
| extend LocationDetails = parse_json(LocationDetails)
| extend 
    Latitude = toreal(LocationDetails.geoCoordinates.latitude),
    Longitude = toreal(LocationDetails.geoCoordinates.longitude),
    City = tostring(LocationDetails.city),
    Country = tostring(LocationDetails.countryOrRegion)
| where isnotempty(Latitude) and isnotempty(Longitude)
| sort by UserPrincipalName, TimeGenerated asc
| extend 
    PrevLatitude = prev(Latitude, 1),
    PrevLongitude = prev(Longitude, 1),
    PrevTime = prev(TimeGenerated, 1),
    PrevUser = prev(UserPrincipalName, 1)
| where UserPrincipalName == PrevUser
| extend 
    TimeDiffMinutes = datetime_diff('minute', TimeGenerated, PrevTime),
    // Haversine formula for distance
    DistanceKm = 6371 * acos(
        cos(radians(Latitude)) * cos(radians(PrevLatitude)) * 
        cos(radians(PrevLongitude) - radians(Longitude)) + 
        sin(radians(Latitude)) * sin(radians(PrevLatitude))
    )
| where DistanceKm > distanceThresholdKm and TimeDiffMinutes < timeThresholdMinutes
| project 
    TimeGenerated,
    UserPrincipalName,
    CurrentLocation = strcat(City, ", ", Country),
    DistanceKm = round(DistanceKm, 0),
    TimeDiffMinutes,
    IPAddress,
    AppDisplayName,
    UserAgent</code></pre>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">CUSTOM-IDENTITY-002: First-Time Access to Sensitive Application</span></div>
          <pre><code>// Detects first-time user access to sensitive applications
// MITRE: T1078 (Valid Accounts)
// Severity: Medium
// Tables: SigninLogs
// XDR Status: KEEP (business context)

let lookbackDays = 30;
let sensitiveApps = dynamic([
    "Azure Portal",
    "Microsoft Azure Management",
    "Graph Explorer",
    "Azure Key Vault",
    "Microsoft Intune",
    "Microsoft Purview"
]);

let historicalAccess = SigninLogs
| where TimeGenerated between (ago(lookbackDays) .. ago(1d))
| where ResultType == "0"
| where AppDisplayName in (sensitiveApps)
| summarize by UserPrincipalName, AppDisplayName;

SigninLogs
| where TimeGenerated > ago(1d)
| where ResultType == "0"
| where AppDisplayName in (sensitiveApps)
| join kind=leftanti historicalAccess on UserPrincipalName, AppDisplayName
| project 
    TimeGenerated,
    UserPrincipalName,
    AppDisplayName,
    IPAddress,
    Location = strcat(LocationDetails.city, ", ", LocationDetails.countryOrRegion),
    DeviceDetail = strcat(DeviceDetail.operatingSystem, " - ", DeviceDetail.browser),
    ConditionalAccessStatus
| extend AlertTitle = strcat("First-time access to ", AppDisplayName, " by ", UserPrincipalName)</code></pre>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">CUSTOM-IDENTITY-003: Service Principal Secret Added</span></div>
          <pre><code>// Detects when credentials are added to service principals (potential persistence)
// MITRE: T1098.001 (Account Manipulation: Additional Cloud Credentials)
// Severity: High
// Tables: AuditLogs
// XDR Status: KEEP (Azure-specific)

AuditLogs
| where TimeGenerated > ago(1d)
| where OperationName in ("Add service principal credentials", "Update application â€“ Certificates and secrets management")
| extend InitiatedBy = tostring(InitiatedBy.user.userPrincipalName)
| extend TargetApp = tostring(TargetResources[0].displayName)
| extend TargetAppId = tostring(TargetResources[0].id)
| project 
    TimeGenerated,
    OperationName,
    InitiatedBy,
    TargetApp,
    TargetAppId,
    Result,
    CorrelationId
| extend AlertTitle = strcat("Service principal credential added to ", TargetApp)</code></pre>
        </div>

        <h3>4.2 Endpoint Detections</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">CUSTOM-ENDPOINT-001: Suspicious LSASS Access</span></div>
          <pre><code>// Detects processes accessing LSASS memory (credential dumping)
// MITRE: T1003.001 (OS Credential Dumping: LSASS Memory)
// Severity: High
// Tables: DeviceProcessEvents
// XDR Status: RETIRE when XDR enabled (MDE handles natively)

let excludedProcesses = dynamic([
    "csrss.exe",
    "wininit.exe",
    "services.exe",
    "lsass.exe",
    "MsMpEng.exe",
    "svchost.exe"
]);

DeviceProcessEvents
| where TimeGenerated > ago(1h)
| where FileName =~ "lsass.exe" or InitiatingProcessFileName =~ "lsass.exe"
| where ActionType in ("ProcessAccessed", "CreateRemoteThread")
| where InitiatingProcessFileName !in~ (excludedProcesses)
| project 
    TimeGenerated,
    DeviceName,
    InitiatingProcessFileName,
    InitiatingProcessCommandLine,
    InitiatingProcessAccountName,
    FileName,
    ActionType,
    InitiatingProcessParentFileName
| extend AlertTitle = strcat("Suspicious LSASS access by ", InitiatingProcessFileName)</code></pre>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">CUSTOM-ENDPOINT-002: Living Off the Land Binary Execution</span></div>
          <pre><code>// Detects suspicious use of LOLBins with network activity
// MITRE: T1218 (System Binary Proxy Execution)
// Severity: Medium
// Tables: DeviceProcessEvents, DeviceNetworkEvents
// XDR Status: RETIRE when XDR enabled (MDE handles natively)

let lolbins = dynamic([
    "certutil.exe",
    "bitsadmin.exe",
    "mshta.exe",
    "regsvr32.exe",
    "rundll32.exe",
    "msiexec.exe",
    "wmic.exe",
    "cmstp.exe",
    "msxsl.exe"
]);

let suspiciousProcesses = DeviceProcessEvents
| where TimeGenerated > ago(1h)
| where FileName in~ (lolbins)
| where ProcessCommandLine has_any ("http", "ftp", "\\\\", "download", "-urlcache", "-split");

let networkConnections = DeviceNetworkEvents
| where TimeGenerated > ago(1h)
| where InitiatingProcessFileName in~ (lolbins)
| where RemoteIPType == "Public";

suspiciousProcesses
| join kind=inner networkConnections on DeviceId, InitiatingProcessFileName
| project 
    TimeGenerated,
    DeviceName,
    FileName,
    ProcessCommandLine,
    AccountName,
    RemoteIP,
    RemotePort,
    RemoteUrl
| extend AlertTitle = strcat("LOLBin ", FileName, " with network activity")</code></pre>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">CUSTOM-ENDPOINT-003: Mass File Encryption (Ransomware)</span></div>
          <pre><code>// Detects potential ransomware based on rapid file modifications
// MITRE: T1486 (Data Encrypted for Impact)
// Severity: High
// Tables: DeviceFileEvents
// XDR Status: RETIRE when XDR enabled (MDE handles natively)

let timeWindow = 5m;
let fileThreshold = 100;
let suspiciousExtensions = dynamic([
    ".encrypted", ".locked", ".crypto", ".crypt", ".enc", 
    ".ransom", ".pay", ".wallet", ".locky", ".cerber"
]);

DeviceFileEvents
| where TimeGenerated > ago(1h)
| where ActionType in ("FileModified", "FileRenamed", "FileCreated")
| extend FileExtension = extract(@"\.([^.]+)$", 1, FileName)
| summarize 
    FileCount = count(),
    UniqueExtensions = dcount(FileExtension),
    Files = make_set(FileName, 20),
    FirstEvent = min(TimeGenerated),
    LastEvent = max(TimeGenerated)
    by DeviceName, InitiatingProcessFileName, bin(TimeGenerated, timeWindow)
| where FileCount > fileThreshold
| extend 
    TimespanSeconds = datetime_diff('second', LastEvent, FirstEvent),
    AlertTitle = strcat("Mass file modification (", FileCount, " files) by ", InitiatingProcessFileName)
| project 
    TimeGenerated,
    DeviceName,
    InitiatingProcessFileName,
    FileCount,
    TimespanSeconds,
    UniqueExtensions,
    Files,
    AlertTitle</code></pre>
        </div>

        <h3>4.3 Network Detections</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">CUSTOM-NETWORK-001: Outbound Connection to Rare Domain</span></div>
          <pre><code>// Detects outbound connections to domains rarely seen in the environment
// MITRE: T1071 (Application Layer Protocol)
// Severity: Low
// Tables: DeviceNetworkEvents
// XDR Status: KEEP (enriched with firewall context)

let lookbackDays = 14;
let threshold = 5; // Domain must be seen by fewer than 5 devices

let domainBaseline = DeviceNetworkEvents
| where TimeGenerated between (ago(lookbackDays) .. ago(1d))
| where isnotempty(RemoteUrl)
| extend Domain = extract(@"https?://([^/]+)", 1, RemoteUrl)
| where isnotempty(Domain)
| summarize DeviceCount = dcount(DeviceId) by Domain;

DeviceNetworkEvents
| where TimeGenerated > ago(1d)
| where isnotempty(RemoteUrl)
| extend Domain = extract(@"https?://([^/]+)", 1, RemoteUrl)
| where isnotempty(Domain)
| join kind=leftanti domainBaseline on Domain
| project 
    TimeGenerated,
    DeviceName,
    InitiatingProcessFileName,
    RemoteUrl,
    RemoteIP,
    RemotePort,
    Domain
| extend AlertTitle = strcat("First-time outbound connection to ", Domain)</code></pre>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">CUSTOM-NETWORK-002: Firewall Allow After Multiple Denies</span></div>
          <pre><code>// Detects successful connection after multiple blocked attempts (potential brute force)
// MITRE: T1110 (Brute Force)
// Severity: Medium
// Tables: CommonSecurityLog
// XDR Status: KEEP (firewall-specific)

let timeWindow = 1h;
let denyThreshold = 10;

let deniedConnections = CommonSecurityLog
| where TimeGenerated > ago(timeWindow)
| where DeviceVendor == "Palo Alto Networks"
| where DeviceAction == "deny"
| summarize 
    DenyCount = count(),
    FirstDeny = min(TimeGenerated),
    LastDeny = max(TimeGenerated)
    by SourceIP, DestinationIP, DestinationPort
| where DenyCount >= denyThreshold;

CommonSecurityLog
| where TimeGenerated > ago(timeWindow)
| where DeviceVendor == "Palo Alto Networks"
| where DeviceAction == "allow"
| join kind=inner deniedConnections on SourceIP, DestinationIP, DestinationPort
| where TimeGenerated > LastDeny
| project 
    TimeGenerated,
    SourceIP,
    DestinationIP,
    DestinationPort,
    DenyCount,
    FirstDeny,
    LastDeny,
    Protocol,
    ApplicationProtocol
| extend AlertTitle = strcat("Connection allowed after ", DenyCount, " denies from ", SourceIP)</code></pre>
        </div>

        <!-- ==================== SECTION 5: CORRELATION RULES ==================== -->
        <h2>5. Correlation Rules (Multi-Table)</h2>

        <p>These rules join multiple tables to detect complex attack patterns. This is where Sentinel shines before XDR â€” and where Sentinel shifts focus after XDR (combining XDR incidents with non-Microsoft context).</p>

        <h3>5.1 Pre-XDR Correlation Rules</h3>

        <div class="callout warning">
          <div class="callout-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>
            XDR Impact
          </div>
          <div class="callout-content">
            <p>These correlation rules are <strong>manual implementations</strong> of what XDR does automatically. When XDR is enabled, most of these can be retired. Sentinel then focuses on correlating XDR incidents with non-Microsoft data.</p>
          </div>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">CORR-001: Compromised Account â†’ Endpoint Activity</span></div>
          <pre><code>// Correlates risky sign-in with subsequent suspicious endpoint activity
// MITRE: T1078 â†’ T1059 (Valid Accounts â†’ Command and Scripting)
// Severity: High
// Tables: SigninLogs, DeviceProcessEvents
// XDR Status: RETIRE when XDR enabled (this is exactly what XDR correlates automatically)

let timeWindow = 2h;

// Step 1: Find risky sign-ins
let riskySignins = SigninLogs
| where TimeGenerated > ago(timeWindow)
| where RiskLevelDuringSignIn in ("high", "medium") or ResultType != "0"
| where ResultType == "0" // Eventually successful
| project 
    SigninTime = TimeGenerated,
    UserPrincipalName,
    IPAddress,
    RiskLevel = RiskLevelDuringSignIn,
    AppDisplayName;

// Step 2: Find suspicious endpoint activity by same user
let suspiciousEndpointActivity = DeviceProcessEvents
| where TimeGenerated > ago(timeWindow)
| where ProcessCommandLine has_any ("-enc", "-e ", "IEX", "Invoke-", "downloadstring", "Net.WebClient")
| project 
    EndpointTime = TimeGenerated,
    DeviceName,
    AccountName,
    FileName,
    ProcessCommandLine;

// Step 3: Correlate
riskySignins
| extend AccountName = tostring(split(UserPrincipalName, "@")[0])
| join kind=inner suspiciousEndpointActivity on AccountName
| where EndpointTime between (SigninTime .. (SigninTime + timeWindow))
| project 
    SigninTime,
    EndpointTime,
    UserPrincipalName,
    DeviceName,
    RiskLevel,
    FileName,
    ProcessCommandLine,
    IPAddress
| extend AlertTitle = strcat("Risky sign-in followed by suspicious activity: ", UserPrincipalName)</code></pre>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">CORR-002: Privilege Escalation â†’ Sensitive Action</span></div>
          <pre><code>// Correlates privilege grant with subsequent sensitive Azure action
// MITRE: T1078.004 â†’ T1530 (Cloud Accounts â†’ Data from Cloud Storage)
// Severity: High
// Tables: AuditLogs, AzureActivity
// XDR Status: KEEP (Azure-specific, not in XDR scope)

let timeWindow = 4h;

// Step 1: Find privilege grants
let privilegeGrants = AuditLogs
| where TimeGenerated > ago(timeWindow)
| where OperationName has_any ("Add member to role", "Add eligible member to role", "Add owner")
| extend 
    GrantTime = TimeGenerated,
    GrantedTo = tostring(TargetResources[0].userPrincipalName),
    Role = tostring(parse_json(tostring(TargetResources[0].modifiedProperties))[1].newValue),
    GrantedBy = tostring(InitiatedBy.user.userPrincipalName);

// Step 2: Find sensitive Azure actions
let sensitiveActions = AzureActivity
| where TimeGenerated > ago(timeWindow)
| where OperationNameValue has_any (
    "Microsoft.Storage/storageAccounts/listKeys/action",
    "Microsoft.KeyVault/vaults/secrets/read",
    "Microsoft.Compute/virtualMachines/runCommand/action",
    "Microsoft.Resources/subscriptions/resourceGroups/delete"
)
| project 
    ActionTime = TimeGenerated,
    Caller,
    OperationNameValue,
    ResourceGroup,
    CallerIpAddress;

// Step 3: Correlate
privilegeGrants
| join kind=inner sensitiveActions on $left.GrantedTo == $right.Caller
| where ActionTime between (GrantTime .. (GrantTime + timeWindow))
| project 
    GrantTime,
    ActionTime,
    GrantedTo,
    Role,
    GrantedBy,
    OperationNameValue,
    ResourceGroup,
    CallerIpAddress
| extend AlertTitle = strcat("Privilege escalation followed by sensitive action: ", GrantedTo)</code></pre>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">CORR-003: Endpoint Compromise â†’ Lateral Movement</span></div>
          <pre><code>// Correlates suspicious endpoint activity with network lateral movement
// MITRE: T1059 â†’ T1021 (Command and Scripting â†’ Remote Services)
// Severity: High
// Tables: DeviceProcessEvents, DeviceNetworkEvents, DeviceLogonEvents
// XDR Status: RETIRE when XDR enabled (MDE handles this chain natively)

let timeWindow = 1h;

// Step 1: Find suspicious process execution
let suspiciousProcesses = DeviceProcessEvents
| where TimeGenerated > ago(timeWindow)
| where ProcessCommandLine has_any ("-enc", "IEX", "Invoke-", "mimikatz", "procdump")
    or FileName in~ ("psexec.exe", "wmic.exe", "powershell.exe")
| project 
    ProcessTime = TimeGenerated,
    SourceDevice = DeviceName,
    SourceDeviceId = DeviceId,
    AccountName,
    SuspiciousProcess = FileName,
    ProcessCommandLine;

// Step 2: Find lateral movement (SMB, WinRM, RDP connections)
let lateralConnections = DeviceNetworkEvents
| where TimeGenerated > ago(timeWindow)
| where RemotePort in (445, 5985, 5986, 3389) // SMB, WinRM, RDP
| where LocalIPType == "Private" and RemoteIPType == "Private"
| project 
    ConnectionTime = TimeGenerated,
    SourceDeviceId = DeviceId,
    SourceDevice = DeviceName,
    RemoteIP,
    RemotePort,
    InitiatingProcessFileName;

// Step 3: Find logon events on target
let targetLogons = DeviceLogonEvents
| where TimeGenerated > ago(timeWindow)
| where LogonType in ("Network", "RemoteInteractive")
| project 
    LogonTime = TimeGenerated,
    TargetDevice = DeviceName,
    TargetIP = LocalIP,
    AccountName,
    LogonType,
    RemoteIP;

// Correlate: Suspicious process â†’ Lateral connection â†’ Target logon
suspiciousProcesses
| join kind=inner lateralConnections on SourceDeviceId
| where ConnectionTime between (ProcessTime .. (ProcessTime + 30m))
| join kind=inner targetLogons on $left.RemoteIP == $right.TargetIP, AccountName
| where LogonTime between (ConnectionTime .. (ConnectionTime + 10m))
| project 
    ProcessTime,
    ConnectionTime,
    LogonTime,
    AccountName,
    SourceDevice,
    SuspiciousProcess,
    TargetDevice,
    RemotePort,
    LogonType
| extend AlertTitle = strcat("Lateral movement chain: ", SourceDevice, " â†’ ", TargetDevice)</code></pre>
        </div>

        <h3>5.2 Post-XDR Correlation Rules (Higher-Order)</h3>

        <p>When XDR handles Microsoft telemetry correlation, Sentinel focuses on enriching XDR incidents with non-Microsoft context.</p>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">CORR-XDR-001: XDR Incident + Firewall Context</span></div>
          <pre><code>// Enriches XDR incidents with related firewall activity
// Use Case: Add network context to endpoint compromise incidents
// Tables: SecurityIncident (XDR), CommonSecurityLog (Firewall)
// XDR Status: BUILD NEW (Sentinel's role post-XDR)

SecurityIncident
| where TimeGenerated > ago(1d)
| where ProviderName == "Microsoft 365 Defender"
| where Severity in ("High", "Medium")
| mv-expand AlertIds
| join kind=inner (
    SecurityAlert
    | where ProviderName == "Microsoft 365 Defender"
    | extend Entities = parse_json(Entities)
    | mv-expand Entities
    | where Entities.Type == "ip"
    | extend SuspiciousIP = tostring(Entities.Address)
    | project SystemAlertId, SuspiciousIP
) on $left.AlertIds == $right.SystemAlertId
| join kind=leftouter (
    CommonSecurityLog
    | where TimeGenerated > ago(1d)
    | where DeviceVendor == "Palo Alto Networks"
    | summarize 
        FirewallHits = count(),
        BytesSent = sum(SentBytes),
        BytesReceived = sum(ReceivedBytes),
        Destinations = make_set(DestinationIP, 10),
        Ports = make_set(DestinationPort, 10),
        Actions = make_set(DeviceAction)
    by SourceIP
) on $left.SuspiciousIP == $right.SourceIP
| project 
    IncidentNumber,
    Title,
    Severity,
    SuspiciousIP,
    FirewallHits,
    BytesSent,
    BytesReceived,
    Destinations,
    Ports,
    FirewallActions = Actions
| where isnotempty(FirewallHits)</code></pre>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">CORR-XDR-002: XDR Incident + Critical Asset Context</span></div>
          <pre><code>// Flags XDR incidents involving critical business assets
// Use Case: Prioritize incidents affecting crown jewels
// Tables: SecurityIncident (XDR), Watchlist (CriticalAssets)
// XDR Status: BUILD NEW (Sentinel's role post-XDR)

let criticalAssets = _GetWatchlist('CriticalAssets')
| project 
    AssetName = tolower(HostName), 
    BusinessFunction, 
    DataClassification, 
    Owner;

SecurityIncident
| where TimeGenerated > ago(1d)
| where ProviderName == "Microsoft 365 Defender"
| mv-expand AlertIds
| join kind=inner (
    SecurityAlert
    | extend Entities = parse_json(Entities)
    | mv-expand Entities
    | where Entities.Type == "host"
    | extend HostName = tolower(tostring(Entities.HostName))
    | project SystemAlertId, HostName
) on $left.AlertIds == $right.SystemAlertId
| join kind=inner criticalAssets on $left.HostName == $right.AssetName
| project 
    IncidentNumber,
    Title,
    Severity,
    HostName,
    BusinessFunction,
    DataClassification,
    Owner,
    EscalationRequired = true
| extend 
    EscalationReason = strcat("Critical asset affected: ", BusinessFunction),
    AlertTitle = strcat("[CRITICAL ASSET] ", Title)</code></pre>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">CORR-XDR-003: XDR Incident + DLP Violation Context</span></div>
          <pre><code>// Correlates XDR incidents with DLP violations for data exfiltration detection
// Use Case: Combine endpoint compromise with data loss indicators
// Tables: SecurityIncident (XDR), PurviewDLPLogs
// XDR Status: BUILD NEW (Sentinel's role post-XDR)

let timeWindow = 4h;

SecurityIncident
| where TimeGenerated > ago(1d)
| where ProviderName == "Microsoft 365 Defender"
| where Title has_any ("exfiltration", "data", "transfer", "upload")
| mv-expand AlertIds
| join kind=inner (
    SecurityAlert
    | extend Entities = parse_json(Entities)
    | mv-expand Entities
    | where Entities.Type == "account"
    | extend UserAccount = tostring(Entities.Name)
    | project SystemAlertId, UserAccount, AlertTime = TimeGenerated
) on $left.AlertIds == $right.SystemAlertId
| join kind=leftouter (
    PurviewDLPLogs
    | where TimeGenerated > ago(1d)
    | summarize 
        DLPViolations = count(),
        Policies = make_set(PolicyName),
        SensitiveTypes = make_set(SensitiveInfoType),
        Actions = make_set(ActionsTaken)
    by User
) on $left.UserAccount == $right.User
| where DLPViolations > 0
| project 
    IncidentNumber,
    Title,
    Severity,
    UserAccount,
    DLPViolations,
    Policies,
    SensitiveTypes,
    DLPActions = Actions
| extend AlertTitle = strcat("[XDR + DLP] ", Title, " with ", DLPViolations, " DLP violations")</code></pre>
        </div>

        <!-- ==================== SECTION 6: SIGMA FORMAT ==================== -->
        <h2>6. Sigma Format & Conversion</h2>

        <h3>6.1 What is Sigma?</h3>

        <div class="callout info">
          <div class="callout-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
            Sigma: The SIEM-Agnostic Detection Format
          </div>
          <div class="callout-content">
            <p>Sigma is an open, vendor-neutral format for writing detection rules. It allows you to:</p>
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
              <li>Write detections once, deploy to any SIEM</li>
              <li>Share detections across the community</li>
              <li>Convert rules to KQL, SPL, Elastic, etc.</li>
              <li>Maintain a portable detection catalog</li>
            </ul>
          </div>
        </div>

        <h3>6.2 Sigma Rule Structure</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">YAML - Sigma Rule Structure</span></div>
          <pre><code>title: Suspicious LSASS Access
id: 5d2c62b8-a7d3-4c6b-9f5e-1a2b3c4d5e6f
status: production
description: Detects processes accessing LSASS memory for credential dumping
author: Security Team
date: 2024/01/15
modified: 2024/06/01
references:
    - https://attack.mitre.org/techniques/T1003/001/
tags:
    - attack.credential_access
    - attack.t1003.001
logsource:
    category: process_access
    product: windows
detection:
    selection:
        TargetImage|endswith: '\lsass.exe'
        GrantedAccess|contains:
            - '0x1010'
            - '0x1410'
    filter_legitimate:
        SourceImage|endswith:
            - '\MsMpEng.exe'
            - '\csrss.exe'
            - '\wininit.exe'
    condition: selection and not filter_legitimate
falsepositives:
    - Legitimate security tools
    - System processes
level: high</code></pre>
        </div>

        <h3>6.3 Sigma to KQL Conversion</h3>

        <p>We use <code>sigma-cli</code> to convert Sigma rules to KQL for Sentinel.</p>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Bash - Sigma CLI Conversion</span></div>
          <pre><code># Install sigma-cli
pip install sigma-cli pySigma-backend-microsoft365defender pySigma-pipeline-microsoft365defender

# Convert single rule to KQL (Microsoft 365 Defender backend)
sigma convert -t microsoft365defender -p microsoft365defender rules/lsass_access.yml

# Convert entire directory
sigma convert -t microsoft365defender -p microsoft365defender rules/ -o kql_rules/

# Convert to Sentinel format (Azure Monitor backend)
sigma convert -t azure-monitor -p azure-monitor rules/</code></pre>
        </div>

        <h3>6.4 Sigma Rule Examples</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">YAML - Encoded PowerShell Detection</span></div>
          <pre><code>title: Encoded PowerShell Command Line
id: a1b2c3d4-e5f6-7890-abcd-ef1234567890
status: production
description: Detects base64 encoded PowerShell command lines
author: Security Team
references:
    - https://attack.mitre.org/techniques/T1059/001/
tags:
    - attack.execution
    - attack.t1059.001
logsource:
    category: process_creation
    product: windows
detection:
    selection_powershell:
        Image|endswith:
            - '\powershell.exe'
            - '\pwsh.exe'
    selection_encoded:
        CommandLine|contains:
            - ' -e '
            - ' -en '
            - ' -enc '
            - ' -enco '
            - ' -encod '
            - ' -encode '
            - ' -encoded '
            - ' -encodedcommand '
    condition: selection_powershell and selection_encoded
falsepositives:
    - Legitimate admin scripts
    - Software deployment tools
level: medium</code></pre>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">KQL - Converted Rule (M365 Defender)</span></div>
          <pre><code>// Auto-converted from Sigma rule: Encoded PowerShell Command Line
// Sigma ID: a1b2c3d4-e5f6-7890-abcd-ef1234567890

DeviceProcessEvents
| where (
    (FileName endswith "powershell.exe" or FileName endswith "pwsh.exe")
    and (
        ProcessCommandLine contains " -e " or
        ProcessCommandLine contains " -en " or
        ProcessCommandLine contains " -enc " or
        ProcessCommandLine contains " -enco " or
        ProcessCommandLine contains " -encod " or
        ProcessCommandLine contains " -encode " or
        ProcessCommandLine contains " -encoded " or
        ProcessCommandLine contains " -encodedcommand "
    )
)</code></pre>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">YAML - Scheduled Task Creation for Persistence</span></div>
          <pre><code>title: Scheduled Task Created Via Schtasks
id: 92a974c8-5f72-4f2e-9a8b-3c7d5e9f1234
status: production
description: Detects scheduled task creation via schtasks.exe with suspicious patterns
author: Security Team
references:
    - https://attack.mitre.org/techniques/T1053/005/
tags:
    - attack.persistence
    - attack.t1053.005
logsource:
    category: process_creation
    product: windows
detection:
    selection:
        Image|endswith: '\schtasks.exe'
        CommandLine|contains: '/create'
    suspicious_paths:
        CommandLine|contains:
            - '\AppData\'
            - '\Temp\'
            - '\ProgramData\'
            - 'powershell'
            - 'cmd /c'
            - 'wscript'
            - 'cscript'
    condition: selection and suspicious_paths
falsepositives:
    - Legitimate software installation
    - IT automation scripts
level: medium</code></pre>
        </div>

        <h3>6.5 Sigma Workflow</h3>

        <div class="flow-diagram">
          <div class="flow-step">
            <div class="flow-step-number">1</div>
            <div class="flow-step-content">
              <strong>Source Rules</strong><br>
              Pull from SigmaHQ repository or write custom Sigma rules.
            </div>
          </div>
          <div class="flow-connector">â†“</div>
          <div class="flow-step">
            <div class="flow-step-number">2</div>
            <div class="flow-step-content">
              <strong>Validate</strong><br>
              Check rule syntax and test against sample logs.
            </div>
          </div>
          <div class="flow-connector">â†“</div>
          <div class="flow-step">
            <div class="flow-step-number">3</div>
            <div class="flow-step-content">
              <strong>Convert to KQL</strong><br>
              Use sigma-cli with microsoft365defender or azure-monitor backend.
            </div>
          </div>
          <div class="flow-connector">â†“</div>
          <div class="flow-step">
            <div class="flow-step-number">4</div>
            <div class="flow-step-content">
              <strong>Review & Tune</strong><br>
              Adjust KQL for environment specifics, add exclusions.
            </div>
          </div>
          <div class="flow-connector">â†“</div>
          <div class="flow-step">
            <div class="flow-step-number">5</div>
            <div class="flow-step-content">
              <strong>Deploy to Sentinel</strong><br>
              Create analytics rule via ARM template, Bicep, or portal.
            </div>
          </div>
          <div class="flow-connector">â†“</div>
          <div class="flow-step">
            <div class="flow-step-number">6</div>
            <div class="flow-step-content">
              <strong>Monitor & Iterate</strong><br>
              Track false positives, tune thresholds, update rule.
            </div>
          </div>
        </div>

        <!-- ==================== SECTION 7: XDR-FIRST DETECTION CATALOG ==================== -->
        <h2>7. XDR-First Detection Catalog</h2>

        <p>Following the XDR-first approach, detection ownership is split between Microsoft 365 Defender XDR and Microsoft Sentinel from Day 1. This right-sized catalog shows what Sentinel owns (~270 rules) vs. what XDR handles natively.</p>

        <div class="callout success">
          <div class="callout-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
            XDR-First Architecture: Right-Sized from Day 1
          </div>
          <div class="callout-content">
            <p><strong>Detection ownership is defined upfront, not discovered later.</strong> XDR handles endpoint, identity, email, and cloud apps with automatic cross-domain correlation. Sentinel handles network, Azure infrastructure, DLP, custom apps, and higher-order correlation that combines XDR incidents with non-Microsoft context.</p>
            <p style="margin-top: 0.5rem;"><strong>Result:</strong> ~270 Sentinel rules (not 500+), 12-month migration, XDR benefits from Day 1.</p>
          </div>
        </div>

        <h3>7.1 Detection Ownership Summary</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Domain</th><th>Detection Owner</th><th>Sentinel Rules</th><th>Why</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Endpoint (Windows/Mac/Linux)</strong></td>
                <td><span class="status-badge" style="background: #22c55e; color: white;">XDR (MDE)</span></td>
                <td>0</td>
                <td>MDE has kernel-level visibility, AMSI, behavioral analysis</td>
              </tr>
              <tr>
                <td><strong>Identity (Entra ID + On-Prem AD)</strong></td>
                <td><span class="status-badge" style="background: #22c55e; color: white;">XDR (Entra + MDI)</span></td>
                <td>0</td>
                <td>ML-based risk detection, DC monitoring, impossible travel</td>
              </tr>
              <tr>
                <td><strong>Email (M365)</strong></td>
                <td><span class="status-badge" style="background: #22c55e; color: white;">XDR (MDO)</span></td>
                <td>0</td>
                <td>Content analysis, sandbox detonation, Safe Links</td>
              </tr>
              <tr>
                <td><strong>Cloud Apps (M365 SaaS)</strong></td>
                <td><span class="status-badge" style="background: #22c55e; color: white;">XDR (MDCA)</span></td>
                <td>0</td>
                <td>OAuth visibility, user behavior analytics</td>
              </tr>
              <tr>
                <td><strong>Network (Firewall/IDS)</strong></td>
                <td><span class="status-badge" style="background: #3b82f6; color: white;">Sentinel</span></td>
                <td>85</td>
                <td>Palo Alto, DNS, network traffic not in XDR</td>
              </tr>
              <tr>
                <td><strong>Azure Infrastructure</strong></td>
                <td><span class="status-badge" style="background: #3b82f6; color: white;">Sentinel</span></td>
                <td>65</td>
                <td>Azure control plane not in M365 Defender</td>
              </tr>
              <tr>
                <td><strong>Higher-Order Correlation</strong></td>
                <td><span class="status-badge" style="background: #3b82f6; color: white;">Sentinel</span></td>
                <td>35</td>
                <td>XDR incidents + non-Microsoft context</td>
              </tr>
              <tr>
                <td><strong>DLP (Purview)</strong></td>
                <td><span class="status-badge" style="background: #3b82f6; color: white;">Sentinel</span></td>
                <td>25</td>
                <td>DLP alerting + exfiltration correlation</td>
              </tr>
              <tr>
                <td><strong>Custom Applications</strong></td>
                <td><span class="status-badge" style="background: #3b82f6; color: white;">Sentinel</span></td>
                <td>22</td>
                <td>Business-specific detection logic</td>
              </tr>
              <tr>
                <td><strong>Linux Servers</strong></td>
                <td><span class="status-badge" style="background: #3b82f6; color: white;">Sentinel</span></td>
                <td>18</td>
                <td>Syslog-based edge cases</td>
              </tr>
              <tr>
                <td><strong>Third-Party SaaS</strong></td>
                <td><span class="status-badge" style="background: #3b82f6; color: white;">Sentinel</span></td>
                <td>15</td>
                <td>Non-Microsoft cloud apps</td>
              </tr>
              <tr>
                <td><strong>Threat Intelligence</strong></td>
                <td><span class="status-badge" style="background: #3b82f6; color: white;">Sentinel</span></td>
                <td>8</td>
                <td>Non-Microsoft TI feeds (ISAC, commercial)</td>
              </tr>
              <tr style="font-weight: bold; background: rgba(139, 92, 246, 0.1);">
                <td colspan="2"><strong>TOTAL SENTINEL RULES</strong></td>
                <td><strong>~270</strong></td>
                <td></td>
              </tr>
            </tbody>
          </table>
        </div>

        <h3>7.2 Network Security Rules (85 Rules)</h3>

        <p>Sentinel owns all network/firewall detections â€” XDR has no visibility into Palo Alto, DNS servers, or network appliances.</p>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Detection</th><th>MITRE</th><th>Severity</th><th>Table</th><th>Type</th></tr>
            </thead>
            <tbody>
              <tr><td>C2 Beaconing Pattern (Regular Intervals)</td><td>T1071.001</td><td>High</td><td>CommonSecurityLog</td><td>Custom</td></tr>
              <tr><td>DNS Tunneling Detection</td><td>T1071.004</td><td>High</td><td>DnsEvents</td><td>Built-in</td></tr>
              <tr><td>High-Entropy Domain Requests (DGA)</td><td>T1568.002</td><td>Medium</td><td>DnsEvents</td><td>Custom</td></tr>
              <tr><td>Port Scan Detection</td><td>T1046</td><td>Medium</td><td>CommonSecurityLog</td><td>Built-in</td></tr>
              <tr><td>Firewall Allow After Repeated Denies</td><td>T1190</td><td>High</td><td>CommonSecurityLog</td><td>Custom</td></tr>
              <tr><td>Unusual Outbound Port Usage</td><td>T1571</td><td>Medium</td><td>CommonSecurityLog</td><td>Built-in</td></tr>
              <tr><td>Large Data Transfer to External IP (&gt;100MB)</td><td>T1048</td><td>High</td><td>CommonSecurityLog</td><td>Custom</td></tr>
              <tr><td>Connection to Known Bad IP (TI Match)</td><td>T1071</td><td>High</td><td>CommonSecurityLog + TI</td><td>Built-in</td></tr>
              <tr><td>SSH Brute Force</td><td>T1110</td><td>Medium</td><td>Syslog</td><td>Built-in</td></tr>
              <tr><td>RDP from External IP</td><td>T1021.001</td><td>High</td><td>CommonSecurityLog</td><td>Built-in</td></tr>
              <tr><td>Non-Standard DNS Port Traffic</td><td>T1571</td><td>Medium</td><td>CommonSecurityLog</td><td>Custom</td></tr>
              <tr><td>ICMP Tunnel Detection</td><td>T1095</td><td>Medium</td><td>CommonSecurityLog</td><td>Custom</td></tr>
              <tr><td>Multiple Failed VPN Authentications</td><td>T1110</td><td>Medium</td><td>CommonSecurityLog</td><td>Built-in</td></tr>
              <tr><td>Traffic to Tor Exit Nodes</td><td>T1090.003</td><td>High</td><td>CommonSecurityLog + TI</td><td>Built-in</td></tr>
              <tr><td>Unusual Protocol on Standard Port</td><td>T1571</td><td>Medium</td><td>CommonSecurityLog</td><td>Custom</td></tr>
            </tbody>
          </table>
        </div>
        <p><em>+ 70 additional network rules covering IDS alerts, geographic anomalies, bandwidth abuse, protocol violations</em></p>

        <h3>7.3 Azure Infrastructure Rules (65 Rules)</h3>

        <p>Azure control plane activity is not in M365 Defender scope â€” Sentinel owns these detections.</p>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Detection</th><th>MITRE</th><th>Severity</th><th>Table</th><th>Type</th></tr>
            </thead>
            <tbody>
              <tr><td>Resource Deletion by New Principal</td><td>T1485</td><td>High</td><td>AzureActivity</td><td>Custom</td></tr>
              <tr><td>NSG Rule Modified to Allow All</td><td>T1562.007</td><td>Critical</td><td>AzureActivity</td><td>Built-in</td></tr>
              <tr><td>Key Vault Secret Accessed from New IP</td><td>T1552.001</td><td>High</td><td>AzureDiagnostics</td><td>Custom</td></tr>
              <tr><td>Bulk Key Vault Secret Download</td><td>T1552.001</td><td>Critical</td><td>AzureDiagnostics</td><td>Custom</td></tr>
              <tr><td>Azure AD Role Assignment (Global Admin)</td><td>T1098.003</td><td>Critical</td><td>AuditLogs</td><td>Built-in</td></tr>
              <tr><td>Custom Role Created with High Privileges</td><td>T1098</td><td>High</td><td>AzureActivity</td><td>Custom</td></tr>
              <tr><td>Storage Account Public Access Enabled</td><td>T1530</td><td>High</td><td>AzureActivity</td><td>Built-in</td></tr>
              <tr><td>VM Run Command Execution</td><td>T1059</td><td>High</td><td>AzureActivity</td><td>Built-in</td></tr>
              <tr><td>Diagnostic Settings Deleted</td><td>T1562.008</td><td>High</td><td>AzureActivity</td><td>Built-in</td></tr>
              <tr><td>Subscription Transferred Out</td><td>T1537</td><td>Critical</td><td>AzureActivity</td><td>Built-in</td></tr>
              <tr><td>Azure Policy Disabled</td><td>T1562</td><td>High</td><td>AzureActivity</td><td>Custom</td></tr>
              <tr><td>Mass Resource Creation (Cryptomining)</td><td>T1496</td><td>High</td><td>AzureActivity</td><td>Custom</td></tr>
              <tr><td>SQL Firewall Rule: Allow All</td><td>T1562</td><td>High</td><td>AzureDiagnostics</td><td>Built-in</td></tr>
              <tr><td>Service Principal Secret Added</td><td>T1098.001</td><td>Medium</td><td>AuditLogs</td><td>Built-in</td></tr>
              <tr><td>Automation Runbook Modified</td><td>T1059</td><td>Medium</td><td>AzureActivity</td><td>Built-in</td></tr>
            </tbody>
          </table>
        </div>
        <p><em>+ 50 additional Azure rules covering AKS, App Service, Functions, Cosmos DB, networking changes</em></p>

        <h3>7.4 Higher-Order Correlation Rules (35 Rules)</h3>

        <p>These are Sentinel's <strong>unique value-add</strong>: correlating XDR incidents with context XDR can't see (network, Azure, DLP, critical assets).</p>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Rule Name</th><th>Correlation</th><th>Severity</th><th>Business Value</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>XDR Incident + Large Outbound Transfer</strong></td>
                <td>SecurityIncident (XDR) + CommonSecurityLog (bytes &gt; 100MB)</td>
                <td>Critical</td>
                <td>Detect data exfiltration from compromised device</td>
              </tr>
              <tr>
                <td><strong>XDR Incident + DLP Block</strong></td>
                <td>SecurityIncident (XDR) + PurviewDLPLogs (block action)</td>
                <td>Critical</td>
                <td>Confirm exfiltration attempt from compromised user</td>
              </tr>
              <tr>
                <td><strong>XDR Incident + Critical Asset</strong></td>
                <td>SecurityIncident (XDR) + Watchlist (crown jewels)</td>
                <td>Critical</td>
                <td>Auto-escalate incidents on critical systems</td>
              </tr>
              <tr>
                <td><strong>XDR Incident + VIP User</strong></td>
                <td>SecurityIncident (XDR) + Watchlist (executives)</td>
                <td>Critical</td>
                <td>Auto-escalate incidents involving executives</td>
              </tr>
              <tr>
                <td><strong>XDR Identity Incident + Key Vault Access</strong></td>
                <td>SecurityIncident (identity) + AzureDiagnostics (secret access)</td>
                <td>Critical</td>
                <td>Detect secret theft after credential compromise</td>
              </tr>
              <tr>
                <td><strong>XDR Identity Incident + Azure Resource Change</strong></td>
                <td>SecurityIncident (identity) + AzureActivity (modify/delete)</td>
                <td>High</td>
                <td>Detect cloud infrastructure abuse</td>
              </tr>
              <tr>
                <td><strong>XDR Incident + Third-Party TI Match</strong></td>
                <td>SecurityIncident (XDR) + ThreatIntelligenceIndicator (ISAC)</td>
                <td>High</td>
                <td>Enrich with non-Microsoft threat intel</td>
              </tr>
              <tr>
                <td><strong>XDR Incident + After-Hours Activity</strong></td>
                <td>SecurityIncident (XDR) + TimeGenerated outside business hours</td>
                <td>Medium</td>
                <td>Flag incidents outside normal working hours</td>
              </tr>
              <tr>
                <td><strong>XDR Endpoint + Firewall Deny to Same Dest</strong></td>
                <td>SecurityIncident (endpoint) + CommonSecurityLog (deny + allow)</td>
                <td>High</td>
                <td>Detect malware attempting blocked destinations</td>
              </tr>
              <tr>
                <td><strong>XDR Email Incident + DLP Violation Same User</strong></td>
                <td>SecurityIncident (email) + PurviewDLPLogs (same user, 1hr)</td>
                <td>Critical</td>
                <td>Detect BEC + data theft in progress</td>
              </tr>
            </tbody>
          </table>
        </div>
        <p><em>+ 25 additional higher-order rules covering regulatory assets, geographic anomalies, multi-stage attacks</em></p>

        <h3>7.5 DLP Context Rules (25 Rules)</h3>

        <p>Purview DLP alerting and correlation with security incidents.</p>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Detection</th><th>Severity</th><th>Table</th><th>Action</th></tr>
            </thead>
            <tbody>
              <tr><td>PCI Data Exfiltration Attempt (Block)</td><td>Critical</td><td>PurviewDLPLogs</td><td>Alert + Legal notification</td></tr>
              <tr><td>PHI Data Sharing External (Block)</td><td>Critical</td><td>PurviewDLPLogs</td><td>Alert + Compliance notification</td></tr>
              <tr><td>SSN Detection in Email (Warn)</td><td>High</td><td>PurviewDLPLogs</td><td>Alert + User education</td></tr>
              <tr><td>Bank Account Numbers External (Block)</td><td>Critical</td><td>PurviewDLPLogs</td><td>Alert + Manager notification</td></tr>
              <tr><td>Source Code Upload to Personal Cloud</td><td>High</td><td>PurviewDLPLogs</td><td>Alert + IP protection review</td></tr>
              <tr><td>Mass File Download from SharePoint</td><td>High</td><td>PurviewDLPLogs</td><td>Alert + Insider threat review</td></tr>
              <tr><td>Repeat DLP Offender (3+ violations/30 days)</td><td>High</td><td>PurviewDLPLogs</td><td>Alert + HR notification</td></tr>
              <tr><td>DLP Override Abuse (frequent)</td><td>Medium</td><td>PurviewDLPLogs</td><td>Alert + Policy review</td></tr>
            </tbody>
          </table>
        </div>
        <p><em>+ 17 additional DLP rules covering cloud apps, USB, print, and specific sensitive info types</em></p>

        <h3>7.6 Custom Application Rules (22 Rules)</h3>

        <p>Business-specific detections for internal applications.</p>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Detection</th><th>Application</th><th>Severity</th><th>Logic</th></tr>
            </thead>
            <tbody>
              <tr><td>ERP Mass Record Export</td><td>SAP</td><td>High</td><td>&gt;10,000 records exported by single user</td></tr>
              <tr><td>CRM Bulk Contact Download</td><td>Salesforce</td><td>High</td><td>&gt;5,000 contacts downloaded</td></tr>
              <tr><td>Financial System After-Hours Access</td><td>Oracle Financials</td><td>Medium</td><td>Access outside business hours</td></tr>
              <tr><td>HR System Bulk Employee Lookup</td><td>Workday</td><td>Medium</td><td>&gt;100 employee records viewed</td></tr>
              <tr><td>Database Admin Action by Non-DBA</td><td>Internal DBs</td><td>High</td><td>DDL commands by non-admin</td></tr>
              <tr><td>API Rate Limit Abuse</td><td>Internal APIs</td><td>Medium</td><td>&gt;1000 calls/minute</td></tr>
            </tbody>
          </table>
        </div>
        <p><em>+ 16 additional custom rules for internal applications</em></p>

        <h3>7.7 What XDR Handles (Not in Sentinel)</h3>

        <div class="callout info">
          <div class="callout-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
            These Detections Are NOT Built in Sentinel
          </div>
          <div class="callout-content">
            <p>The following attack types are handled natively by XDR with automatic cross-domain correlation. Building these in Sentinel would duplicate XDR's built-in capabilities.</p>
          </div>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Detection Category</th><th>XDR Product</th><th>Why Not Sentinel</th></tr>
            </thead>
            <tbody>
              <tr><td>LSASS Credential Dumping</td><td>MDE</td><td>Kernel-level visibility, behavioral analysis</td></tr>
              <tr><td>Encoded PowerShell Execution</td><td>MDE</td><td>AMSI decodes in-memory, catches obfuscation</td></tr>
              <tr><td>Ransomware Activity</td><td>MDE</td><td>Behavioral blocking (prevents, not just detects)</td></tr>
              <tr><td>Process Hollowing</td><td>MDE</td><td>Memory analysis not in log telemetry</td></tr>
              <tr><td>Fileless Malware</td><td>MDE</td><td>Real-time memory inspection</td></tr>
              <tr><td>Living-off-the-Land (LOLBins)</td><td>MDE</td><td>Behavioral context, not just command line</td></tr>
              <tr><td>Impossible Travel</td><td>Entra ID Protection</td><td>ML per user, accounts for VPN/travel patterns</td></tr>
              <tr><td>Password Spray</td><td>Entra ID Protection</td><td>Tenant-wide ML, distributed attack detection</td></tr>
              <tr><td>Token Theft</td><td>Entra ID Protection</td><td>Token anomaly detection</td></tr>
              <tr><td>Kerberoasting</td><td>MDI</td><td>Domain controller monitoring</td></tr>
              <tr><td>DCSync Attack</td><td>MDI</td><td>AD replication traffic analysis</td></tr>
              <tr><td>Pass-the-Hash/Ticket</td><td>MDI</td><td>Authentication protocol analysis</td></tr>
              <tr><td>Phishing Email</td><td>MDO</td><td>Content analysis, sandbox detonation</td></tr>
              <tr><td>Business Email Compromise</td><td>MDO</td><td>ML on communication patterns</td></tr>
              <tr><td>Malicious Attachment</td><td>MDO</td><td>Safe Attachments sandbox</td></tr>
              <tr><td>OAuth App Abuse</td><td>MDCA</td><td>Consent grant visibility, app behavior</td></tr>
              <tr><td>Mass File Download (M365)</td><td>MDCA</td><td>User behavior baseline</td></tr>
            </tbody>
          </table>
        </div>

        <h3>7.8 Architecture Comparison</h3>

        <div class="comparison-grid">
          <div class="comparison-column">
            <div class="comparison-header" style="background: #450a0a; color: #fecaca;">Anti-Pattern: Build Everything</div>
            <div class="comparison-content">
              <div class="comparison-item"><span class="comparison-item-icon">âŒ</span><span>580+ rules in Sentinel</span></div>
              <div class="comparison-item"><span class="comparison-item-icon">âŒ</span><span>Duplicate XDR detections</span></div>
              <div class="comparison-item"><span class="comparison-item-icon">âŒ</span><span>18-month migration</span></div>
              <div class="comparison-item"><span class="comparison-item-icon">âŒ</span><span>XDR benefits delayed</span></div>
              <div class="comparison-item"><span class="comparison-item-icon">âŒ</span><span>Higher Sentinel compute cost</span></div>
              <div class="comparison-item"><span class="comparison-item-icon">âŒ</span><span>Manual correlation in KQL</span></div>
            </div>
          </div>
          <div class="comparison-column">
            <div class="comparison-header" style="background: #14532d; color: #bbf7d0;">XDR-First: Right-Sized âœ“</div>
            <div class="comparison-content">
              <div class="comparison-item"><span class="comparison-item-icon">âœ“</span><span>~270 rules in Sentinel</span></div>
              <div class="comparison-item"><span class="comparison-item-icon">âœ“</span><span>XDR handles Microsoft data</span></div>
              <div class="comparison-item"><span class="comparison-item-icon">âœ“</span><span>12-month migration</span></div>
              <div class="comparison-item"><span class="comparison-item-icon">âœ“</span><span>XDR benefits from Day 1</span></div>
              <div class="comparison-item"><span class="comparison-item-icon">âœ“</span><span>Optimized Sentinel cost</span></div>
              <div class="comparison-item"><span class="comparison-item-icon">âœ“</span><span>Automatic XDR correlation</span></div>
            </div>
          </div>
        </div>

        <div class="page-nav">
          <a href="detection-engineering.html" class="page-nav-prev">â† Detection Engineering</a>
          <a href="soc-transition.html" class="page-nav-next">SOC Transition â†’</a>
        </div>

      </div>
    </main>
  </div>

  <script src="../js/main.js"></script>
</body>
</html>
