<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detection Engineering | SIEM Migration</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="sidebar-logo-icon">RF</div>
          <div class="sidebar-logo-text">
            <span class="sidebar-logo-title">Security Transformation</span>
            <span class="sidebar-logo-subtitle">RevFlow Analytics</span>
          </div>
        </div>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Overview</div>
          <a href="../index.html" class="nav-item">Executive Summary</a>
          <a href="../company-profile.html" class="nav-item">Company Profile</a>
          <a href="../program-structure.html" class="nav-item">Program Structure</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Migration Tracks</div>
          <a href="index.html" class="nav-item"><span class="nav-track-indicator siem"></span>SIEM: RSA → Sentinel</a>
          <a href="discovery.html" class="nav-item nav-item-sub">Discovery & Assessment</a>
          <a href="log-sources.html" class="nav-item nav-item-sub">Log Source Strategy</a>
          <a href="log-engineering.html" class="nav-item nav-item-sub">Log Engineering</a>
          <a href="detection-engineering.html" class="nav-item nav-item-sub active">Detection Engineering</a>
          <a href="soc-transition.html" class="nav-item nav-item-sub">SOC Transition</a>
          <a href="../edr/index.html" class="nav-item"><span class="nav-track-indicator edr"></span>EDR: ESET → MDE</a>
          <a href="../dlp/index.html" class="nav-item"><span class="nav-track-indicator dlp"></span>DLP: Symantec → Purview</a>
          <a href="../identity/index.html" class="nav-item"><span class="nav-track-indicator identity"></span>Identity: AD → Entra ID</a>
          <a href="../infrastructure/index.html" class="nav-item"><span class="nav-track-indicator infra"></span>Infrastructure: Azure</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Resources</div>
          <a href="../resources/scripts.html" class="nav-item">Scripts & Queries</a>
        </div>
      </nav>
    </aside>
    <button class="mobile-menu-toggle" aria-label="Toggle menu">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"></path></svg>
    </button>
    <div class="sidebar-overlay"></div>
    <main class="main-content">
      <div class="content-wrapper">
        <nav class="breadcrumb">
          <a href="../index.html">Home</a>
          <span class="breadcrumb-separator">/</span>
          <a href="index.html">SIEM Migration</a>
          <span class="breadcrumb-separator">/</span>
          <span class="breadcrumb-current">Detection Engineering</span>
        </nav>

        <div class="page-header">
          <h1>Detection Engineering</h1>
          <div class="page-header-meta">
            <span class="page-badge siem">SIEM Track</span>
          </div>
          <p class="intro-text">Enabling built-in detection capabilities and translating custom RSA NetWitness rules to Sentinel KQL. This section covers rule categorization, Microsoft content deployment, and translation patterns.</p>
        </div>

        <div class="callout info">
          <div class="callout-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
            Role Scope
          </div>
          <div class="callout-content">
            <p><strong>My Contribution (Security Engineer):</strong> Implemented and enabled built-in detection rules from the detection translation catalog — specifically those with direct native equivalents in Microsoft Sentinel and Microsoft Defender. Translated and aligned detection use cases around endpoint telemetry, ensuring proper correlation between MDE, identity, and network signals. Deployed Microsoft Content Hub solutions and configured XDR-aligned rules.</p>
            <p><strong>Detection Engineering Team:</strong> Detailed custom KQL detection development, complex rule translation requiring significant logic rewrite, ongoing threshold tuning, false positive reduction, and continuous detection optimization.</p>
          </div>
        </div>

        <h2>Rule Migration Strategy</h2>
        <p>Don't migrate all rules blindly. Categorize and prioritize:</p>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Category</th><th>% of Rules</th><th>Action</th></tr>
            </thead>
            <tbody>
              <tr><td>Never fired (12 months)</td><td>30-40%</td><td><span class="status-badge not-started">Discard</span></td></tr>
              <tr><td>Constantly noisy</td><td>20-30%</td><td><span class="status-badge in-progress">Review/Fix or Discard</span></td></tr>
              <tr><td>Covered by Microsoft content</td><td>20%</td><td><span class="status-badge complete">Use Microsoft version</span></td></tr>
              <tr><td>Valuable custom rules</td><td>10-20%</td><td><span class="status-badge critical">Migrate & improve</span></td></tr>
              <tr><td>Compliance-required</td><td>5-10%</td><td><span class="status-badge critical">Must migrate</span></td></tr>
            </tbody>
          </table>
        </div>

        <h2>Microsoft Content Hub</h2>
        <p>Before writing custom rules, check Content Hub for free solutions:</p>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Solution</th><th>Detection Coverage</th><th>Install Priority</th></tr>
            </thead>
            <tbody>
              <tr><td><strong>Microsoft Entra ID</strong></td><td>Sign-in anomalies, risky users, MFA bypass</td><td>Week 1</td></tr>
              <tr><td><strong>Microsoft 365 Defender</strong></td><td>Endpoint, email, identity threats</td><td>Week 1</td></tr>
              <tr><td><strong>Azure Activity</strong></td><td>Resource changes, privilege escalation</td><td>Week 2</td></tr>
              <tr><td><strong>Threat Intelligence</strong></td><td>IOC matching across all tables</td><td>Week 2</td></tr>
              <tr><td><strong>UEBA</strong></td><td>User behavior anomalies</td><td>Week 4</td></tr>
              <tr><td><strong>AWS</strong></td><td>CloudTrail anomalies, IAM changes</td><td>Week 4</td></tr>
            </tbody>
          </table>
        </div>

        <h2>RSA ESA to Sentinel KQL Translation</h2>

        <h3>Example 1: Brute Force Detection</h3>
        <div class="comparison-grid">
          <div class="comparison-column">
            <div class="comparison-header before">RSA ESA Rule</div>
            <div class="comparison-content">
              <div class="code-block" style="margin: 0; border: none;">
                <pre><code>@RSAAlert(
  name='Brute Force Attack',
  severity='High'
)
SELECT * FROM Event
WHERE device_type = 'winevent_nic'
AND reference_id = '4625'
GROUP BY src_ip
HAVING COUNT(*) > 10
WINDOW (SIZE 5 MINUTE)</code></pre>
              </div>
            </div>
          </div>
          <div class="comparison-column">
            <div class="comparison-header after">Sentinel KQL</div>
            <div class="comparison-content">
              <div class="code-block" style="margin: 0; border: none;">
                <pre><code>SecurityEvent
| where TimeGenerated > ago(5m)
| where EventID == 4625
| summarize 
    FailedAttempts = count(),
    TargetAccounts = dcount(TargetUserName)
    by IpAddress
| where FailedAttempts > 10
| extend AlertSeverity = "High"</code></pre>
              </div>
            </div>
          </div>
        </div>

        <h3>Example 2: Salesforce Bulk Export Detection</h3>
        <div class="code-block">
          <div class="code-header"><span class="code-lang">KQL - Sentinel Analytics Rule</span><button class="code-copy-btn">Copy</button></div>
          <pre><code>// Detect unusual bulk record exports from Salesforce
// Critical for RevFlow - protects customer CRM data

SalesforceServiceCloud_CL
| where TimeGenerated > ago(1h)
| where EventType_s == "ReportExport" or EventType_s == "DataExport"
| summarize 
    ExportCount = count(),
    TotalRecords = sum(toint(RowsProcessed_s)),
    ExportTypes = make_set(EventType_s)
    by UserId_s, UserName_s
| where TotalRecords > 10000  // Threshold: 10k records
| join kind=leftouter (
    // Get user's baseline
    SalesforceServiceCloud_CL
    | where TimeGenerated > ago(30d) and TimeGenerated < ago(1h)
    | where EventType_s in ("ReportExport", "DataExport")
    | summarize BaselineAvg = avg(toint(RowsProcessed_s)) by UserId_s
) on UserId_s
| where TotalRecords > (BaselineAvg * 5) or isempty(BaselineAvg)
| extend 
    AlertName = "Salesforce Bulk Data Export",
    AlertSeverity = "High",
    Description = strcat(UserName_s, " exported ", TotalRecords, " records")</code></pre>
        </div>

        <h3>Example 3: Suspicious PowerShell Execution</h3>
        <div class="code-block">
          <div class="code-header"><span class="code-lang">KQL</span><button class="code-copy-btn">Copy</button></div>
          <pre><code>// Detect encoded PowerShell and suspicious patterns
DeviceProcessEvents
| where TimeGenerated > ago(1h)
| where FileName =~ "powershell.exe" or FileName =~ "pwsh.exe"
| where ProcessCommandLine has_any (
    "-enc", "-encodedcommand",
    "-nop", "-noprofile",
    "bypass", "-exec bypass",
    "downloadstring", "downloadfile",
    "invoke-webrequest", "iwr",
    "invoke-expression", "iex",
    "net.webclient",
    "bitstransfer"
)
| extend 
    EncodedCommand = ProcessCommandLine has_any ("-enc", "-encodedcommand"),
    DownloadAttempt = ProcessCommandLine has_any ("downloadstring", "downloadfile", "invoke-webrequest"),
    ExecutionBypass = ProcessCommandLine has_any ("bypass", "-exec bypass")
| project 
    TimeGenerated,
    DeviceName,
    AccountName,
    ProcessCommandLine,
    InitiatingProcessFileName,
    EncodedCommand,
    DownloadAttempt,
    ExecutionBypass</code></pre>
        </div>

        <h3>Example 4: Impossible Travel</h3>
        <div class="callout info">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>Use Built-In</div>
          <div class="callout-content"><p>Don't write custom impossible travel rules. Entra ID Identity Protection detects this natively and feeds into Sentinel via the connector. Enable the Microsoft Entra ID solution from Content Hub.</p></div>
        </div>

        <h2>Analytics Rule Configuration</h2>
        <div class="code-block">
          <div class="code-header"><span class="code-lang">JSON - ARM Template</span><button class="code-copy-btn">Copy</button></div>
          <pre><code>{
  "type": "Microsoft.SecurityInsights/alertRules",
  "apiVersion": "2022-11-01",
  "name": "BruteForceDetection",
  "kind": "Scheduled",
  "properties": {
    "displayName": "Brute Force Attack Detected",
    "description": "Detects multiple failed login attempts from single IP",
    "severity": "High",
    "enabled": true,
    "query": "SecurityEvent | where EventID == 4625 | summarize FailedAttempts = count() by IpAddress | where FailedAttempts > 10",
    "queryFrequency": "PT5M",
    "queryPeriod": "PT5M",
    "triggerOperator": "GreaterThan",
    "triggerThreshold": 0,
    "suppressionDuration": "PT1H",
    "suppressionEnabled": true,
    "tactics": ["CredentialAccess"],
    "techniques": ["T1110"],
    "entityMappings": [
      {
        "entityType": "IP",
        "fieldMappings": [{"identifier": "Address", "columnName": "IpAddress"}]
      }
    ]
  }
}</code></pre>
        </div>

        <h2>Testing & Validation</h2>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Test Type</th><th>Method</th><th>Success Criteria</th></tr>
            </thead>
            <tbody>
              <tr><td><strong>Syntax validation</strong></td><td>Run query in Log Analytics</td><td>No errors, returns results</td></tr>
              <tr><td><strong>Historical data</strong></td><td>Query last 30 days</td><td>Expected alerts would have fired</td></tr>
              <tr><td><strong>False positive rate</strong></td><td>Review first week of alerts</td><td>&lt;20% false positive rate</td></tr>
              <tr><td><strong>Purple team</strong></td><td>Simulate attack</td><td>Detection within SLA</td></tr>
            </tbody>
          </table>
        </div>

        <nav class="page-nav">
          <a href="log-engineering.html" class="page-nav-link prev"><span class="page-nav-label">Previous</span><span class="page-nav-title">← Log Engineering</span></a>
          <a href="soc-transition.html" class="page-nav-link next"><span class="page-nav-label">Next</span><span class="page-nav-title">SOC Transition →</span></a>
        </nav>
      </div>
    </main>
  </div>
  <script src="../js/main.js"></script>
</body>
</html>
