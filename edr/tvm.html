<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vulnerability Management â€” Automated Risk-Based Prioritization | EDR</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">
  <style>
    .flow-diagram { background: var(--bg-tertiary); padding: 1.5rem; border-radius: 8px; margin: 1rem 0; overflow-x: auto; }
    .enrichment-card { background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 8px; padding: 1.25rem; margin: 0.75rem 0; }
    .enrichment-card h4 { margin: 0 0 0.75rem 0; display: flex; align-items: center; gap: 0.5rem; }
    .source-badge { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
    .source-badge.qualys { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
    .source-badge.mde { background: rgba(59, 130, 246, 0.2); color: #93c5fd; }
    .source-badge.epss { background: rgba(249, 115, 22, 0.2); color: #fdba74; }
    .source-badge.kev { background: rgba(220, 38, 38, 0.2); color: #fca5a5; }
    .source-badge.cmdb { background: rgba(34, 197, 94, 0.2); color: #86efac; }
    .priority-badge { display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; }
    .priority-badge.critical { background: #991b1b; color: #fecaca; }
    .priority-badge.high { background: #c2410c; color: #fed7aa; }
    .priority-badge.medium { background: #a16207; color: #fef3c7; }
    .priority-badge.low { background: #166534; color: #dcfce7; }
    .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0; }
    .metric-card { background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 8px; padding: 1rem; text-align: center; }
    .metric-card .value { font-size: 2rem; font-weight: 700; color: #3b82f6; }
    .metric-card .label { font-size: 0.85rem; color: var(--text-secondary); }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="sidebar-logo-icon">RF</div>
          <div class="sidebar-logo-text">
            <span class="sidebar-logo-title">Security Transformation</span>
            <span class="sidebar-logo-subtitle">RevFlow Analytics</span>
          </div>
        </div>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Overview</div>
          <a href="../index.html" class="nav-item">Executive Summary</a>
          <a href="../company-profile.html" class="nav-item">Company Profile</a>
          <a href="../security-framework.html" class="nav-item">Security Framework</a>
          <a href="../program-structure.html" class="nav-item">Program Structure</a>
          <a href="../controls-mapping.html" class="nav-item">Controls Mapping</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">SIEM Migration</div>
          <a href="../siem/index.html" class="nav-item">SIEM Overview</a>
          <a href="../siem/discovery.html" class="nav-item">Discovery & Assessment</a>
          <a href="../siem/log-sources.html" class="nav-item">Log Source Strategy</a>
          <a href="../siem/log-engineering.html" class="nav-item">Log Engineering</a>
          <a href="../siem/parsing-deep-dive.html" class="nav-item">Parsing Deep Dive</a>
          <a href="../siem/threat-intelligence.html" class="nav-item">Threat Intelligence</a>
          <a href="../siem/detection-engineering.html" class="nav-item">Detection Engineering</a>
          <a href="../siem/detection-anatomy.html" class="nav-item">Detection Anatomy</a>
          <a href="../siem/detection-catalog.html" class="nav-item">Detection Catalog</a>
          <a href="../siem/soar-automation.html" class="nav-item">SOAR &amp; Automation</a>
          <a href="../siem/workbooks.html" class="nav-item">Workbooks &amp; Dashboards</a>
          <a href="../siem/cost-optimization.html" class="nav-item">Cost Optimization</a>
          <a href="../siem/casb-saas-security.html" class="nav-item">CASB &amp; SaaS Security</a>
          <a href="../siem/soc-transition.html" class="nav-item">SOC Transition</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">EDR Migration</div>
          <a href="../edr/index.html" class="nav-item">EDR Overview</a>
          <a href="../edr/xdr-detection-model.html" class="nav-item">XDR Detection Model</a>
          <a href="../edr/advanced-hunting.html" class="nav-item">Advanced Hunting</a>
          <a href="../edr/live-response.html" class="nav-item">Live Response</a>
          <a href="../edr/tvm.html" class="nav-item">Vulnerability Management</a>
          <a href="../edr/deployment.html" class="nav-item">MDE Deployment</a>
          <a href="../edr/asr-rules.html" class="nav-item">ASR Rules</a>
          <a href="../edr/device-control.html" class="nav-item">Device Control</a>
          <a href="../edr/compensating-controls.html" class="nav-item">Compensating Controls</a>
          <a href="../edr/coexistence.html" class="nav-item">Coexistence Strategy</a>
          <a href="../edr/eset-removal.html" class="nav-item">ESET Removal</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">DLP Migration</div>
          <a href="../dlp/index.html" class="nav-item">DLP Overview</a>
          <a href="../dlp/dlp-catalog.html" class="nav-item">DLP Catalog</a>
          <a href="../dlp/policy-translation.html" class="nav-item">Policy Translation</a>
          <a href="../dlp/rollout-phases.html" class="nav-item">Rollout Phases</a>
          <a href="../dlp/user-communication.html" class="nav-item">User Communication</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Identity & Access</div>
          <a href="../identity/index.html" class="nav-item">Identity Overview</a>
          <a href="../identity/hybrid-setup.html" class="nav-item">Hybrid Identity</a>
          <a href="../identity/conditional-access.html" class="nav-item">Conditional Access</a>
          <a href="../identity/pim.html" class="nav-item">PIM Configuration</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Infrastructure</div>
          <a href="../infrastructure/index.html" class="nav-item">Infrastructure Overview</a>
          <a href="../infrastructure/landing-zone.html" class="nav-item">Landing Zone</a>
          <a href="../infrastructure/network-architecture.html" class="nav-item">Network Architecture</a>
          <a href="../infrastructure/workload-migration.html" class="nav-item">Workload Migration</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Operations</div>
          <a href="../operations/parallel-ops.html" class="nav-item">Parallel Operations</a>
          <a href="../operations/soc-workflows.html" class="nav-item">SOC Workflows</a>
          <a href="../operations/integration.html" class="nav-item">Platform Integration</a>
          <a href="../operations/xdr-integration.html" class="nav-item">XDR Integration</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Resources</div>
          <a href="../resources/timeline.html" class="nav-item">Project Timeline</a>
          <a href="../resources/raci.html" class="nav-item">RACI Matrix</a>
          <a href="../resources/infrastructure-reference.html" class="nav-item">Infrastructure Reference</a>
          <a href="../resources/scripts.html" class="nav-item">Scripts & Queries</a>
          <a href="../resources/data-dictionary.html" class="nav-item">Data Dictionary</a>
          <a href="../resources/templates.html" class="nav-item">Templates</a>
          <a href="../resources/splunk-reference.html" class="nav-item">Splunk Reference</a>
          <a href="../resources/alternative-architectures.html" class="nav-item">Alternative Architectures</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Runbooks</div>
          <a href="../resources/mde-onboarding.html" class="nav-item">MDE Onboarding</a>
          <a href="../resources/mde-offboarding.html" class="nav-item">MDE Offboarding</a>
          <a href="../resources/incident-response.html" class="nav-item">Incident Response</a>
          <a href="../resources/operational-procedures.html" class="nav-item">Operational Procedures</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Troubleshooting</div>
          <a href="../troubleshooting/index.html" class="nav-item">Common Issues</a>
          <a href="../troubleshooting/siem-issues.html" class="nav-item">SIEM Issues</a>
          <a href="../troubleshooting/mde-issues.html" class="nav-item">MDE Issues</a>
          <a href="../troubleshooting/dlp-issues.html" class="nav-item">DLP Issues</a>
          <a href="../troubleshooting/agent-conflicts.html" class="nav-item">Agent Conflicts</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">â˜… Interview Prep</div>
          <a href="../interview-behavioral.html" class="nav-item">Behavioral Questions</a>
          <a href="../interview-technical.html" class="nav-item">Technical Questions</a>
          <a href="../interview-team-fit.html" class="nav-item">Team Fit &amp; Director</a>
          <a href="../interview-cheatsheet.html" class="nav-item">âš¡ Quick Cheat Sheet</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Career &amp; Reference</div>
          <a href="../career-narrative.html" class="nav-item">Career Narrative</a>
          
          
          
          
          <a href="../director-interview-prep.html" class="nav-item">Director Prep (Full)</a>
          <a href="../soc-maturity.html" class="nav-item">SOC Maturity</a>
          <a href="../security-mental-model.html" class="nav-item">Security Mental Model</a>
          <a href="../ai-security-risk.html" class="nav-item">AI Security & Risk</a>
        </div>
      </nav>
    </aside>
    <button class="mobile-menu-toggle" aria-label="Toggle menu">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"></path></svg>
    </button>
    <div class="sidebar-overlay"></div>
    <main class="main-content">
      <div class="content-wrapper">
        <nav class="breadcrumb">
          <a href="../index.html">Home</a>
          <span class="breadcrumb-separator">/</span>
          <a href="index.html">EDR Migration</a>
          <span class="breadcrumb-separator">/</span>
          <span class="breadcrumb-current">Vulnerability Management</span>
        </nav>

        <div class="page-header">
          <h1>Vulnerability Management â€” Automated Risk-Based Prioritization</h1>
          <div class="page-header-meta">
            <span class="page-badge edr">EDR Track</span>
            <span class="page-reading-time">MDVM & Custom Automation</span>
          </div>
          <p class="intro-text">This page documents our automated vulnerability management workflow. Both Microsoft Defender Vulnerability Management (MDVM, formerly TVM) and Qualys now provide EPSS scores, CISA KEV status, and exposure metrics natively. Our automation adds an <strong>additional layer</strong> â€” unifying data from both platforms, adding CMDB business context, and implementing custom risk prioritization beyond what either tool provides out of the box.</p>
        </div>

        <div class="callout info">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>TVM â†’ MDVM Evolution (2024-2025)</div>
          <div class="callout-content">
            <p><strong>Rebranding:</strong> TVM (Threat and Vulnerability Management) â†’ MDVM (Microsoft Defender Vulnerability Management)</p>
            <p><strong>Key Changes:</strong></p>
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
              <li><strong>Licensing:</strong> Now available as standalone (previously MDE P2 only)</li>
              <li><strong>Scope expanded:</strong> Browser extension scanning, certificate monitoring, firmware vulnerabilities</li>
              <li><strong>Portal:</strong> <code>security.microsoft.com â†’ Endpoints â†’ Vulnerability management</code></li>
              <li><strong>Exposure Management (Preview):</strong> Attack path analysis from internet to critical assets</li>
            </ul>
            <p>ğŸ‘‰ <strong><a href="../resources/timeline.html#ms-evolution">Full MDVM Evolution â†’</a></strong></p>
          </div>
        </div>

        <!-- ==================== WHAT TOOLS PROVIDE NATIVELY ==================== -->
        <h2>1. What MDVM & Qualys Already Provide (Native Capabilities)</h2>

        <div class="callout success">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Both Platforms Now Include Exploit Intelligence</div>
          <div class="callout-content">
            <p><strong>Modern vulnerability scanners have evolved.</strong> Both MDVM and Qualys now provide EPSS, CISA KEV, and exposure scoring natively â€” you don't need custom automation just for basic exploit intelligence. Our automation adds value <em>beyond</em> these native capabilities.</p>
          </div>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Capability</th><th>Microsoft MDVM</th><th>Qualys VMDR</th><th>Notes</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>CVSS Score</strong></td>
                <td>âœ… Yes (v2, v3, v3.1)</td>
                <td>âœ… Yes (v2, v3, v3.1)</td>
                <td>Standard severity rating</td>
              </tr>
              <tr>
                <td><strong>EPSS Score</strong></td>
                <td>âœ… Yes (native)</td>
                <td>âœ… Yes (TruRisk includes EPSS)</td>
                <td>Exploit prediction probability</td>
              </tr>
              <tr>
                <td><strong>CISA KEV Status</strong></td>
                <td>âœ… Yes (native)</td>
                <td>âœ… Yes (Real-Time Threat Indicators)</td>
                <td>Known exploited in the wild</td>
              </tr>
              <tr>
                <td><strong>Exposure Score</strong></td>
                <td>âœ… Yes (0-100 per device + org-wide)</td>
                <td>âœ… Yes (TruRisk factor)</td>
                <td>Attack surface context</td>
              </tr>
              <tr>
                <td><strong>Exploitability</strong></td>
                <td>âœ… Yes (Verified/Likely/Unlikely)</td>
                <td>âœ… Yes (Exploit Code Maturity)</td>
                <td>How likely to be exploited</td>
              </tr>
              <tr>
                <td><strong>Threat Actor Context</strong></td>
                <td>âœ… Yes (linked to threat campaigns)</td>
                <td>âœ… Yes (Active Threats feed)</td>
                <td>APT/ransomware associations</td>
              </tr>
              <tr>
                <td><strong>Patch Availability</strong></td>
                <td>âœ… Yes</td>
                <td>âœ… Yes</td>
                <td>Is a fix available?</td>
              </tr>
              <tr>
                <td><strong>Security Recommendations</strong></td>
                <td>âœ… Yes (with remediation steps)</td>
                <td>âœ… Yes (with solutions)</td>
                <td>Guidance for fixing</td>
              </tr>
            </tbody>
          </table>
        </div>

        <h3>1.1 Microsoft Defender Vulnerability Management (MDVM)</h3>

        <div class="enrichment-card">
          <h4><span class="source-badge mde">MDVM</span> Native Risk Prioritization Features</h4>
          <p><strong>MDVM (formerly TVM) now includes comprehensive threat intelligence:</strong></p>
          <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
            <li><strong>Exposure Score:</strong> 0-100 score reflecting organizational attack surface based on vulnerabilities, misconfigurations, and security controls</li>
            <li><strong>Device Exposure Level:</strong> Per-device risk scoring (Low/Medium/High)</li>
            <li><strong>EPSS Integration:</strong> Native display of exploit prediction scores</li>
            <li><strong>CISA KEV Tagging:</strong> Automatic flagging of known exploited vulnerabilities</li>
            <li><strong>Exploitability:</strong> Verified (exploit exists), Likely (conditions favorable), Unlikely</li>
            <li><strong>Threat Insights:</strong> Links CVEs to active threat campaigns and APT groups</li>
            <li><strong>Security Recommendations:</strong> Prioritized remediation guidance with impact assessment</li>
            <li><strong>Browser Extension Vulnerabilities:</strong> Detects vulnerable browser add-ons</li>
            <li><strong>Certificate Issues:</strong> Identifies expiring or weak certificates</li>
          </ul>
          <p style="margin-top: 0.75rem;"><strong>API endpoint:</strong> <code>https://api.securitycenter.microsoft.com/api/vulnerabilities</code></p>
          <p><strong>Key advantage:</strong> Correlates with MDE alerts â€” if a vulnerability is being actively exploited on a device, you see it immediately in the same console</p>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">MDVM API Response â€” Rich Native Data</span></div>
          <pre><code>// Example MDVM vulnerability response
{
    "id": "CVE-2024-21351",
    "name": "Windows SmartScreen Security Feature Bypass",
    "severity": "High",
    "cvssV3": 7.8,
    "epssScore": 0.45,           // â† Native EPSS
    "epssPercentile": 0.92,      // â† Top 8% most likely to be exploited
    "isKnownExploited": true,    // â† Native KEV flag
    "exploitabilityLevel": "ExploitIsVerified",
    "exposedMachines": 847,
    "organizationExposureLevel": "High",
    "publicExploit": true,
    "exploitTypes": ["Remote", "Local"],
    "exploitUris": ["https://github.com/..."],
    "threatInfo": {
        "associatedThreats": ["Ransomware", "APT29"],
        "lastSeenInWild": "2024-02-15"
    },
    "recommendedSecurityUpdate": "KB5034763",
    "patchReleaseDate": "2024-02-13"
}</code></pre>
        </div>

        <h3>1.2 Qualys VMDR (Vulnerability Management, Detection & Response)</h3>

        <div class="enrichment-card">
          <h4><span class="source-badge qualys">QUALYS</span> TruRisk & Real-Time Threat Indicators</h4>
          <p><strong>Qualys VMDR includes similar intelligence capabilities:</strong></p>
          <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
            <li><strong>TruRisk Score:</strong> Composite risk score factoring CVSS, exploit maturity, EPSS, and business context</li>
            <li><strong>Real-Time Threat Indicators (RTI):</strong> Active exploitation, weaponized, malware, wormable, denial of service flags</li>
            <li><strong>EPSS Integration:</strong> Exploit prediction scores displayed natively</li>
            <li><strong>CISA KEV Status:</strong> Automatic tagging of known exploited vulnerabilities</li>
            <li><strong>Exploit Code Maturity:</strong> Functional, POC, Unproven categories</li>
            <li><strong>Ransomware Association:</strong> Links to known ransomware families</li>
            <li><strong>Asset Criticality Tags:</strong> User-defined business criticality (though requires setup)</li>
          </ul>
          <p style="margin-top: 0.75rem;"><strong>API endpoint:</strong> <code>/api/2.0/fo/asset/host/vm/detection/</code></p>
        </div>

        <!-- ==================== SECTION 2: THE GAP ==================== -->
        <h2>2. The Gap: Why We Still Built Automation</h2>

        <div class="callout warning">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>What Native Tools DON'T Provide</div>
          <div class="callout-content">
            <p>Even with EPSS, KEV, and exposure scores built into both platforms, RevFlow still had operational challenges that required custom automation:</p>
          </div>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Challenge</th><th>What Native Tools Miss</th><th>Our Automation Solution</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Two Consoles</strong></td>
                <td>MDVM sees endpoints; Qualys sees network assets. Analysts switch between portals.</td>
                <td>Single Sentinel workbook with unified view</td>
              </tr>
              <tr>
                <td><strong>Duplicate Findings</strong></td>
                <td>Same CVE on same host appears in both tools with different scores</td>
                <td>Deduplication by CVE + hostname</td>
              </tr>
              <tr>
                <td><strong>Asset Context</strong></td>
                <td>Native tools don't know Tier 1 vs Tier 3 or business owner</td>
                <td>Watchlist enrichment (weekly CMDB export)</td>
              </tr>
              <tr>
                <td><strong>Custom Prioritization</strong></td>
                <td>Native scoring doesn't weight by RevFlow's specific risk appetite</td>
                <td>Custom risk score formula</td>
              </tr>
              <tr>
                <td><strong>Alerting</strong></td>
                <td>Must check each portal manually</td>
                <td>Sentinel alerts for Critical/High (SOC triages)</td>
              </tr>
              <tr>
                <td><strong>Alert Deduplication</strong></td>
                <td>Daily scans would create duplicate alerts</td>
                <td>Analytics rule skips already-alerted findings</td>
              </tr>
              <tr>
                <td><strong>Historical Trending</strong></td>
                <td>Native dashboards show point-in-time, not trends</td>
                <td>Log Analytics retention enables trend analysis</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="callout info">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>Interview Talking Point</div>
          <div class="callout-content">
            <p><em>"MDVM and Qualys both provide EPSS and KEV data natively now â€” that's table stakes. Our automation adds value on top: unifying data from both scanners into a single workbook, enriching with asset context from a weekly CMDB export watchlist, applying custom risk scoring, and creating deduplicated Sentinel alerts. SOC handles everything after the alert â€” triage, ticketing, remediation coordination."</em></p>
          </div>
        </div>

        <!-- ==================== SECTION 3: ARCHITECTURE ==================== -->
        <h2>3. Solution Architecture â€” Alert-Based Workflow</h2>

        <p><strong>Key principle:</strong> We aggregate and enrich vulnerability data, then create Sentinel alerts for Critical/High findings. SOC handles triage, ticketing, and remediation manually. CMDB context comes from a watchlist updated weekly.</p>

        <div class="flow-diagram">
          <pre><code>VULNERABILITY MANAGEMENT â€” ACTUAL WORKFLOW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DAILY SCANS:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   QUALYS VMDR               â”‚     â”‚   MICROSOFT MDVM            â”‚
â”‚   âœ“ CVSS, EPSS, KEV         â”‚     â”‚   âœ“ CVSS, EPSS, KEV         â”‚
â”‚   âœ“ TruRisk Score           â”‚     â”‚   âœ“ Exposure Score          â”‚
â”‚   (Scans daily)             â”‚     â”‚   (Continuous)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                                    â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   AZURE FUNCTION      â”‚
                    â”‚   (Daily @ 6 AM)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                      â”‚                      â”‚
         â–¼                      â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DEDUPLICATION  â”‚  â”‚  WATCHLIST      â”‚  â”‚  RISK SCORING   â”‚
â”‚  CVE + Hostname â”‚  â”‚  ENRICHMENT     â”‚  â”‚  CVSS + Tool    â”‚
â”‚  Skip if seen   â”‚  â”‚  (Weekly update)â”‚  â”‚  Scores + Tier  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   LOG ANALYTICS       â”‚
                    â”‚   VulnInventory_CL    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                 â”‚                 â”‚
              â–¼                 â–¼                 â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  SENTINEL       â”‚  â”‚  SENTINEL       â”‚  â”‚  WORKBOOK       â”‚
   â”‚  ALERTS         â”‚  â”‚  INCIDENTS      â”‚  â”‚  DASHBOARD      â”‚
   â”‚  (Crit/High)    â”‚  â”‚  (SOC Queue)    â”‚  â”‚  (Single View)  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                   SOC MANUAL WORK                    â”‚
          â”‚  â€¢ Triage alerts                                     â”‚
          â”‚  â€¢ Validate findings                                 â”‚
          â”‚  â€¢ Create tickets (internal system)                  â”‚
          â”‚  â€¢ Coordinate remediation with asset owners          â”‚
          â”‚  â€¢ Track SLAs manually                               â”‚
          â”‚  â€¢ Close incidents when resolved                     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

NO AUTO-TICKETING â€” SOC owns the full workflow after alerts are generated.
CMDB context via watchlist, not API integration.</code></pre>
        </div>

        <div class="callout info">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>Why No Auto-Ticketing?</div>
          <div class="callout-content">
            <p><strong>We don't have ServiceNow integration.</strong> The automation creates Sentinel alerts and incidents â€” SOC analysts then triage, validate, and create tickets in our internal ticketing system manually. This gives SOC control over what becomes a ticket vs. what gets closed as noise.</p>
          </div>
        </div>

        <h3>3.1 Deployment Options</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Option</th><th>How It Works</th><th>Best For</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Azure Function (Recommended)</strong></td>
                <td>Python code runs on timer trigger (daily), writes to Log Analytics custom table via Data Collector API</td>
                <td>Production, scalable, serverless</td>
              </tr>
              <tr>
                <td><strong>Azure Automation Runbook</strong></td>
                <td>PowerShell or Python in Azure Automation account with managed identity</td>
                <td>If already using Azure Automation</td>
              </tr>
              <tr>
                <td><strong>Logic Apps + Function</strong></td>
                <td>Logic Apps orchestrates workflow, calls Azure Function for complex processing</td>
                <td>Visual workflow, approval steps</td>
              </tr>
              <tr>
                <td><strong>On-prem VM + Task Scheduler</strong></td>
                <td>Python script runs on scheduled task, pushes to Sentinel via API</td>
                <td>Hybrid environments, air-gapped</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="callout info">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>Why Azure Functions?</div>
          <div class="callout-content">
            <p>Azure Functions is ideal because: serverless (no VM to manage), built-in timer triggers, managed identity for secure API access, automatic scaling, and native integration with Log Analytics.</p>
          </div>
        </div>

        <h3>3.2 Data Flow Summary</h3>

        <div class="flow-diagram">
          <pre><code>DATA FLOW â€” FROM SCANNERS TO UNIFIED DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

BEFORE (Manual):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Qualys Portal       â”‚     â”‚  M365 Defender       â”‚
â”‚  (has EPSS, KEV)     â”‚ â†â†’  â”‚  (has EPSS, KEV)     â”‚     â† 2 consoles
â”‚  but no CMDB context â”‚     â”‚  but no CMDB context â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

AFTER (Automated):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Qualys API          â”‚     â”‚  MDVM API            â”‚
â”‚  â€¢ CVE, CVSS         â”‚     â”‚  â€¢ CVE, CVSS         â”‚
â”‚  â€¢ EPSS (native)     â”‚     â”‚  â€¢ EPSS (native)     â”‚
â”‚  â€¢ KEV (native)      â”‚     â”‚  â€¢ KEV (native)      â”‚
â”‚  â€¢ Exploitability    â”‚     â”‚  â€¢ Exposure Score    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                            â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   AZURE FUNCTION      â”‚
            â”‚   â€¢ Deduplicate       â”‚
            â”‚   â€¢ Add CMDB context  â”‚  â† THIS IS THE VALUE-ADD
            â”‚   â€¢ Custom scoring    â”‚
            â”‚   â€¢ Auto-ticketing    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SENTINEL   â”‚  â”‚  SERVICENOW â”‚  â”‚  TEAMS      â”‚
â”‚  Workbook   â”‚  â”‚  Tickets    â”‚  â”‚  Alerts     â”‚
â”‚  (unified)  â”‚  â”‚  (Crit/High)â”‚  â”‚  (owners)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>

        <!-- ==================== SECTION 4: WATCHLIST ENRICHMENT ==================== -->
        <h2>4. Asset Context via Watchlist (Weekly Update)</h2>

        <div class="callout warning">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>No CMDB API Integration</div>
          <div class="callout-content">
            <p><strong>We don't have direct CMDB API access.</strong> Instead, we maintain a Sentinel watchlist with asset metadata that's updated weekly. This gives us business context (Tier 1/2/3, environment, owner) without requiring API integration.</p>
          </div>
        </div>

        <div class="callout success">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Why Watchlists Work</div>
          <div class="callout-content">
            <p><strong>Asset metadata doesn't change daily.</strong> Server tiers, owners, and environments are relatively static. A weekly CSV export from CMDB â†’ watchlist is sufficient. New assets get added during weekly refresh; SOC flags unknown assets for investigation.</p>
          </div>
        </div>

        <h3>4.1 Watchlist Structure</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">AssetInventory_WL â€” Sentinel Watchlist</span></div>
          <pre><code>WATCHLIST: AssetInventory_WL
UPDATED: Weekly (every Monday)
SOURCE: Manual export from CMDB â†’ CSV â†’ Upload to Sentinel

SCHEMA:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Column              â”‚ Type       â”‚ Description                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Hostname            â”‚ string     â”‚ Device name (primary key for join)          â”‚
â”‚ FQDN                â”‚ string     â”‚ Fully qualified domain name                 â”‚
â”‚ IPAddress           â”‚ string     â”‚ Primary IP address                          â”‚
â”‚ AssetTier           â”‚ string     â”‚ Tier 1 / Tier 2 / Tier 3                    â”‚
â”‚ Environment         â”‚ string     â”‚ Production / Staging / Development / Test   â”‚
â”‚ NetworkZone         â”‚ string     â”‚ Internet-facing / DMZ / Internal            â”‚
â”‚ Owner               â”‚ string     â”‚ Team or person responsible                  â”‚
â”‚ OwnerEmail          â”‚ string     â”‚ Contact email for notifications             â”‚
â”‚ DataClassification  â”‚ string     â”‚ Confidential / Internal / Public            â”‚
â”‚ ComplianceScope     â”‚ string     â”‚ SOC2, PCI, HIPAA (comma-separated)          â”‚
â”‚ LastUpdated         â”‚ datetime   â”‚ When this record was last refreshed         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SAMPLE DATA:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Hostname,FQDN,IPAddress,AssetTier,Environment,NetworkZone,Owner,OwnerEmail,DataClassification,ComplianceScope
PROD-EXCH-01,prod-exch-01.revflow.local,10.50.1.25,Tier 1,Production,Internet-facing,Messaging Team,messaging@revflow.com,Confidential,"SOC2,PCI"
PROD-WEB-03,prod-web-03.revflow.local,10.50.2.15,Tier 2,Production,Internet-facing,Web Operations,webops@revflow.com,Internal,SOC2
DEV-TEST-15,dev-test-15.revflow.local,10.60.5.42,Tier 3,Development,Internal,Development,dev@revflow.com,Internal,</code></pre>
        </div>

        <h3>4.2 Weekly Update Process</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Watchlist Update Workflow (Manual)</span></div>
          <pre><code>WEEKLY WATCHLIST UPDATE â€” EVERY MONDAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STEP 1: Export from CMDB (Manual)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Log into CMDB (ServiceNow, or whatever system you use)
â€¢ Run saved report: "Asset Inventory for Security"
â€¢ Export as CSV
â€¢ Columns: Hostname, FQDN, IP, Tier, Environment, Zone, Owner, Email, Classification, Compliance

STEP 2: Clean & Validate CSV
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Remove duplicates
â€¢ Standardize tier names (Tier 1 / Tier 2 / Tier 3)
â€¢ Standardize environment names (Production / Staging / Development / Test)
â€¢ Verify no blank hostnames

STEP 3: Upload to Sentinel Watchlist
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Sentinel â†’ Configuration â†’ Watchlists
â€¢ Select "AssetInventory_WL"
â€¢ Click "Update watchlist" â†’ Upload CSV
â€¢ Sentinel replaces existing data with new CSV

STEP 4: Verify Upload
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// KQL to verify watchlist is populated
_GetWatchlist('AssetInventory_WL')
| summarize 
    TotalAssets = count(),
    Tier1 = countif(AssetTier == "Tier 1"),
    Tier2 = countif(AssetTier == "Tier 2"),
    Tier3 = countif(AssetTier == "Tier 3")

Expected output:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TotalAssets â”‚ Tier1 â”‚ Tier2 â”‚ Tier3 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 9,247       â”‚ 312   â”‚ 1,845 â”‚ 7,090 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>

        <h3>4.3 Joining Watchlist in Analytics Rules</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">KQL â€” Enrich Vulnerabilities with Watchlist Data</span></div>
          <pre><code>// Join vulnerability data with asset watchlist
VulnInventory_CL
| where Priority_s in ("CRITICAL", "HIGH")
| where TimeGenerated > ago(1d)
| join kind=leftouter (
    _GetWatchlist('AssetInventory_WL')
    | project 
        Hostname = Hostname,
        AssetTier,
        Environment,
        NetworkZone,
        Owner,
        OwnerEmail,
        ComplianceScope
) on $left.Hostname_s == $right.Hostname
| extend 
    // If not in watchlist, flag for investigation
    AssetTier = coalesce(AssetTier, "UNKNOWN - Investigate"),
    Environment = coalesce(Environment, "UNKNOWN"),
    Owner = coalesce(Owner, "Unassigned")
| project 
    TimeGenerated,
    CVE_s,
    Hostname_s,
    CVSS_d,
    EPSS_d,
    KEV_b,
    Priority_s,
    RiskScore_d,
    AssetTier,
    Environment,
    NetworkZone,
    Owner,
    OwnerEmail</code></pre>
        </div>

        <div class="callout info">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>Handling Unknown Assets</div>
          <div class="callout-content">
            <p><strong>Assets not in watchlist get flagged as "UNKNOWN - Investigate".</strong> This catches:</p>
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
              <li>New assets deployed since last watchlist update</li>
              <li>Shadow IT or unauthorized systems</li>
              <li>Assets with hostname mismatches</li>
            </ul>
            <p style="margin-top: 0.5rem;">SOC adds unknown assets to next week's watchlist update after investigation.</p>
          </div>
        </div>

        <h3>4.2 EPSS & KEV: Native but Passed Through</h3>

        <p>Our automation still references EPSS and KEV scores, but now we pull them from the native scanner responses rather than making separate API calls:</p>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Data</th><th>MDVM Source</th><th>Qualys Source</th><th>Fallback</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>EPSS Score</strong></td>
                <td><code>epssScore</code> field</td>
                <td>TruRisk EPSS component</td>
                <td>FIRST.org API (if missing)</td>
              </tr>
              <tr>
                <td><strong>KEV Status</strong></td>
                <td><code>isKnownExploited</code></td>
                <td>RTI "Active Exploitation" flag</td>
                <td>CISA KEV JSON (if missing)</td>
              </tr>
              <tr>
                <td><strong>Exploitability</strong></td>
                <td><code>exploitabilityLevel</code></td>
                <td>Exploit Code Maturity</td>
                <td>N/A</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="callout info">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>Why Keep EPSS/KEV API Fallback?</div>
          <div class="callout-content">
            <p>Some older Qualys scans may not include EPSS. Some assets may only be scanned by network-based Qualys (no agent) and lack MDVM data. The FIRST.org EPSS API and CISA KEV JSON provide a safety net for these edge cases.</p>
          </div>
        </div>

        <h3>4.3 Decision Framework: When to Build Custom Automation</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Scenario</th><th>Use Native Tools</th><th>Build Custom Automation</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Single scanner environment</strong></td>
                <td>âœ… Native MDVM or Qualys dashboard</td>
                <td>âŒ Not needed</td>
              </tr>
              <tr>
                <td><strong>Multi-scanner environment</strong></td>
                <td>âŒ Console switching, duplicates</td>
                <td>âœ… Unified view + deduplication</td>
              </tr>
              <tr>
                <td><strong>No CMDB / asset inventory</strong></td>
                <td>âœ… Native exposure scores are enough</td>
                <td>âŒ Can't enrich without data</td>
              </tr>
              <tr>
                <td><strong>Mature CMDB with business criticality</strong></td>
                <td>âŒ Native tools don't know Tier 1/2/3</td>
                <td>âœ… Watchlist-aware prioritization</td>
              </tr>
              <tr>
                <td><strong>SOC can handle manual ticketing</strong></td>
                <td>âœ… Use native portal alerts</td>
                <td>âœ… Sentinel alerts, SOC creates tickets manually</td>
              </tr>
              <tr>
                <td><strong>Need deduplication for daily scans</strong></td>
                <td>âŒ Same alert every day</td>
                <td>âœ… Analytics rule skips already-alerted findings</td>
              </tr>
              <tr>
                <td><strong>SOC uses Sentinel for everything</strong></td>
                <td>âŒ Another console to monitor</td>
                <td>âœ… Vuln data in same workbook as security alerts</td>
              </tr>
              <tr>
                <td><strong>Compliance requires trend reporting</strong></td>
                <td>âŒ Point-in-time views only</td>
                <td>âœ… Log Analytics retention for historical</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="callout warning">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>Don't Over-Engineer</div>
          <div class="callout-content">
            <p><strong>If you only use MDVM</strong> and your asset inventory is basic, the native MDVM dashboard with its built-in EPSS, KEV, and exposure scoring is probably sufficient. Custom automation adds complexity that must be maintained.</p>
            <p style="margin-top: 0.5rem;"><strong>We built this because:</strong> RevFlow has both Qualys (network scanning) and MDVM (agent-based), SOC lives in Sentinel, and we needed deduplication for daily scans plus asset context from a weekly CMDB export. No auto-ticketing â€” SOC handles that manually after triage.</p>
          </div>
        </div>

        <!-- ==================== SECTION 5: RISK SCORING MODEL ==================== -->
        <h2>5. Custom Risk Scoring Model</h2>

        <p>We combine multiple scoring inputs â€” CVSS, tool-native scores (MDVM Exposure Score, Qualys TruRisk), and CMDB context â€” into a unified risk score:</p>

        <div class="callout info">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>Why Not Just Use CVSS?</div>
          <div class="callout-content">
            <p><strong>CVSS alone is insufficient.</strong> A CVSS 9.8 on a test VM matters less than a CVSS 7.0 on a Tier 1 payment server. We combine three layers:</p>
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
              <li><strong>CVSS:</strong> Technical severity (0-10)</li>
              <li><strong>Tool Scores:</strong> MDVM Exposure Score (0-100) or Qualys TruRisk â€” these already factor in EPSS, KEV, exploitability</li>
              <li><strong>CMDB Context:</strong> Business criticality, environment, network exposure</li>
            </ul>
          </div>
        </div>

        <h3>5.1 Input Scores from Each Tool</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Score</th><th>Source</th><th>Range</th><th>What It Includes</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>CVSS</strong></td>
                <td>Both tools</td>
                <td>0-10</td>
                <td>Technical severity only (attack vector, complexity, impact)</td>
              </tr>
              <tr>
                <td><strong>MDVM Exposure Score</strong></td>
                <td>Microsoft MDVM</td>
                <td>0-100</td>
                <td>CVSS + EPSS + KEV + exploitability + device exposure + threat insights</td>
              </tr>
              <tr>
                <td><strong>Qualys TruRisk</strong></td>
                <td>Qualys VMDR</td>
                <td>0-1000</td>
                <td>CVSS + EPSS + exploit maturity + RTI (ransomware, active exploitation) + asset criticality tags</td>
              </tr>
              <tr>
                <td><strong>EPSS</strong></td>
                <td>Both (native)</td>
                <td>0.0-1.0</td>
                <td>Probability of exploitation in 30 days</td>
              </tr>
              <tr>
                <td><strong>KEV Status</strong></td>
                <td>Both (native)</td>
                <td>Yes/No</td>
                <td>Confirmed active exploitation in the wild</td>
              </tr>
            </tbody>
          </table>
        </div>

        <h3>5.2 Unified Risk Score Formula</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">RevFlow Unified Risk Score Calculation</span></div>
          <pre><code># RevFlow Risk Score Formula â€” Combining CVSS + Tool Scores + CMDB Context
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def calculate_risk_score(vuln: dict) -> float:
    """
    Combines:
    - CVSS (technical severity)
    - Tool-native score (MDVM Exposure or Qualys TruRisk)
    - CMDB business context
    """
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # STEP 1: Get base technical score (CVSS)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    cvss = vuln.get('cvss_v3', vuln.get('cvss_v2', 5.0))  # 0-10
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # STEP 2: Get tool-native score (already includes EPSS, KEV, exploitability)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if vuln.get('source') == 'MDVM':
        # MDVM Exposure Score: 0-100, normalize to 0-10
        tool_score = vuln.get('mdvm_exposure_score', 50) / 10
    elif vuln.get('source') == 'Qualys':
        # Qualys TruRisk: 0-1000, normalize to 0-10
        tool_score = vuln.get('qualys_trurisk', 500) / 100
    else:
        # Fallback: calculate from EPSS + KEV
        tool_score = calculate_epss_kev_score(vuln)
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # STEP 3: Blend CVSS + Tool Score (weighted average)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Tool score carries more weight because it includes threat intel
    TECHNICAL_SCORE = (cvss * 0.4) + (tool_score * 0.6)  # 0-10
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # STEP 4: Apply CMDB multipliers (what tools DON'T know)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    # Asset criticality from CMDB
    tier = vuln.get('asset_tier', 'Tier 3')
    ASSET_MULTIPLIER = {'Tier 1': 2.0, 'Tier 2': 1.5, 'Tier 3': 1.0}.get(tier, 1.0)
    
    # Network exposure from CMDB
    exposure = vuln.get('network_exposure', 'Internal')
    EXPOSURE_MULTIPLIER = {
        'Internet-facing': 2.0,
        'DMZ': 1.5,
        'Internal': 1.0
    }.get(exposure, 1.0)
    
    # Environment from CMDB
    env = vuln.get('environment', 'Development')
    ENV_MULTIPLIER = {
        'Production': 1.5,
        'Staging': 1.2,
        'Development': 1.0,
        'Test': 0.8
    }.get(env, 1.0)
    
    # Compliance scope boost
    compliance = vuln.get('compliance_scope', [])
    COMPLIANCE_MULTIPLIER = 1.3 if ('PCI' in compliance or 'SOC2' in compliance) else 1.0
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # STEP 5: Calculate final score
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    RISK_SCORE = (TECHNICAL_SCORE 
                  * ASSET_MULTIPLIER 
                  * EXPOSURE_MULTIPLIER 
                  * ENV_MULTIPLIER 
                  * COMPLIANCE_MULTIPLIER)
    
    return round(RISK_SCORE, 1)


def calculate_epss_kev_score(vuln: dict) -> float:
    """Fallback if tool score is missing"""
    base = vuln.get('cvss_v3', 5.0)
    epss = vuln.get('epss', 0.0)
    kev = vuln.get('is_kev', False)
    
    if kev:
        return min(base * 2.0, 10.0)
    elif epss > 0.7:
        return min(base * 1.8, 10.0)
    elif epss > 0.4:
        return min(base * 1.5, 10.0)
    elif epss > 0.1:
        return min(base * 1.2, 10.0)
    return base


def assign_priority(risk_score: float, is_kev: bool) -> str:
    """Assign priority based on risk score"""
    if risk_score >= 50 or is_kev:
        return "CRITICAL"    # Remediate within 24-48 hours
    elif risk_score >= 30:
        return "HIGH"        # Remediate within 7 days
    elif risk_score >= 15:
        return "MEDIUM"      # Remediate within 30 days
    else:
        return "LOW"         # Remediate within 90 days or accept risk</code></pre>
        </div>

        <h3>5.3 Risk Score Examples (With Tool Scores)</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>CVE</th>
                <th>CVSS</th>
                <th>MDVM Exp.</th>
                <th>Qualys TruRisk</th>
                <th>EPSS</th>
                <th>KEV</th>
                <th>Tier</th>
                <th>Exposure</th>
                <th>Env</th>
                <th>Risk Score</th>
                <th>Priority</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><code>CVE-2023-23397</code></td>
                <td>9.8</td>
                <td>95</td>
                <td>920</td>
                <td>0.97</td>
                <td>âœ…</td>
                <td>Tier 1</td>
                <td>Internet</td>
                <td>Prod</td>
                <td><strong>85.5</strong></td>
                <td><span class="priority-badge critical">CRITICAL</span></td>
              </tr>
              <tr>
                <td><code>CVE-2024-21351</code></td>
                <td>7.8</td>
                <td>72</td>
                <td>650</td>
                <td>0.45</td>
                <td>âœ…</td>
                <td>Tier 2</td>
                <td>Internet</td>
                <td>Prod</td>
                <td><strong>58.3</strong></td>
                <td><span class="priority-badge critical">CRITICAL</span></td>
              </tr>
              <tr>
                <td><code>CVE-2024-38063</code></td>
                <td>9.8</td>
                <td>85</td>
                <td>780</td>
                <td>0.82</td>
                <td>âŒ</td>
                <td>Tier 1</td>
                <td>DMZ</td>
                <td>Prod</td>
                <td><strong>51.2</strong></td>
                <td><span class="priority-badge critical">CRITICAL</span></td>
              </tr>
              <tr>
                <td><code>CVE-2024-12345</code></td>
                <td>7.5</td>
                <td>45</td>
                <td>380</td>
                <td>0.08</td>
                <td>âŒ</td>
                <td>Tier 1</td>
                <td>Internal</td>
                <td>Prod</td>
                <td><strong>18.9</strong></td>
                <td><span class="priority-badge medium">MEDIUM</span></td>
              </tr>
              <tr>
                <td><code>CVE-2024-99999</code></td>
                <td>9.0</td>
                <td>55</td>
                <td>420</td>
                <td>0.02</td>
                <td>âŒ</td>
                <td>Tier 3</td>
                <td>Internal</td>
                <td>Dev</td>
                <td><strong>5.2</strong></td>
                <td><span class="priority-badge low">LOW</span></td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="callout warning">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>Key Insight</div>
          <div class="callout-content">
            <p><strong>Notice CVE-2024-99999:</strong> CVSS 9.0 (Critical by CVSS alone) but our Risk Score is only 5.2 (LOW priority). Why? It's on a Tier 3 internal development box with low EPSS (0.02) and no KEV. The business context matters.</p>
          </div>
        </div>

        <!-- ==================== OUTPUT TABLE: WHAT SOC SEES ==================== -->
        <h3>5.4 Output Table: What SOC Analysts See</h3>

        <p>After aggregation, enrichment, and scoring, this is the actual data that lands in the Sentinel workbook:</p>

        <div class="flow-diagram">
          <pre><code>UNIFIED VULNERABILITY INVENTORY â€” SOC WORKQUEUE VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CVE            â”‚ PRIORITY  â”‚ AFFECTED HOST                      â”‚ CVSS  â”‚ MDVM   â”‚ EPSS  â”‚ KEV      â”‚ ASSET TIER â”‚ NETWORK â”‚ ENVIRONMENT   â”‚ RISK      â”‚ OWNER                      â”‚
â”‚                â”‚           â”‚                                    â”‚       â”‚ SCORE  â”‚       â”‚          â”‚            â”‚         â”‚               â”‚ SCORE     â”‚                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CVE-2023-23397 â”‚ CRITICAL  â”‚ PROD-EXCH-01.revflow.local         â”‚ 9.8   â”‚ 95     â”‚ 0.97  â”‚ âœ… Yes   â”‚ Tier 1     â”‚ Internetâ”‚ Production    â”‚ 85.5      â”‚ messaging-team@revflow.com â”‚
â”‚ CVE-2024-21351 â”‚ CRITICAL  â”‚ PROD-WEB-03.revflow.local          â”‚ 7.8   â”‚ 72     â”‚ 0.45  â”‚ âœ… Yes   â”‚ Tier 2     â”‚ Internetâ”‚ Production    â”‚ 58.3      â”‚ webops@revflow.com         â”‚
â”‚ CVE-2024-38063 â”‚ CRITICAL  â”‚ PROD-DC-02.revflow.local           â”‚ 9.8   â”‚ 85     â”‚ 0.82  â”‚ âŒ No    â”‚ Tier 1     â”‚ DMZ     â”‚ Production    â”‚ 51.2      â”‚ infra-team@revflow.com     â”‚
â”‚ CVE-2024-30088 â”‚ HIGH      â”‚ PROD-APP-07.revflow.local          â”‚ 7.0   â”‚ 62     â”‚ 0.35  â”‚ âŒ No    â”‚ Tier 1     â”‚ Internalâ”‚ Production    â”‚ 38.4      â”‚ app-team@revflow.com       â”‚
â”‚ CVE-2024-12345 â”‚ MEDIUM    â”‚ PROD-DB-01.revflow.local           â”‚ 7.5   â”‚ 45     â”‚ 0.08  â”‚ âŒ No    â”‚ Tier 1     â”‚ Internalâ”‚ Production    â”‚ 18.9      â”‚ dba-team@revflow.com       â”‚
â”‚ CVE-2024-55555 â”‚ MEDIUM    â”‚ STG-APP-02.revflow.local           â”‚ 8.1   â”‚ 58     â”‚ 0.12  â”‚ âŒ No    â”‚ Tier 2     â”‚ Internalâ”‚ Staging       â”‚ 16.2      â”‚ app-team@revflow.com       â”‚
â”‚ CVE-2024-99999 â”‚ LOW       â”‚ DEV-TEST-15.revflow.local          â”‚ 9.0   â”‚ 55     â”‚ 0.02  â”‚ âŒ No    â”‚ Tier 3     â”‚ Internalâ”‚ Development   â”‚ 5.2       â”‚ dev-team@revflow.com       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ADDITIONAL FIELDS AVAILABLE (expandable in workbook):
â€¢ Software: Affected application/component name and version
â€¢ Patch KB: Microsoft KB number or vendor patch identifier
â€¢ First Seen: Date vulnerability was first detected
â€¢ Days Open: How long remediation has been pending
â€¢ Qualys QID: If detected by Qualys
â€¢ Recommendation: Remediation guidance from MDVM/Qualys
</code></pre>
        </div>

        <h3>5.5 Sample Sentinel Incident (What SOC Receives)</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Sentinel Incident â€” Auto-Generated for Critical/High Findings</span></div>
          <pre><code>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SENTINEL INCIDENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

TITLE: [CRITICAL] CVE-2023-23397 on PROD-EXCH-01 â€” Tier 1 Production

SEVERITY: High
STATUS: New
OWNER: Unassigned (SOC to triage)

DESCRIPTION:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
A CRITICAL vulnerability has been detected on a Tier 1 production asset.

VULNERABILITY DETAILS:
â€¢ CVE: CVE-2023-23397
â€¢ Title: Microsoft Outlook Elevation of Privilege Vulnerability
â€¢ CVSS Score: 9.8 (Critical)
â€¢ MDVM Exposure Score: 95/100
â€¢ EPSS: 0.97 (97% likelihood of exploitation within 30 days)
â€¢ CISA KEV: âœ… YES â€” Actively exploited in the wild

AFFECTED ASSET (from watchlist):
â€¢ Hostname: PROD-EXCH-01.revflow.local
â€¢ Asset Tier: Tier 1 (Mission-Critical)
â€¢ Environment: Production
â€¢ Network Zone: Internet-facing
â€¢ Owner: Messaging Team (messaging@revflow.com)

CALCULATED RISK SCORE: 85.5

RECOMMENDED REMEDIATION:
â€¢ Apply KB5034763 (February 2024 Cumulative Update)
â€¢ Workaround: Disable NTLM or block outbound SMB (445/TCP) if patching delayed

LINKS:
â€¢ Microsoft Advisory: https://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-23397
â€¢ CISA KEV Entry: https://www.cisa.gov/known-exploited-vulnerabilities-catalog

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ENTITIES:
â€¢ Host: PROD-EXCH-01.revflow.local
â€¢ IP: 10.50.1.25

RELATED ALERTS: 1
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SOC NEXT STEPS:
1. Triage and validate finding
2. Contact asset owner (Messaging Team)
3. Create ticket in internal system if confirmed
4. Track remediation to completion
5. Close incident when resolved
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</code></pre>
        </div>

        <div class="callout info">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>No Auto-Ticketing</div>
          <div class="callout-content">
            <p><strong>SOC owns everything after the alert.</strong> Analysts triage, validate, create tickets in our internal system, coordinate with asset owners, and track remediation. The automation only surfaces the findings â€” it doesn't create tickets or assign owners automatically.</p>
          </div>
        </div>

        <!-- ==================== DEDUPLICATION FOR ALERTS ==================== -->
        <h3>5.6 Avoiding Alert Fatigue: Deduplication Logic</h3>

        <div class="callout critical">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>The Problem: Daily Scans = Duplicate Alerts</div>
          <div class="callout-content">
            <p><strong>If the pipeline runs daily and creates an alert for every Critical finding, SOC drowns in duplicates.</strong> Same CVE on same host = same alert every day. 50 Critical vulnerabilities Ã— 30 days = 1,500 duplicate alerts. That's alert fatigue â€” real issues get ignored.</p>
          </div>
        </div>

        <h4>Solution: Alert Only on First Detection + Weekly Re-Alert</h4>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Deduplication Logic for Daily Scans</span></div>
          <pre><code>DEDUPLICATION â€” HOW WE AVOID DUPLICATE ALERTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

APPROACH: Track "first seen" in Log Analytics, only alert on NEW findings
          Re-alert weekly for unresolved Critical items (not daily)

STEP 1: Write ALL findings to Log Analytics daily
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Every scan result goes to VulnInventory_CL table:
â€¢ CVE, hostname, CVSS, EPSS, KEV, risk score, priority
â€¢ TimeGenerated = today's date
â€¢ This gives us historical data for trending/reporting

STEP 2: Analytics Rule filters for NEW findings only
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
The Sentinel analytics rule compares today's findings against historical data.
Only fires alert if finding is:
  a) NEW (not seen in past 7 days), OR
  b) CRITICAL + unresolved for 7+ days (weekly re-alert)

KQL LOGIC:
let lookback = 7d;
let today_findings = VulnInventory_CL
    | where TimeGenerated > ago(1d)
    | where Priority_s in ("CRITICAL", "HIGH");
let historical_findings = VulnInventory_CL
    | where TimeGenerated between (ago(lookback) .. ago(1d))
    | distinct CVE_s, Hostname_s;
// NEW findings = today minus historical
today_findings
| join kind=leftanti historical_findings 
    on $left.CVE_s == $right.CVE_s, $left.Hostname_s == $right.Hostname_s
// This returns only findings NOT seen in past 7 days


RESULT:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Day 1: CVE-2023-23397 on PROD-EXCH-01 detected
       â†’ NEW finding â†’ Alert created â†’ SOC triages

Day 2-7: Same finding still present
       â†’ Already alerted â†’ No new alert (SOC still working on it)

Day 8: Finding still present, 7 days old
       â†’ Re-alert: "CRITICAL vulnerability unresolved for 7 days"
       â†’ SOC escalates if needed

Day 15: Finding resolved (patched)
       â†’ No longer in scan results â†’ No alert

Day 45: Finding reappears (regression!)
       â†’ NEW finding (not seen in past 7 days) â†’ Alert created</code></pre>
        </div>

        <h4>Analytics Rule: New Critical/High Vulnerabilities</h4>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Sentinel Analytics Rule â€” KQL</span></div>
          <pre><code>// RULE: New Critical/High Vulnerability Detected
// Fires only for findings not seen in past 7 days
// Prevents daily duplicate alerts for same CVE+host

let lookback = 7d;

// Today's Critical/High findings
let today_findings = VulnInventory_CL
    | where TimeGenerated > ago(1d)
    | where Priority_s in ("CRITICAL", "HIGH")
    | project 
        CVE_s, 
        Hostname_s, 
        CVSS_d, 
        EPSS_d, 
        KEV_b, 
        RiskScore_d, 
        Priority_s,
        AssetTier_s,
        Environment_s,
        Owner_s;

// Historical findings (what we've already alerted on)
let historical = VulnInventory_CL
    | where TimeGenerated between (ago(lookback) .. ago(1d))
    | distinct CVE_s, Hostname_s;

// Return only NEW findings
today_findings
| join kind=leftanti historical 
    on $left.CVE_s == $right.CVE_s, $left.Hostname_s == $right.Hostname_s
| extend 
    AlertTitle = strcat("[", Priority_s, "] ", CVE_s, " on ", Hostname_s),
    AlertDescription = strcat(
        "New ", Priority_s, " vulnerability detected.\n",
        "CVE: ", CVE_s, "\n",
        "Host: ", Hostname_s, "\n",
        "CVSS: ", CVSS_d, "\n",
        "EPSS: ", EPSS_d, "\n",
        "KEV: ", iff(KEV_b, "YES - Actively Exploited", "No"), "\n",
        "Risk Score: ", RiskScore_d, "\n",
        "Asset Tier: ", AssetTier_s, "\n",
        "Owner: ", Owner_s
    )</code></pre>
        </div>

        <h4>Weekly Re-Alert for Unresolved Critical Items</h4>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Sentinel Analytics Rule â€” Unresolved Critical (Weekly)</span></div>
          <pre><code>// RULE: Unresolved Critical Vulnerability â€” Weekly Escalation
// Fires for CRITICAL items open 7+ days
// Runs weekly (not daily) to avoid alert fatigue

// Find Critical items seen every day for past 7 days (still unresolved)
VulnInventory_CL
| where TimeGenerated > ago(7d)
| where Priority_s == "CRITICAL"
| summarize 
    DaysDetected = dcount(bin(TimeGenerated, 1d)),
    FirstSeen = min(TimeGenerated),
    LatestScore = arg_max(TimeGenerated, RiskScore_d)
    by CVE_s, Hostname_s, AssetTier_s, Owner_s
| where DaysDetected >= 7  // Present every day for 7 days = unresolved
| extend 
    DaysOpen = datetime_diff('day', now(), FirstSeen),
    AlertTitle = strcat("[ESCALATION] ", CVE_s, " unresolved for ", DaysOpen, " days"),
    AlertDescription = strcat(
        "CRITICAL vulnerability has been open for ", DaysOpen, " days.\n",
        "This requires immediate attention.\n\n",
        "CVE: ", CVE_s, "\n",
        "Host: ", Hostname_s, "\n",
        "Asset Tier: ", AssetTier_s, "\n",
        "Owner: ", Owner_s, "\n",
        "First Detected: ", FirstSeen
    )</code></pre>
        </div>

        <div class="callout success">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Interview Talking Point</div>
          <div class="callout-content">
            <p><em>"To avoid alert fatigue from daily scans, we deduplicate at the analytics rule level. All findings go to Log Analytics daily for trending, but the alert rule compares today's findings against the past 7 days. Only NEW findings trigger alerts. For unresolved Critical items, we have a separate weekly rule that escalates anything open for 7+ days. This way SOC gets one alert when a vulnerability first appears, not 30 alerts over a month."</em></p>
          </div>
        </div>

        <!-- ==================== MANUAL SOC WORKFLOWS ==================== -->
        <h3>5.7 Manual SOC Workflows: What Happens After the Alert</h3>

        <p>Automation creates alerts â€” <strong>SOC handles everything else manually</strong>. Here's the workflow:</p>

        <div class="callout info">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>Automation vs. Manual Work</div>
          <div class="callout-content">
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
              <li><strong>Automation does:</strong> Aggregate scans, deduplicate, enrich from watchlist, calculate risk score, create Sentinel alerts</li>
              <li><strong>SOC does manually:</strong> Triage alerts, validate findings, create tickets (internal system), contact asset owners, track remediation, close incidents</li>
            </ul>
          </div>
        </div>

        <h4>Workflow 1: SOC Triage (After Alert Fires)</h4>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">SOC Triage Workflow</span></div>
          <pre><code>SOC TRIAGE â€” WHEN SENTINEL INCIDENT ARRIVES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STEP 1: REVIEW INCIDENT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Open Sentinel incident
â€¢ Review: CVE, hostname, CVSS, EPSS, KEV status, risk score, asset tier
â€¢ Check: Is this a real finding or noise?

STEP 2: VALIDATE FINDING
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Cross-check with MDVM portal: Is vulnerability still showing?
â€¢ Cross-check with Qualys: Same finding?
â€¢ Check patch status: Was this already patched? (Get-HotFix)
â€¢ If false positive â†’ Close incident with notes â†’ Update exclusion watchlist

STEP 3: IF VALID â€” CREATE INTERNAL TICKET
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Create ticket in internal ticketing system
â€¢ Include: CVE, hostname, CVSS, risk score, owner from watchlist
â€¢ Set priority based on risk score (CRITICAL = urgent, HIGH = 7 days, etc.)
â€¢ Assign to asset owner team

STEP 4: CONTACT ASSET OWNER
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Email/Teams message to owner (from watchlist)
â€¢ Include: What's vulnerable, why it matters, remediation steps
â€¢ Set expectation for SLA (manual tracking)

STEP 5: TRACK REMEDIATION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Follow up with owner if no response
â€¢ Check MDVM/Qualys for resolution
â€¢ When fixed: Close ticket + Sentinel incident

STEP 6: CLOSE INCIDENT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Add resolution notes
â€¢ Status: True Positive - Resolved / False Positive / Exception Granted
â€¢ Incident closed</code></pre>
        </div>

        <h4>Workflow 2: False Positive Handling</h4>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">False Positive Workflow â€” SOC Analyst</span></div>
          <pre><code>FALSE POSITIVE SCENARIO:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Scanner detected: CVE-2024-12345 on PROD-APP-03
Reality: Patch KB5034123 was applied last week, but scanner hasn't re-scanned

SOC ANALYST ACTIONS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. VERIFY THE FALSE POSITIVE
   â€¢ Check patch history in SCCM/Intune: Was KB5034123 deployed?
   â€¢ Check installed updates on host: Get-HotFix | Where-Object {$_.HotFixID -eq "KB5034123"}
   â€¢ Check MDVM "Security Recommendations" â€” does it still show as vulnerable?
   â€¢ If patched but still showing: Scanner lag or detection logic issue

2. CLOSE SENTINEL INCIDENT
   â€¢ Status: Closed - False Positive
   â€¢ Notes: "KB5034123 installed 2024-12-18. Scanner lag â€” vulnerability already patched."

3. UPDATE EXCLUSION WATCHLIST (if recurring FP)
   If same CVE+host keeps firing, add to exclusion watchlist:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ CVE              â”‚ Hostname                â”‚ Reason           â”‚ Expiry     â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ CVE-2024-12345   â”‚ PROD-APP-03             â”‚ Scanner lag,     â”‚ 2025-01-15 â”‚
   â”‚                  â”‚                         â”‚ KB5034123 appliedâ”‚            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   Analytics rule excludes these from future alerts.

4. REQUEST RESCAN
   â€¢ MDVM: Device page â†’ "Run antivirus scan"
   â€¢ Qualys: Request on-demand scan from Qualys admin</code></pre>
        </div>

        <h4>Workflow 3: Remediation Coordination (Manual)</h4>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Remediation Workflow â€” SOC Coordinates with Asset Owner</span></div>
          <pre><code>REMEDIATION SCENARIO:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Sentinel Incident: CVE-2023-23397 on PROD-EXCH-01
Priority: CRITICAL
Owner (from watchlist): Messaging Team

SOC COORDINATION STEPS (all manual):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. SOC CREATES INTERNAL TICKET
   â€¢ Create ticket in internal ticketing system (not ServiceNow)
   â€¢ Include all details from Sentinel incident
   â€¢ Assign to Messaging Team

2. SOC CONTACTS ASSET OWNER
   â€¢ Email/Teams to messaging@revflow.com
   â€¢ "Critical vulnerability on PROD-EXCH-01 requires patching"
   â€¢ Include: CVE, CVSS, risk score, recommended patch (KB5034763)

3. ASSET OWNER PLANS REMEDIATION
   â€¢ Option A: Apply patch during maintenance window
   â€¢ Option B: Apply workaround immediately, patch later
   â€¢ Option C: Request exception (if cannot patch)

4. PATCH TEAM EXECUTES
   â€¢ Deploy via SCCM/Intune
   â€¢ Verify installation: Get-HotFix -Id KB5034763
   â€¢ Reboot if required

5. SOC VERIFIES & CLOSES
   â€¢ Check MDVM/Qualys â€” vulnerability cleared?
   â€¢ Close internal ticket
   â€¢ Close Sentinel incident: "Resolved - Patch Applied"</code></pre>
        </div>

        <h4>Workflow 4: Exception Handling (Manual)</h4>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Exception Workflow â€” When Patching Is Not Possible</span></div>
          <pre><code>EXCEPTION SCENARIO:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CVE-2024-30088 on PROD-LEGACY-01
Problem: Legacy app requires Windows Server 2012 R2, patch not available

MANUAL EXCEPTION PROCESS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. ASSET OWNER DOCUMENTS EXCEPTION REQUEST
   â€¢ Why patching is not possible
   â€¢ Proposed compensating controls
   â€¢ Business impact if system offline
   â€¢ Requested duration + review date

2. SECURITY TEAM REVIEWS
   â€¢ Validates compensating controls are in place
   â€¢ Documents residual risk
   â€¢ May request additional controls

3. APPROVAL CHAIN (email/meeting)
   â€¢ Asset Owner â†’ Security Team â†’ IT Manager â†’ CISO (for Critical)

4. DOCUMENT EXCEPTION
   â€¢ Add to risk register (spreadsheet/SharePoint)
   â€¢ Add to exclusion watchlist (so alert doesn't keep firing)
   â€¢ Set calendar reminder for review date

5. CLOSE SENTINEL INCIDENT
   â€¢ Status: Closed - Exception Approved
   â€¢ Notes: "Exception granted until [date]. Compensating controls in place."

EXCLUSION WATCHLIST (to suppress recurring alerts):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CVE              â”‚ Hostname            â”‚ Reason              â”‚ Expiry     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CVE-2024-30088   â”‚ PROD-LEGACY-01      â”‚ Exception approved  â”‚ 2025-06-22 â”‚
â”‚ CVE-2023-44487   â”‚ PROD-PROXY-02       â”‚ Exception approved  â”‚ 2025-01-15 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Analytics rule checks this watchlist and excludes matching CVE+Host pairs.</code></pre>
        </div>

        <div class="callout success">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Interview Talking Point</div>
          <div class="callout-content">
            <p><em>"We don't have ServiceNow integration â€” everything after the alert is manual. Automation aggregates scans, enriches with watchlist data, calculates risk scores, and creates Sentinel alerts. SOC triages, validates, creates tickets in our internal system, and coordinates remediation with asset owners. For false positives and exceptions, we maintain exclusion watchlists that the analytics rule checks before firing. CMDB data comes from a weekly CSV export that we upload to a Sentinel watchlist â€” not a live API."</em></p>
          </div>
        </div>
        </div>

        <!-- ==================== SECTION 6: IMPLEMENTATION ==================== -->
        <h2>6. Implementation â€” Azure Function + Analytics Rules</h2>

        <h3>6.1 Azure Function Structure</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Azure Function Project Structure</span></div>
          <pre><code>vuln-enrichment-function/
â”œâ”€â”€ function_app.py              # Main function code
â”œâ”€â”€ requirements.txt             # Python dependencies
â”œâ”€â”€ host.json                    # Function host configuration
â”œâ”€â”€ local.settings.json          # Local dev settings (not deployed)
â””â”€â”€ modules/
    â”œâ”€â”€ qualys_client.py         # Qualys API wrapper
    â”œâ”€â”€ mde_client.py            # MDE TVM API wrapper
    â”œâ”€â”€ scoring.py               # Risk score calculation
    â””â”€â”€ log_analytics.py         # Log Analytics writer</code></pre>
        </div>

        <div class="callout info">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>What the Function Does vs. What Sentinel Does</div>
          <div class="callout-content">
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
              <li><strong>Azure Function:</strong> Aggregates scans, deduplicates, calculates risk score, writes ALL findings to Log Analytics daily</li>
              <li><strong>Sentinel Analytics Rule:</strong> Queries Log Analytics, compares against historical data, creates alerts only for NEW findings</li>
              <li><strong>Watchlist:</strong> Asset context (Tier, Owner, Environment) â€” updated weekly via manual CSV upload</li>
            </ul>
          </div>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">function_app.py â€” Main Azure Function</span><button class="code-copy-btn">Copy</button></div>
          <pre><code>import azure.functions as func
import logging
from datetime import datetime
from modules.qualys_client import get_qualys_vulnerabilities
from modules.mde_client import get_mde_vulnerabilities
from modules.scoring import calculate_risk_scores
from modules.log_analytics import write_to_log_analytics

app = func.FunctionApp()

# Timer trigger: runs daily at 6 AM UTC
@app.timer_trigger(schedule="0 0 6 * * *", arg_name="timer", run_on_startup=False)
def vuln_enrichment_pipeline(timer: func.TimerRequest) -> None:
    """
    Main vulnerability enrichment pipeline
    Runs daily to aggregate, deduplicate, score, and write to Log Analytics
    
    NOTE: This function does NOT create alerts or tickets.
    - Sentinel analytics rules handle alerting (with deduplication)
    - SOC handles ticketing manually after triage
    - Asset context comes from watchlist (updated weekly)
    """
    logging.info(f"Vulnerability enrichment started at {datetime.utcnow()}")
    
    try:
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        # STEP 1: Aggregate vulnerabilities from all sources
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        logging.info("Step 1: Fetching vulnerabilities from Qualys...")
        qualys_vulns = get_qualys_vulnerabilities()
        logging.info(f"  Found {len(qualys_vulns)} Qualys vulnerabilities")
        
        logging.info("Step 1: Fetching vulnerabilities from MDVM...")
        mde_vulns = get_mde_vulnerabilities()
        logging.info(f"  Found {len(mde_vulns)} MDVM vulnerabilities")
        
        # Combine and deduplicate by CVE + hostname
        all_vulns = deduplicate_vulnerabilities(qualys_vulns + mde_vulns)
        logging.info(f"  Combined: {len(all_vulns)} unique vulnerabilities")
        
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        # STEP 2: Calculate risk scores
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        # Note: EPSS and KEV come from MDVM/Qualys natively
        # Asset context (Tier, Owner) comes from watchlist join in Sentinel
        logging.info("Step 2: Calculating risk scores...")
        all_vulns = calculate_risk_scores(all_vulns)
        
        critical_count = len([v for v in all_vulns if v["priority"] == "CRITICAL"])
        high_count = len([v for v in all_vulns if v["priority"] == "HIGH"])
        logging.info(f"  Priority: {critical_count} Critical, {high_count} High")
        
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        # STEP 3: Write ALL findings to Log Analytics
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        # Analytics rule will handle deduplication for alerting
        logging.info("Step 3: Writing to Log Analytics...")
        write_to_log_analytics(all_vulns, table_name="VulnInventory_CL")
        logging.info(f"  Wrote {len(all_vulns)} records to VulnInventory_CL")
        
        logging.info(f"Pipeline completed at {datetime.utcnow()}")
        
    except Exception as e:
        logging.error(f"Pipeline failed: {str(e)}")
        raise

def deduplicate_vulnerabilities(vulns):
    """Deduplicate by CVE + hostname, keep highest score"""
    seen = {}
    for vuln in vulns:
        key = (vuln.get("cve_id"), vuln.get("hostname"))
        if key not in seen:
            seen[key] = vuln
        else:
            # Merge sources
            existing_sources = seen[key].get("sources", [seen[key].get("source")])
            existing_sources.append(vuln.get("source"))
            seen[key]["sources"] = list(set(existing_sources))
    return list(seen.values())</code></pre>
        </div>

        <h3>6.2 Writing to Log Analytics (Custom Table)</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Python â€” Log Analytics Data Collector API</span><button class="code-copy-btn">Copy</button></div>
          <pre><code>import requests
import json
import hashlib
import hmac
import base64
from datetime import datetime
import os

def write_to_log_analytics(vulnerabilities, table_name="VulnerabilityInventory_CL"):
    """
    Write enriched vulnerability data to Log Analytics custom table
    Uses the Data Collector API (legacy) or DCR-based ingestion
    """
    
    workspace_id = os.environ["LOG_ANALYTICS_WORKSPACE_ID"]
    shared_key = os.environ["LOG_ANALYTICS_SHARED_KEY"]
    
    # Prepare the data
    body = json.dumps([{
        "TimeGenerated": datetime.utcnow().isoformat() + "Z",
        "CVE": v.get("cve_id"),
        "Hostname": v.get("hostname"),
        "IPAddress": v.get("ip_address"),
        "CVSSScore": v.get("cvss_score"),
        "EPSSScore": v.get("epss_score"),
        "EPSSPercentile": v.get("epss_percentile"),
        "InCISAKEV": v.get("in_cisa_kev", False),
        "KEVDueDate": v.get("kev_due_date"),
        "AssetTier": v.get("asset_tier"),
        "Environment": v.get("environment"),
        "Exposure": v.get("exposure"),
        "AssetOwner": v.get("asset_owner"),
        "RiskScore": v.get("risk_score"),
        "Priority": v.get("priority"),
        "SLADays": v.get("sla_days"),
        "Title": v.get("title"),
        "Sources": ",".join(v.get("sources", [v.get("source", "Unknown")]))
    } for v in vulnerabilities])
    
    # Build authorization signature
    content_length = len(body)
    rfc1123date = datetime.utcnow().strftime('%a, %d %b %Y %H:%M:%S GMT')
    
    string_to_sign = f"POST\n{content_length}\napplication/json\nx-ms-date:{rfc1123date}\n/api/logs"
    signature = base64.b64encode(
        hmac.new(
            base64.b64decode(shared_key),
            string_to_sign.encode('utf-8'),
            hashlib.sha256
        ).digest()
    ).decode('utf-8')
    
    # Send to Log Analytics
    uri = f"https://{workspace_id}.ods.opinsights.azure.com/api/logs?api-version=2016-04-01"
    headers = {
        "Content-Type": "application/json",
        "Log-Type": table_name.replace("_CL", ""),  # API adds _CL suffix
        "x-ms-date": rfc1123date,
        "Authorization": f"SharedKey {workspace_id}:{signature}",
        "time-generated-field": "TimeGenerated"
    }
    
    response = requests.post(uri, data=body, headers=headers)
    
    if response.status_code == 200 or response.status_code == 202:
        logging.info(f"Successfully wrote {len(vulnerabilities)} records to {table_name}")
    else:
        logging.error(f"Failed to write to Log Analytics: {response.status_code} - {response.text}")
        raise Exception(f"Log Analytics write failed: {response.text}")</code></pre>
        </div>

        <h3>Step 1: Data Collection (Called by Main Function)</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Python â€” Collect Vulnerabilities from Qualys and MDE</span><button class="code-copy-btn">Copy</button></div>
          <pre><code>import requests
import json
from azure.identity import DefaultAzureCredential
from azure.storage.blob import BlobServiceClient

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 1A: Fetch Qualys Vulnerabilities
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def get_qualys_vulnerabilities():
    """Fetch vulnerability detections from Qualys API"""
    
    url = "https://qualysapi.qualys.com/api/2.0/fo/asset/host/vm/detection/"
    headers = {
        "X-Requested-With": "Python",
        "Authorization": f"Basic {QUALYS_AUTH}"
    }
    params = {
        "action": "list",
        "show_results": 1,
        "status": "New,Active,Re-Opened",
        "severities": "3,4,5"  # Medium, High, Critical
    }
    
    response = requests.get(url, headers=headers, params=params)
    vulnerabilities = parse_qualys_xml(response.text)
    
    # Normalize to common format
    normalized = []
    for vuln in vulnerabilities:
        normalized.append({
            "source": "Qualys",
            "cve_id": vuln.get("cve_id"),
            "qid": vuln.get("qid"),
            "hostname": vuln.get("hostname"),
            "ip_address": vuln.get("ip"),
            "cvss_score": float(vuln.get("cvss_base", 0)),
            "severity": vuln.get("severity"),
            "title": vuln.get("title"),
            "first_detected": vuln.get("first_found"),
            "last_detected": vuln.get("last_found"),
            "port": vuln.get("port"),
            "solution": vuln.get("solution")
        })
    
    return normalized

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 1B: Fetch MDE TVM Vulnerabilities
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def get_mde_vulnerabilities():
    """Fetch vulnerabilities from Microsoft Defender TVM API"""
    
    credential = DefaultAzureCredential()
    token = credential.get_token("https://api.securitycenter.microsoft.com/.default")
    
    url = "https://api.securitycenter.microsoft.com/api/vulnerabilities/machinesVulnerabilities"
    headers = {
        "Authorization": f"Bearer {token.token}",
        "Content-Type": "application/json"
    }
    
    vulnerabilities = []
    next_link = url
    
    while next_link:
        response = requests.get(next_link, headers=headers)
        data = response.json()
        vulnerabilities.extend(data.get("value", []))
        next_link = data.get("@odata.nextLink")
    
    # Normalize to common format
    normalized = []
    for vuln in vulnerabilities:
        normalized.append({
            "source": "MDE_TVM",
            "cve_id": vuln.get("cveId"),
            "hostname": vuln.get("machineName"),
            "device_id": vuln.get("machineId"),
            "cvss_score": vuln.get("cvssV3"),
            "severity": vuln.get("severity"),
            "title": vuln.get("name"),
            "software_name": vuln.get("productName"),
            "software_version": vuln.get("productVersion"),
            "exploit_verified": vuln.get("exploitVerified"),
            "exposure_level": vuln.get("exposureLevel"),
            "first_detected": vuln.get("detectionTime")
        })
    
    return normalized

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 1C: Combine and Deduplicate
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def aggregate_vulnerabilities():
    """Combine vulnerabilities from all sources"""
    
    qualys_vulns = get_qualys_vulnerabilities()
    mde_vulns = get_mde_vulnerabilities()
    
    # Combine all
    all_vulns = qualys_vulns + mde_vulns
    
    # Deduplicate by CVE + hostname
    seen = set()
    unique_vulns = []
    for vuln in all_vulns:
        key = (vuln["cve_id"], vuln["hostname"])
        if key not in seen:
            seen.add(key)
            unique_vulns.append(vuln)
        else:
            # Merge data from both sources if duplicate
            for existing in unique_vulns:
                if (existing["cve_id"], existing["hostname"]) == key:
                    existing["sources"] = existing.get("sources", [existing["source"]])
                    existing["sources"].append(vuln["source"])
    
    return unique_vulns</code></pre>
        </div>

        <h3>Step 2: EPSS Enrichment</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Python â€” Enrich with EPSS Scores</span><button class="code-copy-btn">Copy</button></div>
          <pre><code># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 2: Enrich with EPSS (Exploit Prediction Scoring System)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def get_epss_scores(cve_list):
    """Fetch EPSS scores for a list of CVEs"""
    
    # EPSS API allows batch queries
    cve_string = ",".join(cve_list)
    url = f"https://api.first.org/data/v1/epss?cve={cve_string}"
    
    response = requests.get(url)
    data = response.json()
    
    # Create lookup dictionary
    epss_lookup = {}
    for item in data.get("data", []):
        epss_lookup[item["cve"]] = {
            "epss_score": float(item["epss"]),
            "percentile": float(item["percentile"])
        }
    
    return epss_lookup

def enrich_with_epss(vulnerabilities):
    """Add EPSS scores to vulnerability list"""
    
    # Get unique CVEs
    cve_list = list(set([v["cve_id"] for v in vulnerabilities if v.get("cve_id")]))
    
    # Batch fetch EPSS scores (API limit: 100 CVEs per request)
    epss_lookup = {}
    for i in range(0, len(cve_list), 100):
        batch = cve_list[i:i+100]
        batch_scores = get_epss_scores(batch)
        epss_lookup.update(batch_scores)
    
    # Enrich vulnerabilities
    for vuln in vulnerabilities:
        cve_id = vuln.get("cve_id")
        if cve_id and cve_id in epss_lookup:
            vuln["epss_score"] = epss_lookup[cve_id]["epss_score"]
            vuln["epss_percentile"] = epss_lookup[cve_id]["percentile"]
        else:
            vuln["epss_score"] = 0.0
            vuln["epss_percentile"] = 0.0
    
    return vulnerabilities</code></pre>
        </div>

        <h3>Step 3: CISA KEV Enrichment</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Python â€” Enrich with CISA KEV</span><button class="code-copy-btn">Copy</button></div>
          <pre><code># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 3: Enrich with CISA KEV (Known Exploited Vulnerabilities)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def get_cisa_kev():
    """Fetch CISA Known Exploited Vulnerabilities catalog"""
    
    url = "https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json"
    response = requests.get(url)
    data = response.json()
    
    # Create lookup dictionary
    kev_lookup = {}
    for vuln in data.get("vulnerabilities", []):
        kev_lookup[vuln["cveID"]] = {
            "vendor": vuln["vendorProject"],
            "product": vuln["product"],
            "name": vuln["vulnerabilityName"],
            "date_added": vuln["dateAdded"],
            "due_date": vuln["dueDate"],
            "action": vuln["requiredAction"]
        }
    
    return kev_lookup

def enrich_with_kev(vulnerabilities):
    """Flag vulnerabilities in CISA KEV"""
    
    kev_lookup = get_cisa_kev()
    
    for vuln in vulnerabilities:
        cve_id = vuln.get("cve_id")
        if cve_id and cve_id in kev_lookup:
            vuln["in_cisa_kev"] = True
            vuln["kev_date_added"] = kev_lookup[cve_id]["date_added"]
            vuln["kev_due_date"] = kev_lookup[cve_id]["due_date"]
            vuln["kev_action"] = kev_lookup[cve_id]["action"]
        else:
            vuln["in_cisa_kev"] = False
    
    return vulnerabilities</code></pre>
        </div>

        <div class="callout info">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>Asset Context: Watchlist, Not API</div>
          <div class="callout-content">
            <p><strong>We don't call CMDB API from the Azure Function.</strong> Asset context (Tier, Owner, Environment) comes from a Sentinel watchlist that's updated weekly via manual CSV upload. The analytics rule joins vulnerability data with the watchlist at query time.</p>
            <p style="margin-top: 0.5rem;">See Section 4 for watchlist structure and update process.</p>
          </div>
        </div>

        <h3>Step 4: Calculate Risk Score and Prioritize</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Python â€” Risk Scoring and Prioritization</span><button class="code-copy-btn">Copy</button></div>
          <pre><code># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 5: Calculate Risk Score
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def calculate_risk_score(vuln):
    """Calculate composite risk score for a vulnerability"""
    
    base_score = vuln.get("cvss_score", 5.0)
    
    # Exploitation likelihood multiplier
    if vuln.get("in_cisa_kev"):
        exploit_multiplier = 2.0
    elif vuln.get("epss_score", 0) > 0.7:
        exploit_multiplier = 1.8
    elif vuln.get("epss_score", 0) > 0.4:
        exploit_multiplier = 1.5
    elif vuln.get("epss_score", 0) > 0.1:
        exploit_multiplier = 1.2
    else:
        exploit_multiplier = 1.0
    
    # Asset criticality multiplier
    tier = vuln.get("asset_tier", "Tier 3")
    if tier == "Tier 1":
        asset_multiplier = 2.0
    elif tier == "Tier 2":
        asset_multiplier = 1.5
    else:
        asset_multiplier = 1.0
    
    # Exposure multiplier
    if vuln.get("internet_facing") or vuln.get("exposure") == "Internet-facing":
        exposure_multiplier = 2.0
    elif vuln.get("exposure") == "DMZ":
        exposure_multiplier = 1.5
    else:
        exposure_multiplier = 1.0
    
    # Environment multiplier
    env = vuln.get("environment", "").lower()
    if "prod" in env:
        env_multiplier = 1.5
    elif "stag" in env:
        env_multiplier = 1.2
    else:
        env_multiplier = 1.0
    
    # Calculate final score
    risk_score = (base_score * exploit_multiplier * asset_multiplier * 
                  exposure_multiplier * env_multiplier)
    
    return round(risk_score, 2)

def assign_priority(vuln):
    """Assign priority based on risk score"""
    
    risk_score = vuln.get("risk_score", 0)
    
    # CISA KEV always critical
    if vuln.get("in_cisa_kev"):
        return "CRITICAL"
    
    if risk_score >= 50:
        return "CRITICAL"
    elif risk_score >= 30:
        return "HIGH"
    elif risk_score >= 15:
        return "MEDIUM"
    else:
        return "LOW"

def prioritize_vulnerabilities(vulnerabilities):
    """Calculate risk scores and assign priorities"""
    
    for vuln in vulnerabilities:
        vuln["risk_score"] = calculate_risk_score(vuln)
        vuln["priority"] = assign_priority(vuln)
        
        # Set SLA based on priority
        if vuln["priority"] == "CRITICAL":
            vuln["sla_days"] = 2  # 48 hours
        elif vuln["priority"] == "HIGH":
            vuln["sla_days"] = 7
        elif vuln["priority"] == "MEDIUM":
            vuln["sla_days"] = 30
        else:
            vuln["sla_days"] = 90
    
    # Sort by risk score descending
    vulnerabilities.sort(key=lambda x: x["risk_score"], reverse=True)
    
    return vulnerabilities</code></pre>
        </div>

        <h3>Step 5: Write to Log Analytics</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Python â€” Write ALL Findings to Log Analytics</span><button class="code-copy-btn">Copy</button></div>
          <pre><code># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 5: Write to Log Analytics (Sentinel picks up from here)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

import json
import hashlib
import hmac
import base64
from datetime import datetime

def write_to_log_analytics(vulnerabilities, workspace_id, shared_key):
    """
    Write ALL vulnerability findings to Log Analytics custom table.
    
    NOTE: 
    - We write everything daily (no filtering here)
    - Sentinel analytics rule handles deduplication for alerting
    - Asset context comes from watchlist join in Sentinel query
    """
    
    log_type = "VulnInventory"  # Results in VulnInventory_CL table
    
    # Convert to JSON records
    records = []
    for vuln in vulnerabilities:
        records.append({
            "TimeGenerated": datetime.utcnow().isoformat(),
            "CVE": vuln.get("cve_id"),
            "Hostname": vuln.get("hostname"),
            "IPAddress": vuln.get("ip_address"),
            "Software": vuln.get("software"),
            "CVSSScore": vuln.get("cvss_score"),
            "MDVMExposureScore": vuln.get("mdvm_exposure_score"),
            "QualysTruRisk": vuln.get("qualys_trurisk"),
            "EPSSScore": vuln.get("epss_score"),
            "InCISAKEV": vuln.get("in_cisa_kev", False),
            "RiskScore": vuln.get("risk_score"),
            "Priority": vuln.get("priority"),
            "Source": vuln.get("source"),  # MDVM or Qualys
            "Title": vuln.get("title"),
            "Solution": vuln.get("solution")
        })
    
    # Split into batches of 500 records
    batch_size = 500
    for i in range(0, len(records), batch_size):
        batch = records[i:i+batch_size]
        body = json.dumps(batch)
        
        # Build signature for Log Analytics API
        date_string = datetime.utcnow().strftime('%a, %d %b %Y %H:%M:%S GMT')
        content_length = len(body)
        signature = build_signature(
            workspace_id, shared_key, date_string, 
            content_length, 'POST', 'application/json', '/api/logs'
        )
        
        # POST to Log Analytics Data Collector API
        uri = f"https://{workspace_id}.ods.opinsights.azure.com/api/logs?api-version=2016-04-01"
        headers = {
            'Content-Type': 'application/json',
            'Authorization': signature,
            'Log-Type': log_type,
            'x-ms-date': date_string
        }
        
        response = requests.post(uri, data=body, headers=headers)
        if response.status_code != 200:
            logging.error(f"Failed to write batch: {response.text}")
    
    logging.info(f"Wrote {len(records)} records to {log_type}_CL")

def build_signature(workspace_id, shared_key, date, content_length, method, content_type, resource):
    """Build the authorization signature for Log Analytics API"""
    x_headers = f'x-ms-date:{date}'
    string_to_hash = f"{method}\n{content_length}\n{content_type}\n{x_headers}\n{resource}"
    bytes_to_hash = bytes(string_to_hash, encoding="utf-8")
    decoded_key = base64.b64decode(shared_key)
    encoded_hash = base64.b64encode(
        hmac.new(decoded_key, bytes_to_hash, digestmod=hashlib.sha256).digest()
    ).decode()
    return f"SharedKey {workspace_id}:{encoded_hash}"</code></pre>
        </div>

        <div class="callout success">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>What Happens Next</div>
          <div class="callout-content">
            <p><strong>Azure Function writes ALL findings to VulnInventory_CL daily.</strong> Then:</p>
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
              <li><strong>Sentinel Analytics Rule</strong> queries VulnInventory_CL, joins with AssetInventory_WL watchlist for context, and creates alerts only for NEW Critical/High findings not seen in past 7 days</li>
              <li><strong>SOC</strong> triages alerts, validates, creates tickets manually in internal system</li>
              <li><strong>Workbook</strong> provides dashboard view of all vulnerability data with trending</li>
            </ul>
          </div>
        </div>

        <!-- ==================== SECTION 7: DASHBOARD ==================== -->
        <h2>7. Vulnerability Dashboard</h2>

        <div class="metric-grid">
          <div class="metric-card">
            <div class="value">47,234</div>
            <div class="label">Total Vulnerabilities</div>
          </div>
          <div class="metric-card">
            <div class="value">127</div>
            <div class="label">Critical Priority</div>
          </div>
          <div class="metric-card">
            <div class="value">842</div>
            <div class="label">High Priority</div>
          </div>
          <div class="metric-card">
            <div class="value">23</div>
            <div class="label">In CISA KEV</div>
          </div>
          <div class="metric-card">
            <div class="value">94%</div>
            <div class="label">Within SLA</div>
          </div>
          <div class="metric-card">
            <div class="value">12 days</div>
            <div class="label">Avg Remediation Time</div>
          </div>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">KQL â€” Vulnerability Dashboard Queries (Sentinel)</span><button class="code-copy-btn">Copy</button></div>
          <pre><code>// Critical/High vulnerabilities by host (with watchlist context)
VulnInventory_CL
| where TimeGenerated > ago(7d)
| where Priority_s in ("CRITICAL", "HIGH")
| join kind=leftouter (
    _GetWatchlist('AssetInventory_WL')
    | project Hostname, AssetTier, Owner
) on $left.Hostname_s == $right.Hostname
| summarize VulnCount = count() by Hostname_s, Priority_s, AssetTier
| order by VulnCount desc
| take 20

// Vulnerabilities in CISA KEV
VulnInventory_CL
| where InCISAKEV_b == true
| summarize by CVE_s, Hostname_s, RiskScore_d
| order by RiskScore_d desc

// Priority breakdown over time
VulnInventory_CL
| where TimeGenerated > ago(30d)
| summarize 
    Critical = countif(Priority_s == "CRITICAL"),
    High = countif(Priority_s == "HIGH"),
    Medium = countif(Priority_s == "MEDIUM")
    by bin(TimeGenerated, 1d)
| render timechart

// Top CVEs by affected host count
VulnInventory_CL
| where TimeGenerated > ago(1d)
| where Priority_s in ("CRITICAL", "HIGH")
| summarize 
    AffectedHosts = dcount(Hostname_s),
    AvgRiskScore = avg(RiskScore_d)
    by CVE_s, Title_s
| order by AffectedHosts desc
| take 10</code></pre>
        </div>

        <!-- ==================== SECTION 7: MANUAL WORKFLOW ==================== -->
        <h2>8. Manual Workflow â€” Analysts and Business Owners</h2>

        <p>While automation handles initial triage and ticket creation, humans are essential for:</p>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Activity</th><th>Owner</th><th>Description</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>False Positive Review</strong></td>
                <td>Security Analyst</td>
                <td>Review tickets flagged as potential FPs. Mark as FP with justification if scanner error.</td>
              </tr>
              <tr>
                <td><strong>Impact Assessment</strong></td>
                <td>Business Owner</td>
                <td>Assess business impact of remediation. Does patching require downtime?</td>
              </tr>
              <tr>
                <td><strong>Compensating Controls</strong></td>
                <td>Security Engineer</td>
                <td>If immediate patching not possible, implement compensating controls (network isolation, WAF rules, etc.)</td>
              </tr>
              <tr>
                <td><strong>Exception Requests</strong></td>
                <td>Business Owner + Security</td>
                <td>Request risk acceptance for vulnerabilities that cannot be remediated. Requires CISO approval.</td>
              </tr>
              <tr>
                <td><strong>Verification</strong></td>
                <td>Security Analyst</td>
                <td>After remediation, verify vulnerability is resolved. Close ticket.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- ==================== SECTION 8: INTERVIEW ANSWERS ==================== -->
        <h2>9. Interview-Ready Answers</h2>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Q: "Tell me about a vulnerability management process you implemented"</span></div>
          <pre><code>"I built an automated vulnerability management pipeline to give our team 
a single pane of glass instead of juggling multiple consoles.

THE PROBLEM:
We had vulnerabilities in two places â€” Qualys scanner and MDVM. 
Analysts were constantly switching between portals, manually correlating 
findings. Each tool had its own severity rating but neither provided 
business context aligned to our environment.

THE SOLUTION:
I built an Azure Function that runs daily on a timer trigger. It:

1. AGGREGATES data from both Qualys API and MDVM API into a unified 
   list, deduplicating by CVE + hostname so we have one source of truth.

2. USES NATIVE EXPLOIT INTELLIGENCE â€” both MDVM and Qualys now include
   EPSS scores and KEV status natively, so we pass those through.

3. CALCULATES a custom risk score that factors in CVSS, tool scores 
   (MDVM Exposure Score or Qualys TruRisk), plus asset context.

4. WRITES everything to a custom Log Analytics table (VulnInventory_CL).

5. SENTINEL ANALYTICS RULE then queries this table, joins with an asset 
   watchlist for business context (Tier 1/2/3, owner, environment), and 
   creates alerts only for NEW Critical/High findings not seen in past 7 days.

SOC triages alerts, validates findings, and creates tickets in our 
internal system manually. No auto-ticketing â€” SOC has full control.

THE RESULT:
â€¢ Analysts have ONE dashboard instead of two consoles
â€¢ Deduplication prevents alert fatigue from daily scans
â€¢ Asset context from watchlist drives prioritization
â€¢ SOC owns triage and ticketing, not automation"</code></pre>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Q: "Where does the automation code run?"</span></div>
          <pre><code>"I use Azure Functions with a timer trigger â€” it's serverless, so no 
infrastructure to manage.

The function runs daily at 6 AM. It:
1. Calls Qualys API to get vulnerability detections
2. Calls MDVM API using managed identity
3. Calculates a custom risk score
4. Writes ALL findings to a custom Log Analytics table

Asset context (Tier 1/2/3, owner, environment) comes from a Sentinel 
watchlist that we update weekly via CSV export from our CMDB. We don't 
have API access to CMDB, so we do it manually â€” but asset data doesn't 
change that often, so weekly is fine.

From there, Sentinel picks it up. I built:
â€¢ A workbook that queries VulnInventory_CL for the unified dashboard
â€¢ An analytics rule that creates alerts for NEW Critical/High findings
â€¢ The rule joins with the asset watchlist and skips duplicates

Alternatives I considered:
â€¢ Azure Automation Runbook â€” works but Functions are more lightweight
â€¢ Logic Apps â€” good for visual workflows but complex Python logic is 
  easier in Functions"</code></pre>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Q: "How do you avoid alert fatigue from daily scans?"</span></div>
          <pre><code>"The key is deduplication at the analytics rule level. Here's how it works:

1. Azure Function writes ALL findings to Log Analytics daily â€” no 
   filtering at this stage. This gives us historical data for trending.

2. The Sentinel analytics rule compares today's findings against the 
   past 7 days. It only fires an alert if a finding is NEW â€” meaning 
   the same CVE + hostname combination wasn't seen recently.

3. For unresolved Critical items, we have a separate weekly rule that 
   fires if something has been open for 7+ days. This is an escalation, 
   not a duplicate.

The result: SOC gets one alert when a vulnerability first appears, not 
30 alerts over a month. If they're still working on it, no new alert 
until the weekly escalation check.

We also maintain exclusion watchlists for:
â€¢ False positives (CVE + hostname + reason + expiry date)
â€¢ Approved exceptions (risk acceptance with CISO approval)

The analytics rule checks these watchlists and skips matching items."</code></pre>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Q: "How do you decide what to patch first?"</span></div>
          <pre><code>"I don't rely on CVSS alone â€” it measures theoretical severity, not real 
risk. A CVSS 9.8 on an isolated test server isn't urgent. A CVSS 7.5 on 
an internet-facing production server with active exploitation is critical.

My prioritization uses:
â€¢ CVSS â€” technical severity baseline
â€¢ Tool scores â€” MDVM Exposure Score or Qualys TruRisk (already include 
  EPSS, KEV, exploitability)
â€¢ Asset context from watchlist â€” Tier 1/2/3, environment, network zone

IMMEDIATE (24-48 hours):
â€¢ Any CVE in CISA KEV â€” confirmed active exploitation
â€¢ EPSS > 0.7 on Tier 1 production assets
â€¢ Any vulnerability flagged 'exploit verified' in MDVM

HIGH PRIORITY (7 days):
â€¢ CVSS â‰¥ 7.0 + EPSS > 0.4 + internet-facing

STANDARD (30 days):
â€¢ CVSS â‰¥ 7.0 on internal production systems

BACKLOG (90 days or risk acceptance):
â€¢ Low severity, internal systems, low EPSS

The key insight: EPSS and KEV tell you what attackers are actually 
targeting right now. Asset context tells you what matters to YOUR business."</code></pre>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Q: "How do you handle false positives and exceptions?"</span></div>
          <pre><code>"SOC handles everything manually after the alert fires. Here's the process:

FALSE POSITIVES:
When analysts identify a false positive â€” maybe the scanner detected a 
vulnerable version but the system is actually patched â€” they:
1. Close the Sentinel incident with 'False Positive' status and notes
2. Add CVE + hostname to the exclusion watchlist (with expiry date)
3. The analytics rule checks this watchlist, so no repeat alerts

EXCEPTIONS (Risk Acceptance):
Sometimes we can't patch â€” legacy system, vendor dependency, production 
freeze. The process (all manual):
1. SOC documents why patching isn't possible
2. Security reviews and proposes compensating controls
3. Asset owner and CISO approve (email/meeting)
4. Exception added to watchlist with expiry date
5. Sentinel incident closed as 'Exception Approved'

COMPENSATING CONTROLS we commonly apply:
â€¢ Network segmentation â€” isolate vulnerable system
â€¢ Enhanced monitoring â€” custom detection rule for exploitation attempts
â€¢ Application whitelisting â€” block unauthorized code execution

All exceptions have expiry dates. When they expire, the analytics rule 
sees the finding as 'new' again (not in exclusion list) and fires an 
alert for re-review."</code></pre>
        </div>

        <!-- ==================== FINAL INTERVIEW SUMMARY ==================== -->
        <h2>10. Interview Summary: Vulnerability Management</h2>

        <div class="callout success">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Key Talking Points</div>
          <div class="callout-content">
            <p><strong>On Native Capabilities:</strong></p>
            <p style="margin-left: 1rem;"><em>"MDVM â€” which used to be called TVM â€” now includes EPSS scores, CISA KEV status, and exposure scoring natively. Qualys has similar capabilities with TruRisk. That's table stakes now â€” you don't need custom automation just for exploit intelligence."</em></p>
            
            <p style="margin-top: 1rem;"><strong>On Why We Built Automation:</strong></p>
            <p style="margin-left: 1rem;"><em>"Our automation adds value on top: unifying data from both MDVM and Qualys into a single Sentinel workbook, applying a custom risk score, and deduplicating alerts so SOC doesn't get flooded from daily scans. Asset context comes from a watchlist we update weekly â€” no CMDB API integration. SOC handles everything after the alert: triage, ticketing, remediation coordination."</em></p>
            
            <p style="margin-top: 1rem;"><strong>On Alert Deduplication:</strong></p>
            <p style="margin-left: 1rem;"><em>"We write all findings to Log Analytics daily for trending, but the analytics rule only alerts on NEW findings not seen in past 7 days. For unresolved Critical items, we have a weekly escalation rule. Exclusion watchlists suppress false positives and approved exceptions."</em></p>
            
            <p style="margin-top: 1rem;"><strong>On When NOT to Build This:</strong></p>
            <p style="margin-left: 1rem;"><em>"If you only have one scanner, the native dashboard is probably sufficient. Don't over-engineer. We built this because we have dual scanners, SOC lives in Sentinel, and we needed deduplication for daily scans plus a unified view."</em></p>
          </div>
        </div>

        <div class="metric-grid">
          <div class="metric-card">
            <div class="value">1</div>
            <div class="label">Unified Dashboard</div>
          </div>
          <div class="metric-card">
            <div class="value">2</div>
            <div class="label">Scanner Sources (MDVM + Qualys)</div>
          </div>
          <div class="metric-card">
            <div class="value">7d</div>
            <div class="label">Dedup Lookback</div>
          </div>
          <div class="metric-card">
            <div class="value">Weekly</div>
            <div class="label">Watchlist Update</div>
          </div>
        </div>

        <nav class="page-nav">
          <a href="live-response.html" class="page-nav-link prev"><span class="page-nav-label">Previous</span><span class="page-nav-title">â† Live Response</span></a>
          <a href="deployment.html" class="page-nav-link next"><span class="page-nav-label">Next</span><span class="page-nav-title">MDE Deployment â†’</span></a>
        </nav>
      </div>
    </main>
  </div>
  <script src="../js/main.js"></script>
</body>
</html>
