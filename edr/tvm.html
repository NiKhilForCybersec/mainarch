<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vulnerability Management — Automated Risk-Based Prioritization | EDR</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">
  <style>
    .flow-diagram { background: var(--bg-tertiary); padding: 1.5rem; border-radius: 8px; margin: 1rem 0; overflow-x: auto; }
    .enrichment-card { background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 8px; padding: 1.25rem; margin: 0.75rem 0; }
    .enrichment-card h4 { margin: 0 0 0.75rem 0; display: flex; align-items: center; gap: 0.5rem; }
    .source-badge { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
    .source-badge.qualys { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
    .source-badge.mde { background: rgba(59, 130, 246, 0.2); color: #93c5fd; }
    .source-badge.epss { background: rgba(249, 115, 22, 0.2); color: #fdba74; }
    .source-badge.kev { background: rgba(220, 38, 38, 0.2); color: #fca5a5; }
    .source-badge.cmdb { background: rgba(34, 197, 94, 0.2); color: #86efac; }
    .priority-badge { display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; }
    .priority-badge.critical { background: #991b1b; color: #fecaca; }
    .priority-badge.high { background: #c2410c; color: #fed7aa; }
    .priority-badge.medium { background: #a16207; color: #fef3c7; }
    .priority-badge.low { background: #166534; color: #dcfce7; }
    .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0; }
    .metric-card { background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 8px; padding: 1rem; text-align: center; }
    .metric-card .value { font-size: 2rem; font-weight: 700; color: #3b82f6; }
    .metric-card .label { font-size: 0.85rem; color: var(--text-secondary); }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="sidebar-logo-icon">RF</div>
          <div class="sidebar-logo-text">
            <span class="sidebar-logo-title">Security Transformation</span>
            <span class="sidebar-logo-subtitle">RevFlow Analytics</span>
          </div>
        </div>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Overview</div>
          <a href="../index.html" class="nav-item">Executive Summary</a>
          <a href="../company-profile.html" class="nav-item">Company Profile</a>
          <a href="../security-framework.html" class="nav-item">Security Framework</a>
          <a href="../program-structure.html" class="nav-item">Program Structure</a>
          <a href="../controls-mapping.html" class="nav-item">Controls Mapping</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">SIEM Migration</div>
          <a href="../siem/index.html" class="nav-item">SIEM Overview</a>
          <a href="../siem/discovery.html" class="nav-item">Discovery & Assessment</a>
          <a href="../siem/log-sources.html" class="nav-item">Log Source Strategy</a>
          <a href="../siem/log-engineering.html" class="nav-item">Log Engineering</a>
          <a href="../siem/parsing-deep-dive.html" class="nav-item">Parsing Deep Dive</a>
          <a href="../siem/threat-intelligence.html" class="nav-item">Threat Intelligence</a>
          <a href="../siem/detection-engineering.html" class="nav-item">Detection Engineering</a>
          <a href="../siem/detection-anatomy.html" class="nav-item">Detection Anatomy</a>
          <a href="../siem/detection-catalog.html" class="nav-item">Detection Catalog</a>
          <a href="../siem/soar-automation.html" class="nav-item">SOAR &amp; Automation</a>
          <a href="../siem/workbooks.html" class="nav-item">Workbooks &amp; Dashboards</a>
          <a href="../siem/cost-optimization.html" class="nav-item">Cost Optimization</a>
          <a href="../siem/soc-transition.html" class="nav-item">SOC Transition</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">EDR Migration</div>
          <a href="../edr/index.html" class="nav-item">EDR Overview</a>
          <a href="../edr/xdr-detection-model.html" class="nav-item">XDR Detection Model</a>
          <a href="../edr/advanced-hunting.html" class="nav-item">Advanced Hunting</a>
          <a href="../edr/live-response.html" class="nav-item">Live Response</a>
          <a href="../edr/tvm.html" class="nav-item active">Vulnerability Management</a>
          <a href="../edr/deployment.html" class="nav-item">MDE Deployment</a>
          <a href="../edr/asr-rules.html" class="nav-item">ASR Rules</a>
          <a href="../edr/device-control.html" class="nav-item">Device Control</a>
          <a href="../edr/coexistence.html" class="nav-item">Coexistence Strategy</a>
          <a href="../edr/eset-removal.html" class="nav-item">ESET Removal</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">DLP Migration</div>
          <a href="../dlp/index.html" class="nav-item">DLP Overview</a>
          <a href="../dlp/dlp-catalog.html" class="nav-item">DLP Catalog</a>
          <a href="../dlp/policy-translation.html" class="nav-item">Policy Translation</a>
          <a href="../dlp/rollout-phases.html" class="nav-item">Rollout Phases</a>
          <a href="../dlp/user-communication.html" class="nav-item">User Communication</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Identity & Access</div>
          <a href="../identity/index.html" class="nav-item">Identity Overview</a>
          <a href="../identity/hybrid-setup.html" class="nav-item">Hybrid Identity</a>
          <a href="../identity/conditional-access.html" class="nav-item">Conditional Access</a>
          <a href="../identity/pim.html" class="nav-item">PIM Configuration</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Infrastructure</div>
          <a href="../infrastructure/index.html" class="nav-item">Infrastructure Overview</a>
          <a href="../infrastructure/landing-zone.html" class="nav-item">Landing Zone</a>
          <a href="../infrastructure/network-architecture.html" class="nav-item">Network Architecture</a>
          <a href="../infrastructure/workload-migration.html" class="nav-item">Workload Migration</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Operations</div>
          <a href="../operations/parallel-ops.html" class="nav-item">Parallel Operations</a>
          <a href="../operations/soc-workflows.html" class="nav-item">SOC Workflows</a>
          <a href="../operations/integration.html" class="nav-item">Platform Integration</a>
          <a href="../operations/xdr-integration.html" class="nav-item">XDR Integration</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Resources</div>
          <a href="../resources/timeline.html" class="nav-item">Project Timeline</a>
          <a href="../resources/raci.html" class="nav-item">RACI Matrix</a>
          <a href="../resources/infrastructure-reference.html" class="nav-item">Infrastructure Reference</a>
          <a href="../resources/scripts.html" class="nav-item">Scripts & Queries</a>
          <a href="../resources/data-dictionary.html" class="nav-item">Data Dictionary</a>
          <a href="../resources/templates.html" class="nav-item">Templates</a>
          <a href="../resources/splunk-reference.html" class="nav-item">Splunk Reference</a>
          <a href="../resources/alternative-architectures.html" class="nav-item">Alternative Architectures</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Runbooks</div>
          <a href="../resources/mde-onboarding.html" class="nav-item">MDE Onboarding</a>
          <a href="../resources/mde-offboarding.html" class="nav-item">MDE Offboarding</a>
          <a href="../resources/incident-response.html" class="nav-item">Incident Response</a>
          <a href="../resources/operational-procedures.html" class="nav-item">Operational Procedures</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Troubleshooting</div>
          <a href="../troubleshooting/index.html" class="nav-item">Common Issues</a>
          <a href="../troubleshooting/siem-issues.html" class="nav-item">SIEM Issues</a>
          <a href="../troubleshooting/mde-issues.html" class="nav-item">MDE Issues</a>
          <a href="../troubleshooting/dlp-issues.html" class="nav-item">DLP Issues</a>
          <a href="../troubleshooting/agent-conflicts.html" class="nav-item">Agent Conflicts</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Career</div>
          <a href="../career-narrative.html" class="nav-item">Career Narrative</a>
          <a href="../interview-prep.html" class="nav-item">Interview Prep</a>
        </div>
      </nav>
    </aside>

    <main class="main-content">
      <div class="content-wrapper">
        <nav class="breadcrumb">
          <a href="../index.html">Home</a>
          <span class="breadcrumb-separator">/</span>
          <a href="index.html">EDR Migration</a>
          <span class="breadcrumb-separator">/</span>
          <span class="breadcrumb-current">Vulnerability Management</span>
        </nav>

        <div class="page-header">
          <h1>Vulnerability Management — Automated Risk-Based Prioritization</h1>
          <div class="page-header-meta">
            <span class="page-badge edr">EDR Track</span>
            <span class="page-reading-time">TVM & Automation</span>
          </div>
          <p class="intro-text">This page documents our automated vulnerability management workflow — integrating Qualys and MDE TVM data, enriching with EPSS, CISA KEV, and CMDB, then automatically prioritizing, alerting, and creating tickets for remediation.</p>
        </div>

        <!-- ==================== SECTION 1: THE PROBLEM ==================== -->
        <h2>1. The Problem: Multiple Consoles, No Unified View</h2>

        <div class="callout warning">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>The Challenge</div>
          <div class="callout-content">
            <p>RevFlow had vulnerabilities scattered across <strong>two platforms</strong> — Qualys scanner and MDE TVM. Analysts had to switch between consoles, manually correlate findings, and make prioritization decisions without complete context. This was inefficient and error-prone.</p>
          </div>
        </div>

        <p>The operational challenges:</p>
        <ul>
          <li><strong>Console switching:</strong> Analysts juggling Qualys portal and Microsoft 365 Defender portal</li>
          <li><strong>Manual correlation:</strong> Same CVE on same host reported differently in each tool</li>
          <li><strong>No unified prioritization:</strong> Each tool has its own severity rating with no business context</li>
          <li><strong>Missing exploit intelligence:</strong> Neither tool tells you if a CVE is actively exploited in the wild</li>
          <li><strong>No asset context:</strong> Scanners don't know which servers are Tier 1 production vs. test environments</li>
        </ul>

        <p><strong>Our solution:</strong> Build a single pane of glass — an automated pipeline that aggregates, enriches, and prioritizes vulnerabilities from all sources.</p>

        <!-- ==================== SECTION 2: ARCHITECTURE ==================== -->
        <h2>2. Solution Architecture — Single Pane of Glass</h2>

        <div class="flow-diagram">
          <pre><code>VULNERABILITY MANAGEMENT AUTOMATION — DEPLOYMENT ARCHITECTURE
════════════════════════════════════════════════════════════════════════════════

                    ┌─────────────────────────────────────────┐
                    │         AZURE FUNCTION                   │
                    │         (Timer Trigger - Daily)          │
                    │         Python runtime                   │
                    └─────────────────┬───────────────────────┘
                                      │
              ┌───────────────────────┼───────────────────────┐
              │                       │                       │
              ▼                       ▼                       ▼
┌─────────────────────┐ ┌─────────────────────┐ ┌─────────────────────┐
│   QUALYS API        │ │   MDE TVM API       │ │   ENRICHMENT APIs   │
│   Vulnerability     │ │   Microsoft 365     │ │   • FIRST.org EPSS  │
│   Detections        │ │   Defender          │ │   • CISA KEV JSON   │
└─────────────────────┘ └─────────────────────┘ │   • ServiceNow CMDB │
              │                       │         └─────────────────────┘
              │                       │                       │
              └───────────────────────┼───────────────────────┘
                                      │
                                      ▼
                    ┌─────────────────────────────────────────┐
                    │   AZURE FUNCTION PROCESSING              │
                    │   1. Aggregate vulnerabilities           │
                    │   2. Deduplicate by CVE + Host           │
                    │   3. Enrich with EPSS, KEV, CMDB         │
                    │   4. Calculate risk score                │
                    │   5. Assign priority                     │
                    └─────────────────┬───────────────────────┘
                                      │
              ┌───────────────────────┼───────────────────────┐
              │                       │                       │
              ▼                       ▼                       ▼
┌─────────────────────┐ ┌─────────────────────┐ ┌─────────────────────┐
│  LOG ANALYTICS      │ │  SERVICENOW         │ │  EMAIL/TEAMS        │
│  Custom Table:      │ │  Auto-create ticket │ │  Notify asset       │
│  VulnInventory_CL   │ │  for Critical/High  │ │  owners             │
└─────────────────────┘ └─────────────────────┘ └─────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  MICROSOFT SENTINEL                                                          │
│  • Workbook dashboard (single pane of glass)                                 │
│  • Analytics rules for new Critical findings                                 │
│  • Integration with incident management                                      │
└─────────────────────────────────────────────────────────────────────────────┘</code></pre>
        </div>

        <h3>2.1 Deployment Options</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Option</th><th>How It Works</th><th>Best For</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Azure Function (Recommended)</strong></td>
                <td>Python code runs on timer trigger (daily), writes to Log Analytics custom table via Data Collector API</td>
                <td>Production, scalable, serverless</td>
              </tr>
              <tr>
                <td><strong>Azure Automation Runbook</strong></td>
                <td>PowerShell or Python in Azure Automation account with managed identity</td>
                <td>If already using Azure Automation</td>
              </tr>
              <tr>
                <td><strong>Logic Apps + Function</strong></td>
                <td>Logic Apps orchestrates workflow, calls Azure Function for complex processing</td>
                <td>Visual workflow, approval steps</td>
              </tr>
              <tr>
                <td><strong>On-prem VM + Task Scheduler</strong></td>
                <td>Python script runs on scheduled task, pushes to Sentinel via API</td>
                <td>Hybrid environments, air-gapped</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="callout info">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>Why Azure Functions?</div>
          <div class="callout-content">
            <p>Azure Functions is ideal because: serverless (no VM to manage), built-in timer triggers, managed identity for secure API access, automatic scaling, and native integration with Log Analytics.</p>
          </div>
        </div>

        <h3>2.2 Data Flow Summary</h3>

        <div class="flow-diagram">
          <pre><code>DATA FLOW — FROM SCANNERS TO SINGLE DASHBOARD
════════════════════════════════════════════════════════════════════════════════

BEFORE (Manual):
┌──────────┐     ┌──────────┐
│  Qualys  │     │  MDE     │     Analyst switches between 2 consoles
│  Portal  │ ←→  │  Portal  │     Manual correlation, inconsistent priority
└──────────┘     └──────────┘

AFTER (Automated):
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  Qualys  │────▶│  Azure   │────▶│  Log     │────▶│ Sentinel │
│  API     │     │ Function │     │Analytics │     │ Workbook │
└──────────┘     │          │     │          │     │          │
┌──────────┐     │ Enrich:  │     │ Custom   │     │ Single   │
│  MDE     │────▶│ +EPSS    │     │ Table    │     │ Pane of  │
│  API     │     │ +KEV     │     │          │     │ Glass    │
└──────────┘     │ +CMDB    │     └──────────┘     └──────────┘
                 │ +Score   │            │
                 └────┬─────┘            │
                      │                  ▼
                      │         ┌──────────────────┐
                      └────────▶│  ServiceNow      │
                                │  Auto-Tickets    │
                                └──────────────────┘</code></pre>
        </div>

        <!-- ==================== SECTION 3: ENRICHMENT SOURCES ==================== -->
        <h2>3. Enrichment Sources Deep Dive</h2>

        <div class="enrichment-card">
          <h4><span class="source-badge qualys">QUALYS</span> Qualys Vulnerability Scanner</h4>
          <p><strong>What it provides:</strong> Network-based and agent-based vulnerability scanning</p>
          <p><strong>Key data:</strong></p>
          <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
            <li>CVE ID, QID (Qualys ID)</li>
            <li>CVSS score (v2, v3)</li>
            <li>Affected host, IP, OS</li>
            <li>Detection date, last seen</li>
            <li>Port, service, protocol</li>
            <li>Patch availability</li>
          </ul>
          <p><strong>API endpoint:</strong> <code>/api/2.0/fo/asset/host/vm/detection/</code></p>
        </div>

        <div class="enrichment-card">
          <h4><span class="source-badge mde">MDE TVM</span> Microsoft Defender Threat & Vulnerability Management</h4>
          <p><strong>What it provides:</strong> Agent-based vulnerability assessment integrated with EDR</p>
          <p><strong>Key data:</strong></p>
          <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
            <li>CVE ID, software name/version</li>
            <li>Severity (Critical/High/Medium/Low)</li>
            <li>Exposure score (0-100)</li>
            <li>Exploitability (verified, likely, unlikely)</li>
            <li>Security recommendations</li>
            <li>Device exposure level</li>
          </ul>
          <p><strong>API endpoint:</strong> <code>https://api.securitycenter.microsoft.com/api/vulnerabilities</code></p>
          <p><strong>Advantage:</strong> Correlates with MDE alerts — if a vulnerability is being actively exploited on a device, we see it</p>
        </div>

        <div class="enrichment-card">
          <h4><span class="source-badge epss">EPSS</span> Exploit Prediction Scoring System (FIRST.org)</h4>
          <p><strong>What it provides:</strong> Probability that a vulnerability will be exploited in the wild within 30 days</p>
          <p><strong>Key data:</strong></p>
          <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
            <li>EPSS score (0.0 - 1.0)</li>
            <li>Percentile ranking</li>
            <li>Updated daily</li>
          </ul>
          <p><strong>API endpoint:</strong> <code>https://api.first.org/data/v1/epss?cve=CVE-XXXX-XXXX</code></p>
          <p><strong>Why it matters:</strong></p>
          <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
            <li>EPSS > 0.1 (10%): Elevated risk</li>
            <li>EPSS > 0.4 (40%): High exploitation likelihood</li>
            <li>EPSS > 0.7 (70%): Very likely to be exploited</li>
          </ul>
          <p><strong>Example:</strong> CVE-2023-23397 (Outlook privilege escalation) had EPSS of 0.97 — almost certain exploitation</p>
        </div>

        <div class="enrichment-card">
          <h4><span class="source-badge kev">CISA KEV</span> Known Exploited Vulnerabilities Catalog</h4>
          <p><strong>What it provides:</strong> Authoritative list of CVEs actively exploited in the wild</p>
          <p><strong>Key data:</strong></p>
          <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
            <li>CVE ID</li>
            <li>Vendor, product</li>
            <li>Vulnerability name</li>
            <li>Date added to KEV</li>
            <li>Due date for federal agencies</li>
            <li>Required action</li>
          </ul>
          <p><strong>API endpoint:</strong> <code>https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json</code></p>
          <p><strong>Policy implication:</strong> Federal agencies MUST patch KEV vulnerabilities within specified timeframe. Many enterprises adopt KEV as mandatory patch list.</p>
        </div>

        <div class="enrichment-card">
          <h4><span class="source-badge cmdb">CMDB</span> Configuration Management Database (ServiceNow)</h4>
          <p><strong>What it provides:</strong> Asset context and business metadata</p>
          <p><strong>Key data:</strong></p>
          <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
            <li>Asset name, IP, hostname</li>
            <li>Business criticality (Tier 1 = mission-critical, Tier 2 = important, Tier 3 = standard)</li>
            <li>Environment (Production, Staging, Development, Test)</li>
            <li>Exposure (Internet-facing, Internal, DMZ)</li>
            <li>Owner (department, contact email)</li>
            <li>Support group</li>
            <li>EOL/EOS status</li>
          </ul>
          <p><strong>Why it matters:</strong> A critical vulnerability on a Tier 1 production server needs immediate attention. The same vulnerability on a Tier 3 test server can wait.</p>
        </div>

        <!-- ==================== SECTION 4: RISK SCORING MODEL ==================== -->
        <h2>4. Risk Scoring Model</h2>

        <p>We calculate a composite risk score that determines prioritization:</p>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Risk Score Calculation</span></div>
          <pre><code># RevFlow Risk Score Formula
# ═══════════════════════════════════════════════════════════════════════════════

BASE_SCORE = CVSS_Score  # 0-10

# Exploitation likelihood multiplier
if CVE in CISA_KEV:
    EXPLOIT_MULTIPLIER = 2.0     # Confirmed active exploitation
elif EPSS > 0.7:
    EXPLOIT_MULTIPLIER = 1.8     # Very high exploitation probability
elif EPSS > 0.4:
    EXPLOIT_MULTIPLIER = 1.5     # High exploitation probability
elif EPSS > 0.1:
    EXPLOIT_MULTIPLIER = 1.2     # Elevated exploitation probability
else:
    EXPLOIT_MULTIPLIER = 1.0     # Standard

# Asset criticality multiplier
if Asset_Tier == "Tier 1":
    ASSET_MULTIPLIER = 2.0       # Mission-critical systems
elif Asset_Tier == "Tier 2":
    ASSET_MULTIPLIER = 1.5       # Important systems
else:
    ASSET_MULTIPLIER = 1.0       # Standard systems

# Exposure multiplier
if Exposure == "Internet-facing":
    EXPOSURE_MULTIPLIER = 2.0    # Directly exposed to attackers
elif Exposure == "DMZ":
    EXPOSURE_MULTIPLIER = 1.5    # Partially exposed
else:
    EXPOSURE_MULTIPLIER = 1.0    # Internal only

# Environment multiplier
if Environment == "Production":
    ENV_MULTIPLIER = 1.5
elif Environment == "Staging":
    ENV_MULTIPLIER = 1.2
else:
    ENV_MULTIPLIER = 1.0         # Dev/Test

# ═══════════════════════════════════════════════════════════════════════════════
# FINAL RISK SCORE
# ═══════════════════════════════════════════════════════════════════════════════
RISK_SCORE = BASE_SCORE × EXPLOIT_MULTIPLIER × ASSET_MULTIPLIER 
             × EXPOSURE_MULTIPLIER × ENV_MULTIPLIER

# Priority assignment
if RISK_SCORE >= 50 or CVE in CISA_KEV:
    PRIORITY = "CRITICAL"    # Remediate within 24-48 hours
elif RISK_SCORE >= 30:
    PRIORITY = "HIGH"        # Remediate within 7 days
elif RISK_SCORE >= 15:
    PRIORITY = "MEDIUM"      # Remediate within 30 days
else:
    PRIORITY = "LOW"         # Remediate within 90 days or accept risk</code></pre>
        </div>

        <h3>4.1 Risk Score Examples</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>CVE</th><th>CVSS</th><th>EPSS</th><th>KEV</th><th>Asset</th><th>Exposure</th><th>Env</th><th>Risk Score</th><th>Priority</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>CVE-2023-23397</td>
                <td>9.8</td>
                <td>0.97</td>
                <td>✅ Yes</td>
                <td>Tier 1</td>
                <td>Internet</td>
                <td>Prod</td>
                <td><strong>117.6</strong></td>
                <td><span class="priority-badge critical">CRITICAL</span></td>
              </tr>
              <tr>
                <td>CVE-2024-21351</td>
                <td>7.8</td>
                <td>0.45</td>
                <td>❌ No</td>
                <td>Tier 2</td>
                <td>Internet</td>
                <td>Prod</td>
                <td><strong>52.7</strong></td>
                <td><span class="priority-badge critical">CRITICAL</span></td>
              </tr>
              <tr>
                <td>CVE-2024-12345</td>
                <td>7.5</td>
                <td>0.08</td>
                <td>❌ No</td>
                <td>Tier 1</td>
                <td>Internal</td>
                <td>Prod</td>
                <td><strong>22.5</strong></td>
                <td><span class="priority-badge medium">MEDIUM</span></td>
              </tr>
              <tr>
                <td>CVE-2024-99999</td>
                <td>9.0</td>
                <td>0.02</td>
                <td>❌ No</td>
                <td>Tier 3</td>
                <td>Internal</td>
                <td>Dev</td>
                <td><strong>9.0</strong></td>
                <td><span class="priority-badge low">LOW</span></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- ==================== SECTION 5: IMPLEMENTATION ==================== -->
        <h2>5. Implementation — Azure Function Deployment</h2>

        <h3>5.1 Azure Function Structure</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Azure Function Project Structure</span></div>
          <pre><code>vuln-enrichment-function/
├── function_app.py              # Main function code
├── requirements.txt             # Python dependencies
├── host.json                    # Function host configuration
├── local.settings.json          # Local dev settings (not deployed)
└── modules/
    ├── qualys_client.py         # Qualys API wrapper
    ├── mde_client.py            # MDE TVM API wrapper
    ├── enrichment.py            # EPSS, KEV, CMDB enrichment
    ├── scoring.py               # Risk score calculation
    └── outputs.py               # Log Analytics, ServiceNow writers</code></pre>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">function_app.py — Main Azure Function</span><button class="code-copy-btn">Copy</button></div>
          <pre><code>import azure.functions as func
import logging
from datetime import datetime
from modules.qualys_client import get_qualys_vulnerabilities
from modules.mde_client import get_mde_vulnerabilities
from modules.enrichment import enrich_with_epss, enrich_with_kev, enrich_with_cmdb
from modules.scoring import prioritize_vulnerabilities
from modules.outputs import write_to_log_analytics, create_servicenow_tickets

app = func.FunctionApp()

# Timer trigger: runs daily at 6 AM UTC
@app.timer_trigger(schedule="0 0 6 * * *", arg_name="timer", run_on_startup=False)
def vuln_enrichment_pipeline(timer: func.TimerRequest) -> None:
    """
    Main vulnerability enrichment pipeline
    Runs daily to aggregate, enrich, and prioritize vulnerabilities
    """
    logging.info(f"Vulnerability enrichment started at {datetime.utcnow()}")
    
    try:
        # ═══════════════════════════════════════════════════════════════════
        # STEP 1: Aggregate vulnerabilities from all sources
        # ═══════════════════════════════════════════════════════════════════
        logging.info("Step 1: Fetching vulnerabilities from Qualys...")
        qualys_vulns = get_qualys_vulnerabilities()
        logging.info(f"  Found {len(qualys_vulns)} Qualys vulnerabilities")
        
        logging.info("Step 1: Fetching vulnerabilities from MDE TVM...")
        mde_vulns = get_mde_vulnerabilities()
        logging.info(f"  Found {len(mde_vulns)} MDE vulnerabilities")
        
        # Combine and deduplicate
        all_vulns = deduplicate_vulnerabilities(qualys_vulns + mde_vulns)
        logging.info(f"  Combined: {len(all_vulns)} unique vulnerabilities")
        
        # ═══════════════════════════════════════════════════════════════════
        # STEP 2-4: Enrich with external data
        # ═══════════════════════════════════════════════════════════════════
        logging.info("Step 2: Enriching with EPSS scores...")
        all_vulns = enrich_with_epss(all_vulns)
        
        logging.info("Step 3: Enriching with CISA KEV...")
        all_vulns = enrich_with_kev(all_vulns)
        
        logging.info("Step 4: Enriching with CMDB asset context...")
        all_vulns = enrich_with_cmdb(all_vulns)
        
        # ═══════════════════════════════════════════════════════════════════
        # STEP 5: Calculate risk scores and prioritize
        # ═══════════════════════════════════════════════════════════════════
        logging.info("Step 5: Calculating risk scores...")
        all_vulns = prioritize_vulnerabilities(all_vulns)
        
        critical_count = len([v for v in all_vulns if v["priority"] == "CRITICAL"])
        high_count = len([v for v in all_vulns if v["priority"] == "HIGH"])
        logging.info(f"  Priority breakdown: {critical_count} Critical, {high_count} High")
        
        # ═══════════════════════════════════════════════════════════════════
        # STEP 6: Output to destinations
        # ═══════════════════════════════════════════════════════════════════
        logging.info("Step 6: Writing to Log Analytics...")
        write_to_log_analytics(all_vulns, table_name="VulnerabilityInventory_CL")
        
        logging.info("Step 6: Creating ServiceNow tickets for Critical/High...")
        tickets_created = create_servicenow_tickets(
            [v for v in all_vulns if v["priority"] in ["CRITICAL", "HIGH"]]
        )
        logging.info(f"  Created {tickets_created} ServiceNow tickets")
        
        logging.info(f"Pipeline completed successfully at {datetime.utcnow()}")
        
    except Exception as e:
        logging.error(f"Pipeline failed: {str(e)}")
        raise

def deduplicate_vulnerabilities(vulns):
    """Deduplicate by CVE + hostname, merge source info"""
    seen = {}
    for vuln in vulns:
        key = (vuln.get("cve_id"), vuln.get("hostname"))
        if key not in seen:
            seen[key] = vuln
        else:
            # Merge sources
            existing_sources = seen[key].get("sources", [seen[key].get("source")])
            existing_sources.append(vuln.get("source"))
            seen[key]["sources"] = list(set(existing_sources))
    return list(seen.values())</code></pre>
        </div>

        <h3>5.2 Writing to Log Analytics (Custom Table)</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Python — Log Analytics Data Collector API</span><button class="code-copy-btn">Copy</button></div>
          <pre><code>import requests
import json
import hashlib
import hmac
import base64
from datetime import datetime
import os

def write_to_log_analytics(vulnerabilities, table_name="VulnerabilityInventory_CL"):
    """
    Write enriched vulnerability data to Log Analytics custom table
    Uses the Data Collector API (legacy) or DCR-based ingestion
    """
    
    workspace_id = os.environ["LOG_ANALYTICS_WORKSPACE_ID"]
    shared_key = os.environ["LOG_ANALYTICS_SHARED_KEY"]
    
    # Prepare the data
    body = json.dumps([{
        "TimeGenerated": datetime.utcnow().isoformat() + "Z",
        "CVE": v.get("cve_id"),
        "Hostname": v.get("hostname"),
        "IPAddress": v.get("ip_address"),
        "CVSSScore": v.get("cvss_score"),
        "EPSSScore": v.get("epss_score"),
        "EPSSPercentile": v.get("epss_percentile"),
        "InCISAKEV": v.get("in_cisa_kev", False),
        "KEVDueDate": v.get("kev_due_date"),
        "AssetTier": v.get("asset_tier"),
        "Environment": v.get("environment"),
        "Exposure": v.get("exposure"),
        "AssetOwner": v.get("asset_owner"),
        "RiskScore": v.get("risk_score"),
        "Priority": v.get("priority"),
        "SLADays": v.get("sla_days"),
        "Title": v.get("title"),
        "Sources": ",".join(v.get("sources", [v.get("source", "Unknown")]))
    } for v in vulnerabilities])
    
    # Build authorization signature
    content_length = len(body)
    rfc1123date = datetime.utcnow().strftime('%a, %d %b %Y %H:%M:%S GMT')
    
    string_to_sign = f"POST\n{content_length}\napplication/json\nx-ms-date:{rfc1123date}\n/api/logs"
    signature = base64.b64encode(
        hmac.new(
            base64.b64decode(shared_key),
            string_to_sign.encode('utf-8'),
            hashlib.sha256
        ).digest()
    ).decode('utf-8')
    
    # Send to Log Analytics
    uri = f"https://{workspace_id}.ods.opinsights.azure.com/api/logs?api-version=2016-04-01"
    headers = {
        "Content-Type": "application/json",
        "Log-Type": table_name.replace("_CL", ""),  # API adds _CL suffix
        "x-ms-date": rfc1123date,
        "Authorization": f"SharedKey {workspace_id}:{signature}",
        "time-generated-field": "TimeGenerated"
    }
    
    response = requests.post(uri, data=body, headers=headers)
    
    if response.status_code == 200 or response.status_code == 202:
        logging.info(f"Successfully wrote {len(vulnerabilities)} records to {table_name}")
    else:
        logging.error(f"Failed to write to Log Analytics: {response.status_code} - {response.text}")
        raise Exception(f"Log Analytics write failed: {response.text}")</code></pre>
        </div>

        <h3>Step 1: Data Collection (Called by Main Function)</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Python — Collect Vulnerabilities from Qualys and MDE</span><button class="code-copy-btn">Copy</button></div>
          <pre><code>import requests
import json
from azure.identity import DefaultAzureCredential
from azure.storage.blob import BlobServiceClient

# ═══════════════════════════════════════════════════════════════════════════════
# STEP 1A: Fetch Qualys Vulnerabilities
# ═══════════════════════════════════════════════════════════════════════════════
def get_qualys_vulnerabilities():
    """Fetch vulnerability detections from Qualys API"""
    
    url = "https://qualysapi.qualys.com/api/2.0/fo/asset/host/vm/detection/"
    headers = {
        "X-Requested-With": "Python",
        "Authorization": f"Basic {QUALYS_AUTH}"
    }
    params = {
        "action": "list",
        "show_results": 1,
        "status": "New,Active,Re-Opened",
        "severities": "3,4,5"  # Medium, High, Critical
    }
    
    response = requests.get(url, headers=headers, params=params)
    vulnerabilities = parse_qualys_xml(response.text)
    
    # Normalize to common format
    normalized = []
    for vuln in vulnerabilities:
        normalized.append({
            "source": "Qualys",
            "cve_id": vuln.get("cve_id"),
            "qid": vuln.get("qid"),
            "hostname": vuln.get("hostname"),
            "ip_address": vuln.get("ip"),
            "cvss_score": float(vuln.get("cvss_base", 0)),
            "severity": vuln.get("severity"),
            "title": vuln.get("title"),
            "first_detected": vuln.get("first_found"),
            "last_detected": vuln.get("last_found"),
            "port": vuln.get("port"),
            "solution": vuln.get("solution")
        })
    
    return normalized

# ═══════════════════════════════════════════════════════════════════════════════
# STEP 1B: Fetch MDE TVM Vulnerabilities
# ═══════════════════════════════════════════════════════════════════════════════
def get_mde_vulnerabilities():
    """Fetch vulnerabilities from Microsoft Defender TVM API"""
    
    credential = DefaultAzureCredential()
    token = credential.get_token("https://api.securitycenter.microsoft.com/.default")
    
    url = "https://api.securitycenter.microsoft.com/api/vulnerabilities/machinesVulnerabilities"
    headers = {
        "Authorization": f"Bearer {token.token}",
        "Content-Type": "application/json"
    }
    
    vulnerabilities = []
    next_link = url
    
    while next_link:
        response = requests.get(next_link, headers=headers)
        data = response.json()
        vulnerabilities.extend(data.get("value", []))
        next_link = data.get("@odata.nextLink")
    
    # Normalize to common format
    normalized = []
    for vuln in vulnerabilities:
        normalized.append({
            "source": "MDE_TVM",
            "cve_id": vuln.get("cveId"),
            "hostname": vuln.get("machineName"),
            "device_id": vuln.get("machineId"),
            "cvss_score": vuln.get("cvssV3"),
            "severity": vuln.get("severity"),
            "title": vuln.get("name"),
            "software_name": vuln.get("productName"),
            "software_version": vuln.get("productVersion"),
            "exploit_verified": vuln.get("exploitVerified"),
            "exposure_level": vuln.get("exposureLevel"),
            "first_detected": vuln.get("detectionTime")
        })
    
    return normalized

# ═══════════════════════════════════════════════════════════════════════════════
# STEP 1C: Combine and Deduplicate
# ═══════════════════════════════════════════════════════════════════════════════
def aggregate_vulnerabilities():
    """Combine vulnerabilities from all sources"""
    
    qualys_vulns = get_qualys_vulnerabilities()
    mde_vulns = get_mde_vulnerabilities()
    
    # Combine all
    all_vulns = qualys_vulns + mde_vulns
    
    # Deduplicate by CVE + hostname
    seen = set()
    unique_vulns = []
    for vuln in all_vulns:
        key = (vuln["cve_id"], vuln["hostname"])
        if key not in seen:
            seen.add(key)
            unique_vulns.append(vuln)
        else:
            # Merge data from both sources if duplicate
            for existing in unique_vulns:
                if (existing["cve_id"], existing["hostname"]) == key:
                    existing["sources"] = existing.get("sources", [existing["source"]])
                    existing["sources"].append(vuln["source"])
    
    return unique_vulns</code></pre>
        </div>

        <h3>Step 2: EPSS Enrichment</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Python — Enrich with EPSS Scores</span><button class="code-copy-btn">Copy</button></div>
          <pre><code># ═══════════════════════════════════════════════════════════════════════════════
# STEP 2: Enrich with EPSS (Exploit Prediction Scoring System)
# ═══════════════════════════════════════════════════════════════════════════════

def get_epss_scores(cve_list):
    """Fetch EPSS scores for a list of CVEs"""
    
    # EPSS API allows batch queries
    cve_string = ",".join(cve_list)
    url = f"https://api.first.org/data/v1/epss?cve={cve_string}"
    
    response = requests.get(url)
    data = response.json()
    
    # Create lookup dictionary
    epss_lookup = {}
    for item in data.get("data", []):
        epss_lookup[item["cve"]] = {
            "epss_score": float(item["epss"]),
            "percentile": float(item["percentile"])
        }
    
    return epss_lookup

def enrich_with_epss(vulnerabilities):
    """Add EPSS scores to vulnerability list"""
    
    # Get unique CVEs
    cve_list = list(set([v["cve_id"] for v in vulnerabilities if v.get("cve_id")]))
    
    # Batch fetch EPSS scores (API limit: 100 CVEs per request)
    epss_lookup = {}
    for i in range(0, len(cve_list), 100):
        batch = cve_list[i:i+100]
        batch_scores = get_epss_scores(batch)
        epss_lookup.update(batch_scores)
    
    # Enrich vulnerabilities
    for vuln in vulnerabilities:
        cve_id = vuln.get("cve_id")
        if cve_id and cve_id in epss_lookup:
            vuln["epss_score"] = epss_lookup[cve_id]["epss_score"]
            vuln["epss_percentile"] = epss_lookup[cve_id]["percentile"]
        else:
            vuln["epss_score"] = 0.0
            vuln["epss_percentile"] = 0.0
    
    return vulnerabilities</code></pre>
        </div>

        <h3>Step 3: CISA KEV Enrichment</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Python — Enrich with CISA KEV</span><button class="code-copy-btn">Copy</button></div>
          <pre><code># ═══════════════════════════════════════════════════════════════════════════════
# STEP 3: Enrich with CISA KEV (Known Exploited Vulnerabilities)
# ═══════════════════════════════════════════════════════════════════════════════

def get_cisa_kev():
    """Fetch CISA Known Exploited Vulnerabilities catalog"""
    
    url = "https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json"
    response = requests.get(url)
    data = response.json()
    
    # Create lookup dictionary
    kev_lookup = {}
    for vuln in data.get("vulnerabilities", []):
        kev_lookup[vuln["cveID"]] = {
            "vendor": vuln["vendorProject"],
            "product": vuln["product"],
            "name": vuln["vulnerabilityName"],
            "date_added": vuln["dateAdded"],
            "due_date": vuln["dueDate"],
            "action": vuln["requiredAction"]
        }
    
    return kev_lookup

def enrich_with_kev(vulnerabilities):
    """Flag vulnerabilities in CISA KEV"""
    
    kev_lookup = get_cisa_kev()
    
    for vuln in vulnerabilities:
        cve_id = vuln.get("cve_id")
        if cve_id and cve_id in kev_lookup:
            vuln["in_cisa_kev"] = True
            vuln["kev_date_added"] = kev_lookup[cve_id]["date_added"]
            vuln["kev_due_date"] = kev_lookup[cve_id]["due_date"]
            vuln["kev_action"] = kev_lookup[cve_id]["action"]
        else:
            vuln["in_cisa_kev"] = False
    
    return vulnerabilities</code></pre>
        </div>

        <h3>Step 4: CMDB Enrichment</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Python — Enrich with CMDB Asset Context</span><button class="code-copy-btn">Copy</button></div>
          <pre><code># ═══════════════════════════════════════════════════════════════════════════════
# STEP 4: Enrich with CMDB (ServiceNow) Asset Context
# ═══════════════════════════════════════════════════════════════════════════════

def get_cmdb_assets():
    """Fetch asset inventory from ServiceNow CMDB"""
    
    url = f"https://{SNOW_INSTANCE}.service-now.com/api/now/table/cmdb_ci_server"
    headers = {
        "Authorization": f"Basic {SNOW_AUTH}",
        "Content-Type": "application/json"
    }
    params = {
        "sysparm_fields": "name,ip_address,fqdn,asset_tag,operational_status,"
                          "business_criticality,environment,location,support_group,"
                          "assigned_to,u_internet_facing,u_tier",
        "sysparm_limit": 10000
    }
    
    response = requests.get(url, headers=headers, params=params)
    assets = response.json().get("result", [])
    
    # Create lookup by hostname and IP
    asset_lookup = {}
    for asset in assets:
        # Index by hostname (normalized)
        hostname = asset.get("name", "").lower()
        if hostname:
            asset_lookup[hostname] = {
                "asset_name": asset.get("name"),
                "ip_address": asset.get("ip_address"),
                "tier": asset.get("u_tier", "Tier 3"),
                "environment": asset.get("environment", "Production"),
                "internet_facing": asset.get("u_internet_facing", "false") == "true",
                "business_criticality": asset.get("business_criticality", "3 - low"),
                "location": asset.get("location"),
                "support_group": asset.get("support_group"),
                "owner": asset.get("assigned_to")
            }
        
        # Also index by IP
        ip = asset.get("ip_address")
        if ip:
            asset_lookup[ip] = asset_lookup.get(hostname, {})
    
    return asset_lookup

def enrich_with_cmdb(vulnerabilities):
    """Add asset context from CMDB"""
    
    cmdb_lookup = get_cmdb_assets()
    
    for vuln in vulnerabilities:
        hostname = vuln.get("hostname", "").lower()
        ip = vuln.get("ip_address")
        
        asset_info = cmdb_lookup.get(hostname) or cmdb_lookup.get(ip) or {}
        
        vuln["asset_tier"] = asset_info.get("tier", "Tier 3")
        vuln["environment"] = asset_info.get("environment", "Unknown")
        vuln["internet_facing"] = asset_info.get("internet_facing", False)
        vuln["business_criticality"] = asset_info.get("business_criticality", "3 - low")
        vuln["asset_owner"] = asset_info.get("owner")
        vuln["support_group"] = asset_info.get("support_group")
        
        # Determine exposure level
        if vuln["internet_facing"]:
            vuln["exposure"] = "Internet-facing"
        else:
            vuln["exposure"] = "Internal"
    
    return vulnerabilities</code></pre>
        </div>

        <h3>Step 5: Calculate Risk Score and Prioritize</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Python — Risk Scoring and Prioritization</span><button class="code-copy-btn">Copy</button></div>
          <pre><code># ═══════════════════════════════════════════════════════════════════════════════
# STEP 5: Calculate Risk Score
# ═══════════════════════════════════════════════════════════════════════════════

def calculate_risk_score(vuln):
    """Calculate composite risk score for a vulnerability"""
    
    base_score = vuln.get("cvss_score", 5.0)
    
    # Exploitation likelihood multiplier
    if vuln.get("in_cisa_kev"):
        exploit_multiplier = 2.0
    elif vuln.get("epss_score", 0) > 0.7:
        exploit_multiplier = 1.8
    elif vuln.get("epss_score", 0) > 0.4:
        exploit_multiplier = 1.5
    elif vuln.get("epss_score", 0) > 0.1:
        exploit_multiplier = 1.2
    else:
        exploit_multiplier = 1.0
    
    # Asset criticality multiplier
    tier = vuln.get("asset_tier", "Tier 3")
    if tier == "Tier 1":
        asset_multiplier = 2.0
    elif tier == "Tier 2":
        asset_multiplier = 1.5
    else:
        asset_multiplier = 1.0
    
    # Exposure multiplier
    if vuln.get("internet_facing") or vuln.get("exposure") == "Internet-facing":
        exposure_multiplier = 2.0
    elif vuln.get("exposure") == "DMZ":
        exposure_multiplier = 1.5
    else:
        exposure_multiplier = 1.0
    
    # Environment multiplier
    env = vuln.get("environment", "").lower()
    if "prod" in env:
        env_multiplier = 1.5
    elif "stag" in env:
        env_multiplier = 1.2
    else:
        env_multiplier = 1.0
    
    # Calculate final score
    risk_score = (base_score * exploit_multiplier * asset_multiplier * 
                  exposure_multiplier * env_multiplier)
    
    return round(risk_score, 2)

def assign_priority(vuln):
    """Assign priority based on risk score"""
    
    risk_score = vuln.get("risk_score", 0)
    
    # CISA KEV always critical
    if vuln.get("in_cisa_kev"):
        return "CRITICAL"
    
    if risk_score >= 50:
        return "CRITICAL"
    elif risk_score >= 30:
        return "HIGH"
    elif risk_score >= 15:
        return "MEDIUM"
    else:
        return "LOW"

def prioritize_vulnerabilities(vulnerabilities):
    """Calculate risk scores and assign priorities"""
    
    for vuln in vulnerabilities:
        vuln["risk_score"] = calculate_risk_score(vuln)
        vuln["priority"] = assign_priority(vuln)
        
        # Set SLA based on priority
        if vuln["priority"] == "CRITICAL":
            vuln["sla_days"] = 2  # 48 hours
        elif vuln["priority"] == "HIGH":
            vuln["sla_days"] = 7
        elif vuln["priority"] == "MEDIUM":
            vuln["sla_days"] = 30
        else:
            vuln["sla_days"] = 90
    
    # Sort by risk score descending
    vulnerabilities.sort(key=lambda x: x["risk_score"], reverse=True)
    
    return vulnerabilities</code></pre>
        </div>

        <h3>Step 6: Automated Actions</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Python — Auto-Create Tickets and Alerts</span><button class="code-copy-btn">Copy</button></div>
          <pre><code># ═══════════════════════════════════════════════════════════════════════════════
# STEP 6: Automated Actions
# ═══════════════════════════════════════════════════════════════════════════════

def create_servicenow_ticket(vuln):
    """Create ServiceNow incident for vulnerability remediation"""
    
    url = f"https://{SNOW_INSTANCE}.service-now.com/api/now/table/incident"
    headers = {
        "Authorization": f"Basic {SNOW_AUTH}",
        "Content-Type": "application/json"
    }
    
    # Map priority to ServiceNow impact/urgency
    priority_map = {
        "CRITICAL": {"impact": "1", "urgency": "1"},
        "HIGH": {"impact": "2", "urgency": "1"},
        "MEDIUM": {"impact": "2", "urgency": "2"},
        "LOW": {"impact": "3", "urgency": "3"}
    }
    
    p = priority_map.get(vuln["priority"], {"impact": "3", "urgency": "3"})
    
    description = f"""
AUTOMATED VULNERABILITY REMEDIATION TICKET

CVE: {vuln.get('cve_id')}
Host: {vuln.get('hostname')}
CVSS Score: {vuln.get('cvss_score')}
Risk Score: {vuln.get('risk_score')}
Priority: {vuln.get('priority')}
SLA: {vuln.get('sla_days')} days

EPSS Score: {vuln.get('epss_score', 0):.2%}
In CISA KEV: {'YES - MANDATORY PATCH' if vuln.get('in_cisa_kev') else 'No'}

Asset Information:
- Tier: {vuln.get('asset_tier')}
- Environment: {vuln.get('environment')}
- Exposure: {vuln.get('exposure')}
- Owner: {vuln.get('asset_owner')}

Vulnerability Details:
{vuln.get('title', 'N/A')}

Solution:
{vuln.get('solution', 'Apply vendor patch or follow security advisory')}
    """
    
    payload = {
        "short_description": f"[{vuln['priority']}] {vuln['cve_id']} on {vuln['hostname']}",
        "description": description,
        "category": "Security",
        "subcategory": "Vulnerability",
        "impact": p["impact"],
        "urgency": p["urgency"],
        "assignment_group": vuln.get("support_group", "Security Operations"),
        "caller_id": "vulnerability_automation"
    }
    
    response = requests.post(url, headers=headers, json=payload)
    return response.json()

def send_to_sentinel(vuln):
    """Send vulnerability alert to Microsoft Sentinel"""
    
    # Use Log Analytics Data Collector API
    log_type = "VulnerabilityAlerts"
    
    body = json.dumps([{
        "TimeGenerated": datetime.utcnow().isoformat(),
        "CVE": vuln.get("cve_id"),
        "Hostname": vuln.get("hostname"),
        "CVSSScore": vuln.get("cvss_score"),
        "RiskScore": vuln.get("risk_score"),
        "Priority": vuln.get("priority"),
        "EPSSScore": vuln.get("epss_score"),
        "InCISAKEV": vuln.get("in_cisa_kev"),
        "AssetTier": vuln.get("asset_tier"),
        "Environment": vuln.get("environment"),
        "Exposure": vuln.get("exposure"),
        "Title": vuln.get("title")
    }])
    
    # Post to Log Analytics
    post_to_log_analytics(WORKSPACE_ID, SHARED_KEY, log_type, body)

def process_vulnerabilities(vulnerabilities):
    """Main automation workflow"""
    
    for vuln in vulnerabilities:
        if vuln["priority"] in ["CRITICAL", "HIGH"]:
            # Auto-create ServiceNow ticket
            ticket = create_servicenow_ticket(vuln)
            vuln["snow_ticket"] = ticket.get("number")
            
            # Send to Sentinel for correlation
            send_to_sentinel(vuln)
            
            # Email asset owner
            if vuln.get("asset_owner"):
                send_notification_email(vuln)
    
    return vulnerabilities</code></pre>
        </div>

        <!-- ==================== SECTION 6: DASHBOARD ==================== -->
        <h2>6. Vulnerability Dashboard</h2>

        <div class="metric-grid">
          <div class="metric-card">
            <div class="value">47,234</div>
            <div class="label">Total Vulnerabilities</div>
          </div>
          <div class="metric-card">
            <div class="value">127</div>
            <div class="label">Critical Priority</div>
          </div>
          <div class="metric-card">
            <div class="value">842</div>
            <div class="label">High Priority</div>
          </div>
          <div class="metric-card">
            <div class="value">23</div>
            <div class="label">In CISA KEV</div>
          </div>
          <div class="metric-card">
            <div class="value">94%</div>
            <div class="label">Within SLA</div>
          </div>
          <div class="metric-card">
            <div class="value">12 days</div>
            <div class="label">Avg Remediation Time</div>
          </div>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">KQL — Vulnerability Dashboard Queries (Sentinel)</span><button class="code-copy-btn">Copy</button></div>
          <pre><code>// Critical/High vulnerabilities by host
VulnerabilityAlerts_CL
| where TimeGenerated > ago(7d)
| where Priority in ("CRITICAL", "HIGH")
| summarize VulnCount = count() by Hostname, Priority
| order by VulnCount desc
| take 20

// Vulnerabilities in CISA KEV
VulnerabilityAlerts_CL
| where InCISAKEV == true
| summarize by CVE, Hostname, RiskScore
| order by RiskScore desc

// Remediation SLA compliance
VulnerabilityAlerts_CL
| join kind=leftouter (
    ServiceNow_Incidents_CL
    | where Category == "Vulnerability"
) on $left.CVE == $right.CVE, $left.Hostname == $right.Hostname
| extend RemediationDays = datetime_diff('day', ResolvedTime, TimeGenerated)
| extend WithinSLA = RemediationDays <= SLADays
| summarize TotalCount = count(), WithinSLACount = countif(WithinSLA) by Priority
| extend SLACompliance = round(100.0 * WithinSLACount / TotalCount, 1)

// Trend over time
VulnerabilityAlerts_CL
| summarize 
    Critical = countif(Priority == "CRITICAL"),
    High = countif(Priority == "HIGH"),
    Medium = countif(Priority == "MEDIUM")
    by bin(TimeGenerated, 1d)
| render timechart</code></pre>
        </div>

        <!-- ==================== SECTION 7: MANUAL WORKFLOW ==================== -->
        <h2>7. Manual Workflow — Analysts and Business Owners</h2>

        <p>While automation handles initial triage and ticket creation, humans are essential for:</p>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Activity</th><th>Owner</th><th>Description</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>False Positive Review</strong></td>
                <td>Security Analyst</td>
                <td>Review tickets flagged as potential FPs. Mark as FP with justification if scanner error.</td>
              </tr>
              <tr>
                <td><strong>Impact Assessment</strong></td>
                <td>Business Owner</td>
                <td>Assess business impact of remediation. Does patching require downtime?</td>
              </tr>
              <tr>
                <td><strong>Compensating Controls</strong></td>
                <td>Security Engineer</td>
                <td>If immediate patching not possible, implement compensating controls (network isolation, WAF rules, etc.)</td>
              </tr>
              <tr>
                <td><strong>Exception Requests</strong></td>
                <td>Business Owner + Security</td>
                <td>Request risk acceptance for vulnerabilities that cannot be remediated. Requires CISO approval.</td>
              </tr>
              <tr>
                <td><strong>Verification</strong></td>
                <td>Security Analyst</td>
                <td>After remediation, verify vulnerability is resolved. Close ticket.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- ==================== SECTION 8: INTERVIEW ANSWERS ==================== -->
        <h2>8. Interview-Ready Answers</h2>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Q: "Tell me about a vulnerability management process you implemented"</span></div>
          <pre><code>"I built an automated vulnerability management pipeline to give our team 
a single pane of glass instead of juggling multiple consoles.

THE PROBLEM:
We had vulnerabilities in two places — Qualys scanner and MDE TVM. 
Analysts were constantly switching between the Qualys portal and 
Microsoft 365 Defender portal, manually correlating findings. Each tool 
had its own severity rating but neither provided business context or 
exploit intelligence.

THE SOLUTION:
I built an Azure Function that runs daily on a timer trigger. It:

1. AGGREGATES data from both Qualys API and MDE TVM API into a unified 
   list, deduplicating by CVE + hostname so we have one source of truth.

2. ENRICHES with exploit intelligence:
   • EPSS scores from FIRST.org — probability of exploitation in 30 days
   • CISA KEV — flags CVEs with confirmed active exploitation
   • ServiceNow CMDB — adds asset tier, environment, exposure, owner

3. CALCULATES risk score: CVSS × EPSS × Asset criticality × Exposure
   This gives us true business risk, not just technical severity.

4. OUTPUTS to multiple destinations:
   • Custom Log Analytics table → Sentinel workbook dashboard
   • Auto-creates ServiceNow tickets for Critical/High
   • Emails asset owners

THE RESULT:
• Analysts have ONE dashboard instead of two consoles
• Prioritization is automated based on actual risk
• Critical findings get tickets immediately
• SLA compliance improved because nothing falls through the cracks
• Asset owners are notified directly, speeding up remediation"</code></pre>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Q: "Where does the automation code run?"</span></div>
          <pre><code>"I use Azure Functions with a timer trigger — it's serverless, so no 
infrastructure to manage.

The function runs daily at 6 AM. It:
1. Calls Qualys API to get vulnerability detections
2. Calls MDE TVM API using managed identity
3. Calls external APIs (FIRST.org for EPSS, CISA for KEV)
4. Queries ServiceNow CMDB for asset context
5. Writes enriched data to a custom Log Analytics table

From there, Sentinel picks it up. I built a workbook that queries 
VulnerabilityInventory_CL table to show the unified dashboard. I also 
have an analytics rule that fires when new Critical findings appear.

For the ServiceNow integration, the same Function calls the ServiceNow 
REST API to auto-create incidents for Critical and High priority items.

Alternatives I considered:
• Azure Automation Runbook — works but Functions are more lightweight
• Logic Apps — good for visual workflows but complex Python logic is 
  easier in Functions
• On-prem scheduled task — we wanted everything in Azure"</code></pre>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Q: "How do you decide what to patch first?"</span></div>
          <pre><code>"I don't rely on CVSS alone — it measures theoretical severity, not real 
risk. A CVSS 9.8 on an isolated test server isn't urgent. A CVSS 7.5 on 
an internet-facing production server with active exploitation is critical.

My prioritization framework uses multiple signals:

IMMEDIATE (24-48 hours):
• Any CVE in CISA KEV — confirmed active exploitation
• EPSS > 0.7 on production assets — very high exploitation probability
• Any vulnerability flagged 'exploit verified' in MDE

HIGH PRIORITY (7 days):
• CVSS ≥ 7.0 + EPSS > 0.4 + internet-facing
• Any vulnerability on Tier 1 systems with known exploits

STANDARD (30 days):
• CVSS ≥ 7.0 on internal production systems
• Medium severity on externally exposed systems

BACKLOG (90 days or risk acceptance):
• Low severity, internal systems, low EPSS
• Requires documented risk acceptance with compensating controls

The key insight: EPSS and CISA KEV tell you what attackers are actually 
targeting right now. CVSS tells you theoretical impact. I prioritize 
based on what's being exploited, not just what could be exploited."</code></pre>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Q: "How do you handle false positives and exceptions?"</span></div>
          <pre><code>"The automation handles initial triage, but humans are essential for:

FALSE POSITIVES:
When analysts identify a false positive — maybe the scanner detected a 
vulnerable version but the system is actually patched — they update the 
ticket in ServiceNow with 'False Positive' status and justification. 
I have a feedback loop where FP data gets added to an exclusion list 
in the Function, so we don't keep creating tickets for known FPs.

EXCEPTIONS (Risk Acceptance):
Sometimes we can't patch — legacy system, vendor dependency, production 
freeze. The process:
1. Business owner documents why patching isn't possible
2. Security reviews and proposes compensating controls
3. If risk is accepted, it requires manager + CISO approval
4. Exception is time-limited (90 days max), then re-review

COMPENSATING CONTROLS we commonly apply:
• Network segmentation — isolate vulnerable system
• Enhanced monitoring — custom detection rule for exploitation attempts
• Application whitelisting — block unauthorized code execution
• WAF rules — virtual patching for web vulnerabilities

All exceptions are tracked in ServiceNow with expiration dates. 
The Function checks for expired exceptions and auto-reopens tickets."</code></pre>
        </div>

        <nav class="page-nav">
          <a href="live-response.html" class="page-nav-link prev"><span class="page-nav-label">Previous</span><span class="page-nav-title">← Live Response</span></a>
          <a href="deployment.html" class="page-nav-link next"><span class="page-nav-label">Next</span><span class="page-nav-title">MDE Deployment →</span></a>
        </nav>
      </div>
    </main>
  </div>
  <script src="../js/main.js"></script>
</body>
</html>
