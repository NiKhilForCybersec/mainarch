<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vulnerability Management — Automated Risk-Based Prioritization | EDR</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">
  <style>
    .flow-diagram { background: var(--bg-tertiary); padding: 1.5rem; border-radius: 8px; margin: 1rem 0; overflow-x: auto; }
    .enrichment-card { background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 8px; padding: 1.25rem; margin: 0.75rem 0; }
    .enrichment-card h4 { margin: 0 0 0.75rem 0; display: flex; align-items: center; gap: 0.5rem; }
    .source-badge { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
    .source-badge.qualys { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
    .source-badge.mde { background: rgba(59, 130, 246, 0.2); color: #93c5fd; }
    .source-badge.epss { background: rgba(249, 115, 22, 0.2); color: #fdba74; }
    .source-badge.kev { background: rgba(220, 38, 38, 0.2); color: #fca5a5; }
    .source-badge.cmdb { background: rgba(34, 197, 94, 0.2); color: #86efac; }
    .priority-badge { display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; }
    .priority-badge.critical { background: #991b1b; color: #fecaca; }
    .priority-badge.high { background: #c2410c; color: #fed7aa; }
    .priority-badge.medium { background: #a16207; color: #fef3c7; }
    .priority-badge.low { background: #166534; color: #dcfce7; }
    .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0; }
    .metric-card { background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 8px; padding: 1rem; text-align: center; }
    .metric-card .value { font-size: 2rem; font-weight: 700; color: #3b82f6; }
    .metric-card .label { font-size: 0.85rem; color: var(--text-secondary); }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="sidebar-logo-icon">RF</div>
          <div class="sidebar-logo-text">
            <span class="sidebar-logo-title">Security Transformation</span>
            <span class="sidebar-logo-subtitle">RevFlow Analytics</span>
          </div>
        </div>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Overview</div>
          <a href="../index.html" class="nav-item">Executive Summary</a>
          <a href="../company-profile.html" class="nav-item">Company Profile</a>
          <a href="../security-framework.html" class="nav-item">Security Framework</a>
          <a href="../program-structure.html" class="nav-item">Program Structure</a>
          <a href="../controls-mapping.html" class="nav-item">Controls Mapping</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">SIEM Migration</div>
          <a href="../siem/index.html" class="nav-item">SIEM Overview</a>
          <a href="../siem/discovery.html" class="nav-item">Discovery & Assessment</a>
          <a href="../siem/log-sources.html" class="nav-item">Log Source Strategy</a>
          <a href="../siem/log-engineering.html" class="nav-item">Log Engineering</a>
          <a href="../siem/parsing-deep-dive.html" class="nav-item">Parsing Deep Dive</a>
          <a href="../siem/threat-intelligence.html" class="nav-item">Threat Intelligence</a>
          <a href="../siem/detection-engineering.html" class="nav-item">Detection Engineering</a>
          <a href="../siem/detection-anatomy.html" class="nav-item">Detection Anatomy</a>
          <a href="../siem/detection-catalog.html" class="nav-item">Detection Catalog</a>
          <a href="../siem/soar-automation.html" class="nav-item">SOAR &amp; Automation</a>
          <a href="../siem/workbooks.html" class="nav-item">Workbooks &amp; Dashboards</a>
          <a href="../siem/cost-optimization.html" class="nav-item">Cost Optimization</a>
          <a href="../siem/casb-saas-security.html" class="nav-item">CASB &amp; SaaS Security</a>
          <a href="../siem/soc-transition.html" class="nav-item">SOC Transition</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">EDR Migration</div>
          <a href="../edr/index.html" class="nav-item">EDR Overview</a>
          <a href="../edr/xdr-detection-model.html" class="nav-item">XDR Detection Model</a>
          <a href="../edr/advanced-hunting.html" class="nav-item">Advanced Hunting</a>
          <a href="../edr/live-response.html" class="nav-item">Live Response</a>
          <a href="../edr/tvm.html" class="nav-item">Vulnerability Management</a>
          <a href="../edr/deployment.html" class="nav-item">MDE Deployment</a>
          <a href="../edr/asr-rules.html" class="nav-item">ASR Rules</a>
          <a href="../edr/device-control.html" class="nav-item">Device Control</a>
          <a href="../edr/coexistence.html" class="nav-item">Coexistence Strategy</a>
          <a href="../edr/eset-removal.html" class="nav-item">ESET Removal</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">DLP Migration</div>
          <a href="../dlp/index.html" class="nav-item">DLP Overview</a>
          <a href="../dlp/dlp-catalog.html" class="nav-item">DLP Catalog</a>
          <a href="../dlp/policy-translation.html" class="nav-item">Policy Translation</a>
          <a href="../dlp/rollout-phases.html" class="nav-item">Rollout Phases</a>
          <a href="../dlp/user-communication.html" class="nav-item">User Communication</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Identity & Access</div>
          <a href="../identity/index.html" class="nav-item">Identity Overview</a>
          <a href="../identity/hybrid-setup.html" class="nav-item">Hybrid Identity</a>
          <a href="../identity/conditional-access.html" class="nav-item">Conditional Access</a>
          <a href="../identity/pim.html" class="nav-item">PIM Configuration</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Infrastructure</div>
          <a href="../infrastructure/index.html" class="nav-item">Infrastructure Overview</a>
          <a href="../infrastructure/landing-zone.html" class="nav-item">Landing Zone</a>
          <a href="../infrastructure/network-architecture.html" class="nav-item">Network Architecture</a>
          <a href="../infrastructure/workload-migration.html" class="nav-item">Workload Migration</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Operations</div>
          <a href="../operations/parallel-ops.html" class="nav-item">Parallel Operations</a>
          <a href="../operations/soc-workflows.html" class="nav-item">SOC Workflows</a>
          <a href="../operations/integration.html" class="nav-item">Platform Integration</a>
          <a href="../operations/xdr-integration.html" class="nav-item">XDR Integration</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Resources</div>
          <a href="../resources/timeline.html" class="nav-item">Project Timeline</a>
          <a href="../resources/raci.html" class="nav-item">RACI Matrix</a>
          <a href="../resources/infrastructure-reference.html" class="nav-item">Infrastructure Reference</a>
          <a href="../resources/scripts.html" class="nav-item">Scripts & Queries</a>
          <a href="../resources/data-dictionary.html" class="nav-item">Data Dictionary</a>
          <a href="../resources/templates.html" class="nav-item">Templates</a>
          <a href="../resources/splunk-reference.html" class="nav-item">Splunk Reference</a>
          <a href="../resources/alternative-architectures.html" class="nav-item">Alternative Architectures</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Runbooks</div>
          <a href="../resources/mde-onboarding.html" class="nav-item">MDE Onboarding</a>
          <a href="../resources/mde-offboarding.html" class="nav-item">MDE Offboarding</a>
          <a href="../resources/incident-response.html" class="nav-item">Incident Response</a>
          <a href="../resources/operational-procedures.html" class="nav-item">Operational Procedures</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Troubleshooting</div>
          <a href="../troubleshooting/index.html" class="nav-item">Common Issues</a>
          <a href="../troubleshooting/siem-issues.html" class="nav-item">SIEM Issues</a>
          <a href="../troubleshooting/mde-issues.html" class="nav-item">MDE Issues</a>
          <a href="../troubleshooting/dlp-issues.html" class="nav-item">DLP Issues</a>
          <a href="../troubleshooting/agent-conflicts.html" class="nav-item">Agent Conflicts</a>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
          <div class="nav-section-title">Career</div>
          <a href="../career-narrative.html" class="nav-item">Career Narrative</a>
          <a href="../interview-prep.html" class="nav-item">Interview Prep (Full)</a>
          <a href="../interview-prep-v2.html" class="nav-item">Interview Prep v2</a>
        </div>
      </nav>
    </aside>

    <main class="main-content">
      <div class="content-wrapper">
        <nav class="breadcrumb">
          <a href="../index.html">Home</a>
          <span class="breadcrumb-separator">/</span>
          <a href="index.html">EDR Migration</a>
          <span class="breadcrumb-separator">/</span>
          <span class="breadcrumb-current">Vulnerability Management</span>
        </nav>

        <div class="page-header">
          <h1>Vulnerability Management — Automated Risk-Based Prioritization</h1>
          <div class="page-header-meta">
            <span class="page-badge edr">EDR Track</span>
            <span class="page-reading-time">MDVM & Custom Automation</span>
          </div>
          <p class="intro-text">This page documents our automated vulnerability management workflow. Both Microsoft Defender Vulnerability Management (MDVM, formerly TVM) and Qualys now provide EPSS scores, CISA KEV status, and exposure metrics natively. Our automation adds an <strong>additional layer</strong> — unifying data from both platforms, adding CMDB business context, and implementing custom risk prioritization beyond what either tool provides out of the box.</p>
        </div>

        <!-- ==================== WHAT TOOLS PROVIDE NATIVELY ==================== -->
        <h2>1. What MDVM & Qualys Already Provide (Native Capabilities)</h2>

        <div class="callout success">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Both Platforms Now Include Exploit Intelligence</div>
          <div class="callout-content">
            <p><strong>Modern vulnerability scanners have evolved.</strong> Both MDVM and Qualys now provide EPSS, CISA KEV, and exposure scoring natively — you don't need custom automation just for basic exploit intelligence. Our automation adds value <em>beyond</em> these native capabilities.</p>
          </div>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Capability</th><th>Microsoft MDVM</th><th>Qualys VMDR</th><th>Notes</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>CVSS Score</strong></td>
                <td>✅ Yes (v2, v3, v3.1)</td>
                <td>✅ Yes (v2, v3, v3.1)</td>
                <td>Standard severity rating</td>
              </tr>
              <tr>
                <td><strong>EPSS Score</strong></td>
                <td>✅ Yes (native)</td>
                <td>✅ Yes (TruRisk includes EPSS)</td>
                <td>Exploit prediction probability</td>
              </tr>
              <tr>
                <td><strong>CISA KEV Status</strong></td>
                <td>✅ Yes (native)</td>
                <td>✅ Yes (Real-Time Threat Indicators)</td>
                <td>Known exploited in the wild</td>
              </tr>
              <tr>
                <td><strong>Exposure Score</strong></td>
                <td>✅ Yes (0-100 per device + org-wide)</td>
                <td>✅ Yes (TruRisk factor)</td>
                <td>Attack surface context</td>
              </tr>
              <tr>
                <td><strong>Exploitability</strong></td>
                <td>✅ Yes (Verified/Likely/Unlikely)</td>
                <td>✅ Yes (Exploit Code Maturity)</td>
                <td>How likely to be exploited</td>
              </tr>
              <tr>
                <td><strong>Threat Actor Context</strong></td>
                <td>✅ Yes (linked to threat campaigns)</td>
                <td>✅ Yes (Active Threats feed)</td>
                <td>APT/ransomware associations</td>
              </tr>
              <tr>
                <td><strong>Patch Availability</strong></td>
                <td>✅ Yes</td>
                <td>✅ Yes</td>
                <td>Is a fix available?</td>
              </tr>
              <tr>
                <td><strong>Security Recommendations</strong></td>
                <td>✅ Yes (with remediation steps)</td>
                <td>✅ Yes (with solutions)</td>
                <td>Guidance for fixing</td>
              </tr>
            </tbody>
          </table>
        </div>

        <h3>1.1 Microsoft Defender Vulnerability Management (MDVM)</h3>

        <div class="enrichment-card">
          <h4><span class="source-badge mde">MDVM</span> Native Risk Prioritization Features</h4>
          <p><strong>MDVM (formerly TVM) now includes comprehensive threat intelligence:</strong></p>
          <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
            <li><strong>Exposure Score:</strong> 0-100 score reflecting organizational attack surface based on vulnerabilities, misconfigurations, and security controls</li>
            <li><strong>Device Exposure Level:</strong> Per-device risk scoring (Low/Medium/High)</li>
            <li><strong>EPSS Integration:</strong> Native display of exploit prediction scores</li>
            <li><strong>CISA KEV Tagging:</strong> Automatic flagging of known exploited vulnerabilities</li>
            <li><strong>Exploitability:</strong> Verified (exploit exists), Likely (conditions favorable), Unlikely</li>
            <li><strong>Threat Insights:</strong> Links CVEs to active threat campaigns and APT groups</li>
            <li><strong>Security Recommendations:</strong> Prioritized remediation guidance with impact assessment</li>
            <li><strong>Browser Extension Vulnerabilities:</strong> Detects vulnerable browser add-ons</li>
            <li><strong>Certificate Issues:</strong> Identifies expiring or weak certificates</li>
          </ul>
          <p style="margin-top: 0.75rem;"><strong>API endpoint:</strong> <code>https://api.securitycenter.microsoft.com/api/vulnerabilities</code></p>
          <p><strong>Key advantage:</strong> Correlates with MDE alerts — if a vulnerability is being actively exploited on a device, you see it immediately in the same console</p>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">MDVM API Response — Rich Native Data</span></div>
          <pre><code>// Example MDVM vulnerability response
{
    "id": "CVE-2024-21351",
    "name": "Windows SmartScreen Security Feature Bypass",
    "severity": "High",
    "cvssV3": 7.8,
    "epssScore": 0.45,           // ← Native EPSS
    "epssPercentile": 0.92,      // ← Top 8% most likely to be exploited
    "isKnownExploited": true,    // ← Native KEV flag
    "exploitabilityLevel": "ExploitIsVerified",
    "exposedMachines": 847,
    "organizationExposureLevel": "High",
    "publicExploit": true,
    "exploitTypes": ["Remote", "Local"],
    "exploitUris": ["https://github.com/..."],
    "threatInfo": {
        "associatedThreats": ["Ransomware", "APT29"],
        "lastSeenInWild": "2024-02-15"
    },
    "recommendedSecurityUpdate": "KB5034763",
    "patchReleaseDate": "2024-02-13"
}</code></pre>
        </div>

        <h3>1.2 Qualys VMDR (Vulnerability Management, Detection & Response)</h3>

        <div class="enrichment-card">
          <h4><span class="source-badge qualys">QUALYS</span> TruRisk & Real-Time Threat Indicators</h4>
          <p><strong>Qualys VMDR includes similar intelligence capabilities:</strong></p>
          <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
            <li><strong>TruRisk Score:</strong> Composite risk score factoring CVSS, exploit maturity, EPSS, and business context</li>
            <li><strong>Real-Time Threat Indicators (RTI):</strong> Active exploitation, weaponized, malware, wormable, denial of service flags</li>
            <li><strong>EPSS Integration:</strong> Exploit prediction scores displayed natively</li>
            <li><strong>CISA KEV Status:</strong> Automatic tagging of known exploited vulnerabilities</li>
            <li><strong>Exploit Code Maturity:</strong> Functional, POC, Unproven categories</li>
            <li><strong>Ransomware Association:</strong> Links to known ransomware families</li>
            <li><strong>Asset Criticality Tags:</strong> User-defined business criticality (though requires setup)</li>
          </ul>
          <p style="margin-top: 0.75rem;"><strong>API endpoint:</strong> <code>/api/2.0/fo/asset/host/vm/detection/</code></p>
        </div>

        <!-- ==================== SECTION 2: THE GAP ==================== -->
        <h2>2. The Gap: Why We Still Built Automation</h2>

        <div class="callout warning">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>What Native Tools DON'T Provide</div>
          <div class="callout-content">
            <p>Even with EPSS, KEV, and exposure scores built into both platforms, RevFlow still had operational challenges that required custom automation:</p>
          </div>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Challenge</th><th>What Native Tools Miss</th><th>Our Automation Solution</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Two Consoles</strong></td>
                <td>MDVM sees endpoints; Qualys sees network assets. Analysts switch between portals.</td>
                <td>Single Sentinel workbook with unified view</td>
              </tr>
              <tr>
                <td><strong>Duplicate Findings</strong></td>
                <td>Same CVE on same host appears in both tools with different scores</td>
                <td>Deduplication by CVE + hostname</td>
              </tr>
              <tr>
                <td><strong>CMDB Context</strong></td>
                <td>Native tools don't know Tier 1 vs Tier 3 or business owner</td>
                <td>ServiceNow CMDB enrichment</td>
              </tr>
              <tr>
                <td><strong>Custom Prioritization</strong></td>
                <td>Native scoring doesn't weight by RevFlow's specific risk appetite</td>
                <td>Custom risk score formula</td>
              </tr>
              <tr>
                <td><strong>Auto-Ticketing</strong></td>
                <td>Manual ticket creation for each finding</td>
                <td>Auto-create ServiceNow incidents for Critical/High</td>
              </tr>
              <tr>
                <td><strong>SLA Tracking</strong></td>
                <td>No unified view of remediation SLA compliance</td>
                <td>Custom tracking in Sentinel workbook</td>
              </tr>
              <tr>
                <td><strong>Historical Trending</strong></td>
                <td>Native dashboards show point-in-time, not trends</td>
                <td>Log Analytics retention enables trend analysis</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="callout info">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>Interview Talking Point</div>
          <div class="callout-content">
            <p><em>"MDVM and Qualys both provide EPSS and KEV data natively now — that's table stakes. Our automation adds value on top: unifying data from both scanners, enriching with CMDB business context, applying custom risk scoring aligned to our risk appetite, and auto-creating tickets. The native tools tell you WHAT's vulnerable; our automation tells you what to fix FIRST based on business impact."</em></p>
          </div>
        </div>

        <!-- ==================== SECTION 3: ARCHITECTURE ==================== -->
        <h2>3. Solution Architecture — Unified Dashboard + Custom Prioritization</h2>

        <p><strong>Key principle:</strong> We're not replacing native EPSS/KEV capabilities — we're building an aggregation and enrichment layer on top that unifies multiple scanners with business context.</p>

        <div class="flow-diagram">
          <pre><code>VULNERABILITY MANAGEMENT AUTOMATION — AGGREGATION & ENRICHMENT LAYER
════════════════════════════════════════════════════════════════════════════════

NATIVE CAPABILITIES (Already in Tools):
┌─────────────────────────────┐     ┌─────────────────────────────┐
│   QUALYS VMDR               │     │   MICROSOFT MDVM            │
│   ✓ CVSS, EPSS, KEV         │     │   ✓ CVSS, EPSS, KEV         │
│   ✓ TruRisk Score           │     │   ✓ Exposure Score          │
│   ✓ Exploit Maturity        │     │   ✓ Exploitability Level    │
│   ✓ Network/Agent Scanning  │     │   ✓ Threat Insights         │
└──────────────┬──────────────┘     └──────────────┬──────────────┘
               │                                    │
               │     OUR AUTOMATION ADDS:           │
               │                                    │
               └────────────────┬───────────────────┘
                                │
                    ┌───────────▼───────────┐
                    │   AZURE FUNCTION      │
                    │   (Daily Aggregation) │
                    └───────────┬───────────┘
                                │
         ┌──────────────────────┼──────────────────────┐
         │                      │                      │
         ▼                      ▼                      ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  DEDUPLICATION  │  │  CMDB ENRICHMENT│  │  CUSTOM SCORING │
│  CVE + Hostname │  │  Tier 1/2/3     │  │  RevFlow Risk   │
│  across tools   │  │  Business Owner │  │  Appetite       │
└─────────────────┘  │  Environment    │  │  Aligned        │
                     └─────────────────┘  └─────────────────┘
                                │
                    ┌───────────▼───────────┐
                    │   UNIFIED OUTPUTS     │
                    └───────────┬───────────┘
                                │
         ┌──────────────────────┼──────────────────────┐
         │                      │                      │
         ▼                      ▼                      ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  SENTINEL       │  │  SERVICENOW     │  │  EMAIL/TEAMS    │
│  Workbook       │  │  Auto-Tickets   │  │  Notifications  │
│  (Single View)  │  │  (Crit/High)    │  │  (Asset Owners) │
└─────────────────┘  └─────────────────┘  └─────────────────┘

VALUE PROPOSITION:
═══════════════════════════════════════════════════════════════════════════════
│ Native Tools Provide:          │ Our Automation Adds:                       │
│ • EPSS scores                  │ • Unified view across Qualys + MDVM        │
│ • CISA KEV status              │ • CMDB business context (Tier 1/2/3)       │
│ • Exposure scoring             │ • Custom risk formula for our environment  │
│ • Exploit intelligence         │ • Automatic ticket creation                │
│ • Per-tool dashboards          │ • Single Sentinel workbook                 │
│                                │ • Historical trending in Log Analytics     │
│                                │ • Owner notifications                      │
═══════════════════════════════════════════════════════════════════════════════</code></pre>
        </div>

        <h3>3.1 Deployment Options</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Option</th><th>How It Works</th><th>Best For</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Azure Function (Recommended)</strong></td>
                <td>Python code runs on timer trigger (daily), writes to Log Analytics custom table via Data Collector API</td>
                <td>Production, scalable, serverless</td>
              </tr>
              <tr>
                <td><strong>Azure Automation Runbook</strong></td>
                <td>PowerShell or Python in Azure Automation account with managed identity</td>
                <td>If already using Azure Automation</td>
              </tr>
              <tr>
                <td><strong>Logic Apps + Function</strong></td>
                <td>Logic Apps orchestrates workflow, calls Azure Function for complex processing</td>
                <td>Visual workflow, approval steps</td>
              </tr>
              <tr>
                <td><strong>On-prem VM + Task Scheduler</strong></td>
                <td>Python script runs on scheduled task, pushes to Sentinel via API</td>
                <td>Hybrid environments, air-gapped</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="callout info">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>Why Azure Functions?</div>
          <div class="callout-content">
            <p>Azure Functions is ideal because: serverless (no VM to manage), built-in timer triggers, managed identity for secure API access, automatic scaling, and native integration with Log Analytics.</p>
          </div>
        </div>

        <h3>3.2 Data Flow Summary</h3>

        <div class="flow-diagram">
          <pre><code>DATA FLOW — FROM SCANNERS TO UNIFIED DASHBOARD
════════════════════════════════════════════════════════════════════════════════

BEFORE (Manual):
┌──────────────────────┐     ┌──────────────────────┐
│  Qualys Portal       │     │  M365 Defender       │
│  (has EPSS, KEV)     │ ←→  │  (has EPSS, KEV)     │     ← 2 consoles
│  but no CMDB context │     │  but no CMDB context │
└──────────────────────┘     └──────────────────────┘

AFTER (Automated):
┌──────────────────────┐     ┌──────────────────────┐
│  Qualys API          │     │  MDVM API            │
│  • CVE, CVSS         │     │  • CVE, CVSS         │
│  • EPSS (native)     │     │  • EPSS (native)     │
│  • KEV (native)      │     │  • KEV (native)      │
│  • Exploitability    │     │  • Exposure Score    │
└──────────┬───────────┘     └──────────┬───────────┘
           │                            │
           └────────────┬───────────────┘
                        ▼
            ┌───────────────────────┐
            │   AZURE FUNCTION      │
            │   • Deduplicate       │
            │   • Add CMDB context  │  ← THIS IS THE VALUE-ADD
            │   • Custom scoring    │
            │   • Auto-ticketing    │
            └───────────┬───────────┘
                        │
         ┌──────────────┼──────────────┐
         ▼              ▼              ▼
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│  SENTINEL   │  │  SERVICENOW │  │  TEAMS      │
│  Workbook   │  │  Tickets    │  │  Alerts     │
│  (unified)  │  │  (Crit/High)│  │  (owners)   │
└─────────────┘  └─────────────┘  └─────────────┘</code></pre>
        </div>

        <!-- ==================== SECTION 4: ENRICHMENT SOURCES ==================== -->
        <h2>4. CMDB Enrichment (The Key Value-Add)</h2>

        <div class="callout success">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Business Context is What Native Tools Lack</div>
          <div class="callout-content">
            <p><strong>EPSS and KEV are built into MDVM and Qualys.</strong> What neither tool knows is which assets matter most to YOUR business. A CVSS 9.8 on a test VM doesn't matter as much as a CVSS 7.5 on a Tier 1 production server handling customer payments. CMDB provides that context.</p>
          </div>
        </div>

        <div class="enrichment-card">
          <h4><span class="source-badge cmdb">CMDB</span> Configuration Management Database (ServiceNow)</h4>
          <p><strong>What it provides:</strong> Asset context and business metadata that scanners don't have</p>
          <p><strong>Key data:</strong></p>
          <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
            <li><strong>Business Criticality:</strong> Tier 1 = mission-critical (revenue, customer data), Tier 2 = important (internal systems), Tier 3 = standard (workstations, test systems)</li>
            <li><strong>Environment:</strong> Production, Staging, Development, Test</li>
            <li><strong>Exposure:</strong> Internet-facing, DMZ, Internal-only</li>
            <li><strong>Owner:</strong> Department, support group, contact email</li>
            <li><strong>Data Classification:</strong> Confidential, Internal, Public</li>
            <li><strong>Compliance Scope:</strong> SOC 2, PCI, HIPAA, GDPR systems</li>
            <li><strong>EOL/EOS Status:</strong> End-of-life systems needing replacement</li>
          </ul>
          <p style="margin-top: 0.75rem;"><strong>Why it matters:</strong> A critical vulnerability on a Tier 1 internet-facing production server needs immediate attention. The same vulnerability on a Tier 3 internal test server can wait.</p>
        </div>

        <h3>4.1 Correlation Logic</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">CMDB Lookup & Correlation</span></div>
          <pre><code># CMDB enrichment function
def enrich_with_cmdb(vulnerabilities: list) -> list:
    """
    Enrich vulnerabilities with business context from ServiceNow CMDB
    Matches by hostname → FQDN → IP address
    """
    for vuln in vulnerabilities:
        # Try hostname first, then FQDN, then IP
        asset = None
        if vuln.get('hostname'):
            asset = cmdb_lookup(hostname=vuln['hostname'])
        if not asset and vuln.get('fqdn'):
            asset = cmdb_lookup(fqdn=vuln['fqdn'])
        if not asset and vuln.get('ip_address'):
            asset = cmdb_lookup(ip=vuln['ip_address'])
        
        if asset:
            vuln['asset_tier'] = asset.get('u_business_criticality', 'Tier 3')
            vuln['environment'] = asset.get('u_environment', 'Unknown')
            vuln['exposure'] = asset.get('u_network_zone', 'Internal')
            vuln['owner_email'] = asset.get('owned_by.email', '')
            vuln['support_group'] = asset.get('support_group.name', '')
            vuln['data_class'] = asset.get('u_data_classification', 'Internal')
            vuln['compliance_scope'] = asset.get('u_compliance_tags', [])
        else:
            # Unknown assets default to medium risk (investigate)
            vuln['asset_tier'] = 'Unknown'
            vuln['environment'] = 'Unknown'
            vuln['exposure'] = 'Unknown'
    
    return vulnerabilities</code></pre>
        </div>

        <h3>4.2 EPSS & KEV: Native but Passed Through</h3>

        <p>Our automation still references EPSS and KEV scores, but now we pull them from the native scanner responses rather than making separate API calls:</p>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Data</th><th>MDVM Source</th><th>Qualys Source</th><th>Fallback</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>EPSS Score</strong></td>
                <td><code>epssScore</code> field</td>
                <td>TruRisk EPSS component</td>
                <td>FIRST.org API (if missing)</td>
              </tr>
              <tr>
                <td><strong>KEV Status</strong></td>
                <td><code>isKnownExploited</code></td>
                <td>RTI "Active Exploitation" flag</td>
                <td>CISA KEV JSON (if missing)</td>
              </tr>
              <tr>
                <td><strong>Exploitability</strong></td>
                <td><code>exploitabilityLevel</code></td>
                <td>Exploit Code Maturity</td>
                <td>N/A</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="callout info">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>Why Keep EPSS/KEV API Fallback?</div>
          <div class="callout-content">
            <p>Some older Qualys scans may not include EPSS. Some assets may only be scanned by network-based Qualys (no agent) and lack MDVM data. The FIRST.org EPSS API and CISA KEV JSON provide a safety net for these edge cases.</p>
          </div>
        </div>

        <h3>4.3 Decision Framework: When to Build Custom Automation</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Scenario</th><th>Use Native Tools</th><th>Build Custom Automation</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Single scanner environment</strong></td>
                <td>✅ Native MDVM or Qualys dashboard</td>
                <td>❌ Not needed</td>
              </tr>
              <tr>
                <td><strong>Multi-scanner environment</strong></td>
                <td>❌ Console switching, duplicates</td>
                <td>✅ Unified view + deduplication</td>
              </tr>
              <tr>
                <td><strong>No CMDB / asset inventory</strong></td>
                <td>✅ Native exposure scores are enough</td>
                <td>❌ Can't enrich without data</td>
              </tr>
              <tr>
                <td><strong>Mature CMDB with business criticality</strong></td>
                <td>❌ Native tools don't know Tier 1/2/3</td>
                <td>✅ CMDB-aware prioritization</td>
              </tr>
              <tr>
                <td><strong>Manual ticketing acceptable</strong></td>
                <td>✅ Create tickets from portal</td>
                <td>❌ Overkill</td>
              </tr>
              <tr>
                <td><strong>High volume, auto-ticketing needed</strong></td>
                <td>❌ Too many manual clicks</td>
                <td>✅ Auto-create with SLA assignment</td>
              </tr>
              <tr>
                <td><strong>SOC uses Sentinel for everything</strong></td>
                <td>❌ Another console to monitor</td>
                <td>✅ Vuln data in same workbook as alerts</td>
              </tr>
              <tr>
                <td><strong>Compliance requires trend reporting</strong></td>
                <td>❌ Point-in-time views only</td>
                <td>✅ Log Analytics retention for historical</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="callout warning">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>Don't Over-Engineer</div>
          <div class="callout-content">
            <p><strong>If you only use MDVM</strong> and your asset inventory is basic, the native MDVM dashboard with its built-in EPSS, KEV, and exposure scoring is probably sufficient. Custom automation adds complexity that must be maintained.</p>
            <p style="margin-top: 0.5rem;"><strong>We built this because:</strong> RevFlow has both Qualys (network scanning) and MDVM (agent-based), a mature ServiceNow CMDB, SOC lives in Sentinel, and we need auto-ticketing for Critical/High at scale.</p>
          </div>
        </div>

        <!-- ==================== SECTION 5: RISK SCORING MODEL ==================== -->
        <h2>5. Custom Risk Scoring Model</h2>

        <p>We combine multiple scoring inputs — CVSS, tool-native scores (MDVM Exposure Score, Qualys TruRisk), and CMDB context — into a unified risk score:</p>

        <div class="callout info">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>Why Not Just Use CVSS?</div>
          <div class="callout-content">
            <p><strong>CVSS alone is insufficient.</strong> A CVSS 9.8 on a test VM matters less than a CVSS 7.0 on a Tier 1 payment server. We combine three layers:</p>
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
              <li><strong>CVSS:</strong> Technical severity (0-10)</li>
              <li><strong>Tool Scores:</strong> MDVM Exposure Score (0-100) or Qualys TruRisk — these already factor in EPSS, KEV, exploitability</li>
              <li><strong>CMDB Context:</strong> Business criticality, environment, network exposure</li>
            </ul>
          </div>
        </div>

        <h3>5.1 Input Scores from Each Tool</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Score</th><th>Source</th><th>Range</th><th>What It Includes</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>CVSS</strong></td>
                <td>Both tools</td>
                <td>0-10</td>
                <td>Technical severity only (attack vector, complexity, impact)</td>
              </tr>
              <tr>
                <td><strong>MDVM Exposure Score</strong></td>
                <td>Microsoft MDVM</td>
                <td>0-100</td>
                <td>CVSS + EPSS + KEV + exploitability + device exposure + threat insights</td>
              </tr>
              <tr>
                <td><strong>Qualys TruRisk</strong></td>
                <td>Qualys VMDR</td>
                <td>0-1000</td>
                <td>CVSS + EPSS + exploit maturity + RTI (ransomware, active exploitation) + asset criticality tags</td>
              </tr>
              <tr>
                <td><strong>EPSS</strong></td>
                <td>Both (native)</td>
                <td>0.0-1.0</td>
                <td>Probability of exploitation in 30 days</td>
              </tr>
              <tr>
                <td><strong>KEV Status</strong></td>
                <td>Both (native)</td>
                <td>Yes/No</td>
                <td>Confirmed active exploitation in the wild</td>
              </tr>
            </tbody>
          </table>
        </div>

        <h3>5.2 Unified Risk Score Formula</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">RevFlow Unified Risk Score Calculation</span></div>
          <pre><code># RevFlow Risk Score Formula — Combining CVSS + Tool Scores + CMDB Context
# ═══════════════════════════════════════════════════════════════════════════════

def calculate_risk_score(vuln: dict) -> float:
    """
    Combines:
    - CVSS (technical severity)
    - Tool-native score (MDVM Exposure or Qualys TruRisk)
    - CMDB business context
    """
    
    # ─────────────────────────────────────────────────────────────────────────
    # STEP 1: Get base technical score (CVSS)
    # ─────────────────────────────────────────────────────────────────────────
    cvss = vuln.get('cvss_v3', vuln.get('cvss_v2', 5.0))  # 0-10
    
    # ─────────────────────────────────────────────────────────────────────────
    # STEP 2: Get tool-native score (already includes EPSS, KEV, exploitability)
    # ─────────────────────────────────────────────────────────────────────────
    if vuln.get('source') == 'MDVM':
        # MDVM Exposure Score: 0-100, normalize to 0-10
        tool_score = vuln.get('mdvm_exposure_score', 50) / 10
    elif vuln.get('source') == 'Qualys':
        # Qualys TruRisk: 0-1000, normalize to 0-10
        tool_score = vuln.get('qualys_trurisk', 500) / 100
    else:
        # Fallback: calculate from EPSS + KEV
        tool_score = calculate_epss_kev_score(vuln)
    
    # ─────────────────────────────────────────────────────────────────────────
    # STEP 3: Blend CVSS + Tool Score (weighted average)
    # ─────────────────────────────────────────────────────────────────────────
    # Tool score carries more weight because it includes threat intel
    TECHNICAL_SCORE = (cvss * 0.4) + (tool_score * 0.6)  # 0-10
    
    # ─────────────────────────────────────────────────────────────────────────
    # STEP 4: Apply CMDB multipliers (what tools DON'T know)
    # ─────────────────────────────────────────────────────────────────────────
    
    # Asset criticality from CMDB
    tier = vuln.get('asset_tier', 'Tier 3')
    ASSET_MULTIPLIER = {'Tier 1': 2.0, 'Tier 2': 1.5, 'Tier 3': 1.0}.get(tier, 1.0)
    
    # Network exposure from CMDB
    exposure = vuln.get('network_exposure', 'Internal')
    EXPOSURE_MULTIPLIER = {
        'Internet-facing': 2.0,
        'DMZ': 1.5,
        'Internal': 1.0
    }.get(exposure, 1.0)
    
    # Environment from CMDB
    env = vuln.get('environment', 'Development')
    ENV_MULTIPLIER = {
        'Production': 1.5,
        'Staging': 1.2,
        'Development': 1.0,
        'Test': 0.8
    }.get(env, 1.0)
    
    # Compliance scope boost
    compliance = vuln.get('compliance_scope', [])
    COMPLIANCE_MULTIPLIER = 1.3 if ('PCI' in compliance or 'SOC2' in compliance) else 1.0
    
    # ─────────────────────────────────────────────────────────────────────────
    # STEP 5: Calculate final score
    # ─────────────────────────────────────────────────────────────────────────
    RISK_SCORE = (TECHNICAL_SCORE 
                  * ASSET_MULTIPLIER 
                  * EXPOSURE_MULTIPLIER 
                  * ENV_MULTIPLIER 
                  * COMPLIANCE_MULTIPLIER)
    
    return round(RISK_SCORE, 1)


def calculate_epss_kev_score(vuln: dict) -> float:
    """Fallback if tool score is missing"""
    base = vuln.get('cvss_v3', 5.0)
    epss = vuln.get('epss', 0.0)
    kev = vuln.get('is_kev', False)
    
    if kev:
        return min(base * 2.0, 10.0)
    elif epss > 0.7:
        return min(base * 1.8, 10.0)
    elif epss > 0.4:
        return min(base * 1.5, 10.0)
    elif epss > 0.1:
        return min(base * 1.2, 10.0)
    return base


def assign_priority(risk_score: float, is_kev: bool) -> str:
    """Assign priority based on risk score"""
    if risk_score >= 50 or is_kev:
        return "CRITICAL"    # Remediate within 24-48 hours
    elif risk_score >= 30:
        return "HIGH"        # Remediate within 7 days
    elif risk_score >= 15:
        return "MEDIUM"      # Remediate within 30 days
    else:
        return "LOW"         # Remediate within 90 days or accept risk</code></pre>
        </div>

        <h3>5.3 Risk Score Examples (With Tool Scores)</h3>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>CVE</th>
                <th>CVSS</th>
                <th>MDVM Exp.</th>
                <th>Qualys TruRisk</th>
                <th>EPSS</th>
                <th>KEV</th>
                <th>Tier</th>
                <th>Exposure</th>
                <th>Env</th>
                <th>Risk Score</th>
                <th>Priority</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><code>CVE-2023-23397</code></td>
                <td>9.8</td>
                <td>95</td>
                <td>920</td>
                <td>0.97</td>
                <td>✅</td>
                <td>Tier 1</td>
                <td>Internet</td>
                <td>Prod</td>
                <td><strong>85.5</strong></td>
                <td><span class="priority-badge critical">CRITICAL</span></td>
              </tr>
              <tr>
                <td><code>CVE-2024-21351</code></td>
                <td>7.8</td>
                <td>72</td>
                <td>650</td>
                <td>0.45</td>
                <td>✅</td>
                <td>Tier 2</td>
                <td>Internet</td>
                <td>Prod</td>
                <td><strong>58.3</strong></td>
                <td><span class="priority-badge critical">CRITICAL</span></td>
              </tr>
              <tr>
                <td><code>CVE-2024-38063</code></td>
                <td>9.8</td>
                <td>85</td>
                <td>780</td>
                <td>0.82</td>
                <td>❌</td>
                <td>Tier 1</td>
                <td>DMZ</td>
                <td>Prod</td>
                <td><strong>51.2</strong></td>
                <td><span class="priority-badge critical">CRITICAL</span></td>
              </tr>
              <tr>
                <td><code>CVE-2024-12345</code></td>
                <td>7.5</td>
                <td>45</td>
                <td>380</td>
                <td>0.08</td>
                <td>❌</td>
                <td>Tier 1</td>
                <td>Internal</td>
                <td>Prod</td>
                <td><strong>18.9</strong></td>
                <td><span class="priority-badge medium">MEDIUM</span></td>
              </tr>
              <tr>
                <td><code>CVE-2024-99999</code></td>
                <td>9.0</td>
                <td>55</td>
                <td>420</td>
                <td>0.02</td>
                <td>❌</td>
                <td>Tier 3</td>
                <td>Internal</td>
                <td>Dev</td>
                <td><strong>5.2</strong></td>
                <td><span class="priority-badge low">LOW</span></td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="callout warning">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>Key Insight</div>
          <div class="callout-content">
            <p><strong>Notice CVE-2024-99999:</strong> CVSS 9.0 (Critical by CVSS alone) but our Risk Score is only 5.2 (LOW priority). Why? It's on a Tier 3 internal development box with low EPSS (0.02) and no KEV. The business context matters.</p>
          </div>
        </div>

        <!-- ==================== OUTPUT TABLE: WHAT SOC SEES ==================== -->
        <h3>5.4 Output Table: What SOC Analysts See</h3>

        <p>After aggregation, enrichment, and scoring, this is the actual data that lands in the Sentinel workbook and ServiceNow tickets:</p>

        <div class="flow-diagram">
          <pre><code>UNIFIED VULNERABILITY INVENTORY — SOC WORKQUEUE VIEW
════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════

┌────────────────┬───────────┬────────────────────────────────────┬───────┬────────┬───────┬──────────┬────────────┬─────────┬───────────────┬───────────┬────────────────────────────┐
│ CVE            │ PRIORITY  │ AFFECTED HOST                      │ CVSS  │ MDVM   │ EPSS  │ KEV      │ ASSET TIER │ NETWORK │ ENVIRONMENT   │ RISK      │ OWNER                      │
│                │           │                                    │       │ SCORE  │       │          │            │         │               │ SCORE     │                            │
├────────────────┼───────────┼────────────────────────────────────┼───────┼────────┼───────┼──────────┼────────────┼─────────┼───────────────┼───────────┼────────────────────────────┤
│ CVE-2023-23397 │ CRITICAL  │ PROD-EXCH-01.revflow.local         │ 9.8   │ 95     │ 0.97  │ ✅ Yes   │ Tier 1     │ Internet│ Production    │ 85.5      │ messaging-team@revflow.com │
│ CVE-2024-21351 │ CRITICAL  │ PROD-WEB-03.revflow.local          │ 7.8   │ 72     │ 0.45  │ ✅ Yes   │ Tier 2     │ Internet│ Production    │ 58.3      │ webops@revflow.com         │
│ CVE-2024-38063 │ CRITICAL  │ PROD-DC-02.revflow.local           │ 9.8   │ 85     │ 0.82  │ ❌ No    │ Tier 1     │ DMZ     │ Production    │ 51.2      │ infra-team@revflow.com     │
│ CVE-2024-30088 │ HIGH      │ PROD-APP-07.revflow.local          │ 7.0   │ 62     │ 0.35  │ ❌ No    │ Tier 1     │ Internal│ Production    │ 38.4      │ app-team@revflow.com       │
│ CVE-2024-12345 │ MEDIUM    │ PROD-DB-01.revflow.local           │ 7.5   │ 45     │ 0.08  │ ❌ No    │ Tier 1     │ Internal│ Production    │ 18.9      │ dba-team@revflow.com       │
│ CVE-2024-55555 │ MEDIUM    │ STG-APP-02.revflow.local           │ 8.1   │ 58     │ 0.12  │ ❌ No    │ Tier 2     │ Internal│ Staging       │ 16.2      │ app-team@revflow.com       │
│ CVE-2024-99999 │ LOW       │ DEV-TEST-15.revflow.local          │ 9.0   │ 55     │ 0.02  │ ❌ No    │ Tier 3     │ Internal│ Development   │ 5.2       │ dev-team@revflow.com       │
└────────────────┴───────────┴────────────────────────────────────┴───────┴────────┴───────┴──────────┴────────────┴─────────┴───────────────┴───────────┴────────────────────────────┘

ADDITIONAL FIELDS AVAILABLE (expandable in workbook):
• Software: Affected application/component name and version
• Patch KB: Microsoft KB number or vendor patch identifier
• First Seen: Date vulnerability was first detected
• Days Open: How long remediation has been pending
• SLA Status: On Track / At Risk / Breached
• ServiceNow Ticket: INC0012345 (auto-linked)
• Qualys QID: If detected by Qualys
• Recommendation: Remediation guidance from MDVM/Qualys
</code></pre>
        </div>

        <h3>5.5 Sample ServiceNow Ticket (Auto-Created)</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">ServiceNow Incident — Auto-Generated for Critical/High</span></div>
          <pre><code>═══════════════════════════════════════════════════════════════════════════════
INCIDENT: INC0012847
═══════════════════════════════════════════════════════════════════════════════

SHORT DESCRIPTION:
[CRITICAL] CVE-2023-23397 on PROD-EXCH-01 — Remediate within 48 hours

PRIORITY: 1 - Critical
CATEGORY: Vulnerability Management
ASSIGNMENT GROUP: Messaging Team
ASSIGNED TO: (Auto-routed based on CMDB owner)

DESCRIPTION:
────────────────────────────────────────────────────────────────────────────────
A CRITICAL vulnerability has been detected requiring immediate remediation.

VULNERABILITY DETAILS:
• CVE: CVE-2023-23397
• Title: Microsoft Outlook Elevation of Privilege Vulnerability
• CVSS Score: 9.8 (Critical)
• MDVM Exposure Score: 95/100
• EPSS: 0.97 (97% likelihood of exploitation within 30 days)
• CISA KEV: ✅ YES — Actively exploited in the wild

AFFECTED ASSET:
• Hostname: PROD-EXCH-01.revflow.local
• IP Address: 10.50.1.25
• Operating System: Windows Server 2019
• Asset Tier: Tier 1 (Mission-Critical)
• Environment: Production
• Network Zone: Internet-facing
• Business Function: Corporate email server

RISK ASSESSMENT:
• RevFlow Risk Score: 85.5
• SLA: 48 hours (Critical)
• SLA Deadline: 2024-12-24 14:00 UTC

REMEDIATION:
• Recommended Action: Apply KB5034763 (February 2024 Cumulative Update)
• Patch Release Date: 2024-02-13
• Workaround: Disable NTLM or block outbound SMB (445/TCP) if patching delayed

INTELLIGENCE:
• Threat Actors: APT28 (Fancy Bear) actively exploiting this vulnerability
• Malware Families: Associated with credential theft campaigns
• Attack Vector: Specially crafted email triggers NTLM relay without user interaction

LINKS:
• Microsoft Advisory: https://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-23397
• CISA KEV Entry: https://www.cisa.gov/known-exploited-vulnerabilities-catalog

────────────────────────────────────────────────────────────────────────────────
AUTO-GENERATED BY: Vulnerability Enrichment Pipeline
SOURCE: MDVM + Qualys (deduplicated)
CREATED: 2024-12-22 06:45 UTC
═══════════════════════════════════════════════════════════════════════════════</code></pre>
        </div>

        <!-- ==================== MANUAL SOC WORKFLOWS ==================== -->
        <h3>5.6 Manual SOC Workflows: False Positives, Remediation & Exceptions</h3>

        <p>Automation handles aggregation and prioritization, but <strong>humans are essential</strong> for validation, remediation decisions, and exceptions. Here's what SOC analysts and asset owners work on manually:</p>

        <div class="callout info">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>Automation vs. Human Work</div>
          <div class="callout-content">
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
              <li><strong>Automation does:</strong> Aggregate, deduplicate, enrich, score, create tickets, track SLAs</li>
              <li><strong>Humans do:</strong> Validate FPs, decide remediation path, apply patches, approve exceptions, verify fixes</li>
            </ul>
          </div>
        </div>

        <h4>Workflow 1: False Positive Handling</h4>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">False Positive Workflow — SOC Analyst</span></div>
          <pre><code>FALSE POSITIVE SCENARIO:
═══════════════════════════════════════════════════════════════════════════════
Scanner detected: CVE-2024-12345 on PROD-APP-03
Reality: Patch KB5034123 was applied last week, but scanner hasn't re-scanned

SOC ANALYST ACTIONS:
────────────────────────────────────────────────────────────────────────────────

1. VERIFY THE FALSE POSITIVE
   • Check patch history in SCCM/Intune: Was KB5034123 deployed?
   • Check installed updates on host: Get-HotFix | Where-Object {$_.HotFixID -eq "KB5034123"}
   • Check MDVM "Security Recommendations" — does it still show as vulnerable?
   • If patched but still showing: Scanner lag or detection logic issue

2. DOCUMENT IN SERVICENOW TICKET
   ┌───────────────────────────────────────────────────────────────────────────┐
   │ INC0012850 — CVE-2024-12345 on PROD-APP-03                                │
   ├───────────────────────────────────────────────────────────────────────────┤
   │ Resolution Code: False Positive                                          │
   │ Resolution Notes:                                                         │
   │   Verified KB5034123 installed on 2024-12-18.                            │
   │   MDVM shows vulnerability due to scan lag.                              │
   │   Requested rescan via MDVM portal.                                      │
   │   Evidence: Screenshot of Get-HotFix output attached.                    │
   └───────────────────────────────────────────────────────────────────────────┘

3. UPDATE EXCLUSION LIST (if recurring FP)
   • If same FP appears repeatedly, add to automation exclusion list
   • Exclusion format: CVE + Hostname + Justification + Expiry date
   • Exclusions reviewed quarterly

4. REQUEST RESCAN
   • MDVM: Device page → "Run antivirus scan" or wait for next scheduled scan
   • Qualys: Request on-demand scan from Qualys admin

FEEDBACK LOOP TO AUTOMATION:
────────────────────────────────────────────────────────────────────────────────
FP data is added to exclusion table in Azure Function:
┌──────────────────┬─────────────────────────┬──────────────────┬────────────┐
│ CVE              │ Hostname                │ Reason           │ Expiry     │
├──────────────────┼─────────────────────────┼──────────────────┼────────────┤
│ CVE-2024-12345   │ PROD-APP-03             │ Scan lag after   │ 2025-01-15 │
│                  │                         │ KB5034123        │            │
└──────────────────┴─────────────────────────┴──────────────────┴────────────┘

Next pipeline run will skip this CVE+Host combination until expiry.</code></pre>
        </div>

        <h4>Workflow 2: Remediation & Patch Management</h4>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Remediation Workflow — Asset Owner + Patch Team</span></div>
          <pre><code>REMEDIATION SCENARIO:
═══════════════════════════════════════════════════════════════════════════════
Ticket: INC0012847 — CVE-2023-23397 on PROD-EXCH-01
Priority: CRITICAL (48-hour SLA)
Assigned To: Messaging Team

REMEDIATION STEPS:
────────────────────────────────────────────────────────────────────────────────

1. TRIAGE (Asset Owner — within 2 hours of ticket creation)
   • Review ticket details: Is this server still in use? Correct owner?
   • Check CMDB: Confirm asset tier, maintenance window, dependencies
   • Acknowledge ticket: "Investigating" status

2. PLAN REMEDIATION
   ┌───────────────────────────────────────────────────────────────────────────┐
   │ REMEDIATION OPTIONS:                                                      │
   ├───────────────────────────────────────────────────────────────────────────┤
   │ A. Apply Patch (preferred)                                                │
   │    • KB5034763 (February 2024 Cumulative Update)                         │
   │    • Requires reboot — schedule during maintenance window                │
   │    • ETA: Tonight at 2 AM EST                                            │
   │                                                                           │
   │ B. Workaround (if patch delayed)                                         │
   │    • Disable NTLM authentication (may break legacy apps)                 │
   │    • Block outbound SMB (445/TCP) at firewall                            │
   │    • Apply immediately, patch within 7 days                              │
   │                                                                           │
   │ C. Compensating Controls (if cannot patch)                               │
   │    • Enhanced monitoring: Custom Sentinel rule for exploitation attempt  │
   │    • Network segmentation: Move to isolated VLAN                         │
   │    • Document risk acceptance if choosing this path                      │
   └───────────────────────────────────────────────────────────────────────────┘

3. EXECUTE PATCH (Patch Team)
   • Deploy KB5034763 via SCCM/Intune
   • Monitor deployment status
   • Verify successful installation: Get-HotFix -Id KB5034763
   • Reboot server if required
   • Validate Exchange services healthy post-reboot

4. VERIFY REMEDIATION
   • MDVM: Check device page — vulnerability should clear after next scan
   • Qualys: Request on-demand scan, confirm CVE no longer detected
   • Update ServiceNow ticket: "Resolved — Patch Applied"

5. CLOSE TICKET
   ┌───────────────────────────────────────────────────────────────────────────┐
   │ INC0012847 — RESOLVED                                                     │
   ├───────────────────────────────────────────────────────────────────────────┤
   │ Resolution Code: Patch Applied                                            │
   │ Resolution Notes:                                                         │
   │   KB5034763 deployed 2024-12-23 02:15 EST.                               │
   │   Server rebooted, Exchange services verified healthy.                   │
   │   MDVM rescan requested, vulnerability cleared.                          │
   │   SLA: Met (within 48 hours)                                             │
   └───────────────────────────────────────────────────────────────────────────┘

PATCH MANAGEMENT INTEGRATION:
────────────────────────────────────────────────────────────────────────────────
Our automation integrates with SCCM/Intune:
• Ticket includes KB number from MDVM/Qualys recommendation
• Patch team can filter SCCM by KB to find applicable deployment
• Post-patch, automation checks for ticket closure when CVE clears</code></pre>
        </div>

        <h4>Workflow 3: Risk Acceptance / Exception Handling</h4>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Exception Workflow — When Patching Is Not Possible</span></div>
          <pre><code>EXCEPTION SCENARIO:
═══════════════════════════════════════════════════════════════════════════════
Ticket: INC0012855 — CVE-2024-30088 on PROD-LEGACY-01
Problem: Legacy application requires Windows Server 2012 R2, vendor no longer 
         supports newer OS. Patch not available for this OS version.

EXCEPTION REQUEST PROCESS:
────────────────────────────────────────────────────────────────────────────────

1. ASSET OWNER INITIATES EXCEPTION REQUEST
   • Cannot patch — document why
   • Propose compensating controls
   • Submit via ServiceNow exception workflow

2. EXCEPTION REQUEST FORM
   ┌───────────────────────────────────────────────────────────────────────────┐
   │ VULNERABILITY EXCEPTION REQUEST                                           │
   ├───────────────────────────────────────────────────────────────────────────┤
   │ CVE: CVE-2024-30088                                                       │
   │ Host: PROD-LEGACY-01                                                      │
   │ Asset Owner: John Smith (Operations Manager)                              │
   │                                                                           │
   │ REASON PATCHING IS NOT POSSIBLE:                                          │
   │ Legacy inventory management application (VendorApp v3.2) only runs on    │
   │ Windows Server 2012 R2. Vendor went out of business in 2019. Application │
   │ replacement project scheduled for Q3 2025 (Project ID: PRJ-2024-087).    │
   │                                                                           │
   │ PROPOSED COMPENSATING CONTROLS:                                           │
   │ [✓] Network segmentation — isolated VLAN 192.168.50.0/24                 │
   │ [✓] Host-based firewall — only allows traffic from 3 specific IPs       │
   │ [✓] Enhanced monitoring — Sentinel rule for exploitation patterns        │
   │ [✓] No internet access — internal only                                   │
   │ [✓] Privileged access restricted — only 2 service accounts               │
   │                                                                           │
   │ BUSINESS IMPACT IF SYSTEM OFFLINE:                                        │
   │ Warehouse operations halt. ~$50K/day revenue impact.                     │
   │                                                                           │
   │ REQUESTED EXCEPTION DURATION: 180 days (until replacement project)       │
   │ NEXT REVIEW DATE: 2025-03-22                                             │
   └───────────────────────────────────────────────────────────────────────────┘

3. SECURITY REVIEW
   • Security team reviews compensating controls
   • Validates controls are actually in place (not just proposed)
   • May request additional controls
   • Documents residual risk

4. APPROVAL CHAIN
   ┌─────────────────┬───────────────────┬────────────────┬───────────────────┐
   │ Role            │ Approver          │ Status         │ Date              │
   ├─────────────────┼───────────────────┼────────────────┼───────────────────┤
   │ Asset Owner     │ John Smith        │ ✅ Approved    │ 2024-12-22        │
   │ Security Team   │ Jane Doe (SecOps) │ ✅ Approved    │ 2024-12-22        │
   │ IT Manager      │ Bob Wilson        │ ✅ Approved    │ 2024-12-23        │
   │ CISO            │ Sarah Johnson     │ ✅ Approved    │ 2024-12-23        │
   └─────────────────┴───────────────────┴────────────────┴───────────────────┘

5. EXCEPTION DOCUMENTED
   • Exception logged in risk register
   • Ticket updated: "Exception Approved — Review by 2025-03-22"
   • Automation marks CVE+Host as "Accepted Risk" (won't auto-ticket)
   • Calendar reminder for review date

EXCEPTION TRACKING IN AUTOMATION:
────────────────────────────────────────────────────────────────────────────────
Exceptions table in Azure Function:
┌──────────────────┬─────────────────────┬─────────────┬────────────┬──────────┐
│ CVE              │ Hostname            │ Approved By │ Expiry     │ Status   │
├──────────────────┼─────────────────────┼─────────────┼────────────┼──────────┤
│ CVE-2024-30088   │ PROD-LEGACY-01      │ S. Johnson  │ 2025-06-22 │ Active   │
│ CVE-2023-44487   │ PROD-PROXY-02       │ S. Johnson  │ 2025-01-15 │ Active   │
│ CVE-2024-21413   │ PROD-APP-05         │ S. Johnson  │ 2024-12-01 │ Expired  │
└──────────────────┴─────────────────────┴─────────────┴────────────┴──────────┘

Expired exceptions auto-reopen tickets for re-review.</code></pre>
        </div>

        <div class="callout success">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Interview Talking Point</div>
          <div class="callout-content">
            <p><em>"Automation handles aggregation, scoring, and ticket creation — but humans are essential. SOC analysts validate false positives and feed that back to the exclusion list. Asset owners plan and execute remediation with the patch team. For exceptions, we have a formal approval chain: asset owner, security team, IT manager, CISO. Every exception has an expiration date, and automation auto-reopens tickets when exceptions expire."</em></p>
          </div>
        </div>

        <!-- ==================== SECTION 6: IMPLEMENTATION ==================== -->
        <h2>6. Implementation — Azure Function Deployment</h2>

        <h3>6.1 Azure Function Structure</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Azure Function Project Structure</span></div>
          <pre><code>vuln-enrichment-function/
├── function_app.py              # Main function code
├── requirements.txt             # Python dependencies
├── host.json                    # Function host configuration
├── local.settings.json          # Local dev settings (not deployed)
└── modules/
    ├── qualys_client.py         # Qualys API wrapper
    ├── mde_client.py            # MDE TVM API wrapper
    ├── enrichment.py            # EPSS, KEV, CMDB enrichment
    ├── scoring.py               # Risk score calculation
    └── outputs.py               # Log Analytics, ServiceNow writers</code></pre>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">function_app.py — Main Azure Function</span><button class="code-copy-btn">Copy</button></div>
          <pre><code>import azure.functions as func
import logging
from datetime import datetime
from modules.qualys_client import get_qualys_vulnerabilities
from modules.mde_client import get_mde_vulnerabilities
from modules.enrichment import enrich_with_epss, enrich_with_kev, enrich_with_cmdb
from modules.scoring import prioritize_vulnerabilities
from modules.outputs import write_to_log_analytics, create_servicenow_tickets

app = func.FunctionApp()

# Timer trigger: runs daily at 6 AM UTC
@app.timer_trigger(schedule="0 0 6 * * *", arg_name="timer", run_on_startup=False)
def vuln_enrichment_pipeline(timer: func.TimerRequest) -> None:
    """
    Main vulnerability enrichment pipeline
    Runs daily to aggregate, enrich, and prioritize vulnerabilities
    """
    logging.info(f"Vulnerability enrichment started at {datetime.utcnow()}")
    
    try:
        # ═══════════════════════════════════════════════════════════════════
        # STEP 1: Aggregate vulnerabilities from all sources
        # ═══════════════════════════════════════════════════════════════════
        logging.info("Step 1: Fetching vulnerabilities from Qualys...")
        qualys_vulns = get_qualys_vulnerabilities()
        logging.info(f"  Found {len(qualys_vulns)} Qualys vulnerabilities")
        
        logging.info("Step 1: Fetching vulnerabilities from MDE TVM...")
        mde_vulns = get_mde_vulnerabilities()
        logging.info(f"  Found {len(mde_vulns)} MDE vulnerabilities")
        
        # Combine and deduplicate
        all_vulns = deduplicate_vulnerabilities(qualys_vulns + mde_vulns)
        logging.info(f"  Combined: {len(all_vulns)} unique vulnerabilities")
        
        # ═══════════════════════════════════════════════════════════════════
        # STEP 2-4: Enrich with external data
        # ═══════════════════════════════════════════════════════════════════
        logging.info("Step 2: Enriching with EPSS scores...")
        all_vulns = enrich_with_epss(all_vulns)
        
        logging.info("Step 3: Enriching with CISA KEV...")
        all_vulns = enrich_with_kev(all_vulns)
        
        logging.info("Step 4: Enriching with CMDB asset context...")
        all_vulns = enrich_with_cmdb(all_vulns)
        
        # ═══════════════════════════════════════════════════════════════════
        # STEP 5: Calculate risk scores and prioritize
        # ═══════════════════════════════════════════════════════════════════
        logging.info("Step 5: Calculating risk scores...")
        all_vulns = prioritize_vulnerabilities(all_vulns)
        
        critical_count = len([v for v in all_vulns if v["priority"] == "CRITICAL"])
        high_count = len([v for v in all_vulns if v["priority"] == "HIGH"])
        logging.info(f"  Priority breakdown: {critical_count} Critical, {high_count} High")
        
        # ═══════════════════════════════════════════════════════════════════
        # STEP 6: Output to destinations
        # ═══════════════════════════════════════════════════════════════════
        logging.info("Step 6: Writing to Log Analytics...")
        write_to_log_analytics(all_vulns, table_name="VulnerabilityInventory_CL")
        
        logging.info("Step 6: Creating ServiceNow tickets for Critical/High...")
        tickets_created = create_servicenow_tickets(
            [v for v in all_vulns if v["priority"] in ["CRITICAL", "HIGH"]]
        )
        logging.info(f"  Created {tickets_created} ServiceNow tickets")
        
        logging.info(f"Pipeline completed successfully at {datetime.utcnow()}")
        
    except Exception as e:
        logging.error(f"Pipeline failed: {str(e)}")
        raise

def deduplicate_vulnerabilities(vulns):
    """Deduplicate by CVE + hostname, merge source info"""
    seen = {}
    for vuln in vulns:
        key = (vuln.get("cve_id"), vuln.get("hostname"))
        if key not in seen:
            seen[key] = vuln
        else:
            # Merge sources
            existing_sources = seen[key].get("sources", [seen[key].get("source")])
            existing_sources.append(vuln.get("source"))
            seen[key]["sources"] = list(set(existing_sources))
    return list(seen.values())</code></pre>
        </div>

        <h3>5.2 Writing to Log Analytics (Custom Table)</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Python — Log Analytics Data Collector API</span><button class="code-copy-btn">Copy</button></div>
          <pre><code>import requests
import json
import hashlib
import hmac
import base64
from datetime import datetime
import os

def write_to_log_analytics(vulnerabilities, table_name="VulnerabilityInventory_CL"):
    """
    Write enriched vulnerability data to Log Analytics custom table
    Uses the Data Collector API (legacy) or DCR-based ingestion
    """
    
    workspace_id = os.environ["LOG_ANALYTICS_WORKSPACE_ID"]
    shared_key = os.environ["LOG_ANALYTICS_SHARED_KEY"]
    
    # Prepare the data
    body = json.dumps([{
        "TimeGenerated": datetime.utcnow().isoformat() + "Z",
        "CVE": v.get("cve_id"),
        "Hostname": v.get("hostname"),
        "IPAddress": v.get("ip_address"),
        "CVSSScore": v.get("cvss_score"),
        "EPSSScore": v.get("epss_score"),
        "EPSSPercentile": v.get("epss_percentile"),
        "InCISAKEV": v.get("in_cisa_kev", False),
        "KEVDueDate": v.get("kev_due_date"),
        "AssetTier": v.get("asset_tier"),
        "Environment": v.get("environment"),
        "Exposure": v.get("exposure"),
        "AssetOwner": v.get("asset_owner"),
        "RiskScore": v.get("risk_score"),
        "Priority": v.get("priority"),
        "SLADays": v.get("sla_days"),
        "Title": v.get("title"),
        "Sources": ",".join(v.get("sources", [v.get("source", "Unknown")]))
    } for v in vulnerabilities])
    
    # Build authorization signature
    content_length = len(body)
    rfc1123date = datetime.utcnow().strftime('%a, %d %b %Y %H:%M:%S GMT')
    
    string_to_sign = f"POST\n{content_length}\napplication/json\nx-ms-date:{rfc1123date}\n/api/logs"
    signature = base64.b64encode(
        hmac.new(
            base64.b64decode(shared_key),
            string_to_sign.encode('utf-8'),
            hashlib.sha256
        ).digest()
    ).decode('utf-8')
    
    # Send to Log Analytics
    uri = f"https://{workspace_id}.ods.opinsights.azure.com/api/logs?api-version=2016-04-01"
    headers = {
        "Content-Type": "application/json",
        "Log-Type": table_name.replace("_CL", ""),  # API adds _CL suffix
        "x-ms-date": rfc1123date,
        "Authorization": f"SharedKey {workspace_id}:{signature}",
        "time-generated-field": "TimeGenerated"
    }
    
    response = requests.post(uri, data=body, headers=headers)
    
    if response.status_code == 200 or response.status_code == 202:
        logging.info(f"Successfully wrote {len(vulnerabilities)} records to {table_name}")
    else:
        logging.error(f"Failed to write to Log Analytics: {response.status_code} - {response.text}")
        raise Exception(f"Log Analytics write failed: {response.text}")</code></pre>
        </div>

        <h3>Step 1: Data Collection (Called by Main Function)</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Python — Collect Vulnerabilities from Qualys and MDE</span><button class="code-copy-btn">Copy</button></div>
          <pre><code>import requests
import json
from azure.identity import DefaultAzureCredential
from azure.storage.blob import BlobServiceClient

# ═══════════════════════════════════════════════════════════════════════════════
# STEP 1A: Fetch Qualys Vulnerabilities
# ═══════════════════════════════════════════════════════════════════════════════
def get_qualys_vulnerabilities():
    """Fetch vulnerability detections from Qualys API"""
    
    url = "https://qualysapi.qualys.com/api/2.0/fo/asset/host/vm/detection/"
    headers = {
        "X-Requested-With": "Python",
        "Authorization": f"Basic {QUALYS_AUTH}"
    }
    params = {
        "action": "list",
        "show_results": 1,
        "status": "New,Active,Re-Opened",
        "severities": "3,4,5"  # Medium, High, Critical
    }
    
    response = requests.get(url, headers=headers, params=params)
    vulnerabilities = parse_qualys_xml(response.text)
    
    # Normalize to common format
    normalized = []
    for vuln in vulnerabilities:
        normalized.append({
            "source": "Qualys",
            "cve_id": vuln.get("cve_id"),
            "qid": vuln.get("qid"),
            "hostname": vuln.get("hostname"),
            "ip_address": vuln.get("ip"),
            "cvss_score": float(vuln.get("cvss_base", 0)),
            "severity": vuln.get("severity"),
            "title": vuln.get("title"),
            "first_detected": vuln.get("first_found"),
            "last_detected": vuln.get("last_found"),
            "port": vuln.get("port"),
            "solution": vuln.get("solution")
        })
    
    return normalized

# ═══════════════════════════════════════════════════════════════════════════════
# STEP 1B: Fetch MDE TVM Vulnerabilities
# ═══════════════════════════════════════════════════════════════════════════════
def get_mde_vulnerabilities():
    """Fetch vulnerabilities from Microsoft Defender TVM API"""
    
    credential = DefaultAzureCredential()
    token = credential.get_token("https://api.securitycenter.microsoft.com/.default")
    
    url = "https://api.securitycenter.microsoft.com/api/vulnerabilities/machinesVulnerabilities"
    headers = {
        "Authorization": f"Bearer {token.token}",
        "Content-Type": "application/json"
    }
    
    vulnerabilities = []
    next_link = url
    
    while next_link:
        response = requests.get(next_link, headers=headers)
        data = response.json()
        vulnerabilities.extend(data.get("value", []))
        next_link = data.get("@odata.nextLink")
    
    # Normalize to common format
    normalized = []
    for vuln in vulnerabilities:
        normalized.append({
            "source": "MDE_TVM",
            "cve_id": vuln.get("cveId"),
            "hostname": vuln.get("machineName"),
            "device_id": vuln.get("machineId"),
            "cvss_score": vuln.get("cvssV3"),
            "severity": vuln.get("severity"),
            "title": vuln.get("name"),
            "software_name": vuln.get("productName"),
            "software_version": vuln.get("productVersion"),
            "exploit_verified": vuln.get("exploitVerified"),
            "exposure_level": vuln.get("exposureLevel"),
            "first_detected": vuln.get("detectionTime")
        })
    
    return normalized

# ═══════════════════════════════════════════════════════════════════════════════
# STEP 1C: Combine and Deduplicate
# ═══════════════════════════════════════════════════════════════════════════════
def aggregate_vulnerabilities():
    """Combine vulnerabilities from all sources"""
    
    qualys_vulns = get_qualys_vulnerabilities()
    mde_vulns = get_mde_vulnerabilities()
    
    # Combine all
    all_vulns = qualys_vulns + mde_vulns
    
    # Deduplicate by CVE + hostname
    seen = set()
    unique_vulns = []
    for vuln in all_vulns:
        key = (vuln["cve_id"], vuln["hostname"])
        if key not in seen:
            seen.add(key)
            unique_vulns.append(vuln)
        else:
            # Merge data from both sources if duplicate
            for existing in unique_vulns:
                if (existing["cve_id"], existing["hostname"]) == key:
                    existing["sources"] = existing.get("sources", [existing["source"]])
                    existing["sources"].append(vuln["source"])
    
    return unique_vulns</code></pre>
        </div>

        <h3>Step 2: EPSS Enrichment</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Python — Enrich with EPSS Scores</span><button class="code-copy-btn">Copy</button></div>
          <pre><code># ═══════════════════════════════════════════════════════════════════════════════
# STEP 2: Enrich with EPSS (Exploit Prediction Scoring System)
# ═══════════════════════════════════════════════════════════════════════════════

def get_epss_scores(cve_list):
    """Fetch EPSS scores for a list of CVEs"""
    
    # EPSS API allows batch queries
    cve_string = ",".join(cve_list)
    url = f"https://api.first.org/data/v1/epss?cve={cve_string}"
    
    response = requests.get(url)
    data = response.json()
    
    # Create lookup dictionary
    epss_lookup = {}
    for item in data.get("data", []):
        epss_lookup[item["cve"]] = {
            "epss_score": float(item["epss"]),
            "percentile": float(item["percentile"])
        }
    
    return epss_lookup

def enrich_with_epss(vulnerabilities):
    """Add EPSS scores to vulnerability list"""
    
    # Get unique CVEs
    cve_list = list(set([v["cve_id"] for v in vulnerabilities if v.get("cve_id")]))
    
    # Batch fetch EPSS scores (API limit: 100 CVEs per request)
    epss_lookup = {}
    for i in range(0, len(cve_list), 100):
        batch = cve_list[i:i+100]
        batch_scores = get_epss_scores(batch)
        epss_lookup.update(batch_scores)
    
    # Enrich vulnerabilities
    for vuln in vulnerabilities:
        cve_id = vuln.get("cve_id")
        if cve_id and cve_id in epss_lookup:
            vuln["epss_score"] = epss_lookup[cve_id]["epss_score"]
            vuln["epss_percentile"] = epss_lookup[cve_id]["percentile"]
        else:
            vuln["epss_score"] = 0.0
            vuln["epss_percentile"] = 0.0
    
    return vulnerabilities</code></pre>
        </div>

        <h3>Step 3: CISA KEV Enrichment</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Python — Enrich with CISA KEV</span><button class="code-copy-btn">Copy</button></div>
          <pre><code># ═══════════════════════════════════════════════════════════════════════════════
# STEP 3: Enrich with CISA KEV (Known Exploited Vulnerabilities)
# ═══════════════════════════════════════════════════════════════════════════════

def get_cisa_kev():
    """Fetch CISA Known Exploited Vulnerabilities catalog"""
    
    url = "https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json"
    response = requests.get(url)
    data = response.json()
    
    # Create lookup dictionary
    kev_lookup = {}
    for vuln in data.get("vulnerabilities", []):
        kev_lookup[vuln["cveID"]] = {
            "vendor": vuln["vendorProject"],
            "product": vuln["product"],
            "name": vuln["vulnerabilityName"],
            "date_added": vuln["dateAdded"],
            "due_date": vuln["dueDate"],
            "action": vuln["requiredAction"]
        }
    
    return kev_lookup

def enrich_with_kev(vulnerabilities):
    """Flag vulnerabilities in CISA KEV"""
    
    kev_lookup = get_cisa_kev()
    
    for vuln in vulnerabilities:
        cve_id = vuln.get("cve_id")
        if cve_id and cve_id in kev_lookup:
            vuln["in_cisa_kev"] = True
            vuln["kev_date_added"] = kev_lookup[cve_id]["date_added"]
            vuln["kev_due_date"] = kev_lookup[cve_id]["due_date"]
            vuln["kev_action"] = kev_lookup[cve_id]["action"]
        else:
            vuln["in_cisa_kev"] = False
    
    return vulnerabilities</code></pre>
        </div>

        <h3>Step 4: CMDB Enrichment</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Python — Enrich with CMDB Asset Context</span><button class="code-copy-btn">Copy</button></div>
          <pre><code># ═══════════════════════════════════════════════════════════════════════════════
# STEP 4: Enrich with CMDB (ServiceNow) Asset Context
# ═══════════════════════════════════════════════════════════════════════════════

def get_cmdb_assets():
    """Fetch asset inventory from ServiceNow CMDB"""
    
    url = f"https://{SNOW_INSTANCE}.service-now.com/api/now/table/cmdb_ci_server"
    headers = {
        "Authorization": f"Basic {SNOW_AUTH}",
        "Content-Type": "application/json"
    }
    params = {
        "sysparm_fields": "name,ip_address,fqdn,asset_tag,operational_status,"
                          "business_criticality,environment,location,support_group,"
                          "assigned_to,u_internet_facing,u_tier",
        "sysparm_limit": 10000
    }
    
    response = requests.get(url, headers=headers, params=params)
    assets = response.json().get("result", [])
    
    # Create lookup by hostname and IP
    asset_lookup = {}
    for asset in assets:
        # Index by hostname (normalized)
        hostname = asset.get("name", "").lower()
        if hostname:
            asset_lookup[hostname] = {
                "asset_name": asset.get("name"),
                "ip_address": asset.get("ip_address"),
                "tier": asset.get("u_tier", "Tier 3"),
                "environment": asset.get("environment", "Production"),
                "internet_facing": asset.get("u_internet_facing", "false") == "true",
                "business_criticality": asset.get("business_criticality", "3 - low"),
                "location": asset.get("location"),
                "support_group": asset.get("support_group"),
                "owner": asset.get("assigned_to")
            }
        
        # Also index by IP
        ip = asset.get("ip_address")
        if ip:
            asset_lookup[ip] = asset_lookup.get(hostname, {})
    
    return asset_lookup

def enrich_with_cmdb(vulnerabilities):
    """Add asset context from CMDB"""
    
    cmdb_lookup = get_cmdb_assets()
    
    for vuln in vulnerabilities:
        hostname = vuln.get("hostname", "").lower()
        ip = vuln.get("ip_address")
        
        asset_info = cmdb_lookup.get(hostname) or cmdb_lookup.get(ip) or {}
        
        vuln["asset_tier"] = asset_info.get("tier", "Tier 3")
        vuln["environment"] = asset_info.get("environment", "Unknown")
        vuln["internet_facing"] = asset_info.get("internet_facing", False)
        vuln["business_criticality"] = asset_info.get("business_criticality", "3 - low")
        vuln["asset_owner"] = asset_info.get("owner")
        vuln["support_group"] = asset_info.get("support_group")
        
        # Determine exposure level
        if vuln["internet_facing"]:
            vuln["exposure"] = "Internet-facing"
        else:
            vuln["exposure"] = "Internal"
    
    return vulnerabilities</code></pre>
        </div>

        <h3>Step 5: Calculate Risk Score and Prioritize</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Python — Risk Scoring and Prioritization</span><button class="code-copy-btn">Copy</button></div>
          <pre><code># ═══════════════════════════════════════════════════════════════════════════════
# STEP 5: Calculate Risk Score
# ═══════════════════════════════════════════════════════════════════════════════

def calculate_risk_score(vuln):
    """Calculate composite risk score for a vulnerability"""
    
    base_score = vuln.get("cvss_score", 5.0)
    
    # Exploitation likelihood multiplier
    if vuln.get("in_cisa_kev"):
        exploit_multiplier = 2.0
    elif vuln.get("epss_score", 0) > 0.7:
        exploit_multiplier = 1.8
    elif vuln.get("epss_score", 0) > 0.4:
        exploit_multiplier = 1.5
    elif vuln.get("epss_score", 0) > 0.1:
        exploit_multiplier = 1.2
    else:
        exploit_multiplier = 1.0
    
    # Asset criticality multiplier
    tier = vuln.get("asset_tier", "Tier 3")
    if tier == "Tier 1":
        asset_multiplier = 2.0
    elif tier == "Tier 2":
        asset_multiplier = 1.5
    else:
        asset_multiplier = 1.0
    
    # Exposure multiplier
    if vuln.get("internet_facing") or vuln.get("exposure") == "Internet-facing":
        exposure_multiplier = 2.0
    elif vuln.get("exposure") == "DMZ":
        exposure_multiplier = 1.5
    else:
        exposure_multiplier = 1.0
    
    # Environment multiplier
    env = vuln.get("environment", "").lower()
    if "prod" in env:
        env_multiplier = 1.5
    elif "stag" in env:
        env_multiplier = 1.2
    else:
        env_multiplier = 1.0
    
    # Calculate final score
    risk_score = (base_score * exploit_multiplier * asset_multiplier * 
                  exposure_multiplier * env_multiplier)
    
    return round(risk_score, 2)

def assign_priority(vuln):
    """Assign priority based on risk score"""
    
    risk_score = vuln.get("risk_score", 0)
    
    # CISA KEV always critical
    if vuln.get("in_cisa_kev"):
        return "CRITICAL"
    
    if risk_score >= 50:
        return "CRITICAL"
    elif risk_score >= 30:
        return "HIGH"
    elif risk_score >= 15:
        return "MEDIUM"
    else:
        return "LOW"

def prioritize_vulnerabilities(vulnerabilities):
    """Calculate risk scores and assign priorities"""
    
    for vuln in vulnerabilities:
        vuln["risk_score"] = calculate_risk_score(vuln)
        vuln["priority"] = assign_priority(vuln)
        
        # Set SLA based on priority
        if vuln["priority"] == "CRITICAL":
            vuln["sla_days"] = 2  # 48 hours
        elif vuln["priority"] == "HIGH":
            vuln["sla_days"] = 7
        elif vuln["priority"] == "MEDIUM":
            vuln["sla_days"] = 30
        else:
            vuln["sla_days"] = 90
    
    # Sort by risk score descending
    vulnerabilities.sort(key=lambda x: x["risk_score"], reverse=True)
    
    return vulnerabilities</code></pre>
        </div>

        <h3>Step 6: Automated Actions</h3>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Python — Auto-Create Tickets and Alerts</span><button class="code-copy-btn">Copy</button></div>
          <pre><code># ═══════════════════════════════════════════════════════════════════════════════
# STEP 6: Automated Actions
# ═══════════════════════════════════════════════════════════════════════════════

def create_servicenow_ticket(vuln):
    """Create ServiceNow incident for vulnerability remediation"""
    
    url = f"https://{SNOW_INSTANCE}.service-now.com/api/now/table/incident"
    headers = {
        "Authorization": f"Basic {SNOW_AUTH}",
        "Content-Type": "application/json"
    }
    
    # Map priority to ServiceNow impact/urgency
    priority_map = {
        "CRITICAL": {"impact": "1", "urgency": "1"},
        "HIGH": {"impact": "2", "urgency": "1"},
        "MEDIUM": {"impact": "2", "urgency": "2"},
        "LOW": {"impact": "3", "urgency": "3"}
    }
    
    p = priority_map.get(vuln["priority"], {"impact": "3", "urgency": "3"})
    
    description = f"""
AUTOMATED VULNERABILITY REMEDIATION TICKET

CVE: {vuln.get('cve_id')}
Host: {vuln.get('hostname')}
CVSS Score: {vuln.get('cvss_score')}
Risk Score: {vuln.get('risk_score')}
Priority: {vuln.get('priority')}
SLA: {vuln.get('sla_days')} days

EPSS Score: {vuln.get('epss_score', 0):.2%}
In CISA KEV: {'YES - MANDATORY PATCH' if vuln.get('in_cisa_kev') else 'No'}

Asset Information:
- Tier: {vuln.get('asset_tier')}
- Environment: {vuln.get('environment')}
- Exposure: {vuln.get('exposure')}
- Owner: {vuln.get('asset_owner')}

Vulnerability Details:
{vuln.get('title', 'N/A')}

Solution:
{vuln.get('solution', 'Apply vendor patch or follow security advisory')}
    """
    
    payload = {
        "short_description": f"[{vuln['priority']}] {vuln['cve_id']} on {vuln['hostname']}",
        "description": description,
        "category": "Security",
        "subcategory": "Vulnerability",
        "impact": p["impact"],
        "urgency": p["urgency"],
        "assignment_group": vuln.get("support_group", "Security Operations"),
        "caller_id": "vulnerability_automation"
    }
    
    response = requests.post(url, headers=headers, json=payload)
    return response.json()

def send_to_sentinel(vuln):
    """Send vulnerability alert to Microsoft Sentinel"""
    
    # Use Log Analytics Data Collector API
    log_type = "VulnerabilityAlerts"
    
    body = json.dumps([{
        "TimeGenerated": datetime.utcnow().isoformat(),
        "CVE": vuln.get("cve_id"),
        "Hostname": vuln.get("hostname"),
        "CVSSScore": vuln.get("cvss_score"),
        "RiskScore": vuln.get("risk_score"),
        "Priority": vuln.get("priority"),
        "EPSSScore": vuln.get("epss_score"),
        "InCISAKEV": vuln.get("in_cisa_kev"),
        "AssetTier": vuln.get("asset_tier"),
        "Environment": vuln.get("environment"),
        "Exposure": vuln.get("exposure"),
        "Title": vuln.get("title")
    }])
    
    # Post to Log Analytics
    post_to_log_analytics(WORKSPACE_ID, SHARED_KEY, log_type, body)

def process_vulnerabilities(vulnerabilities):
    """Main automation workflow"""
    
    for vuln in vulnerabilities:
        if vuln["priority"] in ["CRITICAL", "HIGH"]:
            # Auto-create ServiceNow ticket
            ticket = create_servicenow_ticket(vuln)
            vuln["snow_ticket"] = ticket.get("number")
            
            # Send to Sentinel for correlation
            send_to_sentinel(vuln)
            
            # Email asset owner
            if vuln.get("asset_owner"):
                send_notification_email(vuln)
    
    return vulnerabilities</code></pre>
        </div>

        <!-- ==================== SECTION 6: DASHBOARD ==================== -->
        <h2>7. Vulnerability Dashboard</h2>

        <div class="metric-grid">
          <div class="metric-card">
            <div class="value">47,234</div>
            <div class="label">Total Vulnerabilities</div>
          </div>
          <div class="metric-card">
            <div class="value">127</div>
            <div class="label">Critical Priority</div>
          </div>
          <div class="metric-card">
            <div class="value">842</div>
            <div class="label">High Priority</div>
          </div>
          <div class="metric-card">
            <div class="value">23</div>
            <div class="label">In CISA KEV</div>
          </div>
          <div class="metric-card">
            <div class="value">94%</div>
            <div class="label">Within SLA</div>
          </div>
          <div class="metric-card">
            <div class="value">12 days</div>
            <div class="label">Avg Remediation Time</div>
          </div>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">KQL — Vulnerability Dashboard Queries (Sentinel)</span><button class="code-copy-btn">Copy</button></div>
          <pre><code>// Critical/High vulnerabilities by host
VulnerabilityAlerts_CL
| where TimeGenerated > ago(7d)
| where Priority in ("CRITICAL", "HIGH")
| summarize VulnCount = count() by Hostname, Priority
| order by VulnCount desc
| take 20

// Vulnerabilities in CISA KEV
VulnerabilityAlerts_CL
| where InCISAKEV == true
| summarize by CVE, Hostname, RiskScore
| order by RiskScore desc

// Remediation SLA compliance
VulnerabilityAlerts_CL
| join kind=leftouter (
    ServiceNow_Incidents_CL
    | where Category == "Vulnerability"
) on $left.CVE == $right.CVE, $left.Hostname == $right.Hostname
| extend RemediationDays = datetime_diff('day', ResolvedTime, TimeGenerated)
| extend WithinSLA = RemediationDays <= SLADays
| summarize TotalCount = count(), WithinSLACount = countif(WithinSLA) by Priority
| extend SLACompliance = round(100.0 * WithinSLACount / TotalCount, 1)

// Trend over time
VulnerabilityAlerts_CL
| summarize 
    Critical = countif(Priority == "CRITICAL"),
    High = countif(Priority == "HIGH"),
    Medium = countif(Priority == "MEDIUM")
    by bin(TimeGenerated, 1d)
| render timechart</code></pre>
        </div>

        <!-- ==================== SECTION 7: MANUAL WORKFLOW ==================== -->
        <h2>8. Manual Workflow — Analysts and Business Owners</h2>

        <p>While automation handles initial triage and ticket creation, humans are essential for:</p>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Activity</th><th>Owner</th><th>Description</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>False Positive Review</strong></td>
                <td>Security Analyst</td>
                <td>Review tickets flagged as potential FPs. Mark as FP with justification if scanner error.</td>
              </tr>
              <tr>
                <td><strong>Impact Assessment</strong></td>
                <td>Business Owner</td>
                <td>Assess business impact of remediation. Does patching require downtime?</td>
              </tr>
              <tr>
                <td><strong>Compensating Controls</strong></td>
                <td>Security Engineer</td>
                <td>If immediate patching not possible, implement compensating controls (network isolation, WAF rules, etc.)</td>
              </tr>
              <tr>
                <td><strong>Exception Requests</strong></td>
                <td>Business Owner + Security</td>
                <td>Request risk acceptance for vulnerabilities that cannot be remediated. Requires CISO approval.</td>
              </tr>
              <tr>
                <td><strong>Verification</strong></td>
                <td>Security Analyst</td>
                <td>After remediation, verify vulnerability is resolved. Close ticket.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- ==================== SECTION 8: INTERVIEW ANSWERS ==================== -->
        <h2>9. Interview-Ready Answers</h2>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Q: "Tell me about a vulnerability management process you implemented"</span></div>
          <pre><code>"I built an automated vulnerability management pipeline to give our team 
a single pane of glass instead of juggling multiple consoles.

THE PROBLEM:
We had vulnerabilities in two places — Qualys scanner and MDE TVM. 
Analysts were constantly switching between the Qualys portal and 
Microsoft 365 Defender portal, manually correlating findings. Each tool 
had its own severity rating but neither provided business context or 
exploit intelligence.

THE SOLUTION:
I built an Azure Function that runs daily on a timer trigger. It:

1. AGGREGATES data from both Qualys API and MDE TVM API into a unified 
   list, deduplicating by CVE + hostname so we have one source of truth.

2. ENRICHES with exploit intelligence:
   • EPSS scores from FIRST.org — probability of exploitation in 30 days
   • CISA KEV — flags CVEs with confirmed active exploitation
   • ServiceNow CMDB — adds asset tier, environment, exposure, owner

3. CALCULATES risk score: CVSS × EPSS × Asset criticality × Exposure
   This gives us true business risk, not just technical severity.

4. OUTPUTS to multiple destinations:
   • Custom Log Analytics table → Sentinel workbook dashboard
   • Auto-creates ServiceNow tickets for Critical/High
   • Emails asset owners

THE RESULT:
• Analysts have ONE dashboard instead of two consoles
• Prioritization is automated based on actual risk
• Critical findings get tickets immediately
• SLA compliance improved because nothing falls through the cracks
• Asset owners are notified directly, speeding up remediation"</code></pre>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Q: "Where does the automation code run?"</span></div>
          <pre><code>"I use Azure Functions with a timer trigger — it's serverless, so no 
infrastructure to manage.

The function runs daily at 6 AM. It:
1. Calls Qualys API to get vulnerability detections
2. Calls MDE TVM API using managed identity
3. Calls external APIs (FIRST.org for EPSS, CISA for KEV)
4. Queries ServiceNow CMDB for asset context
5. Writes enriched data to a custom Log Analytics table

From there, Sentinel picks it up. I built a workbook that queries 
VulnerabilityInventory_CL table to show the unified dashboard. I also 
have an analytics rule that fires when new Critical findings appear.

For the ServiceNow integration, the same Function calls the ServiceNow 
REST API to auto-create incidents for Critical and High priority items.

Alternatives I considered:
• Azure Automation Runbook — works but Functions are more lightweight
• Logic Apps — good for visual workflows but complex Python logic is 
  easier in Functions
• On-prem scheduled task — we wanted everything in Azure"</code></pre>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Q: "How do you decide what to patch first?"</span></div>
          <pre><code>"I don't rely on CVSS alone — it measures theoretical severity, not real 
risk. A CVSS 9.8 on an isolated test server isn't urgent. A CVSS 7.5 on 
an internet-facing production server with active exploitation is critical.

My prioritization framework uses multiple signals:

IMMEDIATE (24-48 hours):
• Any CVE in CISA KEV — confirmed active exploitation
• EPSS > 0.7 on production assets — very high exploitation probability
• Any vulnerability flagged 'exploit verified' in MDE

HIGH PRIORITY (7 days):
• CVSS ≥ 7.0 + EPSS > 0.4 + internet-facing
• Any vulnerability on Tier 1 systems with known exploits

STANDARD (30 days):
• CVSS ≥ 7.0 on internal production systems
• Medium severity on externally exposed systems

BACKLOG (90 days or risk acceptance):
• Low severity, internal systems, low EPSS
• Requires documented risk acceptance with compensating controls

The key insight: EPSS and CISA KEV tell you what attackers are actually 
targeting right now. CVSS tells you theoretical impact. I prioritize 
based on what's being exploited, not just what could be exploited."</code></pre>
        </div>

        <div class="code-block">
          <div class="code-header"><span class="code-lang">Q: "How do you handle false positives and exceptions?"</span></div>
          <pre><code>"The automation handles initial triage, but humans are essential for:

FALSE POSITIVES:
When analysts identify a false positive — maybe the scanner detected a 
vulnerable version but the system is actually patched — they update the 
ticket in ServiceNow with 'False Positive' status and justification. 
I have a feedback loop where FP data gets added to an exclusion list 
in the Function, so we don't keep creating tickets for known FPs.

EXCEPTIONS (Risk Acceptance):
Sometimes we can't patch — legacy system, vendor dependency, production 
freeze. The process:
1. Business owner documents why patching isn't possible
2. Security reviews and proposes compensating controls
3. If risk is accepted, it requires manager + CISO approval
4. Exception is time-limited (90 days max), then re-review

COMPENSATING CONTROLS we commonly apply:
• Network segmentation — isolate vulnerable system
• Enhanced monitoring — custom detection rule for exploitation attempts
• Application whitelisting — block unauthorized code execution
• WAF rules — virtual patching for web vulnerabilities

All exceptions are tracked in ServiceNow with expiration dates. 
The Function checks for expired exceptions and auto-reopens tickets."</code></pre>
        </div>

        <!-- ==================== FINAL INTERVIEW SUMMARY ==================== -->
        <h2>10. Interview Summary: Vulnerability Management</h2>

        <div class="callout success">
          <div class="callout-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Key Talking Points</div>
          <div class="callout-content">
            <p><strong>On Native Capabilities:</strong></p>
            <p style="margin-left: 1rem;"><em>"MDVM — which used to be called TVM — now includes EPSS scores, CISA KEV status, and exposure scoring natively. Qualys has similar capabilities with TruRisk. That's table stakes now — you don't need custom automation just for exploit intelligence."</em></p>
            
            <p style="margin-top: 1rem;"><strong>On Why We Built Automation:</strong></p>
            <p style="margin-left: 1rem;"><em>"Our automation adds value on top: unifying data from both MDVM and Qualys since we use both, enriching with CMDB business context that scanners don't know — like which servers are Tier 1 production versus test environments — applying a custom risk formula aligned to our risk appetite, and auto-creating ServiceNow tickets for Critical and High findings. The native tools tell you what's vulnerable; our automation tells you what to fix first based on business impact."</em></p>
            
            <p style="margin-top: 1rem;"><strong>On the Custom Risk Formula:</strong></p>
            <p style="margin-left: 1rem;"><em>"We multiply CVSS by exploitation likelihood — using KEV status and EPSS — then by asset criticality from CMDB and network exposure. A CVSS 7.5 on a Tier 1 internet-facing production server scores higher than a CVSS 9.8 on a Tier 3 internal test box. That's business-aware prioritization."</em></p>
            
            <p style="margin-top: 1rem;"><strong>On When NOT to Build This:</strong></p>
            <p style="margin-left: 1rem;"><em>"If you only have one scanner and no mature CMDB, the native dashboard is probably sufficient. Don't over-engineer. We built this because we have dual scanners, a mature ServiceNow CMDB, and our SOC lives in Sentinel — we wanted vulnerability data in the same workbook as security alerts."</em></p>
          </div>
        </div>

        <div class="metric-grid">
          <div class="metric-card">
            <div class="value">1</div>
            <div class="label">Unified Dashboard</div>
          </div>
          <div class="metric-card">
            <div class="value">2</div>
            <div class="label">Scanner Sources (MDVM + Qualys)</div>
          </div>
          <div class="metric-card">
            <div class="value">4</div>
            <div class="label">Risk Multipliers (EPSS, KEV, Tier, Exposure)</div>
          </div>
          <div class="metric-card">
            <div class="value">Auto</div>
            <div class="label">Ticketing for Crit/High</div>
          </div>
        </div>

        <nav class="page-nav">
          <a href="live-response.html" class="page-nav-link prev"><span class="page-nav-label">Previous</span><span class="page-nav-title">← Live Response</span></a>
          <a href="deployment.html" class="page-nav-link next"><span class="page-nav-label">Next</span><span class="page-nav-title">MDE Deployment →</span></a>
        </nav>
      </div>
    </main>
  </div>
  <script src="../js/main.js"></script>
</body>
</html>
